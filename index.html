<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PubliFleet | Sistema de Control de Publicidad</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                            950: '#082f49',
                        },
                        secondary: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            200: '#ddd6fe',
                            300: '#c4b5fd',
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                            700: '#6d28d9',
                            800: '#5b21b6',
                            900: '#4c1d95',
                            950: '#2e1065',
                        },
                        success: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                            950: '#052e16',
                        },
                        warning: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                            950: '#451a03',
                        },
                        danger: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d',
                            950: '#450a0a',
                        },
                        gray: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#6b7280',
                            600: '#4b5563',
                            700: '#374151',
                            800: '#1f2937',
                            900: '#111827',
                            950: '#030712',
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'heading': ['Outfit', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                        'dropdown': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                        'button': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'button-hover': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.4s ease-in-out',
                        'slide-down': 'slideDown 0.4s ease-in-out',
                        'slide-in-right': 'slideInRight 0.4s ease-in-out',
                        'bounce-subtle': 'bounceSubtle 2s infinite',
                        'pulse-subtle': 'pulseSubtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideInRight: {
                            '0%': { transform: 'translateX(20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        bounceSubtle: {
                            '0%, 100%': { transform: 'translateY(-2px)' },
                            '50%': { transform: 'translateY(0)' },
                        },
                        pulseSubtle: {
                            '0%, 100%': { opacity: 0.85 },
                            '50%': { opacity: 1 },
                        },
                    },
                }
            }
        }
    </script>
    
    <!-- Leaflet CSS (para mapas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Estilos personalizados -->
    <style>
        /* Base Styles */
        :root {
            --primary-bg: #f8fafc;
            --sidebar-bg: #ffffff;
            --sidebar-active: #0ea5e9;
            --header-height: 70px;
            --sidebar-width: 280px;
            --mobile-nav-height: 65px;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--primary-bg);
            color: #1f2937;
            overflow-x: hidden;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Outfit', sans-serif;
        }
        
        /* Scrollbar customization */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Layout */
        #app-container {
            min-height: 100vh;
        }
        
        #desktop-layout {
            height: 100vh;
            overflow: hidden;
        }
        
        #main-content, 
        #mobile-main-content {
            scroll-behavior: smooth;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            z-index: 20;
            transition: transform 0.3s ease;
        }
        
        .sidebar-link {
            transition: all 0.2s ease;
            position: relative;
        }
        
        .sidebar-link.active {
            background-color: rgba(14, 165, 233, 0.08);
            color: var(--sidebar-active);
            font-weight: 600;
        }
        
        .sidebar-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background-color: var(--sidebar-active);
            border-radius: 0 4px 4px 0;
        }
        
        /* Mobile nav */
        .mobile-nav {
            height: var(--mobile-nav-height);
            border-top: 1px solid #e5e7eb;
            background-color: #ffffff;
            z-index: 30;
        }
        
        .nav-item {
            transition: all 0.2s ease;
        }
        
        .nav-item.active {
            color: var(--sidebar-active);
        }
        
        /* Main Content */
        .content-section {
            opacity: 0;
            display: none;
            transition: opacity 0.3s ease;
        }
        
        .content-section.active {
            opacity: 1;
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Cards & Components */
        .card {
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            background-color: #ffffff;
        }
        
        .card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            transform: translateY(-2px);
        }
        
        .stat-card {
            animation: slideUp 0.4s ease;
            animation-fill-mode: both;
        }
        
        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        
        /* Forms */
        .form-control {
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid #e5e7eb;
            width: 100%;
            padding: 0.75rem 1rem;
        }
        
        .form-control:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
            outline: none;
        }
        
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
            color: #4b5563;
        }
        
        /* Buttons */
        .btn {
            font-weight: 600;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: #0ea5e9;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0284c7;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary {
            background-color: #f3f4f6;
            color: #4b5563;
        }
        
        .btn-secondary:hover {
            background-color: #e5e7eb;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background-color: #22c55e;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #16a34a;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-warning {
            background-color: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-outline {
            border: 1px solid #e5e7eb;
            background-color: transparent;
        }
        
        .btn-outline:hover {
            border-color: #d1d5db;
            background-color: #f9fafb;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .btn-xs {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        /* Badge */
        .badge {
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-weight: 600;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .badge-blue {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .badge-green {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .badge-red {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .badge-yellow {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .badge-gray {
            background-color: #f3f4f6;
            color: #4b5563;
        }
        
        /* Tables */
        .table-container {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background-color: #f9fafb;
            font-weight: 600;
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #4b5563;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        
        .table tr:hover {
            background-color: #f9fafb;
        }
        
        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal-backdrop.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 95%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateY(20px) scale(0.95);
            transition: transform 0.3s ease;
        }
        
        .modal-backdrop.visible .modal-content {
            transform: translateY(0) scale(1);
        }
        
        /* Loader */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #0ea5e9;
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: loader 1s linear infinite;
        }
        
        @keyframes loader {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: white;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            max-width: 380px;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Status indicators */
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-indicator.online {
            background-color: #22c55e;
        }
        
        .status-indicator.offline {
            background-color: #ef4444;
        }
        
        /* Map customization */
        .map-container {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        /* Offline banner */
        .offline-banner {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 0.5rem 1rem;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        
        .offline-banner.visible {
            display: block;
        }
        
        /* Form Components */
        .form-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        
        .form-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e7eb;
            transition: .4s;
            border-radius: 24px;
        }
        
        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .switch-slider {
            background-color: #0ea5e9;
        }
        
        input:checked + .switch-slider:before {
            transform: translateX(24px);
        }
        
        /* File Upload */
        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .file-upload:hover {
            border-color: #9ca3af;
            background-color: #f9fafb;
        }
        
        .file-upload.dragging {
            border-color: #60a5fa;
            background-color: #eff6ff;
        }
        
        /* Bus Card */
        .bus-card {
            position: relative;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            background-color: #ffffff;
            padding: 1rem;
            cursor: pointer;
        }
        
        .bus-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            transform: translateY(-2px);
        }
        
        .bus-card .status-dot {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .bus-card .status-dot.reviewed {
            background-color: #22c55e;
        }
        
        .bus-card .status-dot.pending {
            background-color: #d1d5db;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }
        
        .tab {
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .tab:hover {
            color: #4b5563;
        }
        
        .tab.active {
            color: #0ea5e9;
            border-bottom-color: #0ea5e9;
        }
        
        /* Image Preview */
        .image-preview {
            border-radius: 8px;
            overflow: hidden;
            max-width: 100%;
            max-height: 300px;
        }
        
        .image-preview img {
            width: 100%;
            height: auto;
            object-fit: contain;
        }
        
        /* Combobox */
        .combobox {
            position: relative;
        }
        
        .combobox-input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-right: 2.5rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .combobox-input:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
            outline: none;
        }
        
        .combobox-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }
        
        .combobox-options {
            position: absolute;
            z-index: 10;
            width: 100%;
            margin-top: 0.25rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            display: none;
        }
        
        .combobox-options.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        .combobox-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.1s ease;
        }
        
        .combobox-option:hover {
            background-color: #f3f4f6;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            #mobile-main-content {
                padding-bottom: var(--mobile-nav-height);
            }
            
            .card {
                border-radius: 10px;
            }
            
            .btn {
                padding: 0.625rem 1.25rem;
            }
            
            .table th, .table td {
                padding: 0.625rem 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Loader principal -->
        <div id="main-loader" class="loader-overlay">
            <div class="text-center">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-gray-600 font-medium">Cargando PubliFleet...</p>
            </div>
        </div>

        <!-- Banner de offline -->
        <div id="offline-banner" class="offline-banner">
            <div class="flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><line x1="1" x2="23" y1="1" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>
                <span>Sin conexión - Los cambios se guardarán cuando vuelva la conexión</span>
            </div>
        </div>

        <!-- Layout de Escritorio -->
        <div id="desktop-layout" class="hidden md:flex">
            <!-- Sidebar -->
            <aside class="sidebar fixed top-0 left-0 h-full bg-white shadow-lg flex flex-col z-20">
                <div class="p-6">
                    <div class="flex items-center gap-3">
                        <div class="flex-shrink-0 w-10 h-10 bg-primary-600 rounded-lg flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold font-heading text-gray-900">PubliFleet</h1>
                            <p class="text-xs text-gray-500">Sistema de Gestión de Publicidad</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex-1 px-4 py-2 overflow-y-auto">
                    <nav id="desktop-nav" class="space-y-1">
                        <!-- Nav links will be inserted here by JS -->
                    </nav>
                </div>
                
                <div class="p-4 border-t border-gray-100">
                    <div class="flex items-center gap-3 p-2">
                        <div class="status-indicator online"></div>
                        <div>
                            <p class="text-sm font-medium text-gray-700" id="connection-status">Conectado</p>
                            <p class="text-xs text-gray-500" id="sync-status">Datos sincronizados</p>
                        </div>
                    </div>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="flex-1 ml-[280px] h-full overflow-y-auto bg-gray-50 transition-all duration-300" id="main-content">
                <!-- Content will be inserted here by JS -->
            </main>
        </div>

        <!-- Layout Móvil -->
        <div id="mobile-layout" class="md:hidden">
            <!-- Header Móvil -->
            <header class="bg-white shadow-sm py-4 px-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-primary-600 rounded-md flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                    </div>
                    <h1 class="text-xl font-bold font-heading text-gray-900">PubliFleet</h1>
                </div>
                <div class="flex items-center gap-2">
                    <div class="status-indicator online" id="mobile-status-indicator"></div>
                </div>
            </header>
            
            <!-- Main Content -->
            <main class="overflow-y-auto bg-gray-50" id="mobile-main-content">
                <!-- Content will be inserted here by JS -->
            </main>
            
            <!-- Navigation -->
            <footer class="mobile-nav fixed bottom-0 left-0 right-0 bg-white shadow-lg flex justify-around items-center">
                <nav id="mobile-nav" class="flex justify-around w-full">
                    <!-- Nav links will be inserted here by JS -->
                </nav>
            </footer>
        </div>
    </div>

    <!-- Modal para detalles de bus -->
    <div id="bus-detail-modal" class="modal-backdrop">
        <div class="modal-content p-6">
            <!-- Modal content will be inserted here by JS -->
        </div>
    </div>

    <!-- Modal para imágenes de daños -->
    <div id="damage-image-modal" class="modal-backdrop">
        <div class="modal-content p-6">
            <!-- Modal content will be inserted here by JS -->
        </div>
    </div>

    <!-- Notificación -->
    <div id="notification" class="notification">
        <div id="notification-icon" class="flex-shrink-0"></div>
        <div>
            <h3 id="notification-title" class="font-medium text-gray-900"></h3>
            <p id="notification-message" class="text-sm text-gray-500"></p>
        </div>
    </div>

    <!-- Librerías de JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <script>
        // --- CONFIGURACIÓN ---
        const CONFIG = {
            supabaseUrl: 'https://tcmtxvuucjttngcazgff.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjbXR4dnV1Y2p0dG5nY2F6Z2ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA3MjUwMDEsImV4cCI6MjA1NjMwMTAwMX0.2WcIjMUEhSM6j9kYpbsYArQocZdHx86k7wXk-NyjIs0',
            offlineStorageKey: 'publifleet_offline_data',
            userLocationKey: 'publifleet_user_location',
            version: '2.0.0'
        };
        
        const TERMINALS = [
            { name: 'El Roble', lat: -33.44071194412281, lon: -70.78973603006452 },
            { name: 'La Reina', lat: -33.4648451661274, lon: -70.53179284909858 },
            { name: 'Maria Angelica', lat: -33.51772240158645, lon: -70.55641931656773 },
            { name: 'El Descanso', lat: -33.4695150389365, lon: -70.76243487908678 },
        ];
        
        // --- ESTADO DE LA APLICACIÓN ---
        const APP = {
            // Estado principal de la aplicación
            state: {
                activeView: 'dashboard',
                inspections: [],
                pendingSync: [],
                processedFleet: [],
                loading: true,
                selectedBus: null,
                isOnline: navigator.onLine,
                map: null,
                userMarker: null,
                userLocation: null,
                lastSyncTime: null,
                charts: {}
            },
            
            // Instancias de supabase
            supabase: null,
            
            // Datos estáticos
            fleetData: [], // Se cargará desde archivo JSON
            
            // Definición de la navegación
            navItems: [
                { 
                    id: 'dashboard',
                    label: 'Dashboard',
                    mobileLabel: 'Inicio',
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>'
                },
                { 
                    id: 'form',
                    label: 'Nuevo Registro',
                    mobileLabel: 'Registrar',
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>'
                },
                { 
                    id: 'reports',
                    label: 'Reportes',
                    mobileLabel: 'Reportes',
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>'
                },
                { 
                    id: 'fleet',
                    label: 'Flota',
                    mobileLabel: 'Flota',
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 17h4V5h-4v12Z"/><path d="M6 17h-2a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2v12Z"/><path d="M14 17h4a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-4v12Z"/><path d="M12 5V3"/><path d="M12 17v2"/><path d="M12 21a2 2 0 1 0 4 0a2 2 0 1 0-4 0m-8 0a2 2 0 1 0 4 0a2 2 0 1 0-4 0"/></svg>'
                },
                { 
                    id: 'assistance',
                    label: 'Asistencia',
                    mobileLabel: 'Ayuda',
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>'
                },
            ],
            
            // Templates para vistas
            templates: {}
        };
        
        // --- UTILIDADES ---
        const Utils = {
            // Formateo de datos
            formatDate: (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', { 
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },
            
            // Cálculo de distancia entre coordenadas
            getDistance: (lat1, lon1, lat2, lon2) => {
                const R = 6371; // Radio de la Tierra en km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + 
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                          Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            },
            
            // Obtener el terminal más cercano
            getNearestTerminal: (lat, lon) => {
                return TERMINALS.reduce((prev, curr) => 
                    (Utils.getDistance(lat, lon, prev.lat, prev.lon) < Utils.getDistance(lat, lon, curr.lat, curr.lon)) 
                        ? prev : curr
                );
            },
            
            // Generar ID único
            generateId: () => {
                return 'id_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            },
            
            // Mostrar loader
            showLoader: (show) => {
                document.getElementById('main-loader').style.display = show ? 'flex' : 'none';
            },
            
            // Mostrar modal
            showModal: (modalId, content) => {
                const modal = document.getElementById(modalId);
                if (modalId === 'bus-detail-modal') {
                    modal.querySelector('.modal-content').innerHTML = content;
                } else if (modalId === 'damage-image-modal') {
                    modal.querySelector('.modal-content').innerHTML = content;
                }
                modal.classList.add('visible');
            },
            
            // Ocultar modal
            hideModal: (modalId) => {
                document.getElementById(modalId).classList.remove('visible');
            },
            
            // Mostrar notificación
            showNotification: (title, message, type = 'success') => {
                const notification = document.getElementById('notification');
                const titleEl = document.getElementById('notification-title');
                const messageEl = document.getElementById('notification-message');
                const iconEl = document.getElementById('notification-icon');
                
                let iconSvg, bgColor;
                
                switch (type) {
                    case 'success':
                        iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';
                        bgColor = '#dcfce7';
                        break;
                    case 'error':
                        iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>';
                        bgColor = '#fee2e2';
                        break;
                    case 'warning':
                        iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>';
                        bgColor = '#fef3c7';
                        break;
                    case 'info':
                        iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0284c7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>';
                        bgColor = '#e0f2fe';
                        break;
                }
                
                iconEl.innerHTML = iconSvg;
                notification.style.backgroundColor = bgColor;
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 4000);
            },
            
            // Conversiones de base64
            dataURLtoBlob: (dataURL) => {
                const arr = dataURL.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                
                return new Blob([u8arr], { type: mime });
            },
            
            // Cargar el fleetData
            loadFleetData: () => {
                return [
                    { interno: '1919', ppu: 'LXWP57', marca: 'Scania' }, { interno: '1931', ppu: 'LXWP58', marca: 'Scania' },
                    { interno: '1932', ppu: 'LXWP59', marca: 'Scania' }, { interno: '1885', ppu: 'LXWP60', marca: 'Scania' },
                    { interno: '1920', ppu: 'LXWP61', marca: 'Scania' }, { interno: '1921', ppu: 'LXWP62', marca: 'Scania' },
                    { interno: '1886', ppu: 'LXWP64', marca: 'Scania' }, { interno: '1693', ppu: 'LXWP66', marca: 'Scania' },
                    { interno: '1854', ppu: 'LXWP67', marca: 'Scania' }, { interno: '1855', ppu: 'LXWP68', marca: 'Scania' },
                    { interno: '1856', ppu: 'LXWP69', marca: 'Scania' }, { interno: '1857', ppu: 'LXWP70', marca: 'Scania' },
                    { interno: '1858', ppu: 'LXWP71', marca: 'Scania' }, { interno: '1859', ppu: 'LXWP72', marca: 'Scania' },
                    { interno: '1860', ppu: 'LXWP73', marca: 'Scania' }, { interno: '1861', ppu: 'LXWP74', marca: 'Scania' },
                    { interno: '1862', ppu: 'LXWP75', marca: 'Scania' }, { interno: '1694', ppu: 'LXWP76', marca: 'Scania' },
                    { interno: '1695', ppu: 'LXWP77', marca: 'Scania' }, { interno: '1863', ppu: 'LXWP78', marca: 'Scania' },
                    { interno: '1864', ppu: 'LXWP79', marca: 'Scania' }, { interno: '1865', ppu: 'LXWP80', marca: 'Scania' },
                    { interno: '1696', ppu: 'LXWP81', marca: 'Scania' }, { interno: '1866', ppu: 'LXWP82', marca: 'Scania' },
                    { interno: '1867', ppu: 'LXWP83', marca: 'Scania' }, { interno: '1697', ppu: 'LXWP85', marca: 'Scania' },
                    { interno: '1698', ppu: 'LXWP86', marca: 'Scania' }, { interno: '1888', ppu: 'LXWP87', marca: 'Scania' },
                    { interno: '1699', ppu: 'PFTV77', marca: 'Scania' }, { interno: '1889', ppu: 'PFTW19', marca: 'Scania' },
                    { interno: '1890', ppu: 'PFTW20', marca: 'Scania' }, { interno: '1700', ppu: 'PFTW25', marca: 'Scania' },
                    { interno: '1891', ppu: 'PFTW26', marca: 'Scania' }, { interno: '1868', ppu: 'PFTW28', marca: 'Scania' },
                    { interno: '1869', ppu: 'PFTW29', marca: 'Scania' }, { interno: '1870', ppu: 'PFTW30', marca: 'Scania' },
                    { interno: '1871', ppu: 'PFTW31', marca: 'Scania' }, { interno: '1701', ppu: 'PFTW32', marca: 'Scania' },
                    { interno: '1872', ppu: 'PFTW34', marca: 'Scania' }, { interno: '1892', ppu: 'PFTW35', marca: 'Scania' },
                    { interno: '1702', ppu: 'PFTW36', marca: 'Scania' }, { interno: '1873', ppu: 'PFTW38', marca: 'Scania' },
                    { interno: '1893', ppu: 'PFTW39', marca: 'Scania' }, { interno: '1703', ppu: 'PFTW40', marca: 'Scania' },
                    { interno: '1894', ppu: 'PFTW41', marca: 'Scania' }, { interno: '1895', ppu: 'PFTW42', marca: 'Scania' },
                    { interno: '1874', ppu: 'PFTW44', marca: 'Scania' }, { interno: '1875', ppu: 'PFTW45', marca: 'Scania' },
                    { interno: '1704', ppu: 'PFTW46', marca: 'Scania' }, { interno: '1876', ppu: 'PFTW47', marca: 'Scania' },
                    { interno: '1896', ppu: 'PFTW48', marca: 'Scania' }, { interno: '1877', ppu: 'PFTW49', marca: 'Scania' },
                    { interno: '1878', ppu: 'PFTW50', marca: 'Scania' }, { interno: '1897', ppu: 'PFTW51', marca: 'Scania' },
                    { interno: '1898', ppu: 'PFTW55', marca: 'Scania' }, { interno: '1879', ppu: 'PFTW56', marca: 'Scania' },
                    { interno: '1705', ppu: 'PFTW57', marca: 'Scania' }, { interno: '1880', ppu: 'PFTW58', marca: 'Scania' },
                    { interno: '1899', ppu: 'PFTW59', marca: 'Scania' }, { interno: '1706', ppu: 'PFTW60', marca: 'Scania' },
                    { interno: '1900', ppu: 'PFTW61', marca: 'Scania' }, { interno: '1901', ppu: 'PFTW62', marca: 'Scania' },
                    { interno: '1902', ppu: 'PFVG75', marca: 'Scania' }, { interno: '1903', ppu: 'PFVG76', marca: 'Scania' },
                    { interno: '1904', ppu: 'PFVG77', marca: 'Scania' }, { interno: '1707', ppu: 'PFVG78', marca: 'Scania' },
                    { interno: '1881', ppu: 'PFVG79', marca: 'Scania' }, { interno: '1708', ppu: 'PFVG80', marca: 'Scania' },
                    { interno: '1709', ppu: 'PFVG82', marca: 'Scania' }, { interno: '1710', ppu: 'PFVG83', marca: 'Scania' },
                    { interno: '1711', ppu: 'PFVG85', marca: 'Scania' }, { interno: '1712', ppu: 'PFVG86', marca: 'Scania' },
                    { interno: '1713', ppu: 'PFVG87', marca: 'Scania' }, { interno: '1714', ppu: 'PFVG88', marca: 'Scania' },
                    { interno: '1905', ppu: 'PFVG89', marca: 'Scania' }, { interno: '1906', ppu: 'PFVG90', marca: 'Scania' },
                    { interno: '1907', ppu: 'PFVG92', marca: 'Scania' }, { interno: '1909', ppu: 'PFVG94', marca: 'Scania' },
                    { interno: '1910', ppu: 'PFVG95', marca: 'Scania' }, { interno: '1911', ppu: 'PFVG96', marca: 'Scania' },
                    { interno: '1715', ppu: 'PFVG97', marca: 'Scania' }, { interno: '1716', ppu: 'PFVG98', marca: 'Scania' },
                    { interno: '1717', ppu: 'PFVG99', marca: 'Scania' }, { interno: '1882', ppu: 'PFVH10', marca: 'Scania' },
                    { interno: '1883', ppu: 'PFVH11', marca: 'Scania' }, { interno: '1718', ppu: 'PFVH12', marca: 'Scania' },
                    { interno: '1719', ppu: 'PFVH13', marca: 'Scania' }, { interno: '1884', ppu: 'PFVH14', marca: 'Scania' },
                    { interno: '1720', ppu: 'PFVH15', marca: 'Scania' }, { interno: '1721', ppu: 'PFYC13', marca: 'Scania' },
                    { interno: '1722', ppu: 'PFYC14', marca: 'Scania' }, { interno: '1723', ppu: 'PFYC16', marca: 'Scania' },
                    { interno: '1724', ppu: 'PFYC17', marca: 'Scania' }, { interno: '1725', ppu: 'PFYC19', marca: 'Scania' },
                    { interno: '1726', ppu: 'PFYC20', marca: 'Scania' }, { interno: '1727', ppu: 'PFYC25', marca: 'Scania' },
                    { interno: '1728', ppu: 'PFYC26', marca: 'Scania' }, { interno: '1729', ppu: 'PFYC27', marca: 'Scania' },
                    { interno: '1730', ppu: 'PFYC28', marca: 'Scania' }, { interno: '1731', ppu: 'PFYC29', marca: 'Scania' },
                    { interno: '1732', ppu: 'PFYC31', marca: 'Scania' }, { interno: '1733', ppu: 'PFYC32', marca: 'Scania' },
                    { interno: '1734', ppu: 'PFYC33', marca: 'Scania' }, { interno: '1735', ppu: 'PFYC34', marca: 'Scania' },
                    { interno: '1736', ppu: 'PFYC35', marca: 'Scania' }, { interno: '1737', ppu: 'PFYC36', marca: 'Scania' },
                    { interno: '1738', ppu: 'PFYC37', marca: 'Scania' }, { interno: '1739', ppu: 'PFYC43', marca: 'Scania' },
                    { interno: '1740', ppu: 'PFYC44', marca: 'Scania' }, { interno: '1741', ppu: 'PFYC46', marca: 'Scania' },
                    { interno: '1742', ppu: 'PFYC49', marca: 'Scania' }, { interno: '1743', ppu: 'PFYC50', marca: 'Scania' },
                    { interno: '1744', ppu: 'PFYC53', marca: 'Scania' }, { interno: '1745', ppu: 'PFYC55', marca: 'Scania' },
                    { interno: '1912', ppu: 'PFYC57', marca: 'Scania' }, { interno: '1746', ppu: 'PFYC58', marca: 'Scania' },
                    { interno: '1748', ppu: 'PFYC60', marca: 'Scania' }, { interno: '1749', ppu: 'PFYC61', marca: 'Scania' },
                    { interno: '1752', ppu: 'PFYC64', marca: 'Scania' }, { interno: '1753', ppu: 'PFYC65', marca: 'Scania' },
                    { interno: '1922', ppu: 'PFYC66', marca: 'Scania' }, { interno: '1754', ppu: 'PFYC68', marca: 'Scania' },
                    { interno: '1755', ppu: 'PFYC69', marca: 'Scania' }, { interno: '1756', ppu: 'PFYC70', marca: 'Scania' },
                    { interno: '1757', ppu: 'PFYC72', marca: 'Scania' }, { interno: '1923', ppu: 'PFYC75', marca: 'Scania' },
                    { interno: '1924', ppu: 'PFYC76', marca: 'Scania' }, { interno: '1913', ppu: 'PFYC77', marca: 'Scania' },
                    { interno: '1758', ppu: 'PFYC79', marca: 'Scania' }, { interno: '1933', ppu: 'PFYC80', marca: 'Scania' },
                    { interno: '1759', ppu: 'PFYC81', marca: 'Scania' }, { interno: '1761', ppu: 'PFYC85', marca: 'Scania' },
                    { interno: '1914', ppu: 'PFYC88', marca: 'Scania' }, { interno: '1915', ppu: 'PFYC90', marca: 'Scania' },
                    { interno: '1762', ppu: 'PFZK83', marca: 'Scania' }, { interno: '1927', ppu: 'PFZK91', marca: 'Scania' },
                    { interno: '1928', ppu: 'PGBF59', marca: 'Scania' }, { interno: '1916', ppu: 'PGBY67', marca: 'Scania' },
                    { interno: '1929', ppu: 'PGBY72', marca: 'Scania' }, { interno: '1930', ppu: 'PGBY73', marca: 'Scania' },
                    { interno: '1774', ppu: 'PGBY83', marca: 'Scania' }, { interno: '1781', ppu: 'PGKP67', marca: 'Scania' },
                    { interno: '1782', ppu: 'PGLD42', marca: 'Scania' }, { interno: '1917', ppu: 'PGLD67', marca: 'Scania' },
                    { interno: '1918', ppu: 'PGRZ67', marca: 'Scania' }, { interno: '1925', ppu: 'PGTT95', marca: 'Scania' },
                    { interno: '1926', ppu: 'PGTV12', marca: 'Scania' }, { interno: '1791', ppu: 'PGWT98', marca: 'Scania' },
                    { interno: '911', ppu: 'SHCV78', marca: 'Volvo' }, { interno: '916', ppu: 'SHCV83', marca: 'Volvo' },
                    { interno: '922', ppu: 'SHCX39', marca: 'Volvo' }, { interno: '936', ppu: 'SHCY22', marca: 'Volvo' },
                    { interno: '942', ppu: 'SHCY28', marca: 'Volvo' }, { interno: '1455', ppu: 'SHXD75', marca: 'Volvo' },
                    { interno: '1456', ppu: 'SHXD77', marca: 'Volvo' }, { interno: '1457', ppu: 'SHXD79', marca: 'Volvo' },
                    { interno: '1459', ppu: 'SHXD85', marca: 'Volvo' }, { interno: '1460', ppu: 'SHXF13', marca: 'Volvo' },
                    { interno: '1461', ppu: 'SHXF14', marca: 'Volvo' }, { interno: '1462', ppu: 'SHXF29', marca: 'Volvo' },
                    { interno: '1463', ppu: 'SHXF31', marca: 'Volvo' }, { interno: '1465', ppu: 'SHXF84', marca: 'Volvo' },
                    { interno: '1466', ppu: 'SHXF85', marca: 'Volvo' }, { interno: '1467', ppu: 'SHXF87', marca: 'Volvo' },
                    { interno: '1468', ppu: 'SHXF88', marca: 'Volvo' }, { interno: '1469', ppu: 'SHXF90', marca: 'Volvo' },
                    { interno: '1470', ppu: 'SHXF92', marca: 'Volvo' }, { interno: '1471', ppu: 'SHXF93', marca: 'Volvo' },
                    { interno: '1472', ppu: 'SHXF97', marca: 'Volvo' }, { interno: '1475', ppu: 'SHXG36', marca: 'Volvo' },
                    { interno: '1476', ppu: 'SHXG38', marca: 'Volvo' }, { interno: '1606', ppu: 'SJPB21', marca: 'Volvo' },
                    { interno: '1610', ppu: 'SJPB25', marca: 'Volvo' }, { interno: '1636', ppu: 'SJPC73', marca: 'Volvo' },
                    { interno: '1647', ppu: 'SJPD42', marca: 'Volvo' }, { interno: '1649', ppu: 'SJPD44', marca: 'Volvo' },
                    { interno: '1655', ppu: 'SJPD71', marca: 'Volvo' }, { interno: '1656', ppu: 'SJPD72', marca: 'Volvo' },
                    { interno: '1663', ppu: 'SJPD97', marca: 'Volvo' }, { interno: '1667', ppu: 'SJPF43', marca: 'Volvo' },
                    { interno: '1668', ppu: 'SJPF44', marca: 'Volvo' }, { interno: '1682', ppu: 'SKPH70', marca: 'Volvo' },
                    { interno: '1684', ppu: 'SKPH73', marca: 'Volvo' }, { interno: '1822', ppu: 'SKPJ90', marca: 'Volvo' },
                    { interno: '1823', ppu: 'SKPK18', marca: 'Volvo' }, { interno: '1824', ppu: 'SKPK19', marca: 'Volvo' },
                    { interno: '1825', ppu: 'SKPK20', marca: 'Volvo' }, { interno: '1826', ppu: 'SKPK21', marca: 'Volvo' },
                    { interno: '1827', ppu: 'SKPK22', marca: 'Volvo' }, { interno: '1828', ppu: 'SKPK23', marca: 'Volvo' },
                    { interno: '1829', ppu: 'SKPK25', marca: 'Volvo' }, { interno: '1830', ppu: 'SKPK26', marca: 'Volvo' },
                    { interno: '1831', ppu: 'SKPK27', marca: 'Volvo' }, { interno: '1832', ppu: 'SKPK28', marca: 'Volvo' },
                    { interno: '1834', ppu: 'SKPK31', marca: 'Volvo' }, { interno: '1835', ppu: 'SKPK32', marca: 'Volvo' },
                    { interno: '1837', ppu: 'SKPK34', marca: 'Volvo' }, { interno: '1838', ppu: 'SKPK35', marca: 'Volvo' },
                    { interno: '1839', ppu: 'SKPK37', marca: 'Volvo' }, { interno: '1840', ppu: 'SKPK39', marca: 'Volvo' },
                    { interno: '1841', ppu: 'SKPK40', marca: 'Volvo' }, { interno: '1843', ppu: 'SKPK42', marca: 'Volvo' },
                    { interno: '1844', ppu: 'SKPK44', marca: 'Volvo' }, { interno: '1845', ppu: 'SKPK45', marca: 'Volvo' },
                    { interno: '1846', ppu: 'SKPK62', marca: 'Volvo' }, { interno: '1847', ppu: 'SKPK63', marca: 'Volvo' },
                    { interno: '1848', ppu: 'SKPL28', marca: 'Volvo' }, { interno: '1849', ppu: 'SKPL30', marca: 'Volvo' },
                    { interno: '1850', ppu: 'SKPL33', marca: 'Volvo' }, { interno: '1851', ppu: 'SKPL34', marca: 'Volvo' },
                    { interno: '1852', ppu: 'SKPL36', marca: 'Volvo' },
                ];
            },
            
            // Gestión de datos offline
            saveOfflineData: (data) => {
                try {
                    localStorage.setItem(CONFIG.offlineStorageKey, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('Error saving offline data:', error);
                    return false;
                }
            },
            
            loadOfflineData: () => {
                try {
                    const data = localStorage.getItem(CONFIG.offlineStorageKey);
                    return data ? JSON.parse(data) : [];
                } catch (error) {
                    console.error('Error loading offline data:', error);
                    return [];
                }
            },
            
            // Guardar ubicación del usuario
            saveUserLocation: (location) => {
                try {
                    localStorage.setItem(CONFIG.userLocationKey, JSON.stringify(location));
                    return true;
                } catch (error) {
                    console.error('Error saving user location:', error);
                    return false;
                }
            },
            
            loadUserLocation: () => {
                try {
                    const location = localStorage.getItem(CONFIG.userLocationKey);
                    return location ? JSON.parse(location) : null;
                } catch (error) {
                    console.error('Error loading user location:', error);
                    return null;
                }
            }
        };
        
        // --- OPERACIONES DE DATOS ---
        const DataService = {
            // Inicializar Supabase
            initSupabase: () => {
                try {
                    APP.supabase = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
                    console.log('Supabase inicializado correctamente');
                    return true;
                } catch (error) {
                    console.error('Error al inicializar Supabase:', error);
                    return false;
                }
            },
            
            // Obtener inspecciones
            fetchInspections: async () => {
                if (!APP.state.isOnline) {
                    console.log('Offline: cargando datos locales');
                    const offlineData = Utils.loadOfflineData();
                    APP.state.inspections = offlineData.inspections || [];
                    APP.state.pendingSync = offlineData.pendingSync || [];
                    return APP.state.inspections;
                }
                
                try {
                    const { data, error } = await APP.supabase
                        .from('levantamiento_de_publicidad')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        throw error;
                    }
                    
                    APP.state.inspections = data;
                    APP.state.lastSyncTime = new Date();
                    
                    // Guardar también en almacenamiento local para acceso offline
                    Utils.saveOfflineData({
                        inspections: data,
                        pendingSync: APP.state.pendingSync,
                        lastSync: new Date()
                    });
                    
                    return data;
                } catch (error) {
                    console.error('Error fetching inspections:', error);
                    Utils.showNotification('Error de sincronización', 'No se pudieron cargar las inspecciones', 'error');
                    
                    // Cargar datos de respaldo desde almacenamiento local
                    const offlineData = Utils.loadOfflineData();
                    APP.state.inspections = offlineData.inspections || [];
                    APP.state.pendingSync = offlineData.pendingSync || [];
                    
                    return APP.state.inspections;
                }
            },
            
            // Guardar nueva inspección
            saveInspection: async (inspectionData) => {
                // Generar ID único para esta inspección
                inspectionData.client_id = Utils.generateId();
                inspectionData.created_at = new Date().toISOString();
                
                if (!APP.state.isOnline) {
                    console.log('Offline: guardando datos localmente para sincronización posterior');
                    
                    // Agregar a pendientes de sincronización
                    APP.state.pendingSync.push(inspectionData);
                    
                    // Agregar también a inspecciones locales
                    APP.state.inspections.unshift(inspectionData);
                    
                    // Guardar en almacenamiento local
                    Utils.saveOfflineData({
                        inspections: APP.state.inspections,
                        pendingSync: APP.state.pendingSync,
                        lastSync: APP.state.lastSyncTime
                    });
                    
                    Utils.showNotification('Guardado localmente', 'Los datos se sincronizarán cuando vuelva la conexión', 'info');
                    return { success: true, data: inspectionData, offline: true };
                }
                
                try {
                    const { data, error } = await APP.supabase
                        .from('levantamiento_de_publicidad')
                        .insert([inspectionData]);
                    
                    if (error) {
                        throw error;
                    }
                    
                    // Actualizar datos locales
                    APP.state.inspections.unshift(inspectionData);
                    
                    // Guardar en almacenamiento local para acceso offline
                    Utils.saveOfflineData({
                        inspections: APP.state.inspections,
                        pendingSync: APP.state.pendingSync,
                        lastSync: new Date()
                    });
                    
                    return { success: true, data: inspectionData };
                } catch (error) {
                    console.error('Error saving inspection:', error);
                    
                    // En caso de error, guardar para sincronización posterior
                    APP.state.pendingSync.push(inspectionData);
                    APP.state.inspections.unshift(inspectionData);
                    
                    Utils.saveOfflineData({
                        inspections: APP.state.inspections,
                        pendingSync: APP.state.pendingSync,
                        lastSync: APP.state.lastSyncTime
                    });
                    
                    Utils.showNotification('Error al guardar', 'Los datos se sincronizarán más tarde', 'warning');
                    return { success: false, error: error.message, data: inspectionData, offline: true };
                }
            },
            
            // Sincronizar datos pendientes
            syncPendingData: async () => {
                if (!APP.state.isOnline || APP.state.pendingSync.length === 0) {
                    return { success: true, synced: 0 };
                }
                
                try {
                    let syncedCount = 0;
                    const pendingCopy = [...APP.state.pendingSync];
                    
                    for (const item of pendingCopy) {
                        const { error } = await APP.supabase
                            .from('levantamiento_de_publicidad')
                            .insert([item]);
                        
                        if (!error) {
                            // Quitar de pendientes si se sincronizó correctamente
                            APP.state.pendingSync = APP.state.pendingSync.filter(
                                i => i.client_id !== item.client_id
                            );
                            syncedCount++;
                        }
                    }
                    
                    // Actualizar almacenamiento local
                    Utils.saveOfflineData({
                        inspections: APP.state.inspections,
                        pendingSync: APP.state.pendingSync,
                        lastSync: new Date()
                    });
                    
                    APP.state.lastSyncTime = new Date();
                    
                    if (syncedCount > 0) {
                        Utils.showNotification(
                            'Sincronización completada',
                            `Se sincronizaron ${syncedCount} registro(s) pendiente(s)`,
                            'success'
                        );
                    }
                    
                    return { success: true, synced: syncedCount };
                } catch (error) {
                    console.error('Error syncing pending data:', error);
                    return { success: false, error: error.message };
                }
            },
            
            // Procesar datos de flota con inspecciones
            processFleetData: (inspections) => {
                const inspectionMap = new Map();
                
                // Construir un mapa de la última inspección por PPU
                for (const insp of inspections) {
                    if (!inspectionMap.has(insp.ppu)) {
                        inspectionMap.set(insp.ppu, insp);
                    }
                }
                
                // Combinar con datos de flota
                APP.state.processedFleet = APP.fleetData.map(bus => ({
                    ...bus,
                    last_inspection: inspectionMap.get(bus.ppu) || null
                }));
                
                return APP.state.processedFleet;
            },
            
            // Guardar imagen de daños en Supabase Storage
            uploadDamageImage: async (busId, imageData) => {
                if (!APP.state.isOnline) {
                    console.log('Offline: la imagen se guardará cuando vuelva la conexión');
                    return { success: false, offline: true };
                }
                
                try {
                    const blob = Utils.dataURLtoBlob(imageData);
                    const fileName = `damage_${busId}_${Date.now()}.jpg`;
                    
                    const { data, error } = await APP.supabase.storage
                        .from('damage-images')
                        .upload(fileName, blob);
                    
                    if (error) {
                        throw error;
                    }
                    
                    const { data: urlData } = APP.supabase.storage
                        .from('damage-images')
                        .getPublicUrl(fileName);
                    
                    return { success: true, url: urlData.publicUrl };
                } catch (error) {
                    console.error('Error uploading image:', error);
                    return { success: false, error: error.message };
                }
            }
        };
        
        // --- VISTAS ---
        // Dashboard
        APP.templates.dashboard = () => `
            <div class="content-section p-6 lg:p-8 space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold font-heading text-gray-900">Dashboard</h1>
                        <p class="text-gray-500">Resumen de actividad de inspección de publicidad</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="refresh-data" class="btn btn-primary btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                            Actualizar Datos
                        </button>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-5">
                    ${TERMINALS.map((terminal, i) => `
                        <div class="stat-card card p-6 bg-white">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">${terminal.name}</p>
                                    <h3 class="mt-2 text-3xl font-bold text-gray-900" id="terminal-count-${i}">--</h3>
                                    <p class="text-xs text-gray-400 mt-1">Revisiones</p>
                                </div>
                                <div class="h-12 w-12 bg-primary-50 rounded-lg flex items-center justify-center text-primary-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Main Dashboard Content -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Map & Activity -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Map -->
                        <div class="card p-5">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-bold text-gray-800">Mapa de Actividad</h2>
                                <span class="text-xs text-gray-500" id="map-last-update">Actualizado: --</span>
                            </div>
                            <div class="map-container bg-gray-100 h-[450px]">
                                <div id="activity-map" class="h-full w-full"></div>
                            </div>
                            <div class="flex justify-between items-center mt-4">
                                <p class="text-sm text-gray-500" id="map-info">Cargando datos...</p>
                                <div class="flex gap-2">
                                    <button id="center-all" class="btn btn-sm btn-outline">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/></svg>
                                        Ver Todo
                                    </button>
                                    <button id="center-map" class="btn btn-sm btn-outline">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
                                        Mi Ubicación
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="card p-5">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-bold text-gray-800">Actividad Reciente</h2>
                                <a href="#" class="text-sm text-primary-600 hover:text-primary-700" id="view-all-activity">Ver todo</a>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>PPU</th>
                                            <th>Interno</th>
                                            <th>Terminal</th>
                                            <th>Estado</th>
                                            <th>Fecha</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-activity-table">
                                        <tr>
                                            <td colspan="5" class="text-center py-4 text-gray-500">Cargando actividad reciente...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats & Charts -->
                    <div class="space-y-6">
                        <!-- Status Summary -->
                        <div class="card p-5">
                            <h2 class="text-lg font-bold text-gray-800 mb-4">Resumen de Estado</h2>
                            <div class="space-y-5">
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium text-gray-500">Buses Revisados</span>
                                        <span class="text-sm font-medium text-gray-700" id="reviewed-percent">--%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-primary-600 h-2.5 rounded-full" id="reviewed-progress" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium text-gray-500">Con Publicidad</span>
                                        <span class="text-sm font-medium text-gray-700" id="ads-percent">--%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-blue-500 h-2.5 rounded-full" id="ads-progress" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium text-gray-500">Con Daños</span>
                                        <span class="text-sm font-medium text-gray-700" id="damage-percent">--%</span>
                                     </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-red-500 h-2.5 rounded-full" id="damage-progress" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium text-gray-500">Con Residuos</span>
                                        <span class="text-sm font-medium text-gray-700" id="residue-percent">--%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-yellow-500 h-2.5 rounded-full" id="residue-progress" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 pt-4 border-t border-gray-100">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-500">Total Inspecciones</span>
                                    <span class="text-xl font-bold text-gray-900" id="total-inspections">--</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts -->
                        <div class="card p-5">
                            <h2 class="text-lg font-bold text-gray-800 mb-4">Inspecciones por Día</h2>
                            <div class="h-64">
                                <canvas id="inspections-chart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Distribution Chart -->
                        <div class="card p-5">
                            <h2 class="text-lg font-bold text-gray-800 mb-4">Distribución por Terminal</h2>
                            <div class="h-64">
                                <canvas id="terminal-chart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Pending Tasks -->
                        <div class="card p-5">
                            <h2 class="text-lg font-bold text-gray-800 mb-4">Pendientes</h2>
                            <div class="space-y-3" id="pending-tasks">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="h-8 w-8 bg-warning-100 text-warning-700 rounded-lg flex items-center justify-center mr-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-700">Buses pendientes de revisión</p>
                                            <p class="text-xs text-gray-500">Registros por hacer</p>
                                        </div>
                                    </div>
                                    <span class="badge badge-yellow" id="pending-count">--</span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="h-8 w-8 bg-danger-100 text-danger-700 rounded-lg flex items-center justify-center mr-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" x2="2" y1="8" y2="22"/><line x1="17.5" x2="9" y1="15" y2="6.5"/></svg>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-700">Buses con daños</p>
                                            <p class="text-xs text-gray-500">Requieren reparación</p>
                                        </div>
                                    </div>
                                    <span class="badge badge-red" id="damage-count">--</span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="h-8 w-8 bg-warning-100 text-warning-700 rounded-lg flex items-center justify-center mr-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-700">Buses con residuos</p>
                                            <p class="text-xs text-gray-500">Requieren limpieza</p>
                                        </div>
                                    </div>
                                    <span class="badge badge-yellow" id="residue-count">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Form
        APP.templates.form = () => `
            <div class="content-section p-6 lg:p-8 space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold font-heading text-gray-900">Nuevo Registro</h1>
                        <p class="text-gray-500">Registra la inspección de publicidad para un bus</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="show-pending-btn" class="btn btn-warning">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            Buses Pendientes (<span id="pending-count-form">0</span>)
                        </button>
                    </div>
                </div>
                
                <!-- Form Card -->
                <div class="max-w-4xl mx-auto card p-6 md:p-8">
                    <form id="inspection-form" class="space-y-8">
                        <!-- Bus Selection Section -->
                        <div class="space-y-4">
                            <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">Identificación del Bus</h2>
                            
                            <div>
                                <label class="form-label" for="bus-selector">PPU / N° Interno</label>
                                <div class="combobox">
                                    <input type="text" id="bus-selector" class="combobox-input" placeholder="Ingrese PPU o número interno...">
                                    <span class="combobox-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                    </span>
                                    <div id="bus-options" class="combobox-options">
                                        <div class="p-2">
                                            <input type="text" id="bus-search" class="form-control text-sm" placeholder="Buscar...">
                                        </div>
                                        <div id="bus-list" class="max-h-48 overflow-y-auto"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="selected-bus-details" class="hidden p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-800" id="selected-bus-ppu">--</h3>
                                        <p class="text-sm text-gray-600" id="selected-bus-info">--</p>
                                    </div>
                                    <div>
                                        <span class="badge badge-gray" id="selected-bus-status">No seleccionado</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advertising Section -->
                        <div class="space-y-4">
                            <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">Estado de Publicidad</h2>
                            
                            <!-- Publicidad Izquierda -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="space-y-2">
                                    <label class="form-label">Publicidad Izquierda</label>
                                    <div class="flex items-center gap-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="publicidad_izquierda" value="no" checked class="h-4 w-4 text-primary-600">
                                            <span class="ml-2 text-sm text-gray-700">No</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="publicidad_izquierda" value="si" class="h-4 w-4 text-primary-600">
                                            <span class="ml-2 text-sm text-gray-700">Sí</span>
                                        </label>
                                    </div>
                                    <div class="hidden" id="publicidad_izquierda_detail_container">
                                        <input type="text" name="publicidad_izquierda_detalle" class="form-control mt-2" placeholder="Detalles de la publicidad">
                                    </div>
                                </div>
                                
                                <!-- Publicidad Luneta -->
                                <div class="space-y-2">
                                    <label class="form-label">Publicidad Luneta</label>
                                    <div class="flex items-center gap-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="publicidad_luneta" value="no" checked class="h-4 w-4 text-primary-600">
                                            <span class="ml-2 text-sm text-gray-700">No</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="publicidad_luneta" value="si" class="h-4 w-4 text-primary-600">
                                            <span class="ml-2 text-sm text-gray-700">Sí</span>
                                        </label>
                                    </div>
                                    <div class="hidden" id="publicidad_luneta_detail_container">
                                        <input type="text" name="publicidad_luneta_detalle" class="form-control mt-2" placeholder="Detalles de la publicidad">
                                    </div>
                                </div>
                                
                                <!-- Publicidad DTPM -->
                                <div class="space-y-2">
                                    <label class="form-label">Publicidad DTPM</label>
                                    <div class="flex items-center gap-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="publicidad_derecha" value="no" checked class="h-4 w-4 text-primary-600">
                                            <span class="ml-2 text-sm text-gray-700">No</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="publicidad_derecha" value="si" class="h-4 w-4 text-primary-600">
                                            <span class="ml-2 text-sm text-gray-700">Sí</span>
                                        </label>
                                    </div>
                                    <div class="hidden" id="publicidad_derecha_detail_container">
                                        <input type="text" name="publicidad_derecha_detalle" class="form-control mt-2" placeholder="Detalles de la publicidad">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Observations Section -->
                        <div class="space-y-4">
                            <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">Observaciones</h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Residuos de Pegamento -->
                                <div class="space-y-2">
                                    <label class="form-label">Residuos de Pegamento</label>
                                    <div class="flex items-center gap-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="residuos_pegamento" value="no" checked class="h-4 w-4 text-primary-600">
                                            <span class="ml-2 text-sm text-gray-700">No</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="residuos_pegamento" value="si" class="h-4 w-4 text-primary-600">
                                            <span class="ml-2 text-sm text-gray-700">Sí</span>
                                        </label>
                                    </div>
                                    <div class="hidden" id="residuos_pegamento_detail_container">
                                        <input type="text" name="residuos_pegamento_detalle" class="form-control mt-2" placeholder="¿En qué parte?">
                                    </div>
                                </div>
                                
                                <!-- Daño de Pintura -->
                                <div class="space-y-2">
                                    <label class="form-label">Daño de Pintura</label>
                                    <div class="flex items-center gap-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="dano_pintura" value="no" checked class="h-4 w-4 text-primary-600">
                                            <span class="ml-2 text-sm text-gray-700">No</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="dano_pintura" value="si" class="h-4 w-4 text-primary-600">
                                            <span class="ml-2 text-sm text-gray-700">Sí</span>
                                        </label>
                                    </div>
                                    <div class="hidden" id="dano_pintura_detail_container">
                                        <input type="text" name="dano_pintura_detalle" class="form-control mt-2" placeholder="¿En qué lado?">
                                        
                                        <div class="mt-4 space-y-2">
                                            <label class="form-label text-sm">Fotografía del daño (opcional)</label>
                                            <div id="damage-photo-container" class="file-upload">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                                                <p class="text-sm text-gray-500">Haga clic para subir una foto o arrastre una imagen aquí</p>
                                                <input type="file" id="damage-photo-input" class="hidden" accept="image/*">
                                            </div>
                                            <div id="damage-preview" class="hidden mt-2">
                                                <div class="relative">
                                                    <img id="damage-preview-img" class="w-full h-auto rounded-lg object-cover max-h-40" src="">
                                                    <button type="button" id="remove-damage-photo" class="absolute top-2 right-2 bg-red-100 text-red-600 rounded-full p-1 hover:bg-red-200">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Feedback and Submit -->
                        <div>
                            <div id="form-feedback" class="mb-4"></div>
                            <div class="flex flex-col sm:flex-row gap-3 justify-end">
                                <button type="button" id="reset-form" class="btn btn-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                                    Limpiar
                                </button>
                                <button type="submit" id="submit-form" class="btn btn-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                                    Guardar Registro
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Modal para buses pendientes -->
            <div id="pending-modal" class="modal-backdrop">
                <div class="modal-content p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Buses Pendientes de Revisión</h2>
                        <button id="close-pending-modal" class="text-gray-400 hover:text-gray-700 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                        </button>
                    </div>
                    <div id="pending-buses-container">
                        <div class="p-4 bg-blue-50 rounded-lg mb-4">
                            <p class="text-blue-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>
                                <span>Se encontraron <span id="pending-buses-count">0</span> buses pendientes de revisión</span>
                            </p>
                        </div>
                        <div id="pending-buses-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[50vh] overflow-y-auto p-1">
                            <!-- Los buses pendientes se agregarán aquí -->
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Reports
        APP.templates.reports = () => `
            <div class="content-section p-6 lg:p-8 space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold font-heading text-gray-900">Reportes y Estadísticas</h1>
                        <p class="text-gray-500">Análisis detallado de inspecciones y estado de la flota</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="export-excel-btn" class="btn btn-success">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 16H12"/><path d="M8 12H16"/></svg>
                            Exportar a Excel
                        </button>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">
                    <div class="stat-card card p-6 bg-white">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total Registros</p>
                                <h3 class="mt-2 text-3xl font-bold text-gray-900" id="report-total-registros">--</h3>
                                <p class="text-xs text-gray-400 mt-1">Total de inspecciones</p>
                            </div>
                            <div class="h-12 w-12 bg-primary-50 rounded-lg flex items-center justify-center text-primary-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card card p-6 bg-white">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Con Publicidad</p>
                                <h3 class="mt-2 text-3xl font-bold text-blue-600" id="report-con-publicidad">--</h3>
                                <p class="text-xs text-gray-400 mt-1">Buses con publicidad</p>
                            </div>
                            <div class="h-12 w-12 bg-blue-50 rounded-lg flex items-center justify-center text-blue-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 17V7l7 5-7 5z"/></svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card card p-6 bg-white">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Con Residuos</p>
                                <h3 class="mt-2 text-3xl font-bold text-yellow-600" id="report-con-residuos">--</h3>
                                <p class="text-xs text-gray-400 mt-1">Buses con residuos</p>
                            </div>
                            <div class="h-12 w-12 bg-yellow-50 rounded-lg flex items-center justify-center text-yellow-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card card p-6 bg-white">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Con Daños</p>
                                <h3 class="mt-2 text-3xl font-bold text-red-600" id="report-con-danos">--</h3>
                                <p class="text-xs text-gray-400 mt-1">Buses con daños</p>
                            </div>
                            <div class="h-12 w-12 bg-red-50 rounded-lg flex items-center justify-center text-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" x2="2" y1="8" y2="22"/><line x1="17.5" x2="9" y1="15" y2="6.5"/></svg>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Informes -->
                <div class="card p-6">
                    <div class="border-b border-gray-200 mb-6">
                        <div class="tabs" id="report-tabs">
                            <button class="tab active" data-tab="todos">Todos los Registros</button>
                            <button class="tab" data-tab="residuos">Buses con Residuos</button>
                            <button class="tab" data-tab="danos">Buses con Daño</button>
                            <button class="tab" data-tab="publicidad">Buses con Publicidad</button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="relative">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>
                            <input type="text" id="report-search" class="form-control pl-10" placeholder="Buscar por PPU, interno, terminal...">
                        </div>
                    </div>
                    
                    <div id="report-content" class="overflow-x-auto">
                        <div id="todos-report" class="report-panel">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>PPU</th>
                                        <th>N° Interno</th>
                                        <th>Marca</th>
                                        <th>Terminal</th>
                                        <th>Fecha</th>
                                        <th>Publicidad</th>
                                        <th>Luneta</th>
                                        <th>DTPM</th>
                                        <th>Residuos</th>
                                        <th>Daños</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="todos-report-body">
                                    <tr>
                                        <td colspan="11" class="text-center py-4 text-gray-500">Cargando datos...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="residuos-report" class="report-panel hidden">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>PPU</th>
                                        <th>N° Interno</th>
                                        <th>Detalle</th>
                                        <th>Terminal</th>
                                        <th>Fecha</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="residuos-report-body">
                                    <tr>
                                        <td colspan="6" class="text-center py-4 text-gray-500">Cargando datos...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="danos-report" class="report-panel hidden">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>PPU</th>
                                        <th>N° Interno</th>
                                        <th>Detalle</th>
                                        <th>Terminal</th>
                                        <th>Fecha</th>
                                        <th>Foto</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="danos-report-body">
                                    <tr>
                                        <td colspan="7" class="text-center py-4 text-gray-500">Cargando datos...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="publicidad-report" class="report-panel hidden">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>PPU</th>
                                        <th>N° Interno</th>
                                        <th>Tipo</th>
                                        <th>Detalle</th>
                                        <th>Terminal</th>
                                        <th>Fecha</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="publicidad-report-body">
                                    <tr>
                                        <td colspan="7" class="text-center py-4 text-gray-500">Cargando datos...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex justify-between items-center">
                        <p class="text-sm text-gray-500">Mostrando <span id="showing-records">0</span> de <span id="total-records">0</span> registros</p>
                        <div class="flex gap-2">
                            <button id="prev-page" class="btn btn-sm btn-outline" disabled>Anterior</button>
                            <button id="next-page" class="btn btn-sm btn-outline" disabled>Siguiente</button>
                        </div>
                    </div>
                </div>
                
                <!-- Trends and Analytics -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Tendencia de Inspecciones</h2>
                        <div class="h-64">
                            <canvas id="trends-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Distribución de Problemas</h2>
                        <div class="h-64">
                            <canvas id="issues-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Fleet
        APP.templates.fleet = () => `
            <div class="content-section p-6 lg:p-8 space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold font-heading text-gray-900">Flota de Buses</h1>
                        <p class="text-gray-500">Estado y gestión de toda la flota</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-1 text-sm text-gray-500">
                            <span class="inline-block w-3 h-3 bg-green-500 rounded-full"></span>
                            <span>Revisado</span>
                        </div>
                        <div class="flex items-center gap-1 text-sm text-gray-500 ml-4">
                            <span class="inline-block w-3 h-3 bg-gray-300 rounded-full"></span>
                            <span>Pendiente</span>
                        </div>
                    </div>
                </div>
                
                <!-- Filtros y Búsqueda -->
                <div class="card p-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <div class="relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>
                                <input type="text" id="fleet-search" class="form-control pl-10" placeholder="Buscar por PPU o N° Interno...">
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <select id="fleet-filter" class="form-control">
                                <option value="all">Todos los buses</option>
                                <option value="reviewed">Revisados</option>
                                <option value="pending">Pendientes</option>
                                <option value="damaged">Con daños</option>
                                <option value="residue">Con residuos</option>
                                <option value="ads">Con publicidad</option>
                            </select>
                            <select id="fleet-sort" class="form-control">
                                <option value="ppu">Ordenar por PPU</option>
                                <option value="interno">Ordenar por N° Interno</option>
                                <option value="marca">Ordenar por Marca</option>
                                <option value="status">Ordenar por Estado</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Grid de Buses -->
                <div class="card p-6">
                    <div id="fleet-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                        <!-- Buses se agregarán aquí -->
                        <div class="flex items-center justify-center col-span-full py-10 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin mr-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                            Cargando flota...
                        </div>
                    </div>
                    
                    <div id="fleet-empty" class="hidden text-center py-10">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4"><circle cx="12" cy="12" r="10"/><line x1="8" x2="16" y1="12" y2="12"/></svg>
                        <h3 class="text-lg font-medium text-gray-900">No se encontraron buses</h3>
                        <p class="text-gray-500 mt-1">Intente con otros filtros o términos de búsqueda</p>
                    </div>
                </div>
                
                <!-- Resumen de Flota -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Distribución por Marca</h2>
                        <div class="h-64">
                            <canvas id="brand-distribution-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Estado de Revisión</h2>
                        <div class="h-64">
                            <canvas id="review-status-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Assistance
        APP.templates.assistance = () => `
            <div class="content-section p-6 lg:p-8 space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold font-heading text-gray-900">Centro de Asistencia</h1>
                        <p class="text-gray-500">Buses que requieren intervención para limpieza o reparación</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="export-assistance-excel" class="btn btn-success btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 16H12"/><path d="M8 12H16"/></svg>
                            Exportar Lista
                        </button>
                    </div>
                </div>
                
                <!-- Resumen -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-6 bg-gradient-to-br from-red-50 to-white">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" x2="2" y1="8" y2="22"/><line x1="17.5" x2="9" y1="15" y2="6.5"/></svg>
                                    <h2 class="text-xl font-bold text-gray-900">Daños de Pintura</h2>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">Buses con daños que requieren reparación</p>
                            </div>
                            <div class="text-3xl font-bold text-red-600" id="damage-count-assistance">--</div>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                            <div class="p-3 bg-white rounded-lg shadow-sm">
                                <p class="text-sm text-gray-500">Frente</p>
                                <p class="text-xl font-bold text-gray-800" id="damage-front-count">--</p>
                            </div>
                            <div class="p-3 bg-white rounded-lg shadow-sm">
                                <p class="text-sm text-gray-500">Laterales</p>
                                <p class="text-xl font-bold text-gray-800" id="damage-side-count">--</p>
                            </div>
                            <div class="p-3 bg-white rounded-lg shadow-sm">
                                <p class="text-sm text-gray-500">Posterior</p>
                                <p class="text-xl font-bold text-gray-800" id="damage-back-count">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6 bg-gradient-to-br from-yellow-50 to-white">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                                    <h2 class="text-xl font-bold text-gray-900">Residuos de Pegamento</h2>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">Buses con residuos que requieren limpieza</p>
                            </div>
                            <div class="text-3xl font-bold text-yellow-600" id="residue-count-assistance">--</div>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                            <div class="p-3 bg-white rounded-lg shadow-sm">
                                <p class="text-sm text-gray-500">Izquierda</p>
                                <p class="text-xl font-bold text-gray-800" id="residue-left-count">--</p>
                            </div>
                            <div class="p-3 bg-white rounded-lg shadow-sm">
                                <p class="text-sm text-gray-500">Luneta</p>
                                <p class="text-xl font-bold text-gray-800" id="residue-back-count">--</p>
                            </div>
                            <div class="p-3 bg-white rounded-lg shadow-sm">
                                <p class="text-sm text-gray-500">Derecha</p>
                                <p class="text-xl font-bold text-gray-800" id="residue-right-count">--</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Listas de Asistencia -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Daños de Pintura -->
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold text-red-600 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" x2="2" y1="8" y2="22"/><line x1="17.5" x2="9" y1="15" y2="6.5"/></svg>
                                Daños de Pintura
                            </h2>
                            <div>
                                <input type="text" id="damage-search" class="form-control form-control-sm" placeholder="Buscar...">
                            </div>
                        </div>
                        <div id="assistance-danos" class="space-y-3 max-h-[600px] overflow-y-auto px-1">
                            <!-- Los buses con daños se agregarán aquí -->
                            <div class="flex items-center justify-center py-4 text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin mr-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                                Cargando datos...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Residuos de Pegamento -->
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold text-yellow-600 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                                Residuos de Pegamento
                            </h2>
                            <div>
                                <input type="text" id="residue-search" class="form-control form-control-sm" placeholder="Buscar...">
                            </div>
                        </div>
                        <div id="assistance-residuos" class="space-y-3 max-h-[600px] overflow-y-auto px-1">
                            <!-- Los buses con residuos se agregarán aquí -->
                            <div class="flex items-center justify-center py-4 text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin mr-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                                Cargando datos...
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline de mantenimiento -->
                <div class="card p-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">Histórico de Problemas</h2>
                    <div class="h-64">
                        <canvas id="issues-timeline-chart"></canvas>
                    </div>
                    <div class="mt-4 text-center">
                        <p class="text-sm text-gray-500">Histórico de buses con problemas (últimos 30 días)</p>
                    </div>
                </div>
            </div>
        `;
        
        // --- CONTROLADORES ---
        const Controllers = {
            // Dashboard Controller
            dashboardController: {
                init: async () => {
                    console.log('Inicializando dashboard...');
                    
                    // Actualizar contadores de terminales
                    TERMINALS.forEach((terminal, i) => {
                        const count = APP.state.inspections.filter(insp => insp.terminal === terminal.name).length;
                        const countEl = document.getElementById(`terminal-count-${i}`);
                        if (countEl) countEl.textContent = count;
                    });
                    
                    // Actualizar fecha de actualización
                    const lastUpdateEl = document.getElementById('map-last-update');
                    if (lastUpdateEl && APP.state.lastSyncTime) {
                        lastUpdateEl.textContent = `Actualizado: ${Utils.formatDate(APP.state.lastSyncTime)}`;
                    }
                    
                    // Inicializar mapa
                    Controllers.dashboardController.initMap();
                    
                    // Cargar actividad reciente
                    Controllers.dashboardController.loadRecentActivity();
                    
                    // Actualizar estadísticas
                    Controllers.dashboardController.updateStatistics();
                    
                    // Inicializar gráficos
                    Controllers.dashboardController.initCharts();
                    
                    // Event Listeners
                    document.getElementById('refresh-data').addEventListener('click', async () => {
                        Utils.showLoader(true);
                        await DataService.fetchInspections();
                        await Controllers.dashboardController.refreshData();
                        Utils.showLoader(false);
                        Utils.showNotification('Datos actualizados', 'La información ha sido actualizada correctamente', 'success');
                    });
                    
                    document.getElementById('center-map').addEventListener('click', () => {
                        if (APP.state.userLocation && APP.state.map) {
                            APP.state.map.setView([APP.state.userLocation.latitude, APP.state.userLocation.longitude], 13);
                            if (APP.state.userMarker) {
                                APP.state.userMarker.openPopup();
                            }
                            console.log('Mapa centrado en ubicación del usuario');
                        } else {
                            Utils.showNotification('Ubicación no disponible', 'No se pudo obtener su ubicación actual', 'warning');
                        }
                    });
                    
                    // Botón para centrar en todas las inspecciones
                    const centerAllBtn = document.getElementById('center-all');
                    if (centerAllBtn) {
                        centerAllBtn.addEventListener('click', () => {
                            Controllers.dashboardController.centerMapOnInspections();
                            Utils.showNotification('Mapa centrado', 'Vista ajustada a todas las inspecciones', 'info');
                        });
                    }
                    
                    document.getElementById('view-all-activity').addEventListener('click', (e) => {
                        e.preventDefault();
                        UI.setActiveView('reports');
                    });
                },
                
                refreshData: async () => {
                    // Actualizar contadores de terminales
                    TERMINALS.forEach((terminal, i) => {
                        const count = APP.state.inspections.filter(insp => insp.terminal === terminal.name).length;
                        const countEl = document.getElementById(`terminal-count-${i}`);
                        if (countEl) countEl.textContent = count;
                    });
                    
                    // Actualizar fecha de actualización
                    const lastUpdateEl = document.getElementById('map-last-update');
                    if (lastUpdateEl && APP.state.lastSyncTime) {
                        lastUpdateEl.textContent = `Actualizado: ${Utils.formatDate(APP.state.lastSyncTime)}`;
                    }
                    
                    // Actualizar mapa
                    if (APP.state.map) {
                        try {
                            // Limpiar marcadores existentes excepto el del usuario y la capa base
                            const layersToRemove = [];
                            APP.state.map.eachLayer((layer) => {
                                // Verificar que el layer existe y tiene las propiedades necesarias
                                if (layer && layer._leaflet_id && 
                                    layer !== APP.state.userMarker && 
                                    !layer._url && // No es la capa base de tiles
                                    layer._leaflet_id !== (APP.state.map._leafletLayer && APP.state.map._leafletLayer._leaflet_id)) {
                                    layersToRemove.push(layer);
                                }
                            });
                            
                            // Remover layers de forma segura
                            layersToRemove.forEach(layer => {
                                try {
                                    if (layer && layer._leaflet_id) {
                                        APP.state.map.removeLayer(layer);
                                    }
                                } catch (error) {
                                    console.warn('Error removiendo layer:', error);
                                }
                            });
                            
                            // Añadir marcadores de inspecciones
                            Controllers.dashboardController.addInspectionMarkers();
                            
                            // Centrar mapa en todas las inspecciones
                            Controllers.dashboardController.centerMapOnInspections();
                            
                            // Forzar renderizado del mapa
                            setTimeout(() => {
                                if (APP.state.map) {
                                    APP.state.map.invalidateSize();
                                    console.log('Mapa actualizado y renderizado correctamente');
                                }
                            }, 200);
                        } catch (error) {
                            console.error('Error actualizando mapa:', error);
                        }
                    }
                    
                    // Actualizar actividad reciente
                    Controllers.dashboardController.loadRecentActivity();
                    
                    // Actualizar estadísticas
                    Controllers.dashboardController.updateStatistics();
                    
                    // Actualizar gráficos
                    Controllers.dashboardController.updateCharts();
                },
                
                initMap: () => {
                    try {
                        const mapEl = document.getElementById('activity-map');
                        if (!mapEl) {
                            console.warn('Elemento del mapa no encontrado');
                            return;
                        }
                        
                        console.log('Inicializando mapa...');
                        
                        // Remover mapa anterior si existe
                        if (APP.state.map) {
                            try {
                                APP.state.map.remove();
                            } catch (error) {
                                console.warn('Error removiendo mapa anterior:', error);
                            }
                        }
                        
                        // Crear nuevo mapa con configuración mejorada
                        APP.state.map = L.map(mapEl, {
                            center: [-33.45, -70.66], // Santiago, Chile
                            zoom: 10,
                            zoomControl: true,
                            attributionControl: true,
                            dragging: true,
                            touchZoom: true,
                            scrollWheelZoom: true,
                            doubleClickZoom: true,
                            boxZoom: true,
                            keyboard: true,
                            tap: true
                        });
                        
                        // Configurar capa de tiles con mejor rendimiento
                        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                            maxZoom: 19,
                            minZoom: 3,
                            tileSize: 256,
                            zoomOffset: 0,
                            updateWhenIdle: true,
                            updateWhenZooming: false
                        }).addTo(APP.state.map);
                        
                        // Forzar renderizado del mapa
                        setTimeout(() => {
                            if (APP.state.map) {
                                APP.state.map.invalidateSize();
                                console.log('Mapa renderizado correctamente');
                            }
                        }, 100);
                        
                        // Añadir marcadores de terminales
                        TERMINALS.forEach(terminal => {
                            try {
                                const marker = L.marker([terminal.lat, terminal.lon], {
                                    icon: L.divIcon({
                                        html: `<div class="w-4 h-4 bg-primary-600 rounded-full border-2 border-white shadow-lg"></div>`,
                                        className: 'custom-div-icon',
                                        iconSize: [20, 20],
                                        iconAnchor: [10, 10]
                                    })
                                }).addTo(APP.state.map);
                                
                                marker.bindPopup(`<div class="p-2"><strong>${terminal.name}</strong><br>Terminal</div>`);
                            } catch (error) {
                                console.warn('Error añadiendo marcador de terminal:', error, terminal);
                            }
                        });
                        
                        // Añadir marcadores de inspecciones
                        Controllers.dashboardController.addInspectionMarkers();
                        
                        // Centrar mapa en todas las inspecciones si hay datos
                        Controllers.dashboardController.centerMapOnInspections();
                        
                        // Obtener ubicación del usuario
                        const savedLocation = Utils.loadUserLocation();
                        if (savedLocation) {
                            // Usar ubicación guardada mientras se obtiene la actual
                            APP.state.userLocation = savedLocation;
                            Controllers.dashboardController.addUserMarker(savedLocation.latitude, savedLocation.longitude);
                        }
                        
                        // Obtener ubicación actual del usuario
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(
                                position => {
                                    const { latitude, longitude } = position.coords;
                                    APP.state.userLocation = { latitude, longitude };
                                    Utils.saveUserLocation({ latitude, longitude });
                                    Controllers.dashboardController.addUserMarker(latitude, longitude);
                                    
                                    // Centrar mapa en la ubicación del usuario
                                    setTimeout(() => {
                                        if (APP.state.map) {
                                            APP.state.map.setView([latitude, longitude], 13);
                                            console.log('Mapa centrado en ubicación del usuario');
                                        }
                                    }, 500);
                                },
                                error => {
                                    console.log('Error obteniendo ubicación:', error.message);
                                    const mapInfoEl = document.getElementById('map-info');
                                    if (mapInfoEl) {
                                        mapInfoEl.textContent = 'No se pudo obtener su ubicación actual';
                                    }
                                },
                                {
                                    enableHighAccuracy: true,
                                    timeout: 10000,
                                    maximumAge: 60000
                                }
                            );
                        }
                        
                        console.log('Mapa inicializado correctamente');
                        
                    } catch (error) {
                        console.error('Error al inicializar el mapa:', error);
                        const mapEl = document.getElementById('activity-map');
                        if (mapEl) {
                            mapEl.innerHTML = `
                                <div class="flex items-center justify-center h-full bg-gray-100 rounded-lg">
                                    <div class="text-center">
                                        <p class="text-gray-500">Error al cargar el mapa</p>
                                        <p class="text-sm text-gray-400">${error.message}</p>
                                    </div>
                                </div>
                            `;
                        }
                    }
                },
                
                addUserMarker: (lat, lon) => {
                    if (!APP.state.map) return;
                    
                    try {
                        const blueIcon = L.divIcon({
                            html: `<div class="w-4 h-4 bg-blue-600 rounded-full border-2 border-white shadow-lg pulse-animation"></div>`,
                            className: 'custom-div-icon',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });
                        
                        // Remover marcador anterior de forma segura
                        if (APP.state.userMarker && APP.state.userMarker._leaflet_id) {
                            try {
                                APP.state.map.removeLayer(APP.state.userMarker);
                            } catch (error) {
                                console.warn('Error removiendo marcador de usuario anterior:', error);
                            }
                        }
                        
                        // Crear nuevo marcador
                        APP.state.userMarker = L.marker([lat, lon], { icon: blueIcon })
                            .addTo(APP.state.map)
                            .bindPopup('Tu ubicación actual');
                            
                        const mapInfoEl = document.getElementById('map-info');
                        if (mapInfoEl) {
                            mapInfoEl.textContent = 
                                `${APP.state.inspections.filter(i => i.lat && i.lon).length} inspecciones mostradas en el mapa`;
                        }
                    } catch (error) {
                        console.error('Error añadiendo marcador de usuario:', error);
                    }
                },
                
                addInspectionMarkers: () => {
                    if (!APP.state.map) return;
                    
                    try {
                        // Filtrar inspecciones con coordenadas válidas
                        const validInspections = APP.state.inspections.filter(
                            insp => insp.lat && insp.lon && !isNaN(insp.lat) && !isNaN(insp.lon)
                        );
                        
                        // Añadir marcadores al mapa
                        validInspections.forEach(insp => {
                            try {
                                const marker = L.marker([parseFloat(insp.lat), parseFloat(insp.lon)], {
                                    icon: L.divIcon({
                                        html: `<div class="w-3 h-3 bg-gray-800 rounded-full border border-white"></div>`,
                                        className: 'custom-div-icon',
                                        iconSize: [15, 15],
                                        iconAnchor: [7.5, 7.5]
                                    })
                                }).addTo(APP.state.map);
                                
                                // Crear popup con información detallada
                                const hasIssues = insp.residuos_pegamento || insp.dano_pintura;
                                const popupContent = `
                                    <div class="p-2">
                                        <div class="flex items-center justify-between mb-1">
                                            <h3 class="font-bold text-lg">${insp.ppu || 'N/A'}</h3>
                                            ${hasIssues ? `<span class="badge badge-${insp.dano_pintura ? 'red' : 'yellow'} text-xs">Requiere atención</span>` : ''}
                                        </div>
                                        <p class="text-sm text-gray-600">Interno: ${insp.numero_interno || 'N/A'}</p>
                                        <p class="text-sm text-gray-600">Terminal: ${insp.terminal || 'N/A'}</p>
                                        <p class="text-sm text-gray-500">${new Date(insp.created_at).toLocaleString()}</p>
                                        <hr class="my-2">
                                        <div class="grid grid-cols-2 gap-2 text-xs mt-2">
                                            <div>
                                                <p><strong>Publicidad:</strong> ${insp.publicidad_izquierda ? 'Sí' : 'No'}</p>
                                                <p><strong>Luneta:</strong> ${insp.publicidad_luneta ? 'Sí' : 'No'}</p>
                                                <p><strong>DTPM:</strong> ${insp.publicidad_derecha ? 'Sí' : 'No'}</p>
                                            </div>
                                            <div>
                                                <p><strong>Residuos:</strong> ${insp.residuos_pegamento ? `<span class="text-yellow-600 font-semibold">Sí</span>` : 'No'}</p>
                                                <p><strong>Daño:</strong> ${insp.dano_pintura ? `<span class="text-red-600 font-semibold">Sí</span>` : 'No'}</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                
                                marker.bindPopup(popupContent);
                            } catch (error) {
                                console.warn('Error añadiendo marcador de inspección:', error, insp);
                            }
                        });
                        
                        const mapInfoEl = document.getElementById('map-info');
                        if (mapInfoEl) {
                            mapInfoEl.textContent = `${validInspections.length} inspecciones mostradas en el mapa`;
                        }
                    } catch (error) {
                        console.error('Error añadiendo marcadores de inspecciones:', error);
                    }
                },
                
                centerMapOnInspections: () => {
                    if (!APP.state.map) return;
                    
                    try {
                        // Filtrar inspecciones con coordenadas válidas
                        const validInspections = APP.state.inspections.filter(
                            insp => insp.lat && insp.lon && !isNaN(insp.lat) && !isNaN(insp.lon)
                        );
                        
                        if (validInspections.length === 0) {
                            console.log('No hay inspecciones válidas para centrar el mapa');
                            return;
                        }
                        
                        // Crear bounds con todas las inspecciones
                        const bounds = L.latLngBounds();
                        validInspections.forEach(insp => {
                            bounds.extend([parseFloat(insp.lat), parseFloat(insp.lon)]);
                        });
                        
                        // Añadir terminales al bounds si existen
                        TERMINALS.forEach(terminal => {
                            bounds.extend([terminal.lat, terminal.lon]);
                        });
                        
                        // Añadir ubicación del usuario si está disponible
                        if (APP.state.userLocation) {
                            bounds.extend([APP.state.userLocation.latitude, APP.state.userLocation.longitude]);
                        }
                        
                        // Ajustar vista del mapa con padding
                        APP.state.map.fitBounds(bounds, {
                            padding: [20, 20],
                            maxZoom: 15,
                            animate: true
                        });
                        
                        console.log('Mapa centrado en todas las inspecciones');
                        
                    } catch (error) {
                        console.error('Error centrando mapa en inspecciones:', error);
                    }
                },
                
                loadRecentActivity: () => {
                    const tableBody = document.getElementById('recent-activity-table');
                    if (!tableBody) return;
                    
                    // Tomar las 5 inspecciones más recientes
                    const recentInspections = APP.state.inspections.slice(0, 5);
                    
                    if (recentInspections.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center py-4 text-gray-500">No hay actividad reciente</td>
                            </tr>
                        `;
                        return;
                    }
                    
                    let tableContent = '';
                    recentInspections.forEach(insp => {
                        const hasIssues = insp.residuos_pegamento || insp.dano_pintura;
                        let statusBadge = '';
                        
                        if (insp.dano_pintura) {
                            statusBadge = `<span class="badge badge-red">Daño</span>`;
                        } else if (insp.residuos_pegamento) {
                            statusBadge = `<span class="badge badge-yellow">Residuos</span>`;
                        } else if (insp.publicidad_izquierda || insp.publicidad_luneta || insp.publicidad_derecha) {
                            statusBadge = `<span class="badge badge-blue">Publicidad</span>`;
                        } else {
                            statusBadge = `<span class="badge badge-gray">Normal</span>`;
                        }
                        
                        tableContent += `
                            <tr class="hover:bg-gray-50 cursor-pointer" data-ppu="${insp.ppu}">
                                <td class="font-medium">${insp.ppu}</td>
                                <td>${insp.numero_interno}</td>
                                <td>${insp.terminal}</td>
                                <td>${statusBadge}</td>
                                <td>${Utils.formatDate(insp.created_at)}</td>
                            </tr>
                        `;
                    });
                    
                    tableBody.innerHTML = tableContent;
                    
                    // Añadir event listeners a las filas
                    tableBody.querySelectorAll('tr[data-ppu]').forEach(row => {
                        row.addEventListener('click', () => {
                            const ppu = row.dataset.ppu;
                            const inspection = APP.state.inspections.find(i => i.ppu === ppu);
                            if (inspection) {
                                Controllers.dashboardController.showBusDetails(inspection);
                            }
                        });
                    });
                },
                
                showBusDetails: (inspection) => {
                    const modalContent = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">${inspection.ppu}</h2>
                                <p class="text-gray-500">Interno: ${inspection.numero_interno} | Marca: ${inspection.marca_chasis || 'N/A'}</p>
                            </div>
                            <button id="close-modal-btn" class="text-gray-400 hover:text-gray-700 p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                            </button>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg mt-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Terminal</p>
                                    <p class="font-medium">${inspection.terminal}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Fecha</p>
                                    <p class="font-medium">${Utils.formatDate(inspection.created_at)}</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6">
                            <h3 class="font-semibold text-lg border-b pb-2 mb-3">Estado de Publicidad</h3>
                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div class="text-center p-3 ${inspection.publicidad_izquierda ? 'bg-blue-50 border border-blue-100 text-blue-800' : 'bg-gray-50 border border-gray-100 text-gray-500'} rounded-lg">
                                    <p class="font-medium mb-1">Publicidad</p>
                                    <p>${inspection.publicidad_izquierda ? 'Sí' : 'No'}</p>
                                    ${inspection.publicidad_izquierda && inspection.publicidad_izquierda_detalle ? `<p class="text-xs mt-1">${inspection.publicidad_izquierda_detalle}</p>` : ''}
                                </div>
                                <div class="text-center p-3 ${inspection.publicidad_luneta ? 'bg-blue-50 border border-blue-100 text-blue-800' : 'bg-gray-50 border border-gray-100 text-gray-500'} rounded-lg">
                                    <p class="font-medium mb-1">Luneta</p>
                                    <p>${inspection.publicidad_luneta ? 'Sí' : 'No'}</p>
                                    ${inspection.publicidad_luneta && inspection.publicidad_luneta_detalle ? `<p class="text-xs mt-1">${inspection.publicidad_luneta_detalle}</p>` : ''}
                                </div>
                                <div class="text-center p-3 ${inspection.publicidad_derecha ? 'bg-blue-50 border border-blue-100 text-blue-800' : 'bg-gray-50 border border-gray-100 text-gray-500'} rounded-lg">
                                    <p class="font-medium mb-1">DTPM</p>
                                    <p>${inspection.publicidad_derecha ? 'Sí' : 'No'}</p>
                                    ${inspection.publicidad_derecha && inspection.publicidad_derecha_detalle ? `<p class="text-xs mt-1">${inspection.publicidad_derecha_detalle}</p>` : ''}
                                </div>
                            </div>
                            
                            <h3 class="font-semibold text-lg border-b pb-2 mb-3">Observaciones</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 ${inspection.residuos_pegamento ? 'bg-yellow-50 border border-yellow-100 text-yellow-800' : 'bg-gray-50 border border-gray-100 text-gray-500'} rounded-lg">
                                    <p class="font-medium mb-1">Residuos de Pegamento</p>
                                    <p>${inspection.residuos_pegamento ? 'Sí' : 'No'}</p>
                                    ${inspection.residuos_pegamento && inspection.residuos_pegamento_detalle ? `<p class="text-sm mt-1">${inspection.residuos_pegamento_detalle}</p>` : ''}
                                </div>
                                <div class="p-3 ${inspection.dano_pintura ? 'bg-red-50 border border-red-100 text-red-800' : 'bg-gray-50 border border-gray-100 text-gray-500'} rounded-lg">
                                    <p class="font-medium mb-1">Daño de Pintura</p>
                                    <p>${inspection.dano_pintura ? 'Sí' : 'No'}</p>
                                    ${inspection.dano_pintura && inspection.dano_pintura_detalle ? `<p class="text-sm mt-1">${inspection.dano_pintura_detalle}</p>` : ''}
                                    ${inspection.damage_image ? `
                                        <div class="mt-2">
                                            <button id="view-damage-image" class="text-xs flex items-center justify-center gap-1 w-full p-1 bg-red-100 text-red-700 rounded">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
                                                Ver imagen
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 pt-4 border-t border-gray-100 flex justify-end">
                            <button id="new-inspection-btn" class="btn btn-primary btn-sm" data-ppu="${inspection.ppu}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                Nueva Inspección
                            </button>
                        </div>
                    `;
                    
                    Utils.showModal('bus-detail-modal', modalContent);
                    
                    // Event listeners
                    document.getElementById('close-modal-btn').addEventListener('click', () => {
                        Utils.hideModal('bus-detail-modal');
                    });
                    
                    document.getElementById('new-inspection-btn').addEventListener('click', (e) => {
                        const ppu = e.target.closest('button').dataset.ppu;
                        Utils.hideModal('bus-detail-modal');
                        UI.setActiveView('form');
                        // Buscar y seleccionar el bus en el formulario
                        setTimeout(() => {
                            const bus = APP.fleetData.find(b => b.ppu === ppu);
                            if (bus) {
                                APP.state.selectedBus = bus;
                                Controllers.formController.selectBus(bus);
                            }
                        }, 500);
                    });
                    
                    // Si hay imagen de daño, agregar event listener al botón
                    if (inspection.damage_image) {
                        document.getElementById('view-damage-image').addEventListener('click', () => {
                            Controllers.dashboardController.showDamageImage(inspection);
                        });
                    }
                },
                
                showDamageImage: (inspection) => {
                    const modalContent = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Imagen de Daño</h2>
                                <p class="text-gray-500">${inspection.ppu} - ${inspection.numero_interno}</p>
                            </div>
                            <button id="close-image-modal-btn" class="text-gray-400 hover:text-gray-700 p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                            </button>
                        </div>
                        <div class="mt-4">
                            <div class="image-preview">
                                <img src="${inspection.damage_image}" alt="Daño en ${inspection.ppu}">
                            </div>
                            <p class="text-sm text-gray-500 mt-2">
                                ${inspection.dano_pintura_detalle || 'No hay detalle del daño'}
                            </p>
                        </div>
                    `;
                    
                    Utils.showModal('damage-image-modal', modalContent);
                    
                    document.getElementById('close-image-modal-btn').addEventListener('click', () => {
                        Utils.hideModal('damage-image-modal');
                    });
                },
                
                updateStatistics: () => {
                    // Total de inspecciones
                    const totalInspections = APP.state.inspections.length;
                    document.getElementById('total-inspections').textContent = totalInspections;
                    
                    // Calcular porcentajes para las barras de progreso
                    const totalBuses = APP.fleetData.length;
                    const busesReviewed = new Set(APP.state.inspections.map(i => i.ppu)).size;
                    const reviewedPercent = totalBuses > 0 ? Math.round((busesReviewed / totalBuses) * 100) : 0;
                    
                    const withAds = APP.state.inspections.filter(i => 
                        i.publicidad_izquierda || i.publicidad_luneta || i.publicidad_derecha
                    ).length;
                    const adsPercent = totalInspections > 0 ? Math.round((withAds / totalInspections) * 100) : 0;
                    
                    const withDamage = APP.state.inspections.filter(i => i.dano_pintura).length;
                    const damagePercent = totalInspections > 0 ? Math.round((withDamage / totalInspections) * 100) : 0;
                    
                    const withResidue = APP.state.inspections.filter(i => i.residuos_pegamento).length;
                    const residuePercent = totalInspections > 0 ? Math.round((withResidue / totalInspections) * 100) : 0;
                    
                    // Actualizar contadores y barras de progreso
                    document.getElementById('reviewed-percent').textContent = `${reviewedPercent}%`;
                    document.getElementById('reviewed-progress').style.width = `${reviewedPercent}%`;
                    
                    document.getElementById('ads-percent').textContent = `${adsPercent}%`;
                    document.getElementById('ads-progress').style.width = `${adsPercent}%`;
                    
                    document.getElementById('damage-percent').textContent = `${damagePercent}%`;
                    document.getElementById('damage-progress').style.width = `${damagePercent}%`;
                    
                    document.getElementById('residue-percent').textContent = `${residuePercent}%`;
                    document.getElementById('residue-progress').style.width = `${residuePercent}%`;
                    
                    // Actualizar contadores de pendientes
                    const pendingBuses = totalBuses - busesReviewed;
                    document.getElementById('pending-count').textContent = pendingBuses;
                    document.getElementById('damage-count').textContent = withDamage;
                    document.getElementById('residue-count').textContent = withResidue;
                },
                
                initCharts: () => {
                    // Gráfico de inspecciones por día
                    const inspectionsChart = document.getElementById('inspections-chart');
                    if (inspectionsChart) {
                        // Agrupar inspecciones por día
                        const inspectionsByDay = {};
                        APP.state.inspections.forEach(insp => {
                            const date = new Date(insp.created_at).toLocaleDateString();
                            inspectionsByDay[date] = (inspectionsByDay[date] || 0) + 1;
                        });
                        
                        const dates = Object.keys(inspectionsByDay).slice(-7); // Últimos 7 días
                        const counts = dates.map(date => inspectionsByDay[date]);
                        
                        APP.state.charts.inspections = new Chart(inspectionsChart, {
                            type: 'bar',
                            data: {
                                labels: dates,
                                datasets: [{
                                    label: 'Inspecciones',
                                    data: counts,
                                    backgroundColor: '#0ea5e9',
                                    borderColor: '#0284c7',
                                    borderWidth: 1,
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            precision: 0
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Gráfico de distribución por terminal
                    const terminalChart = document.getElementById('terminal-chart');
                    if (terminalChart) {
                        const terminalCounts = {};
                        TERMINALS.forEach(terminal => {
                            terminalCounts[terminal.name] = APP.state.inspections.filter(
                                i => i.terminal === terminal.name
                            ).length;
                        });
                        
                        const terminals = Object.keys(terminalCounts);
                        const counts = terminals.map(term => terminalCounts[term]);
                        
                        APP.state.charts.terminals = new Chart(terminalChart, {
                            type: 'doughnut',
                            data: {
                                labels: terminals,
                                datasets: [{
                                    data: counts,
                                    backgroundColor: [
                                        '#0ea5e9',
                                        '#8b5cf6',
                                        '#22c55e',
                                        '#f59e0b'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }
                },
                
                updateCharts: () => {
                    // Actualizar gráfico de inspecciones por día
                    if (APP.state.charts.inspections) {
                        // Agrupar inspecciones por día
                        const inspectionsByDay = {};
                        APP.state.inspections.forEach(insp => {
                            const date = new Date(insp.created_at).toLocaleDateString();
                            inspectionsByDay[date] = (inspectionsByDay[date] || 0) + 1;
                        });
                        
                        const dates = Object.keys(inspectionsByDay).slice(-7); // Últimos 7 días
                        const counts = dates.map(date => inspectionsByDay[date]);
                        
                        APP.state.charts.inspections.data.labels = dates;
                        APP.state.charts.inspections.data.datasets[0].data = counts;
                        APP.state.charts.inspections.update();
                    }
                    
                    // Actualizar gráfico de distribución por terminal
                    if (APP.state.charts.terminals) {
                        const terminalCounts = {};
                        TERMINALS.forEach(terminal => {
                            terminalCounts[terminal.name] = APP.state.inspections.filter(
                                i => i.terminal === terminal.name
                            ).length;
                        });
                        
                        const terminals = Object.keys(terminalCounts);
                        const counts = terminals.map(term => terminalCounts[term]);
                        
                        APP.state.charts.terminals.data.labels = terminals;
                        APP.state.charts.terminals.data.datasets[0].data = counts;
                        APP.state.charts.terminals.update();
                    }
                }
            },
            
            // Form Controller
            formController: {
                init: () => {
                    console.log('Inicializando formulario...');
                    
                    // Inicializar el combobox
                    Controllers.formController.initCombobox();
                    
                    // Configurar toggles de campos de detalle
                    ['publicidad_izquierda', 'publicidad_luneta', 'publicidad_derecha', 'residuos_pegamento', 'dano_pintura'].forEach(field => {
                        const radioInputs = document.querySelectorAll(`input[name="${field}"]`);
                        radioInputs.forEach(input => {
                            input.addEventListener('change', () => {
                                const detailContainer = document.getElementById(`${field}_detail_container`);
                                if (detailContainer) {
                                    detailContainer.style.display = input.value === 'si' ? 'block' : 'none';
                                }
                            });
                        });
                    });
                    
                    // Actualizar contador de buses pendientes
                    Controllers.formController.updatePendingCount();
                    
                    // Configurar modal de buses pendientes
                    document.getElementById('show-pending-btn').addEventListener('click', 
                        Controllers.formController.showPendingBuses);
                    
                    document.getElementById('close-pending-modal').addEventListener('click', () => {
                        Utils.hideModal('pending-modal');
                    });
                    
                    // Configurar drag & drop para foto de daño
                    const damagePhotoContainer = document.getElementById('damage-photo-container');
                    const damagePhotoInput = document.getElementById('damage-photo-input');
                    const damagePreview = document.getElementById('damage-preview');
                    const damagePreviewImg = document.getElementById('damage-preview-img');
                    const removeDamagePhotoBtn = document.getElementById('remove-damage-photo');
                    
                    if (damagePhotoContainer && damagePhotoInput) {
                        damagePhotoContainer.addEventListener('click', () => {
                            damagePhotoInput.click();
                        });
                        
                        damagePhotoContainer.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            damagePhotoContainer.classList.add('dragging');
                        });
                        
                        damagePhotoContainer.addEventListener('dragleave', () => {
                            damagePhotoContainer.classList.remove('dragging');
                        });
                        
                        damagePhotoContainer.addEventListener('drop', (e) => {
                            e.preventDefault();
                            damagePhotoContainer.classList.remove('dragging');
                            
                            if (e.dataTransfer.files.length) {
                                Controllers.formController.handleDamagePhoto(e.dataTransfer.files[0]);
                            }
                        });
                        
                        damagePhotoInput.addEventListener('change', () => {
                            if (damagePhotoInput.files.length) {
                                Controllers.formController.handleDamagePhoto(damagePhotoInput.files[0]);
                            }
                        });
                        
                        if (removeDamagePhotoBtn) {
                            removeDamagePhotoBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                damagePhotoInput.value = '';
                                damagePreview.classList.add('hidden');
                                damagePhotoContainer.classList.remove('hidden');
                                APP.state.damagePhoto = null;
                            });
                        }
                    }
                    
                    // Configurar submit del formulario
                    const form = document.getElementById('inspection-form');
                    form.addEventListener('submit', Controllers.formController.handleSubmit);
                    
                    // Configurar reset del formulario
                    document.getElementById('reset-form').addEventListener('click', () => {
                        form.reset();
                        APP.state.selectedBus = null;
                        APP.state.damagePhoto = null;
                        document.getElementById('selected-bus-details').classList.add('hidden');
                        document.getElementById('damage-preview').classList.add('hidden');
                        document.getElementById('damage-photo-container').classList.remove('hidden');
                        
                        // Ocultar todos los campos de detalle
                        ['publicidad_izquierda', 'publicidad_luneta', 'publicidad_derecha', 'residuos_pegamento', 'dano_pintura'].forEach(field => {
                            const detailContainer = document.getElementById(`${field}_detail_container`);
                            if (detailContainer) {
                                detailContainer.style.display = 'none';
                            }
                        });
                        
                        document.getElementById('form-feedback').innerHTML = '';
                    });
                },
                
                initCombobox: () => {
                    const busSelector = document.getElementById('bus-selector');
                    const busOptions = document.getElementById('bus-options');
                    const busList = document.getElementById('bus-list');
                    const busSearch = document.getElementById('bus-search');
                    
                    if (!busSelector || !busOptions || !busList || !busSearch) return;
                    
                  // Toggle options visibility on click
                  busSelector.addEventListener('click', () => {
                        busOptions.classList.toggle('show');
                        busSearch.focus();
                    });
                    
                    // Hide options when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!busSelector.contains(e.target) && !busOptions.contains(e.target)) {
                            busOptions.classList.remove('show');
                        }
                    });
                    
                    // Filter buses on search input
                    busSearch.addEventListener('input', () => {
                        const searchTerm = busSearch.value.toLowerCase();
                        Controllers.formController.renderBusList(searchTerm);
                    });
                    
                    // Initial render of bus list
                    Controllers.formController.renderBusList('');
                },
                
                renderBusList: (searchTerm = '') => {
                    const busList = document.getElementById('bus-list');
                    if (!busList) return;
                    
                    // Filter buses by search term
                    const filteredBuses = APP.fleetData.filter(bus => 
                        bus.ppu.toLowerCase().includes(searchTerm) || 
                        bus.interno.toLowerCase().includes(searchTerm)
                    ).slice(0, 50); // Limit to 50 results for performance
                    
                    if (filteredBuses.length === 0) {
                        busList.innerHTML = `
                            <div class="py-4 px-3 text-center text-gray-500">
                                No se encontraron buses con esos términos
                            </div>
                        `;
                        return;
                    }
                    
                    // Generate HTML for each bus
                    busList.innerHTML = filteredBuses.map(bus => {
                        const isReviewed = APP.state.processedFleet.find(b => b.ppu === bus.ppu)?.last_inspection;
                        return `
                            <div class="combobox-option flex items-center justify-between" data-ppu="${bus.ppu}">
                                <div>
                                    <span class="font-medium">${bus.ppu}</span>
                                    <span class="text-gray-500 text-sm ml-2">${bus.interno}</span>
                                </div>
                                <span class="text-xs ${isReviewed ? 'text-green-600' : 'text-gray-400'}">
                                    ${isReviewed ? 'Revisado' : 'Pendiente'}
                                </span>
                            </div>
                        `;
                    }).join('');
                    
                    // Add click handlers to options
                    busList.querySelectorAll('.combobox-option').forEach(option => {
                        option.addEventListener('click', () => {
                            const ppu = option.dataset.ppu;
                            const bus = APP.fleetData.find(b => b.ppu === ppu);
                            if (bus) {
                                APP.state.selectedBus = bus;
                                Controllers.formController.selectBus(bus);
                                document.getElementById('bus-options').classList.remove('show');
                            }
                        });
                    });
                },
                
                selectBus: (bus) => {
                    if (!bus) return;
                    
                    // Update the input field
                    const busSelector = document.getElementById('bus-selector');
                    if (busSelector) {
                        busSelector.value = `${bus.ppu} - ${bus.interno}`;
                    }
                    
                    // Update the details display
                    const detailsContainer = document.getElementById('selected-bus-details');
                    const ppuElement = document.getElementById('selected-bus-ppu');
                    const infoElement = document.getElementById('selected-bus-info');
                    const statusElement = document.getElementById('selected-bus-status');
                    
                    if (detailsContainer && ppuElement && infoElement && statusElement) {
                        ppuElement.textContent = bus.ppu;
                        infoElement.textContent = `Interno: ${bus.interno} | Marca: ${bus.marca}`;
                        
                        const lastInspection = APP.state.processedFleet.find(b => b.ppu === bus.ppu)?.last_inspection;
                        if (lastInspection) {
                            const date = new Date(lastInspection.created_at);
                            statusElement.textContent = `Revisado: ${date.toLocaleDateString()}`;
                            statusElement.className = 'badge badge-green';
                        } else {
                            statusElement.textContent = 'Pendiente de revisión';
                            statusElement.className = 'badge badge-gray';
                        }
                        
                        detailsContainer.classList.remove('hidden');
                    }
                },
                
                updatePendingCount: () => {
                    const pendingBuses = APP.state.processedFleet.filter(bus => !bus.last_inspection);
                    const pendingCountEl = document.getElementById('pending-count-form');
                    if (pendingCountEl) {
                        pendingCountEl.textContent = pendingBuses.length;
                    }
                },
                
                showPendingBuses: () => {
                    const pendingBuses = APP.state.processedFleet.filter(bus => !bus.last_inspection);
                    const listContainer = document.getElementById('pending-buses-list');
                    const countElement = document.getElementById('pending-buses-count');
                    
                    if (countElement) {
                        countElement.textContent = pendingBuses.length;
                    }
                    
                    if (!listContainer) return;
                    
                    if (pendingBuses.length === 0) {
                        listContainer.innerHTML = `
                            <div class="text-center py-8">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                <p class="text-gray-800 text-lg font-medium mt-2">¡Excelente! Todos los buses han sido revisados</p>
                                <p class="text-gray-500 mt-1">No hay buses pendientes de revisión</p>
                            </div>
                        `;
                    } else {
                        listContainer.innerHTML = pendingBuses.map(bus => `
                            <div class="border p-4 rounded-lg bg-white hover:shadow-md transition-all cursor-pointer" data-ppu="${bus.ppu}">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="font-bold text-lg text-gray-800">${bus.ppu}</h3>
                                        <p class="text-sm text-gray-600">Interno: ${bus.interno}</p>
                                        <p class="text-xs text-gray-400">${bus.marca}</p>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <span class="badge badge-yellow">Pendiente</span>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        
                        // Add click handlers to select pending buses
                        listContainer.querySelectorAll('[data-ppu]').forEach(item => {
                            item.addEventListener('click', () => {
                                const ppu = item.dataset.ppu;
                                const bus = APP.fleetData.find(b => b.ppu === ppu);
                                if (bus) {
                                    APP.state.selectedBus = bus;
                                    Controllers.formController.selectBus(bus);
                                    Utils.hideModal('pending-modal');
                                }
                            });
                        });
                    }
                    
                    Utils.showModal('pending-modal', null);
                },
                
                handleDamagePhoto: (file) => {
                    if (!file || !file.type.startsWith('image/')) {
                        Utils.showNotification('Tipo de archivo no válido', 'Por favor, seleccione una imagen', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const damagePreview = document.getElementById('damage-preview');
                        const damagePreviewImg = document.getElementById('damage-preview-img');
                        const damagePhotoContainer = document.getElementById('damage-photo-container');
                        
                        if (damagePreview && damagePreviewImg) {
                            damagePreviewImg.src = e.target.result;
                            damagePreview.classList.remove('hidden');
                            damagePhotoContainer.classList.add('hidden');
                            
                            // Store the image data for submission
                            APP.state.damagePhoto = e.target.result;
                        }
                    };
                    
                    reader.readAsDataURL(file);
                },
                
                handleSubmit: async (e) => {
                    e.preventDefault();
                    
                    const form = e.target;
                    const feedbackEl = document.getElementById('form-feedback');
                    const submitBtn = document.getElementById('submit-form');
                    
                    if (!APP.state.selectedBus) {
                        feedbackEl.innerHTML = `
                            <div class="p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                                    <span>Por favor, seleccione un bus para continuar</span>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Disable submit button and show loading state
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin mr-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                        Guardando...
                    `;
                    
                    try {
                        // Get user location
                        const getPosition = () => {
                            return new Promise((resolve, reject) => {
                                if (APP.state.userLocation) {
                                    // Use cached location if available
                                    resolve(APP.state.userLocation);
                                } else {
                                    navigator.geolocation.getCurrentPosition(
                                        position => {
                                            const { latitude, longitude } = position.coords;
                                            APP.state.userLocation = { latitude, longitude };
                                            Utils.saveUserLocation({ latitude, longitude });
                                            resolve({ latitude, longitude });
                                        },
                                        error => {
                                            console.log('Error obteniendo ubicación:', error.message);
                                            // Use default location or reject
                                            reject(error);
                                        }
                                    );
                                }
                            });
                        };
                        
                        let coordinates;
                        try {
                            coordinates = await getPosition();
                        } catch (locError) {
                            // Use an approximate location from terminal
                            coordinates = { latitude: TERMINALS[0].lat, longitude: TERMINALS[0].lon };
                            feedbackEl.innerHTML = `
                                <div class="p-3 mb-4 bg-yellow-50 border border-yellow-200 text-yellow-700 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                                        <span>No se pudo obtener su ubicación exacta. Se usará la ubicación del terminal.</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Find nearest terminal
                        const nearestTerminal = Utils.getNearestTerminal(
                            coordinates.latitude, 
                            coordinates.longitude
                        );
                        
                        // Collect form data
                        const formData = new FormData(form);
                        const submissionData = {
                            numero_interno: APP.state.selectedBus.interno,
                            ppu: APP.state.selectedBus.ppu,
                            marca_chasis: APP.state.selectedBus.marca,
                            lat: coordinates.latitude,
                            lon: coordinates.longitude,
                            terminal: nearestTerminal.name,
                        };
                        
                        // Process checkbox fields
                        ['izquierda', 'luneta', 'derecha'].forEach(side => {
                            const key = `publicidad_${side}`;
                            submissionData[key] = formData.get(key) === 'si';
                            submissionData[`${key}_detalle`] = submissionData[key] ? formData.get(`${key}_detalle`) : null;
                        });
                        
                        ['residuos_pegamento', 'dano_pintura'].forEach(obs => {
                            submissionData[obs] = formData.get(obs) === 'si';
                            submissionData[`${obs}_detalle`] = submissionData[obs] ? formData.get(`${obs}_detalle`) : null;
                        });
                        
                        // Handle damage photo if present
                        if (APP.state.damagePhoto && submissionData.dano_pintura) {
                            try {
                                const imageUploadResult = await DataService.uploadDamageImage(
                                    submissionData.ppu, 
                                    APP.state.damagePhoto
                                );
                                
                                if (imageUploadResult.success) {
                                    submissionData.damage_image = imageUploadResult.url;
                                }
                            } catch (imageError) {
                                console.error('Error uploading damage image:', imageError);
                                // Continue without image if upload fails
                            }
                        }
                        
                        // Save the inspection
                        const result = await DataService.saveInspection(submissionData);
                        
                        if (result.success) {
                            feedbackEl.innerHTML = `
                                <div class="p-3 bg-green-50 border border-green-200 text-green-700 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                        <span>Registro guardado correctamente${result.offline ? ' (modo sin conexión)' : ''}</span>
                                    </div>
                                </div>
                            `;
                            
                            // Reset form
                            form.reset();
                            APP.state.selectedBus = null;
                            APP.state.damagePhoto = null;
                            document.getElementById('selected-bus-details').classList.add('hidden');
                            document.getElementById('damage-preview').classList.add('hidden');
                            document.getElementById('damage-photo-container').classList.remove('hidden');
                            
                            // Hide all detail fields
                            ['publicidad_izquierda', 'publicidad_luneta', 'publicidad_derecha', 'residuos_pegamento', 'dano_pintura'].forEach(field => {
                                const detailContainer = document.getElementById(`${field}_detail_container`);
                                if (detailContainer) {
                                    detailContainer.style.display = 'none';
                                }
                            });
                            
                            // Update data
                            DataService.processFleetData(APP.state.inspections);
                            Controllers.formController.updatePendingCount();
                            
                            // Scroll to feedback
                            feedbackEl.scrollIntoView({ behavior: 'smooth' });
                            
                            // Show success notification
                            Utils.showNotification('Registro guardado', 'La inspección se ha guardado correctamente', 'success');
                        } else {
                            throw new Error(result.error || 'Error desconocido al guardar');
                        }
                        
                    } catch (error) {
                        console.error('Error submitting form:', error);
                        feedbackEl.innerHTML = `
                            <div class="p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>
                                    <span>Error al guardar el registro: ${error.message}</span>
                                </div>
                            </div>
                        `;
                        
                        Utils.showNotification('Error al guardar', 'No se pudo guardar la inspección', 'error');
                    } finally {
                        // Re-enable submit button
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                            Guardar Registro
                        `;
                    }
                }
            },
            
            // Reports Controller
            reportsController: {
                init: () => {
                    console.log('Inicializando reportes...');
                    
                    // Update statistics
                    Controllers.reportsController.updateStatistics();
                    
                    // Load report data
                    Controllers.reportsController.loadReportData();
                    
                    // Init charts
                    Controllers.reportsController.initCharts();
                    
                    // Setup tab switching
                    document.querySelectorAll('#report-tabs .tab').forEach(tab => {
                        tab.addEventListener('click', () => {
                            // Update active tab
                            document.querySelectorAll('#report-tabs .tab').forEach(t => t.classList.remove('active'));
                            tab.classList.add('active');
                            
                            // Show corresponding panel
                            document.querySelectorAll('.report-panel').forEach(panel => panel.classList.add('hidden'));
                            document.getElementById(`${tab.dataset.tab}-report`).classList.remove('hidden');
                        });
                    });
                    
                    // Setup search functionality
                    const searchInput = document.getElementById('report-search');
                    if (searchInput) {
                        searchInput.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.toLowerCase();
                            Controllers.reportsController.filterReports(searchTerm);
                        });
                    }
                    
                    // Setup Excel export
                    document.getElementById('export-excel-btn').addEventListener('click', 
                        Controllers.reportsController.exportToExcel);
                },
                
                updateStatistics: () => {
                    // Calculate statistics
                    const totalRegistros = APP.state.inspections.length;
                    const conPublicidad = APP.state.inspections.filter(i => 
                        i.publicidad_izquierda || i.publicidad_luneta || i.publicidad_derecha
                    ).length;
                    const conResiduos = APP.state.inspections.filter(i => i.residuos_pegamento).length;
                    const conDanos = APP.state.inspections.filter(i => i.dano_pintura).length;
                    
                    // Update UI
                    document.getElementById('report-total-registros').textContent = totalRegistros;
                    document.getElementById('report-con-publicidad').textContent = conPublicidad;
                    document.getElementById('report-con-residuos').textContent = conResiduos;
                    document.getElementById('report-con-danos').textContent = conDanos;
                },
                
                loadReportData: () => {
                    // Generate table content for each report type
                    Controllers.reportsController.renderAllReport(APP.state.inspections);
                    Controllers.reportsController.renderResiduesReport(
                        APP.state.inspections.filter(i => i.residuos_pegamento)
                    );
                    Controllers.reportsController.renderDamageReport(
                        APP.state.inspections.filter(i => i.dano_pintura)
                    );
                    Controllers.reportsController.renderAdsReport(
                        APP.state.inspections.filter(i => 
                            i.publicidad_izquierda || i.publicidad_luneta || i.publicidad_derecha
                        )
                    );
                    
                    // Update record count display
                    document.getElementById('showing-records').textContent = APP.state.inspections.length;
                    document.getElementById('total-records').textContent = APP.state.inspections.length;
                },
                
                renderAllReport: (data) => {
                    const tableBody = document.getElementById('todos-report-body');
                    if (!tableBody) return;
                    
                    if (data.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="11" class="text-center py-4 text-gray-500">No hay datos disponibles</td>
                            </tr>
                        `;
                        return;
                    }
                    
                    tableBody.innerHTML = data.map(item => {
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="font-medium">${item.ppu}</td>
                                <td>${item.numero_interno}</td>
                                <td>${item.marca_chasis || 'N/A'}</td>
                                <td>${item.terminal}</td>
                                <td>${Utils.formatDate(item.created_at)}</td>
                                <td>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${item.publicidad_izquierda ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                                        ${item.publicidad_izquierda ? 'Sí' : 'No'}
                                    </span>
                                </td>
                                <td>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${item.publicidad_luneta ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                                        ${item.publicidad_luneta ? 'Sí' : 'No'}
                                    </span>
                                </td>
                                <td>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${item.publicidad_derecha ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                                        ${item.publicidad_derecha ? 'Sí' : 'No'}
                                    </span>
                                </td>
                                <td>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${item.residuos_pegamento ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                                        ${item.residuos_pegamento ? 'Sí' : 'No'}
                                    </span>
                                </td>
                                <td>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${item.dano_pintura ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                                        ${item.dano_pintura ? 'Sí' : 'No'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-xs btn-outline view-details" data-ppu="${item.ppu}" data-index="${data.indexOf(item)}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    // Add event listeners to view details buttons
                    tableBody.querySelectorAll('.view-details').forEach(button => {
                        button.addEventListener('click', () => {
                            const index = parseInt(button.dataset.index);
                            const inspection = data[index];
                            if (inspection) {
                                Controllers.dashboardController.showBusDetails(inspection);
                            }
                        });
                    });
                },
                
                renderResiduesReport: (data) => {
                    const tableBody = document.getElementById('residuos-report-body');
                    if (!tableBody) return;
                    
                    if (data.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center py-4 text-gray-500">No hay buses con residuos de pegamento</td>
                            </tr>
                        `;
                        return;
                    }
                    
                    tableBody.innerHTML = data.map(item => {
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="font-medium">${item.ppu}</td>
                                <td>${item.numero_interno}</td>
                                <td>${item.residuos_pegamento_detalle || 'Sin detalles'}</td>
                                <td>${item.terminal}</td>
                                <td>${Utils.formatDate(item.created_at)}</td>
                                <td>
                                    <button class="btn btn-xs btn-outline view-details" data-ppu="${item.ppu}" data-index="${data.indexOf(item)}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    // Add event listeners to view details buttons
                    tableBody.querySelectorAll('.view-details').forEach(button => {
                        button.addEventListener('click', () => {
                            const index = parseInt(button.dataset.index);
                            const inspection = data[index];
                            if (inspection) {
                                Controllers.dashboardController.showBusDetails(inspection);
                            }
                        });
                    });
                },
                
                renderDamageReport: (data) => {
                    const tableBody = document.getElementById('danos-report-body');
                    if (!tableBody) return;
                    
                    if (data.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center py-4 text-gray-500">No hay buses con daños de pintura</td>
                            </tr>
                        `;
                        return;
                    }
                    
                    tableBody.innerHTML = data.map(item => {
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="font-medium">${item.ppu}</td>
                                <td>${item.numero_interno}</td>
                                <td>${item.dano_pintura_detalle || 'Sin detalles'}</td>
                                <td>${item.terminal}</td>
                                <td>${Utils.formatDate(item.created_at)}</td>
                                <td>
                                    ${item.damage_image ? `
                                        <button class="btn btn-xs btn-outline view-image" data-image="${item.damage_image}" data-ppu="${item.ppu}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                                        </button>
                                    ` : 'N/A'}
                                </td>
                                <td>
                                    <button class="btn btn-xs btn-outline view-details" data-ppu="${item.ppu}" data-index="${data.indexOf(item)}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    // Add event listeners to view details buttons
                    tableBody.querySelectorAll('.view-details').forEach(button => {
                        button.addEventListener('click', () => {
                            const index = parseInt(button.dataset.index);
                            const inspection = data[index];
                            if (inspection) {
                                Controllers.dashboardController.showBusDetails(inspection);
                            }
                        });
                    });
                    
                    // Add event listeners to view image buttons
                    tableBody.querySelectorAll('.view-image').forEach(button => {
                        button.addEventListener('click', () => {
                            const imageUrl = button.dataset.image;
                            const ppu = button.dataset.ppu;
                            if (imageUrl) {
                                const modalContent = `
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h2 class="text-xl font-bold text-gray-800">Imagen de Daño</h2>
                                            <p class="text-gray-500">${ppu}</p>
                                        </div>
                                        <button id="close-image-modal-btn" class="text-gray-400 hover:text-gray-700 p-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                                        </button>
                                    </div>
                                    <div class="mt-4">
                                        <div class="image-preview">
                                            <img src="${imageUrl}" alt="Daño en ${ppu}">
                                        </div>
                                    </div>
                                `;
                                
                                Utils.showModal('damage-image-modal', modalContent);
                                
                                document.getElementById('close-image-modal-btn').addEventListener('click', () => {
                                    Utils.hideModal('damage-image-modal');
                                });
                            }
                        });
                    });
                },
                
                renderAdsReport: (data) => {
                    const tableBody = document.getElementById('publicidad-report-body');
                    if (!tableBody) return;
                    
                    if (data.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center py-4 text-gray-500">No hay buses con publicidad</td>
                            </tr>
                        `;
                        return;
                    }
                    
                    // Flatten the data to have one row per ad type
                    const flattenedData = [];
                    data.forEach(item => {
                        if (item.publicidad_izquierda) {
                            flattenedData.push({
                                ...item,
                                tipo: 'Izquierda',
                                detalle: item.publicidad_izquierda_detalle
                            });
                        }
                        if (item.publicidad_luneta) {
                            flattenedData.push({
                                ...item,
                                tipo: 'Luneta',
                                detalle: item.publicidad_luneta_detalle
                            });
                        }
                        if (item.publicidad_derecha) {
                            flattenedData.push({
                                ...item,
                                tipo: 'DTPM',
                                detalle: item.publicidad_derecha_detalle
                            });
                        }
                    });
                    
                    tableBody.innerHTML = flattenedData.map(item => {
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="font-medium">${item.ppu}</td>
                                <td>${item.numero_interno}</td>
                                <td>
                                    <span class="badge badge-blue">${item.tipo}</span>
                                </td>
                                <td>${item.detalle || 'Sin detalles'}</td>
                                <td>${item.terminal}</td>
                                <td>${Utils.formatDate(item.created_at)}</td>
                                <td>
                                    <button class="btn btn-xs btn-outline view-details" data-ppu="${item.ppu}" data-index="${data.indexOf(item)}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    // Add event listeners to view details buttons
                    tableBody.querySelectorAll('.view-details').forEach(button => {
                        button.addEventListener('click', () => {
                            const ppu = button.dataset.ppu;
                            const inspection = data.find(i => i.ppu === ppu);
                            if (inspection) {
                                Controllers.dashboardController.showBusDetails(inspection);
                            }
                        });
                    });
                },
                
                filterReports: (searchTerm) => {
                    // Apply filter to all report types
                    const filteredInspections = APP.state.inspections.filter(insp => 
                        insp.ppu.toLowerCase().includes(searchTerm) || 
                        insp.numero_interno.toLowerCase().includes(searchTerm) || 
                        (insp.terminal && insp.terminal.toLowerCase().includes(searchTerm)) ||
                        (insp.marca_chasis && insp.marca_chasis.toLowerCase().includes(searchTerm))
                    );
                    
                    // Re-render all tables with filtered data
                    Controllers.reportsController.renderAllReport(filteredInspections);
                    
                    Controllers.reportsController.renderResiduesReport(
                        filteredInspections.filter(i => i.residuos_pegamento)
                    );
                    
                    Controllers.reportsController.renderDamageReport(
                        filteredInspections.filter(i => i.dano_pintura)
                    );
                    
                    Controllers.reportsController.renderAdsReport(
                        filteredInspections.filter(i => 
                            i.publicidad_izquierda || i.publicidad_luneta || i.publicidad_derecha
                        )
                    );
                    
                    // Update record counts
                    document.getElementById('showing-records').textContent = filteredInspections.length;
                    document.getElementById('total-records').textContent = APP.state.inspections.length;
                },
                
                initCharts: () => {
                    // Initialize trends chart
                    const trendsChartEl = document.getElementById('trends-chart');
                    if (trendsChartEl) {
                        // Group inspections by day
                        const inspectionsByDay = {};
                        APP.state.inspections.forEach(insp => {
                            const date = new Date(insp.created_at).toLocaleDateString();
                            inspectionsByDay[date] = (inspectionsByDay[date] || 0) + 1;
                        });
                        
                        // Get the last 14 days
                        const today = new Date();
                        const dates = [];
                        const counts = [];
                        
                        for (let i = 13; i >= 0; i--) {
                            const date = new Date(today);
                            date.setDate(today.getDate() - i);
                            const dateString = date.toLocaleDateString();
                            dates.push(dateString);
                            counts.push(inspectionsByDay[dateString] || 0);
                        }
                        
                        APP.state.charts.trends = new Chart(trendsChartEl, {
                            type: 'line',
                            data: {
                                labels: dates,
                                datasets: [{
                                    label: 'Inspecciones',
                                    data: counts,
                                    borderColor: '#0ea5e9',
                                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4,
                                    pointBackgroundColor: '#0ea5e9',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 1,
                                    pointRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            precision: 0
                                        }
                                    },
                                    x: {
                                        ticks: {
                                            maxRotation: 45,
                                            minRotation: 45
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Initialize issues chart
                    const issuesChartEl = document.getElementById('issues-chart');
                    if (issuesChartEl) {
                        const withAds = APP.state.inspections.filter(i => 
                            i.publicidad_izquierda || i.publicidad_luneta || i.publicidad_derecha
                        ).length;
                        const withDamage = APP.state.inspections.filter(i => i.dano_pintura).length;
                        const withResidue = APP.state.inspections.filter(i => i.residuos_pegamento).length;
                        const withBoth = APP.state.inspections.filter(i => 
                            i.dano_pintura && i.residuos_pegamento
                        ).length;
                        const total = APP.state.inspections.length;
                        const normal = total - (withAds + withDamage + withResidue - withBoth);
                        
                        APP.state.charts.issues = new Chart(issuesChartEl, {
                            type: 'pie',
                            data: {
                                labels: ['Con Publicidad', 'Con Daños', 'Con Residuos', 'Normal'],
                                datasets: [{
                                    data: [withAds, withDamage, withResidue, normal],
                                    backgroundColor: [
                                        '#0ea5e9',
                                        '#ef4444',
                                        '#f59e0b',
                                        '#22c55e'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }
                },
                
                exportToExcel: () => {
                    // Prepare data for export
                    const dataToExport = APP.state.inspections.map(i => ({
                        'N° Interno': i.numero_interno,
                        'PPU': i.ppu,
                        'Marca': i.marca_chasis,
                        'Terminal': i.terminal,
                        'Fecha': new Date(i.created_at).toLocaleString(),
                        'Publicidad': i.publicidad_izquierda ? 'Sí' : 'No',
                        'Detalle Publicidad': i.publicidad_izquierda_detalle || '',
                        'Luneta': i.publicidad_luneta ? 'Sí' : 'No',
                        'Detalle Luneta': i.publicidad_luneta_detalle || '',
                        'Publicidad DTPM': i.publicidad_derecha ? 'Sí' : 'No',
                        'Detalle Publicidad DTPM': i.publicidad_derecha_detalle || '',
                        'Residuos': i.residuos_pegamento ? 'Sí' : 'No',
                        'Detalle Residuos': i.residuos_pegamento_detalle || '',
                        'Daño Pintura': i.dano_pintura ? 'Sí' : 'No',
                        'Detalle Daño': i.dano_pintura_detalle || '',
                        'Latitud': i.lat || '',
                        'Longitud': i.lon || '',
                        'Foto de Daño': i.damage_image || ''
                    }));
                    
                    // Create worksheet
                    const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Inspecciones');
                    
                    // Generate filename with current date
                    const date = new Date().toISOString().split('T')[0];
                    const filename = `PubliFleet_Reporte_${date}.xlsx`;
                    
                    // Export file
                    XLSX.writeFile(workbook, filename);
                    
                    // Show success notification
                    Utils.showNotification('Exportación completada', 'El reporte se ha exportado correctamente', 'success');
                }
            },
            
            // Fleet Controller
            fleetController: {
                init: () => {
                    console.log('Inicializando flota...');
                    
                    // Render fleet grid
                    Controllers.fleetController.renderFleetGrid();
                    
                    // Init fleet statistics
                    Controllers.fleetController.initFleetCharts();
                    
                    // Setup search functionality
                    const searchInput = document.getElementById('fleet-search');
                    if (searchInput) {
                        searchInput.addEventListener('input', () => {
                            Controllers.fleetController.filterFleet();
                        });
                    }
                    
                    // Setup filter and sort
                    const filterSelect = document.getElementById('fleet-filter');
                    const sortSelect = document.getElementById('fleet-sort');
                    
                    if (filterSelect) {
                        filterSelect.addEventListener('change', () => {
                            Controllers.fleetController.filterFleet();
                        });
                    }
                    
                    if (sortSelect) {
                        sortSelect.addEventListener('change', () => {
                            Controllers.fleetController.filterFleet();
                        });
                    }
                },
                
                renderFleetGrid: (data = null) => {
                    const grid = document.getElementById('fleet-grid');
                    const emptyMessage = document.getElementById('fleet-empty');
                    
                    if (!grid) return;
                    
                    // Use provided data or full fleet
                    const fleetData = data || APP.state.processedFleet;
                    
                    if (fleetData.length === 0) {
                        grid.innerHTML = '';
                        if (emptyMessage) emptyMessage.classList.remove('hidden');
                        return;
                    }
                    
                    if (emptyMessage) emptyMessage.classList.add('hidden');
                    
                    grid.innerHTML = fleetData.map(bus => {
                        const isReviewed = bus.last_inspection !== null;
                        const hasDamage = isReviewed && bus.last_inspection.dano_pintura;
                        const hasResidue = isReviewed && bus.last_inspection.residuos_pegamento;
                        const hasAds = isReviewed && (
                            bus.last_inspection.publicidad_izquierda || 
                            bus.last_inspection.publicidad_luneta || 
                            bus.last_inspection.publicidad_derecha
                        );
                        
                        let statusBadge = '';
                        if (hasDamage) {
                            statusBadge = '<span class="badge badge-red text-xs">Daño</span>';
                        } else if (hasResidue) {
                            statusBadge = '<span class="badge badge-yellow text-xs">Residuos</span>';
                        } else if (hasAds) {
                            statusBadge = '<span class="badge badge-blue text-xs">Publicidad</span>';
                        }
                        
                        return `
                            <div class="bus-card p-4 rounded-lg bg-white shadow-sm hover:shadow-md transition-all cursor-pointer" data-ppu="${bus.ppu}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-lg text-gray-800">${bus.ppu}</p>
                                        <p class="text-sm text-gray-600">${bus.interno}</p>
                                        <p class="text-xs text-gray-400 mt-2">${bus.marca}</p>
                                    </div>
                                    <div class="flex flex-col items-end gap-1">
                                        <span class="status-dot ${isReviewed ? 'reviewed' : 'pending'}"></span>
                                        ${statusBadge}
                                    </div>
                                </div>
                                ${isReviewed ? `
                                    <div class="mt-3 pt-3 border-t border-gray-100">
                                        <p class="text-xs text-gray-500">Última revisión: ${new Date(bus.last_inspection.created_at).toLocaleDateString()}</p>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    // Add click handlers to bus cards
                    grid.querySelectorAll('.bus-card').forEach(card => {
                        card.addEventListener('click', () => {
                            const ppu = card.dataset.ppu;
                            const bus = APP.state.processedFleet.find(b => b.ppu === ppu);
                            if (bus) {
                                Controllers.fleetController.showBusDetails(bus);
                            }
                        });
                    });
                },
                
                showBusDetails: (bus) => {
                    let modalContent = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">${bus.ppu}</h2>
                                <p class="text-gray-500">Interno: ${bus.interno} | Marca: ${bus.marca}</p>
                            </div>
                            <button id="close-modal-btn" class="text-gray-400 hover:text-gray-700 p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                            </button>
                        </div>
                    `;
                    
                    if (bus.last_inspection) {
                        const insp = bus.last_inspection;
                        modalContent += `
                            <div class="bg-gray-50 p-4 rounded-lg mt-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-500">Terminal</p>
                                        <p class="font-medium">${insp.terminal}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Última Revisión</p>
                                        <p class="font-medium">${Utils.formatDate(insp.created_at)}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <h3 class="font-semibold text-lg border-b pb-2 mb-3">Estado de Publicidad</h3>
                                <div class="grid grid-cols-3 gap-4 mb-6">
                                    <div class="text-center p-3 ${insp.publicidad_izquierda ? 'bg-blue-50 border border-blue-100 text-blue-800' : 'bg-gray-50 border border-gray-100 text-gray-500'} rounded-lg">
                                        <p class="font-medium mb-1">Publicidad</p>
                                        <p>${insp.publicidad_izquierda ? 'Sí' : 'No'}</p>
                                        ${insp.publicidad_izquierda && insp.publicidad_izquierda_detalle ? `<p class="text-xs mt-1">${insp.publicidad_izquierda_detalle}</p>` : ''}
                                    </div>
                                    <div class="text-center p-3 ${insp.publicidad_luneta ? 'bg-blue-50 border border-blue-100 text-blue-800' : 'bg-gray-50 border border-gray-100 text-gray-500'} rounded-lg">
                                        <p class="font-medium mb-1">Luneta</p>
                                        <p>${insp.publicidad_luneta ? 'Sí' : 'No'}</p>
                                        ${insp.publicidad_luneta && insp.publicidad_luneta_detalle ? `<p class="text-xs mt-1">${insp.publicidad_luneta_detalle}</p>` : ''}
                                    </div>
                                    <div class="text-center p-3 ${insp.publicidad_derecha ? 'bg-blue-50 border border-blue-100 text-blue-800' : 'bg-gray-50 border border-gray-100 text-gray-500'} rounded-lg">
                                        <p class="font-medium mb-1">DTPM</p>
                                        <p>${insp.publicidad_derecha ? 'Sí' : 'No'}</p>
                                        ${insp.publicidad_derecha && insp.publicidad_derecha_detalle ? `<p class="text-xs mt-1">${insp.publicidad_derecha_detalle}</p>` : ''}
                                    </div>
                                </div>
                                
                                <h3 class="font-semibold text-lg border-b pb-2 mb-3">Observaciones</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="p-3 ${insp.residuos_pegamento ? 'bg-yellow-50 border border-yellow-100 text-yellow-800' : 'bg-gray-50 border border-gray-100 text-gray-500'} rounded-lg">
                                        <p class="font-medium mb-1">Residuos de Pegamento</p>
                                        <p>${insp.residuos_pegamento ? 'Sí' : 'No'}</p>
                                        ${insp.residuos_pegamento && insp.residuos_pegamento_detalle ? `<p class="text-sm mt-1">${insp.residuos_pegamento_detalle}</p>` : ''}
                                    </div>
                                    <div class="p-3 ${insp.dano_pintura ? 'bg-red-50 border border-red-100 text-red-800' : 'bg-gray-50 border border-gray-100 text-gray-500'} rounded-lg">
                                        <p class="font-medium mb-1">Daño de Pintura</p>
                                        <p>${insp.dano_pintura ? 'Sí' : 'No'}</p>
                                        ${insp.dano_pintura && insp.dano_pintura_detalle ? `<p class="text-sm mt-1">${insp.dano_pintura_detalle}</p>` : ''}
                                        ${insp.damage_image ? `
                                            <div class="mt-2">
                                                <button id="view-damage-image" class="text-xs flex items-center justify-center gap-1 w-full p-1 bg-red-100 text-red-700 rounded">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
                                                    Ver imagen
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        modalContent += `
                            <div class="mt-4 py-8 text-center bg-gray-50 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                                <p class="text-lg font-medium text-gray-800">Sin inspecciones registradas</p>
                                <p class="text-gray-500 mt-1">Este bus no tiene revisiones registradas</p>
                            </div>
                        `;
                    }
                    
                    modalContent += `
                        <div class="mt-6 pt-4 border-t border-gray-100 flex justify-end">
                            <button id="new-inspection-btn" class="btn btn-primary btn-sm" data-ppu="${bus.ppu}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                Nueva Inspección
                            </button>
                        </div>
                    `;
                    
                    Utils.showModal('bus-detail-modal', modalContent);
                    
                    // Event listeners
                    document.getElementById('close-modal-btn').addEventListener('click', () => {
                        Utils.hideModal('bus-detail-modal');
                    });
                    
                    document.getElementById('new-inspection-btn').addEventListener('click', (e) => {
                        const ppu = e.target.closest('button').dataset.ppu;
                        Utils.hideModal('bus-detail-modal');
                        UI.setActiveView('form');
                        // Buscar y seleccionar el bus en el formulario
                        setTimeout(() => {
                            const busToSelect = APP.fleetData.find(b => b.ppu === ppu);
                            if (busToSelect) {
                                APP.state.selectedBus = busToSelect;
                                Controllers.formController.selectBus(busToSelect);
                            }
                        }, 500);
                    });
                    
                    // Si hay imagen de daño, agregar event listener al botón
                    if (bus.last_inspection && bus.last_inspection.damage_image) {
                        document.getElementById('view-damage-image').addEventListener('click', () => {
                            Controllers.dashboardController.showDamageImage(bus.last_inspection);
                        });
                    }
                },
                
                filterFleet: () => {
                    const searchInput = document.getElementById('fleet-search');
                    const filterSelect = document.getElementById('fleet-filter');
                    const sortSelect = document.getElementById('fleet-sort');
                    
                    if (!searchInput || !filterSelect || !sortSelect) return;
                    
                    const searchTerm = searchInput.value.toLowerCase();
                    const filterValue = filterSelect.value;
                    const sortValue = sortSelect.value;
                    
                    // Apply search filter
                    let filteredFleet = APP.state.processedFleet.filter(bus => 
                        bus.ppu.toLowerCase().includes(searchTerm) || 
                        bus.interno.toLowerCase().includes(searchTerm) ||
                        bus.marca.toLowerCase().includes(searchTerm)
                    );
                    
                    // Apply category filter
                    if (filterValue !== 'all') {
                        switch (filterValue) {
                            case 'reviewed':
                                filteredFleet = filteredFleet.filter(bus => bus.last_inspection !== null);
                                break;
                            case 'pending':
                                filteredFleet = filteredFleet.filter(bus => bus.last_inspection === null);
                                break;
                            case 'damaged':
                                filteredFleet = filteredFleet.filter(bus => 
                                    bus.last_inspection && bus.last_inspection.dano_pintura
                                );
                                break;
                            case 'residue':
                                filteredFleet = filteredFleet.filter(bus => 
                                    bus.last_inspection && bus.last_inspection.residuos_pegamento
                                );
                                break;
                            case 'ads':
                                filteredFleet = filteredFleet.filter(bus => 
                                    bus.last_inspection && (
                                        bus.last_inspection.publicidad_izquierda || 
                                        bus.last_inspection.publicidad_luneta || 
                                        bus.last_inspection.publicidad_derecha
                                    )
                                );
                                break;
                        }
                    }
                    
                    // Apply sorting
                    switch (sortValue) {
                        case 'ppu':
                            filteredFleet.sort((a, b) => a.ppu.localeCompare(b.ppu));
                            break;
                        case 'interno':
                            filteredFleet.sort((a, b) => a.interno.localeCompare(b.interno));
                            break;
                        case 'marca':
                            filteredFleet.sort((a, b) => a.marca.localeCompare(b.marca));
                            break;
                        case 'status':
                            filteredFleet.sort((a, b) => {
                                // First by inspection status
                                const aHasInsp = a.last_inspection !== null ? 1 : 0;
                                const bHasInsp = b.last_inspection !== null ? 1 : 0;
                                
                                if (aHasInsp !== bHasInsp) {
                                    return bHasInsp - aHasInsp; // Reviewed first
                                }
                                
                                // Then by date if both have inspections
                                if (aHasInsp && bHasInsp) {
                                    return new Date(b.last_inspection.created_at) - new Date(a.last_inspection.created_at);
                                }
                                
                                return 0;
                            });
                            break;
                    }
                    
                    // Render filtered fleet
                    Controllers.fleetController.renderFleetGrid(filteredFleet);
                },
                
                initFleetCharts: () => {
                    // Brand distribution chart
                    const brandChartEl = document.getElementById('brand-distribution-chart');
                    if (brandChartEl) {
                        // Count buses by brand
                        const brandCounts = {};
                        APP.fleetData.forEach(bus => {
                            brandCounts[bus.marca] = (brandCounts[bus.marca] || 0) + 1;
                        });
                        
                        const brands = Object.keys(brandCounts);
                        const counts = brands.map(brand => brandCounts[brand]);
                        
                        APP.state.charts.brands = new Chart(brandChartEl, {
                            type: 'doughnut',
                            data: {
                                labels: brands,
                                datasets: [{
                                    data: counts,
                                    backgroundColor: [
                                        '#0ea5e9',
                                        '#8b5cf6',
                                        '#22c55e',
                                        '#f59e0b',
                                        '#ef4444'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }
                    
                    // Review status chart
                    const statusChartEl = document.getElementById('review-status-chart');
                    if (statusChartEl) {
                        const reviewed = APP.state.processedFleet.filter(bus => bus.last_inspection !== null).length;
                        const pending = APP.state.processedFleet.length - reviewed;
                        
                        APP.state.charts.status = new Chart(statusChartEl, {
                            type: 'pie',
                            data: {
                                labels: ['Revisados', 'Pendientes'],
                                datasets: [{
                                    data: [reviewed, pending],
                                    backgroundColor: [
                                        '#22c55e',
                                        '#9ca3af'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }
                }
            },
            
            // Assistance Controller
            assistanceController: {
                init: () => {
                    console.log('Inicializando asistencia...');
                    
                    // Load buses with damage
                    Controllers.assistanceController.loadDamageBuses();
                    
                    // Load buses with residue
                    Controllers.assistanceController.loadResidueBuses();
                    
                    // Update summary counts
                    Controllers.assistanceController.updateSummary();
                    
                    // Init timeline chart
                    Controllers.assistanceController.initTimelineChart();
                    
                    // Setup search functionality
                    const damageSearch = document.getElementById('damage-search');
                    const residueSearch = document.getElementById('residue-search');
                    
                    if (damageSearch) {
                        damageSearch.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.toLowerCase();
                            Controllers.assistanceController.filterDamageBuses(searchTerm);
                        });
                    }
                    
                    if (residueSearch) {
                        residueSearch.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.toLowerCase();
                            Controllers.assistanceController.filterResidueBuses(searchTerm);
                        });
                    }
                    
                    // Setup export functionality
                    document.getElementById('export-assistance-excel').addEventListener('click', 
                        Controllers.assistanceController.exportToExcel);
                },
                
                loadDamageBuses: () => {
                    const damageBuses = APP.state.inspections.filter(i => i.dano_pintura);
                    const containerEl = document.getElementById('assistance-danos');
                    
                    if (!containerEl) return;
                    
                    if (damageBuses.length === 0) {
                        containerEl.innerHTML = `
                            <div class="text-center py-6 text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>
                                <p class="text-lg font-medium text-gray-700">¡Sin daños registrados!</p>
                                <p class="text-sm text-gray-500">No hay buses con daños de pintura</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Group by date (newest first)
                    const sortedBuses = [...damageBuses].sort((a, b) => 
                        new Date(b.created_at) - new Date(a.created_at)
                    );
                    
                    // Generate HTML
                    containerEl.innerHTML = sortedBuses.map(bus => `
                        <div class="border p-4 rounded-lg bg-white hover:shadow-md transition-all" data-ppu="${bus.ppu}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">${bus.ppu}</h3>
                                    <p class="text-sm text-gray-600">Interno: ${bus.numero_interno}</p>
                                    <p class="text-sm text-gray-600 mt-1">
                                        <span class="font-medium">Detalle:</span> ${bus.dano_pintura_detalle || 'Sin detalles'}
                                    </p>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <span class="badge badge-red">Daño</span>
                                    ${bus.damage_image ? `
                                        <button class="view-damage-image btn btn-xs btn-outline" data-image="${bus.damage_image}" data-ppu="${bus.ppu}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                                            Ver foto
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="mt-3 flex justify-between items-center text-xs text-gray-500">
                                <p>Terminal: ${bus.terminal}</p>
                                <p>${Utils.formatDate(bus.created_at)}</p>
                            </div>
                        </div>
                    `).join('');
                    
                    // Add event listeners
                    containerEl.querySelectorAll('.view-damage-image').forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const imageUrl = button.dataset.image;
                            const ppu = button.dataset.ppu;
                            if (imageUrl) {
                                const modalContent = `
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h2 class="text-xl font-bold text-gray-800">Imagen de Daño</h2>
                                            <p class="text-gray-500">${ppu}</p>
                                        </div>
                                        <button id="close-image-modal-btn" class="text-gray-400 hover:text-gray-700 p-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                                        </button>
                                    </div>
                                    <div class="mt-4">
                                        <div class="image-preview">
                                            <img src="${imageUrl}" alt="Daño en ${ppu}">
                                        </div>
                                    </div>
                                `;
                                
                                Utils.showModal('damage-image-modal', modalContent);
                                
                                document.getElementById('close-image-modal-btn').addEventListener('click', () => {
                                    Utils.hideModal('damage-image-modal');
                                });
                            }
                        });
                    });
                    
                    // Add click handler to view full details
                    containerEl.querySelectorAll('[data-ppu]').forEach(item => {
                        item.addEventListener('click', () => {
                            const ppu = item.dataset.ppu;
                            const inspection = damageBuses.find(i => i.ppu === ppu);
                            if (inspection) {
                                Controllers.dashboardController.showBusDetails(inspection);
                            }
                        });
                    });
                },
                
                loadResidueBuses: () => {
                    const residueBuses = APP.state.inspections.filter(i => i.residuos_pegamento);
                    const containerEl = document.getElementById('assistance-residuos');
                    
                    if (!containerEl) return;
                    
                    if (residueBuses.length === 0) {
                        containerEl.innerHTML = `
                            <div class="text-center py-6 text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>
                                <p class="text-lg font-medium text-gray-700">¡Sin residuos registrados!</p>
                                <p class="text-sm text-gray-500">No hay buses con residuos de pegamento</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Group by date (newest first)
                    const sortedBuses = [...residueBuses].sort((a, b) => 
                        new Date(b.created_at) - new Date(a.created_at)
                    );
                    
                    // Generate HTML
                    containerEl.innerHTML = sortedBuses.map(bus => `
                        <div class="border p-4 rounded-lg bg-white hover:shadow-md transition-all" data-ppu="${bus.ppu}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">${bus.ppu}</h3>
                                    <p class="text-sm text-gray-600">Interno: ${bus.numero_interno}</p>
                                    <p class="text-sm text-gray-600 mt-1">
                                        <span class="font-medium">Detalle:</span> ${bus.residuos_pegamento_detalle || 'Sin detalles'}
                                    </p>
                                </div>
                                <span class="badge badge-yellow">Residuos</span>
                            </div>
                            <div class="mt-3 flex justify-between items-center text-xs text-gray-500">
                                <p>Terminal: ${bus.terminal}</p>
                                <p>${Utils.formatDate(bus.created_at)}</p>
                            </div>
                        </div>
                    `).join('');
                    
                    // Add click handler to view full details
                    containerEl.querySelectorAll('[data-ppu]').forEach(item => {
                        item.addEventListener('click', () => {
                            const ppu = item.dataset.ppu;
                            const inspection = residueBuses.find(i => i.ppu === ppu);
                            if (inspection) {
                                Controllers.dashboardController.showBusDetails(inspection);
                            }
                        });
                    });
                },
                
                filterDamageBuses: (searchTerm) => {
                    const damageBuses = APP.state.inspections.filter(i => i.dano_pintura);
                    const containerEl = document.getElementById('assistance-danos');
                    
                    if (!containerEl || damageBuses.length === 0) return;
                    
                    const filteredBuses = damageBuses.filter(bus => 
                        bus.ppu.toLowerCase().includes(searchTerm) || 
                        bus.numero_interno.toLowerCase().includes(searchTerm) || 
                        (bus.dano_pintura_detalle && bus.dano_pintura_detalle.toLowerCase().includes(searchTerm)) ||
                        (bus.terminal && bus.terminal.toLowerCase().includes(searchTerm))
                    );
                    
                    if (filteredBuses.length === 0) {
                        containerEl.innerHTML = `
                            <div class="text-center py-6 text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3"><circle cx="12" cy="12" r="10"/><line x1="8" x2="16" y1="12" y2="12"/></svg>
                                <p class="text-lg font-medium text-gray-700">No hay coincidencias</p>
                                <p class="text-sm text-gray-500">No se encontraron buses con esos términos</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Group by date (newest first)
                    const sortedBuses = [...filteredBuses].sort((a, b) => 
                        new Date(b.created_at) - new Date(a.created_at)
                    );
                    
                    // Generate HTML
                    containerEl.innerHTML = sortedBuses.map(bus => `
                        <div class="border p-4 rounded-lg bg-white hover:shadow-md transition-all" data-ppu="${bus.ppu}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">${bus.ppu}</h3>
                                    <p class="text-sm text-gray-600">Interno: ${bus.numero_interno}</p>
                                    <p class="text-sm text-gray-600 mt-1">
                                        <span class="font-medium">Detalle:</span> ${bus.dano_pintura_detalle || 'Sin detalles'}
                                    </p>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <span class="badge badge-red">Daño</span>
                                    ${bus.damage_image ? `
                                        <button class="view-damage-image btn btn-xs btn-outline" data-image="${bus.damage_image}" data-ppu="${bus.ppu}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                                            Ver foto
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="mt-3 flex justify-between items-center text-xs text-gray-500">
                                <p>Terminal: ${bus.terminal}</p>
                                <p>${Utils.formatDate(bus.created_at)}</p>
                            </div>
                        </div>
                    `).join('');
                    
                    // Add event listeners
                    containerEl.querySelectorAll('.view-damage-image').forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const imageUrl = button.dataset.image;
                            const ppu = button.dataset.ppu;
                            if (imageUrl) {
                                const modalContent = `
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h2 class="text-xl font-bold text-gray-800">Imagen de Daño</h2>
                                            <p class="text-gray-500">${ppu}</p>
                                        </div>
                                        <button id="close-image-modal-btn" class="text-gray-400 hover:text-gray-700 p-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                                        </button>
                                    </div>
                                    <div class="mt-4">
                                        <div class="image-preview">
                                            <img src="${imageUrl}" alt="Daño en ${ppu}">
                                        </div>
                                    </div>
                                `;
                                
                                Utils.showModal('damage-image-modal', modalContent);
                                
                                document.getElementById('close-image-modal-btn').addEventListener('click', () => {
                                    Utils.hideModal('damage-image-modal');
                                });
                            }
                        });
                    });
                    
                    // Add click handler to view full details
                    containerEl.querySelectorAll('[data-ppu]').forEach(item => {
                        item.addEventListener('click', () => {
                            const ppu = item.dataset.ppu;
                            const inspection = filteredBuses.find(i => i.ppu === ppu);
                            if (inspection) {
                                Controllers.dashboardController.showBusDetails(inspection);
                            }
                        });
                    });
                },
                
                filterResidueBuses: (searchTerm) => {
                    const residueBuses = APP.state.inspections.filter(i => i.residuos_pegamento);
                    const containerEl = document.getElementById('assistance-residuos');
                    
                    if (!containerEl || residueBuses.length === 0) return;
                    
                    const filteredBuses = residueBuses.filter(bus => 
                        bus.ppu.toLowerCase().includes(searchTerm) || 
                        bus.numero_interno.toLowerCase().includes(searchTerm) || 
                        (bus.residuos_pegamento_detalle && bus.residuos_pegamento_detalle.toLowerCase().includes(searchTerm)) ||
                        (bus.terminal && bus.terminal.toLowerCase().includes(searchTerm))
                    );
                    
                    if (filteredBuses.length === 0) {
                        containerEl.innerHTML = `
                            <div class="text-center py-6 text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3"><circle cx="12" cy="12" r="10"/><line x1="8" x2="16" y1="12" y2="12"/></svg>
                                <p class="text-lg font-medium text-gray-700">No hay coincidencias</p>
                                <p class="text-sm text-gray-500">No se encontraron buses con esos términos</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Group by date (newest first)
                    const sortedBuses = [...filteredBuses].sort((a, b) => 
                        new Date(b.created_at) - new Date(a.created_at)
                    );
                    
                    // Generate HTML
                    containerEl.innerHTML = sortedBuses.map(bus => `
                        <div class="border p-4 rounded-lg bg-white hover:shadow-md transition-all" data-ppu="${bus.ppu}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">${bus.ppu}</h3>
                                    <p class="text-sm text-gray-600">Interno: ${bus.numero_interno}</p>
                                    <p class="text-sm text-gray-600 mt-1">
                                        <span class="font-medium">Detalle:</span> ${bus.residuos_pegamento_detalle || 'Sin detalles'}
                                    </p>
                                </div>
                                <span class="badge badge-yellow">Residuos</span>
                            </div>
                            <div class="mt-3 flex justify-between items-center text-xs text-gray-500">
                                <p>Terminal: ${bus.terminal}</p>
                                <p>${Utils.formatDate(bus.created_at)}</p>
                            </div>
                        </div>
                    `).join('');
                    
                    // Add click handler to view full details
                    containerEl.querySelectorAll('[data-ppu]').forEach(item => {
                        item.addEventListener('click', () => {
                            const ppu = item.dataset.ppu;
                            const inspection = filteredBuses.find(i => i.ppu === ppu);
                            if (inspection) {
                                Controllers.dashboardController.showBusDetails(inspection);
                            }
                        });
                    });
                },
                
                updateSummary: () => {
                    const damageBuses = APP.state.inspections.filter(i => i.dano_pintura);
                    const residueBuses = APP.state.inspections.filter(i => i.residuos_pegamento);
                    
                    // Update main counts
                    document.getElementById('damage-count-assistance').textContent = damageBuses.length;
                    document.getElementById('residue-count-assistance').textContent = residueBuses.length;
                    
                    // Calculate detailed damage counts
                    const frontDamage = damageBuses.filter(b => 
                        b.dano_pintura_detalle && 
                        b.dano_pintura_detalle.toLowerCase().includes('frente')
                    ).length;
                    
                    const sideDamage = damageBuses.filter(b => 
                        b.dano_pintura_detalle && (
                            b.dano_pintura_detalle.toLowerCase().includes('lado') ||
                            b.dano_pintura_detalle.toLowerCase().includes('lateral') ||
                            b.dano_pintura_detalle.toLowerCase().includes('izquierda') ||
                            b.dano_pintura_detalle.toLowerCase().includes('derecha')
                        )
                    ).length;
                    
                    const backDamage = damageBuses.filter(b => 
                        b.dano_pintura_detalle && (
                            b.dano_pintura_detalle.toLowerCase().includes('trasera') ||
                            b.dano_pintura_detalle.toLowerCase().includes('atrás') ||
                            b.dano_pintura_detalle.toLowerCase().includes('posterior')
                        )
                    ).length;
                    
                    // Update damage counts
                    document.getElementById('damage-front-count').textContent = frontDamage;
                    document.getElementById('damage-side-count').textContent = sideDamage;
                    document.getElementById('damage-back-count').textContent = backDamage;
                    
                    // Calculate detailed residue counts
                    const leftResidue = residueBuses.filter(b => 
                        b.residuos_pegamento_detalle && (
                            b.residuos_pegamento_detalle.toLowerCase().includes('izquierda')
                        )
                    ).length;
                    
                    const rightResidue = residueBuses.filter(b => 
                        b.residuos_pegamento_detalle && (
                            b.residuos_pegamento_detalle.toLowerCase().includes('derecha')
                        )
                    ).length;
                    
                    const backResidue = residueBuses.filter(b => 
                        b.residuos_pegamento_detalle && (
                            b.residuos_pegamento_detalle.toLowerCase().includes('luneta') ||
                            b.residuos_pegamento_detalle.toLowerCase().includes('trasera') ||
                            b.residuos_pegamento_detalle.toLowerCase().includes('atrás') ||
                            b.residuos_pegamento_detalle.toLowerCase().includes('posterior')
                        )
                    ).length;
                    
                    // Update residue counts
                    document.getElementById('residue-left-count').textContent = leftResidue;
                    document.getElementById('residue-right-count').textContent = rightResidue;
                    document.getElementById('residue-back-count').textContent = backResidue;
                },
                
                initTimelineChart: () => {
                    const timelineChartEl = document.getElementById('issues-timeline-chart');
                    if (!timelineChartEl) return;
                    
                    // Get last 30 days
                    const dateLabels = [];
                    const today = new Date();
                    
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(today.getDate() - i);
                        const dateString = date.toLocaleDateString();
                        dateLabels.push(dateString);
                    }
                    
                    // Count issues by date
                    const damageData = [];
                    const residueData = [];
                    
                    dateLabels.forEach(date => {
                        const damageCount = APP.state.inspections.filter(i => 
                            i.dano_pintura && 
                            new Date(i.created_at).toLocaleDateString() === date
                        ).length;
                        
                        const residueCount = APP.state.inspections.filter(i => 
                            i.residuos_pegamento && 
                            new Date(i.created_at).toLocaleDateString() === date
                        ).length;
                        
                        damageData.push(damageCount);
                        residueData.push(residueCount);
                    });
                    
                    APP.state.charts.timeline = new Chart(timelineChartEl, {
                        type: 'line',
                        data: {
                            labels: dateLabels,
                            datasets: [
                                {
                                    label: 'Daños',
                                    data: damageData,
                                    borderColor: '#ef4444',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    borderWidth: 2,
                                    pointBackgroundColor: '#ef4444',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 1,
                                    pointRadius: 3
                                },
                                {
                                    label: 'Residuos',
                                    data: residueData,
                                    borderColor: '#f59e0b',
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    borderWidth: 2,
                                    pointBackgroundColor: '#f59e0b',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 1,
                                    pointRadius: 3
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                },
                
                exportToExcel: () => {
                    // Prepare data for export
                    const damageBuses = APP.state.inspections.filter(i => i.dano_pintura);
                    const residueBuses = APP.state.inspections.filter(i => i.residuos_pegamento);
                    
                    // Generate workbook
                    const workbook = XLSX.utils.book_new();
                    
                    // Create damage worksheet
                    const damageData = damageBuses.map(i => ({
                        'PPU': i.ppu,
                        'N° Interno': i.numero_interno,
                        'Marca': i.marca_chasis,
                        'Terminal': i.terminal,
                        'Fecha': new Date(i.created_at).toLocaleString(),
                        'Detalle del Daño': i.dano_pintura_detalle || '',
                        'Imagen': i.damage_image || '',
                        'Ubicación': `${i.lat}, ${i.lon}`
                    }));
                    
                    const damageSheet = XLSX.utils.json_to_sheet(damageData);
                    XLSX.utils.book_append_sheet(workbook, damageSheet, 'Daños de Pintura');
                    
                    // Create residue worksheet
                    const residueData = residueBuses.map(i => ({
                        'PPU': i.ppu,
                        'N° Interno': i.numero_interno,
                        'Marca': i.marca_chasis,
                        'Terminal': i.terminal,
                        'Fecha': new Date(i.created_at).toLocaleString(),
                        'Detalle de Residuos': i.residuos_pegamento_detalle || '',
                        'Ubicación': `${i.lat}, ${i.lon}`
                    }));
                    
                    const residueSheet = XLSX.utils.json_to_sheet(residueData);
                    XLSX.utils.book_append_sheet(workbook, residueSheet, 'Residuos de Pegamento');
                    
                    // Generate filename with current date
                    const date = new Date().toISOString().split('T')[0];
                    const filename = `PubliFleet_Asistencia_${date}.xlsx`;
                    
                    // Export file
                    XLSX.writeFile(workbook, filename);
                    
                    // Show success notification
                    Utils.showNotification('Exportación completada', 'La lista de asistencia se ha exportado correctamente', 'success');
                }
            }
        };
        
        // --- UI CORE ---
        const UI = {
            // Initialize UI
            init: () => {
                console.log('Inicializando UI...');
                
                // Build navigation
                UI.buildNavigation();
                
                // Add event listeners for connectivity
                window.addEventListener('online', UI.handleOnlineStatusChange);
                window.addEventListener('offline', UI.handleOnlineStatusChange);
                
                // Update UI for current connectivity status
                UI.updateConnectivityStatus();
                
                // Add event listeners for modal backdrop clicks
                document.getElementById('bus-detail-modal').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        Utils.hideModal('bus-detail-modal');
                    }
                });
                
                document.getElementById('damage-image-modal').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        Utils.hideModal('damage-image-modal');
                    }
                });
            },
            
            // Build navigation
            buildNavigation: () => {
                const desktopNav = document.getElementById('desktop-nav');
                const mobileNav = document.getElementById('mobile-nav');
                
                if (!desktopNav || !mobileNav) return;
                
                // Build desktop navigation
                desktopNav.innerHTML = APP.navItems.map(item => `
                    <button data-view="${item.id}" class="sidebar-link flex items-center p-3 rounded-lg w-full">
                        <span class="mr-3">${item.icon}</span>
                        <span class="font-medium">${item.label}</span>
                    </button>
                `).join('');
                
                // Build mobile navigation
                mobileNav.innerHTML = APP.navItems.map(item => `
                    <button data-view="${item.id}" class="nav-item flex flex-col items-center justify-center w-full py-2">
                        ${item.icon}
                        <span class="text-xs mt-1">${item.mobileLabel || item.label}</span>
                    </button>
                `).join('');
                
                // Add event listeners
                document.querySelectorAll('[data-view]').forEach(btn => {
                    btn.addEventListener('click', () => UI.setActiveView(btn.dataset.view));
                });
            },
            
            // Set active view
            setActiveView: (viewId) => {
                console.log('Cambiando a vista:', viewId);
                APP.state.activeView = viewId;
                
                // Update navigation state
                document.querySelectorAll('.sidebar-link').forEach(link => {
                    link.classList.toggle('active', link.dataset.view === viewId);
                });
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.view === viewId);
                });
                
                // Get template for view
                const viewTemplate = APP.templates[viewId]();
                
                // Update content
                document.getElementById('main-content').innerHTML = viewTemplate;
                document.getElementById('mobile-main-content').innerHTML = viewTemplate;
                
                // Initialize view controller
                switch (viewId) {
                    case 'dashboard':
                        Controllers.dashboardController.init();
                        break;
                    case 'form':
                        Controllers.formController.init();
                        break;
                    case 'reports':
                        Controllers.reportsController.init();
                        break;
                    case 'fleet':
                        Controllers.fleetController.init();
                        break;
                    case 'assistance':
                        Controllers.assistanceController.init();
                        break;
                }
                
                // Add active class to view section
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.add('active');
                });
                
                // Scroll to top
                document.getElementById('main-content').scrollTop = 0;
                document.getElementById('mobile-main-content').scrollTop = 0;
            },
            
            // Handle online/offline status changes
            handleOnlineStatusChange: () => {
                const isOnline = navigator.onLine;
                APP.state.isOnline = isOnline;
                
                UI.updateConnectivityStatus();
                
                if (isOnline) {
                    // We're back online, try to sync pending data
                    DataService.syncPendingData().then(result => {
                        if (result.synced > 0) {
                            // Refresh data after successful sync
                            DataService.fetchInspections().then(() => {
                                // Update UI if needed
                                if (APP.state.activeView === 'dashboard') {
                                    Controllers.dashboardController.refreshData();
                                } else if (APP.state.activeView === 'reports') {
                                    Controllers.reportsController.loadReportData();
                                } else if (APP.state.activeView === 'fleet') {
                                    Controllers.fleetController.renderFleetGrid();
                                } else if (APP.state.activeView === 'assistance') {
                                    Controllers.assistanceController.loadDamageBuses();
                                    Controllers.assistanceController.loadResidueBuses();
                                    Controllers.assistanceController.updateSummary();
                                }
                            });
                        }
                    });
                    
                    Utils.showNotification('Conexión restablecida', 'Ahora estás conectado a internet', 'success');
                } else {
                    Utils.showNotification('Sin conexión', 'Trabajando en modo sin conexión', 'warning');
                }
            },
            
            // Update connectivity status in UI
            updateConnectivityStatus: () => {
                const isOnline = APP.state.isOnline;
                
                // Show/hide offline banner
                document.getElementById('offline-banner').classList.toggle('visible', !isOnline);
                
                // Update connection indicators
                document.getElementById('connection-status').textContent = isOnline ? 'Conectado' : 'Sin conexión';
                document.getElementById('connection-status').className = isOnline ? 'text-sm font-medium text-gray-700' : 'text-sm font-medium text-red-600';
                
                document.getElementById('sync-status').textContent = isOnline ? 
                    (APP.state.lastSyncTime ? `Última sincronización: ${new Date(APP.state.lastSyncTime).toLocaleTimeString()}` : 'Datos sincronizados') : 
                    `${APP.state.pendingSync.length} registros pendientes`;
                
                // Update status indicators
                document.querySelector('.status-indicator').className = isOnline ? 'status-indicator online' : 'status-indicator offline';
                
                // Update mobile status indicator
                const mobileIndicator = document.getElementById('mobile-status-indicator');
                if (mobileIndicator) {
                    mobileIndicator.className = isOnline ? 'status-indicator online' : 'status-indicator offline';
                }
            }
        };
        
        // --- MAIN APP INITIALIZATION ---
        const App = {
            // Initialize application
            init: async () => {
                console.log('Inicializando aplicación...');
                Utils.showLoader(true);
                
                try {
                    // Load fleet data
                    APP.fleetData = Utils.loadFleetData();
                    
                    // Initialize Supabase
                    const supabaseInitialized = DataService.initSupabase();
                    if (!supabaseInitialized) {
                        console.warn('No se pudo inicializar Supabase, usando modo offline');
                        APP.state.isOnline = false;
                    }
                    
                    // Check connectivity
                    APP.state.isOnline = navigator.onLine;
                    
                    // Initialize UI
                    UI.init();
                    
                    // Fetch inspections
                    await DataService.fetchInspections();
                    
                    // Process fleet data
                    DataService.processFleetData(APP.state.inspections);
                    
                    // Initial view
                    const isMobile = window.innerWidth < 768;
                    const initialView = isMobile ? 'form' : 'dashboard';
                    UI.setActiveView(initialView);
                    
                    console.log('Aplicación inicializada correctamente');
                } catch (error) {
                    console.error('Error al inicializar la aplicación:', error);
                    document.body.innerHTML = `
                        <div class="p-8 text-center">
                            <h1 class="text-2xl font-bold text-red-600">Error de Inicialización</h1>
                            <p class="text-gray-600 mt-2">No se pudo inicializar la aplicación. Por favor, recargue la página o contacte al administrador.</p>
                            <p class="text-sm text-gray-400 mt-4">${error.message}</p>
                            <button onclick="location.reload()" class="mt-6 btn btn-primary">Reintentar</button>
                        </div>
                    `;
                } finally {
                    Utils.showLoader(false);
                }
            }
        };
        
        // Start the application when DOM is ready
        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>