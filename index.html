<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PubliBus - Sistema Avanzado de Inspección de Flota</title>
    
    <!-- Tailwind CSS (crítico) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS (crítico para mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Supabase (crítico) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Scripts diferidos para mejor rendimiento -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="" defer></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js" defer></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://unpkg.com/lucide@latest" defer></script>
    
    <!-- Scripts opcionales (cargados solo cuando se necesiten) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js" defer></script>
    
    <!-- Script local -->
    <script src="bus-alert-functions.js"></script>



    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              'brand-primary': '#1e40af',
              'brand-secondary': '#1d4ed8',
              'brand-light': '#3b82f6',
              'brand-dark': '#1e3a8a',
              'status-green': '#16a34a',
              'status-gray': '#6b7280',
              'status-red': '#dc2626',
              'status-yellow': '#f59e0b',
              'surface': '#f8fafc',
              'surface-dark': '#111827',
              'text-primary': '#1f2937',
              'text-primary-dark': '#f3f4f6',
              'text-secondary': '#4b5563',
              'text-secondary-dark': '#d1d5db'
            },
            fontFamily: {
              sans: ['Inter', 'sans-serif']
            },
            animation: {
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'bounce-slow': 'bounce 3s infinite',
            }
          }
        }
      }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
        }
        body.dark { 
            background-color: #111827; 
            color: #f3f4f6;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal { 
            transition: opacity 0.25s ease;
            backdrop-filter: blur(4px);
        }
        .modal-content { 
            transition: all 0.3s ease;
        }
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .view { display: none; opacity: 0; transform: translateY(10px); }
        .view.active { 
            display: block; 
            animation: fadeIn 0.5s ease-in-out forwards; 
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .mobile-nav-link.active { color: #1e40af; }
        .dark .mobile-nav-link.active { color: #3b82f6; }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Card hover effects */
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .dark .card-hover:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        
        /* Custom switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #1e40af;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
        
        /* Progress circle */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        /* Badge styles */
        .badge {
            display: inline-block;
            padding: 0.25em 0.5em;
            font-size: 0.75em;
            font-weight: 600;
            border-radius: 9999px;
        }
        
        /* Custom Checkbox & Radio */
        .custom-checkbox:checked {
            background-color: #1e40af;
            border-color: #1e40af;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .dark .glass {
            background: rgba(17, 24, 39, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Animaciones optimizadas */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-slow {
            animation: pulse 4s ease-in-out infinite;
        }
        
        /* Optimizaciones de rendimiento */
        .view {
            will-change: auto;
            transform: translateZ(0);
        }
        
        /* Reducir animaciones en dispositivos que prefieren menos movimiento */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Estilos para la alerta de bus ya inspeccionado */
        #bus-inspection-alert {
            transition: all 0.3s ease-in-out;
        }
        
        #bus-inspection-alert.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        #bus-inspection-alert.hide {
            opacity: 0;
            transform: translateY(-20px);
        }
        
        /* Responsive para móviles */
        @media (max-width: 768px) {
            #bus-inspection-alert {
                top: 1rem !important;
                left: 1rem !important;
                right: 1rem !important;
                transform: none !important;
                max-width: none !important;
                width: auto !important;
            }
        }
        
        /* Notification dot */
        .notification-dot {
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
        }
        
        /* ===== MEJORAS DE RESPONSIVIDAD PARA FORMULARIO ===== */
        
        /* Mejoras de responsividad para celulares pequeños */
        @media (max-width: 480px) {
            /* Reducir padding en móviles */
            .view {
                padding: 0.5rem !important;
            }
            
            /* Ajustar tamaños de texto */
            h1, h2 {
                font-size: 1.25rem !important;
                line-height: 1.5 !important;
            }
            
            h3 {
                font-size: 1.125rem !important;
            }
            
            /* Mejorar espaciado en formularios */
            .space-y-6 > * + * {
                margin-top: 1rem !important;
            }
            
            .space-y-8 > * + * {
                margin-top: 1.25rem !important;
            }
            
            /* Ajustar botones para móviles */
            button {
                min-height: 44px !important; /* Tamaño mínimo para touch */
            }
            
            /* Mejorar campos de entrada */
            input, textarea, select {
                font-size: 16px !important; /* Evitar zoom en iOS */
                padding: 0.75rem !important;
            }
            
            /* Ajustar grid para móviles */
            .grid {
                gap: 0.75rem !important;
            }
            
            /* Mejorar legibilidad de labels */
            label {
                font-size: 0.875rem !important;
                margin-bottom: 0.25rem !important;
            }
            
            /* Ajustar iconos en móviles */
            .h-4.w-4 {
                width: 1rem !important;
                height: 1rem !important;
            }
            
            .h-5.w-5 {
                width: 1.125rem !important;
                height: 1.125rem !important;
            }
            
            .h-6.w-6 {
                width: 1.25rem !important;
                height: 1.25rem !important;
            }
            
            /* Mejorar botones del formulario */
            #inspection-form button {
                width: 100% !important;
                margin-bottom: 0.5rem !important;
            }
            
            /* Ajustar campos de radio */
            .form-radio {
                width: 1.25rem !important;
                height: 1.25rem !important;
            }
            
            /* Mejorar espaciado de fieldset */
            fieldset {
                padding: 0.75rem !important;
            }
            
            legend {
                font-size: 1rem !important;
                margin-bottom: 0.5rem !important;
            }
        }
        
        /* Mejoras específicas para pantallas muy pequeñas */
        @media (max-width: 360px) {
            .view {
                padding: 0.25rem !important;
            }
            
            h1, h2 {
                font-size: 1.125rem !important;
            }
            
            .p-3 {
                padding: 0.5rem !important;
            }
            
            .p-4 {
                padding: 0.75rem !important;
            }
            
            .p-6 {
                padding: 1rem !important;
            }
            
            /* Ajustar botones para pantallas muy pequeñas */
            button {
                font-size: 0.875rem !important;
                padding: 0.5rem 0.75rem !important;
            }
            
            /* Mejorar campos de entrada */
            input, textarea, select {
                font-size: 16px !important;
                padding: 0.625rem !important;
            }
        }
        
        /* Mejoras para tablets */
        @media (min-width: 481px) and (max-width: 768px) {
            .view {
                padding: 1rem !important;
            }
            
            .grid-cols-1.sm\:grid-cols-2 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            /* Mejorar botones en tablets */
            #inspection-form button {
                min-width: 120px !important;
            }
        }
        
        /* Mejoras específicas para el formulario */
        @media (max-width: 640px) {
            /* Hacer que los campos de radio se apilen verticalmente */
            .flex.items-center.space-x-4 {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.5rem !important;
            }
            
            /* Ajustar espaciado de los campos */
            .space-y-3 > * + * {
                margin-top: 0.75rem !important;
            }
            
            /* Mejorar botones de foto */
            button[id*="-photo-btn"] {
                padding: 0.75rem !important;
                font-size: 0.875rem !important;
            }
            
            /* Ajustar textareas */
            textarea {
                min-height: 80px !important;
            }
        }
        
        /* Clases utilitarias para móviles */
        .mobile-optimized {
            /* Optimizaciones generales para móviles */
        }
        
        .mobile-optimized input,
        .mobile-optimized textarea,
        .mobile-optimized select {
            font-size: 16px !important; /* Evitar zoom en iOS */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .mobile-optimized button {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Mejorar accesibilidad en móviles */
        @media (max-width: 480px) {
            /* Aumentar área de toque para elementos interactivos */
            button, input[type="radio"], input[type="checkbox"], label {
                min-height: 44px !important;
                min-width: 44px !important;
            }
            
            /* Mejorar contraste y legibilidad */
            .text-text-secondary {
                color: #4b5563 !important;
            }
            
            .dark .text-text-secondary {
                color: #9ca3af !important;
            }
            
            /* Ajustar espaciado para mejor usabilidad */
            .space-y-2 > * + * {
                margin-top: 0.5rem !important;
            }
            
            .space-y-4 > * + * {
                margin-top: 1rem !important;
            }
        }
        
        /* Notification dot styles */
        .notification-dot {
            height: 8px;
            background-color: #ef4444;
            border-radius: 50%;
        }
        
        /* Map Markers */
        .custom-marker {
            width: 25px;
            height: 25px;
            line-height: 25px;
            text-align: center;
            background-color: white;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .marker-cluster {
            background-color: rgba(59, 130, 246, 0.6);
        }
        .marker-cluster div {
            background-color: rgba(30, 64, 175, 0.8);
            color: white;
        }
        
        /* Table styles */
        .data-table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }
        .data-table th {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 10;
        }
        .dark .data-table th {
            background-color: #1f2937;
        }
        .data-table th, .data-table td {
            padding: 12px 16px;
            text-align: left;
        }
        .data-table tbody tr {
            transition: background-color 0.2s;
        }
        .data-table tbody tr:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .dark .data-table tbody tr:hover {
            background-color: rgba(59, 130, 246, 0.2);
        }
        
        /* Chart tooltip */
        .chartjs-tooltip {
            opacity: 1;
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 3px;
            padding: 5px 10px;
            pointer-events: none;
            transform: translate(-50%, 0);
        }
    </style>
</head>
<body class="bg-surface dark:bg-surface-dark text-text-primary dark:text-text-primary-dark transition-colors duration-300">

    <div class="flex h-screen bg-surface dark:bg-surface-dark overflow-hidden">
        <!-- Sidebar for desktop -->
        <aside class="hidden md:flex flex-col w-64 bg-gradient-to-b from-brand-dark to-brand-primary dark:from-gray-900 dark:to-gray-800 text-white shadow-xl z-20 transition-all duration-300">
            <div class="flex items-center justify-between h-20 px-6 border-b border-brand-primary/30 dark:border-gray-700">
                <div class="flex items-center">
                    <i data-lucide="bus" class="h-8 w-8 mr-3 text-white"></i>
                    <h1 class="text-2xl font-bold tracking-tight">PubliBus</h1>
                </div>
                <button id="collapse-sidebar" class="p-1 rounded-md hover:bg-brand-primary/30 transition-colors">
                    <i data-lucide="chevron-left" class="h-5 w-5"></i>
                </button>
            </div>
            <div class="px-4 py-2 border-b border-brand-primary/30 dark:border-gray-700">
                <div class="flex items-center space-x-2 p-2">
                    <div class="h-8 w-8 rounded-full bg-brand-light flex items-center justify-center">
                        <i data-lucide="user" class="h-5 w-5 text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold sidebar-inspector-name">Inspector</p>
                        <p class="text-xs text-gray-300" id="sidebar-terminal">Terminal: --</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 px-2 py-4 space-y-1 overflow-y-auto no-scrollbar">
                <a href="#" data-view="dashboard" class="nav-link flex items-center gap-x-3 px-4 py-3 text-sm font-medium text-gray-300 rounded-md hover:bg-brand-primary hover:text-white transition-colors duration-200 group">
                    <i data-lucide="layout-dashboard" class="h-5 w-5"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" data-view="form" class="nav-link flex items-center gap-x-3 px-4 py-3 text-sm font-medium text-gray-300 rounded-md hover:bg-brand-primary hover:text-white transition-colors duration-200 group">
                    <i data-lucide="clipboard-plus" class="h-5 w-5"></i>
                    <span>Nuevo Registro</span>
                </a>
                <a href="#" data-view="fleet" class="nav-link flex items-center gap-x-3 px-4 py-3 text-sm font-medium text-gray-300 rounded-md hover:bg-brand-primary hover:text-white transition-colors duration-200 group">
                    <i data-lucide="bus" class="h-5 w-5"></i>
                    <span>Flota</span>
                </a>
                <a href="#" data-view="assistance" class="nav-link flex items-center gap-x-3 px-4 py-3 text-sm font-medium text-gray-300 rounded-md hover:bg-brand-primary hover:text-white transition-colors duration-200 group">
                    <i data-lucide="wrench" class="h-5 w-5"></i>
                    <span>Asistencia</span>
                </a>
                <a href="#" data-view="reports" class="nav-link flex items-center gap-x-3 px-4 py-3 text-sm font-medium text-gray-300 rounded-md hover:bg-brand-primary hover:text-white transition-colors duration-200 group">
                    <i data-lucide="file-bar-chart-2" class="h-5 w-5"></i>
                    <span>Reportes</span>
                </a>
                <a href="#" data-view="analytics" class="nav-link flex items-center gap-x-3 px-4 py-3 text-sm font-medium text-gray-300 rounded-md hover:bg-brand-primary hover:text-white transition-colors duration-200 group">
                    <i data-lucide="bar-chart-4" class="h-5 w-5"></i>
                    <span>Analítica</span>
                </a>
                <div class="pt-4 mt-4 border-t border-brand-primary/30 dark:border-gray-700">
                    <div class="px-4 space-y-2">
                        <p class="text-xs font-semibold uppercase tracking-wider text-gray-400">Configuración</p>
                        <div class="flex items-center justify-between text-sm">
                            <span>Modo Oscuro</span>
                            <div class="relative inline-block w-10 align-middle select-none">
                                <input type="checkbox" id="theme-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-2 appearance-none cursor-pointer"/>
                                <label for="theme-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-500 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
            <div class="p-4 text-xs text-center text-gray-400">
                <p>© PubliBus v2.0</p>
                <p class="mt-1">Sistema Avanzado de Inspección</p>
            </div>
        </aside>
        
        <!-- Collapsed sidebar for desktop -->
        <aside id="collapsed-sidebar" class="hidden fixed h-full bg-brand-dark dark:bg-gray-900 text-white w-16 z-20 transition-all duration-300">
            <div class="flex flex-col items-center">
                <div class="h-20 w-full flex items-center justify-center border-b border-brand-primary/30 dark:border-gray-700">
                    <button id="expand-sidebar" class="p-2 rounded-md hover:bg-brand-primary/30 transition-colors">
                        <i data-lucide="chevron-right" class="h-5 w-5"></i>
                    </button>
                </div>
                <div class="w-full py-4 flex flex-col items-center space-y-6">
                    <a href="#" data-view="dashboard" class="nav-link p-2 rounded-md hover:bg-brand-primary/30 transition-colors tooltip">
                        <i data-lucide="layout-dashboard" class="h-6 w-6"></i>
                        <span class="tooltiptext">Dashboard</span>
                    </a>
                    <a href="#" data-view="form" class="nav-link p-2 rounded-md hover:bg-brand-primary/30 transition-colors tooltip">
                        <i data-lucide="clipboard-plus" class="h-6 w-6"></i>
                        <span class="tooltiptext">Nuevo Registro</span>
                    </a>
                    <a href="#" data-view="fleet" class="nav-link p-2 rounded-md hover:bg-brand-primary/30 transition-colors tooltip">
                        <i data-lucide="bus" class="h-6 w-6"></i>
                        <span class="tooltiptext">Flota</span>
                    </a>
                    <a href="#" data-view="assistance" class="nav-link p-2 rounded-md hover:bg-brand-primary/30 transition-colors tooltip">
                        <i data-lucide="wrench" class="h-6 w-6"></i>
                        <span class="tooltiptext">Asistencia</span>
                    </a>
                    <a href="#" data-view="reports" class="nav-link p-2 rounded-md hover:bg-brand-primary/30 transition-colors tooltip">
                        <i data-lucide="file-bar-chart-2" class="h-6 w-6"></i>
                        <span class="tooltiptext">Reportes</span>
                    </a>
                    <a href="#" data-view="analytics" class="nav-link p-2 rounded-md hover:bg-brand-primary/30 transition-colors tooltip">
                        <i data-lucide="bar-chart-4" class="h-6 w-6"></i>
                        <span class="tooltiptext">Analítica</span>
                    </a>
                </div>
                <div class="mt-auto mb-4">
                    <button id="theme-toggle-collapsed" class="p-2 rounded-md hover:bg-brand-primary/30 transition-colors tooltip">
                        <i data-lucide="sun" id="sun-icon-collapsed" class="h-6 w-6 hidden"></i>
                        <i data-lucide="moon" id="moon-icon-collapsed" class="h-6 w-6"></i>
                        <span class="tooltiptext">Cambiar Tema</span>
                    </button>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top navbar -->
            <header class="bg-white dark:bg-gray-800 shadow-sm z-10">
                <div class="flex items-center justify-between h-16 px-4 md:px-6">
                    <div class="flex items-center">
                        <button id="mobile-menu-button" class="md:hidden p-2 rounded-md text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i data-lucide="menu" class="h-6 w-6"></i>
                        </button>
                        <div class="hidden md:block ml-2">
                            <h1 id="header-title" class="text-xl font-bold text-text-primary dark:text-text-primary-dark">Dashboard</h1>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Indicador de tiempo real -->
                        <div class="flex items-center space-x-2 px-3 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-full text-xs font-medium">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <span>Tiempo Real</span>
                        </div>
                        
                        <div class="relative" id="notifications-dropdown">
                            <button class="p-2 rounded-md text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <i data-lucide="bell" class="h-5 w-5"></i>
                                <span id="notification-badge" class="absolute -top-1 -right-1 bg-status-red text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold hidden"></span>
                            </button>
                            <div id="notifications-panel" class="hidden absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-md shadow-lg py-2 z-30 border border-gray-200 dark:border-gray-700">
                                <div class="px-4 py-2 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="font-semibold">Notificaciones</h3>
                                </div>
                                <div id="notifications-list" class="max-h-64 overflow-y-auto">
                                    <div class="px-4 py-2 text-sm text-gray-500 dark:text-gray-400">
                                        No hay notificaciones.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="relative" id="user-dropdown">
                            <button class="p-2 rounded-md text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <i data-lucide="user" class="h-5 w-5"></i>
                            </button>
                            <div id="user-panel" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg py-2 z-30 border border-gray-200 dark:border-gray-700">
                                <div class="px-4 py-2 border-b border-gray-200 dark:border-gray-700">
                                    <p class="font-semibold user-panel-inspector-name">Inspector</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400" id="user-panel-terminal">Terminal: --</p>
                                </div>
                                <div class="mt-2">
                                    <button id="theme-toggle-navbar" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center">
                                        <i data-lucide="sun" id="sun-icon" class="h-4 w-4 mr-2 hidden"></i>
                                        <i data-lucide="moon" id="moon-icon" class="h-4 w-4 mr-2"></i>
                                        <span id="theme-text">Modo Oscuro</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Mobile sidebar (off-canvas) -->
            <div id="mobile-sidebar" class="fixed inset-0 z-40 hidden">
                <div class="absolute inset-0 bg-black bg-opacity-50" id="mobile-sidebar-backdrop"></div>
                <div class="absolute top-0 left-0 h-full w-64 bg-brand-dark dark:bg-gray-900 transform -translate-x-full transition-transform duration-300" id="mobile-sidebar-content">
                    <div class="flex items-center justify-between h-16 px-6 border-b border-brand-primary/30 dark:border-gray-700">
                        <div class="flex items-center">
                            <i data-lucide="bus" class="h-6 w-6 text-white mr-2"></i>
                            <h1 class="text-xl font-bold text-white">PubliBus</h1>
                        </div>
                        <button id="close-mobile-sidebar" class="p-1 rounded-md text-gray-300 hover:text-white hover:bg-brand-primary/30 transition-colors">
                            <i data-lucide="x" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <div class="p-4 border-b border-brand-primary/30 dark:border-gray-700">
                        <div class="flex items-center space-x-2">
                            <div class="h-8 w-8 rounded-full bg-brand-light flex items-center justify-center">
                                <i data-lucide="user" class="h-5 w-5 text-white"></i>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-white mobile-inspector-name">Inspector</p>
                                <p class="text-xs text-gray-300" id="mobile-sidebar-terminal">Terminal: --</p>
                            </div>
                        </div>
                    </div>
                    <nav class="px-4 py-4 space-y-2">
                        <a href="#" data-view="dashboard" class="mobile-nav-link nav-link flex items-center gap-x-3 px-3 py-3 text-sm font-medium text-gray-300 rounded-md hover:bg-brand-primary hover:text-white transition-colors duration-200">
                            <i data-lucide="layout-dashboard" class="h-5 w-5"></i> Dashboard
                        </a>
                        <a href="#" data-view="form" class="mobile-nav-link nav-link flex items-center gap-x-3 px-3 py-3 text-sm font-medium text-gray-300 rounded-md hover:bg-brand-primary hover:text-white transition-colors duration-200">
                            <i data-lucide="clipboard-plus" class="h-5 w-5"></i> Nuevo Registro
                        </a>
                        <a href="#" data-view="fleet" class="mobile-nav-link nav-link flex items-center gap-x-3 px-3 py-3 text-sm font-medium text-gray-300 rounded-md hover:bg-brand-primary hover:text-white transition-colors duration-200">
                            <i data-lucide="bus" class="h-5 w-5"></i> Flota
                        </a>
                        <a href="#" data-view="assistance" class="mobile-nav-link nav-link flex items-center gap-x-3 px-3 py-3 text-sm font-medium text-gray-300 rounded-md hover:bg-brand-primary hover:text-white transition-colors duration-200">
                            <i data-lucide="wrench" class="h-5 w-5"></i> Asistencia
                        </a>
                        <a href="#" data-view="reports" class="mobile-nav-link nav-link flex items-center gap-x-3 px-3 py-3 text-sm font-medium text-gray-300 rounded-md hover:bg-brand-primary hover:text-white transition-colors duration-200">
                            <i data-lucide="file-bar-chart-2" class="h-5 w-5"></i> Reportes
                        </a>
                        <a href="#" data-view="analytics" class="mobile-nav-link nav-link flex items-center gap-x-3 px-3 py-3 text-sm font-medium text-gray-300 rounded-md hover:bg-brand-primary hover:text-white transition-colors duration-200">
                            <i data-lucide="bar-chart-4" class="h-5 w-5"></i> Analítica
                        </a>
                    </nav>
                </div>
            </div>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 dark:bg-gray-900 p-4 md:p-6">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-2">
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-text-primary dark:text-text-primary-dark">Resumen de Inspecciones</h3>
                                    <div class="flex space-x-2">
                                        <button class="date-filter px-3 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-brand-light hover:text-white dark:hover:bg-brand-light transition-colors" data-period="day">Hoy</button>
                                        <button class="date-filter px-3 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-brand-light hover:text-white dark:hover:bg-brand-light transition-colors" data-period="week">Semana</button>
                                        <button class="date-filter px-3 py-1 text-xs font-medium rounded-full bg-brand-light text-white hover:bg-brand-primary transition-colors" data-period="month">Mes</button>
                                        <button class="date-filter px-3 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-brand-light hover:text-white dark:hover:bg-brand-light transition-colors" data-period="year">Año</button>
                                    </div>
                                </div>
                                <div class="h-[300px]">
                                    <canvas id="inspections-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                                <h3 class="text-lg font-bold mb-4 text-text-primary dark:text-text-primary-dark">Progreso de Flota</h3>
                                <div class="flex justify-center">
                                    <div class="relative flex items-center justify-center w-40 h-40">
                                        <svg class="w-full h-full" viewBox="0 0 100 100">
                                            <circle class="text-gray-200 dark:text-gray-700" stroke-width="10" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                                            <circle id="progress-ring" class="progress-ring__circle text-brand-primary" stroke-width="10" stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                                        </svg>
                                        <div class="absolute flex flex-col items-center justify-center">
                                            <span id="fleet-progress-percentage" class="text-3xl font-bold text-text-primary dark:text-text-primary-dark">0%</span>
                                            <span class="text-xs text-text-secondary dark:text-text-secondary-dark">Inspeccionados</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="flex justify-between text-sm text-text-secondary dark:text-text-secondary-dark mb-1">
                                        <span>Progreso</span>
                                        <span id="fleet-progress-text">0/0</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div id="fleet-progress-bar" class="bg-brand-primary h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="mt-4 grid grid-cols-2 gap-4">
                                    <div class="text-center p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                        <p id="buses-inspected" class="text-2xl font-bold text-status-green">0</p>
                                        <p class="text-xs text-text-secondary dark:text-text-secondary-dark">Inspeccionados</p>
                                    </div>
                                    <div class="text-center p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                        <p id="buses-pending" class="text-2xl font-bold text-status-yellow">0</p>
                                        <p class="text-xs text-text-secondary dark:text-text-secondary-dark">Pendientes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-text-secondary dark:text-text-secondary-dark">El Roble</h3>
                                    <p id="stats-el-roble" class="text-4xl font-bold text-brand-primary">0</p>
                                    <p class="text-sm text-text-secondary dark:text-text-secondary-dark mt-1">Inspecciones</p>
                                </div>
                                <div class="bg-brand-light/20 dark:bg-brand-light/10 p-4 rounded-full">
                                    <i data-lucide="map-pin" class="h-7 w-7 text-brand-light"></i>
                                </div>
                            </div>
                            <div class="mt-4">
                                <div class="flex justify-between text-xs text-text-secondary dark:text-text-secondary-dark">
                                    <span id="el-roble-progress-text">0%</span>
                                    <span>Progreso</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 mt-1">
                                    <div id="el-roble-progress-bar" class="bg-brand-primary h-1.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-text-secondary dark:text-text-secondary-dark">La Reina</h3>
                                    <p id="stats-la-reina" class="text-4xl font-bold text-brand-primary">0</p>
                                    <p class="text-sm text-text-secondary dark:text-text-secondary-dark mt-1">Inspecciones</p>
                                </div>
                                <div class="bg-brand-light/20 dark:bg-brand-light/10 p-4 rounded-full">
                                    <i data-lucide="map-pin" class="h-7 w-7 text-brand-light"></i>
                                </div>
                            </div>
                            <div class="mt-4">
                                <div class="flex justify-between text-xs text-text-secondary dark:text-text-secondary-dark">
                                    <span id="la-reina-progress-text">0%</span>
                                    <span>Progreso</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 mt-1">
                                    <div id="la-reina-progress-bar" class="bg-brand-primary h-1.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-text-secondary dark:text-text-secondary-dark">Maria Angelica</h3>
                                    <p id="stats-maria-angelica" class="text-4xl font-bold text-brand-primary">0</p>
                                    <p class="text-sm text-text-secondary dark:text-text-secondary-dark mt-1">Inspecciones</p>
                                </div>
                                <div class="bg-brand-light/20 dark:bg-brand-light/10 p-4 rounded-full">
                                    <i data-lucide="map-pin" class="h-7 w-7 text-brand-light"></i>
                                </div>
                            </div>
                            <div class="mt-4">
                                <div class="flex justify-between text-xs text-text-secondary dark:text-text-secondary-dark">
                                    <span id="maria-angelica-progress-text">0%</span>
                                    <span>Progreso</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 mt-1">
                                    <div id="maria-angelica-progress-bar" class="bg-brand-primary h-1.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-text-secondary dark:text-text-secondary-dark">El Descanso</h3>
                                    <p id="stats-el-descanso" class="text-4xl font-bold text-brand-primary">0</p>
                                    <p class="text-sm text-text-secondary dark:text-text-secondary-dark mt-1">Inspecciones</p>
                                </div>
                                <div class="bg-brand-light/20 dark:bg-brand-light/10 p-4 rounded-full">
                                    <i data-lucide="map-pin" class="h-7 w-7 text-brand-light"></i>
                                </div>
                            </div>
                            <div class="mt-4">
                                <div class="flex justify-between text-xs text-text-secondary dark:text-text-secondary-dark">
                                    <span id="el-descanso-progress-text">0%</span>
                                    <span>Progreso</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 mt-1">
                                    <div id="el-descanso-progress-bar" class="bg-brand-primary h-1.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md mb-6">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                            <h3 class="text-lg font-bold text-text-primary dark:text-text-primary-dark mb-2 md:mb-0">Mapa de Actividad</h3>
                            <div class="flex flex-wrap gap-2">
                                <button id="map-view-standard" class="map-toggle px-3 py-1.5 text-xs font-medium rounded-lg bg-brand-light text-white hover:bg-brand-primary transition-colors">
                                    <i data-lucide="map" class="h-3.5 w-3.5 inline-block mr-1"></i> Estándar
                                </button>
                                <button id="map-view-heat" class="map-toggle px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-brand-light hover:text-white dark:hover:bg-brand-light transition-colors">
                                    <i data-lucide="flame" class="h-3.5 w-3.5 inline-block mr-1"></i> Mapa de Calor
                                </button>
                                <button id="map-view-clusters" class="map-toggle px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-brand-light hover:text-white dark:hover:bg-brand-light transition-colors">
                                    <i data-lucide="circle-dot" class="h-3.5 w-3.5 inline-block mr-1"></i> Clusters
                                </button>
                                <button id="map-view-terminals" class="map-toggle px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-brand-light hover:text-white dark:hover:bg-brand-light transition-colors">
                                    <i data-lucide="target" class="h-3.5 w-3.5 inline-block mr-1"></i> Terminales
                                </button>
                            </div>
                        </div>
                        <div id="map" class="h-[400px] w-full rounded-lg z-0"></div>
                        <div class="flex flex-wrap justify-between items-center mt-4 text-sm text-text-secondary dark:text-text-secondary-dark">
                            <div class="flex items-center space-x-4">
                                <span class="flex items-center"><i data-lucide="map-pin" class="h-4 w-4 mr-1 text-status-red"></i> Inspecciones</span>
                                <span class="flex items-center"><i data-lucide="user" class="h-4 w-4 mr-1 text-brand-secondary"></i> Mi Ubicación</span>
                                <span class="flex items-center"><i data-lucide="bullseye" class="h-4 w-4 mr-1 text-brand-light"></i> Terminales</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <span class="h-2 w-2 bg-status-green rounded-full"></span>
                                <span class="flex items-center"><strong id="active-users-count" class="text-brand-primary dark:text-brand-light mr-1">0</strong> Usuario Activo</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                            <h3 class="text-lg font-bold mb-4 text-text-primary dark:text-text-primary-dark flex items-center">
                                <i data-lucide="paintbrush-2" class="h-5 w-5 mr-2 text-status-red"></i>Buses con Daño de Pintura
                            </h3>
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-3 mb-4">
                                <div class="flex justify-between items-center">
                                    <div class="text-lg font-bold text-text-primary dark:text-text-primary-dark" id="damage-count">0</div>
                                    <div class="text-sm text-text-secondary dark:text-text-secondary-dark">buses afectados</div>
                                </div>
                            </div>
                            <ul id="dashboard-damage-list" class="space-y-2 max-h-[200px] overflow-y-auto pr-2">
                                <li class="text-text-secondary dark:text-text-secondary-dark text-center py-2">Cargando datos...</li>
                            </ul>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                            <h3 class="text-lg font-bold mb-4 text-text-primary dark:text-text-primary-dark flex items-center">
                                <i data-lucide="sticky-note" class="h-5 w-5 mr-2 text-status-yellow"></i>Buses con Residuos de Pegamento
                            </h3>
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-3 mb-4">
                                <div class="flex justify-between items-center">
                                    <div class="text-lg font-bold text-text-primary dark:text-text-primary-dark" id="residue-count">0</div>
                                    <div class="text-sm text-text-secondary dark:text-text-secondary-dark">buses afectados</div>
                                </div>
                            </div>
                            <ul id="dashboard-residue-list" class="space-y-2 max-h-[200px] overflow-y-auto pr-2">
                                <li class="text-text-secondary dark:text-text-secondary-dark text-center py-2">Cargando datos...</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Form View -->
                <div id="form-view" class="view">
                    <!-- Header responsivo -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 sm:mb-6">
                        <h2 class="text-xl sm:text-2xl font-bold text-text-primary dark:text-text-primary-dark">Nuevo Registro de Inspección</h2>
                        <button id="open-pending-modal-btn" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-status-yellow hover:bg-amber-500 text-black font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 text-sm sm:text-base">
                            <i data-lucide="list-todo" class="h-4 w-4"></i> 
                            <span class="hidden xs:inline">Ver Buses Pendientes</span>
                            <span class="xs:hidden">Pendientes</span>
                        </button>
                    </div>
                    
                    <!-- Formulario completamente responsivo -->
                    <form id="inspection-form" class="bg-white dark:bg-gray-800 p-3 sm:p-4 md:p-6 rounded-xl shadow-md max-w-4xl mx-auto space-y-6 sm:space-y-8">
                        <!-- Sección de Información del Bus - Responsiva -->
                        <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                            <div class="flex items-center mb-4 sm:mb-6">
                                <div class="h-6 w-6 sm:h-8 sm:w-8 rounded-full bg-brand-light flex items-center justify-center mr-2 sm:mr-3">
                                    <i data-lucide="bus" class="h-4 w-4 sm:h-5 sm:w-5 text-white"></i>
                                </div>
                                <h3 class="text-lg sm:text-xl font-semibold text-text-primary dark:text-text-primary-dark">Información del Bus</h3>
                            </div>
                            
                            <!-- Grid responsivo para campos del bus -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                                <div class="relative">
                                    <label for="ppu" class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-1">PPU / N° Interno</label>
                                    <div class="relative">
                                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="search" class="h-4 w-4 text-gray-400"></i>
                                        </span>
                                        <input type="text" id="ppu" name="ppu" required class="pl-10 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-brand-primary focus:ring focus:ring-brand-primary focus:ring-opacity-50 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark" placeholder="Buscar bus...">
                                    </div>
                                    <div id="suggestions-box" class="absolute z-20 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md mt-1 max-h-60 overflow-y-auto shadow-lg hidden"></div>
                                </div>
                                <div>
                                    <label for="numero_interno" class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-1">N° Interno</label>
                                    <input type="text" id="numero_interno" name="numero_interno" readonly class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-100 dark:bg-gray-800 text-text-primary dark:text-text-primary-dark cursor-not-allowed">
                                </div>
                                <div>
                                    <label for="marca_chasis" class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-1">Marca Chasis</label>
                                    <input type="text" id="marca_chasis" name="marca_chasis" readonly class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-100 dark:bg-gray-800 text-text-primary dark:text-text-primary-dark cursor-not-allowed">
                                </div>
                            </div>
                            <!-- Información de ubicación e inspector - Responsiva -->
                            <div class="mt-4 space-y-2 sm:space-y-3">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-2">
                                    <span class="text-xs sm:text-sm font-medium text-text-secondary dark:text-text-secondary-dark">Ubicación actual:</span>
                                    <span id="current-terminal" class="text-xs sm:text-sm font-semibold text-brand-primary dark:text-brand-light">Detectando...</span>
                                </div>
                                <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-2">
                                    <span class="text-xs sm:text-sm font-medium text-text-secondary dark:text-text-secondary-dark">Inspector asignado:</span>
                                    <span id="current-inspector" class="text-xs sm:text-sm font-semibold text-brand-secondary dark:text-brand-light">Detectando...</span>
                                </div>
                                <div id="bus-status-indicator" class="mt-2 hidden">
                                    <div class="flex items-center space-x-2 p-2 bg-yellow-50 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-700 rounded-md">
                                        <i data-lucide="alert-triangle" class="h-4 w-4 text-yellow-600 dark:text-yellow-400"></i>
                                        <span class="text-xs sm:text-sm text-yellow-800 dark:text-yellow-200 font-medium">Bus ya inspeccionado - Ver alerta arriba</span>
                                    </div>
                                </div>
                                <!-- Indicadores de estado - Responsivos -->
                                <div class="flex flex-wrap gap-2 mt-2">
                                    <div class="text-xs text-text-secondary dark:text-text-secondary-dark flex items-center">
                                        <i data-lucide="info" class="h-3 w-3 mr-1"></i>
                                        <span class="hidden sm:inline">Conectado</span>
                                    </div>
                                    <div class="text-xs text-green-600 dark:text-green-400 flex items-center">
                                        <i data-lucide="wifi" class="h-3 w-3 mr-1"></i>
                                        <span class="hidden sm:inline">GPS Activo</span>
                                    </div>
                                    <div class="text-xs text-blue-600 dark:text-blue-400 flex items-center">
                                        <i data-lucide="target" class="h-3 w-3 mr-1"></i>
                                        <span class="hidden sm:inline">Tiempo Real</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sección de Estado de Publicidad - Responsiva -->
                        <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                            <div class="flex items-center mb-4 sm:mb-6">
                                <div class="h-6 w-6 sm:h-8 sm:w-8 rounded-full bg-brand-light flex items-center justify-center mr-2 sm:mr-3">
                                    <i data-lucide="layout-dashboard" class="h-4 w-4 sm:h-5 sm:w-5 text-white"></i>
                                </div>
                                <h3 class="text-lg sm:text-xl font-semibold text-text-primary dark:text-text-primary-dark">Estado de la Publicidad</h3>
                            </div>
                            
                            <!-- Grid responsivo para publicidad -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8">
                                <fieldset class="space-y-3">
                                    <legend class="text-base sm:text-lg font-semibold text-text-primary dark:text-text-primary-dark">Publicidad Izquierda</legend>
                                    <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-2 sm:space-y-0">
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="pub_izq_si" name="publicidad_izquierda" value="true" class="form-radio h-4 w-4 text-brand-primary border-gray-300 focus:ring-brand-primary">
                                            <span class="ml-2 text-sm sm:text-base text-text-primary dark:text-text-primary-dark">Sí</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="pub_izq_no" name="publicidad_izquierda" value="false" checked class="form-radio h-4 w-4 text-brand-primary border-gray-300 focus:ring-brand-primary">
                                            <span class="ml-2 text-sm sm:text-base text-text-primary dark:text-text-primary-dark">No</span>
                                        </label>
                                    </div>
                                    <textarea id="publicidad_izquierda_detalle" name="publicidad_izquierda_detalle" rows="3" class="hidden mt-2 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-brand-primary focus:ring focus:ring-brand-primary focus:ring-opacity-50 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark text-sm" placeholder="Detalle de la publicidad..."></textarea>
                                    <div id="pub-izq-photo-container" class="hidden mt-2">
                                        <button type="button" id="pub-izq-photo-btn" class="w-full flex items-center justify-center py-2 px-3 sm:px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-xs sm:text-sm font-medium text-text-primary dark:text-text-primary-dark bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                                            <i data-lucide="camera" class="h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2"></i> 
                                            <span class="hidden sm:inline">Tomar Foto</span>
                                            <span class="sm:hidden">Foto</span>
                                        </button>
                                        <div id="pub-izq-photo-preview" class="mt-2 hidden">
                                            <img src="" alt="Vista previa" class="w-full h-auto rounded-md">
                                        </div>
                                    </div>
                                </fieldset>
                                <fieldset class="space-y-3">
                                    <legend class="text-base sm:text-lg font-semibold text-text-primary dark:text-text-primary-dark">Publicidad Luneta</legend>
                                    <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-2 sm:space-y-0">
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="pub_luneta_si" name="publicidad_luneta" value="true" class="form-radio h-4 w-4 text-brand-primary border-gray-300 focus:ring-brand-primary">
                                            <span class="ml-2 text-sm sm:text-base text-text-primary dark:text-text-primary-dark">Sí</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="pub_luneta_no" name="publicidad_luneta" value="false" checked class="form-radio h-4 w-4 text-brand-primary border-gray-300 focus:ring-brand-primary">
                                            <span class="ml-2 text-sm sm:text-base text-text-primary dark:text-text-primary-dark">No</span>
                                        </label>
                                    </div>
                                    <textarea id="publicidad_luneta_detalle" name="publicidad_luneta_detalle" rows="3" class="hidden mt-2 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-brand-primary focus:ring focus:ring-brand-primary focus:ring-opacity-50 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark text-sm" placeholder="Detalle de la publicidad..."></textarea>
                                    <div id="pub-luneta-photo-container" class="hidden mt-2">
                                        <button type="button" id="pub-luneta-photo-btn" class="w-full flex items-center justify-center py-2 px-3 sm:px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-xs sm:text-sm font-medium text-text-primary dark:text-text-primary-dark bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                                            <i data-lucide="camera" class="h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2"></i> 
                                            <span class="hidden sm:inline">Tomar Foto</span>
                                            <span class="sm:hidden">Foto</span>
                                        </button>
                                        <div id="pub-luneta-photo-preview" class="mt-2 hidden">
                                            <img src="" alt="Vista previa" class="w-full h-auto rounded-md">
                                        </div>
                                    </div>
                                </fieldset>
                                <fieldset class="space-y-3">
                                    <legend class="text-base sm:text-lg font-semibold text-text-primary dark:text-text-primary-dark">Publicidad Derecha (DTPM)</legend>
                                    <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-2 sm:space-y-0">
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="pub_der_si" name="publicidad_derecha" value="true" class="form-radio h-4 w-4 text-brand-primary border-gray-300 focus:ring-brand-primary">
                                            <span class="ml-2 text-sm sm:text-base text-text-primary dark:text-text-primary-dark">Sí</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="pub_der_no" name="publicidad_derecha" value="false" checked class="form-radio h-4 w-4 text-brand-primary border-gray-300 focus:ring-brand-primary">
                                            <span class="ml-2 text-sm sm:text-base text-text-primary dark:text-text-primary-dark">No</span>
                                        </label>
                                    </div>
                                    <textarea id="publicidad_derecha_detalle" name="publicidad_derecha_detalle" rows="3" class="hidden mt-2 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-brand-primary focus:ring focus:ring-brand-primary focus:ring-opacity-50 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark text-sm" placeholder="Detalle de la publicidad..."></textarea>
                                    <div id="pub-der-photo-container" class="hidden mt-2">
                                        <button type="button" id="pub-der-photo-btn" class="w-full flex items-center justify-center py-2 px-3 sm:px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-xs sm:text-sm font-medium text-text-primary dark:text-text-primary-dark bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                                            <i data-lucide="camera" class="h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2"></i> 
                                            <span class="hidden sm:inline">Tomar Foto</span>
                                            <span class="sm:hidden">Foto</span>
                                        </button>
                                        <div id="pub-der-photo-preview" class="mt-2 hidden">
                                            <img src="" alt="Vista previa" class="w-full h-auto rounded-md">
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>

                        <!-- Sección de Observaciones Adicionales - Responsiva -->
                        <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                            <div class="flex items-center mb-4 sm:mb-6">
                                <div class="h-6 w-6 sm:h-8 sm:w-8 rounded-full bg-brand-light flex items-center justify-center mr-2 sm:mr-3">
                                    <i data-lucide="alert-triangle" class="h-4 w-4 sm:h-5 sm:w-5 text-white"></i>
                                </div>
                                <h3 class="text-lg sm:text-xl font-semibold text-text-primary dark:text-text-primary-dark">Observaciones Adicionales</h3>
                            </div>
                            
                            <!-- Grid responsivo para observaciones -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
                                <fieldset class="space-y-3">
                                    <legend class="text-base sm:text-lg font-semibold text-text-primary dark:text-text-primary-dark">Residuos de Pegamento</legend>
                                    <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-2 sm:space-y-0">
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="residuos_si" name="residuos_pegamento" value="true" class="form-radio h-4 w-4 text-brand-primary border-gray-300 focus:ring-brand-primary">
                                            <span class="ml-2 text-sm sm:text-base text-text-primary dark:text-text-primary-dark">Sí</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="residuos_no" name="residuos_pegamento" value="false" checked class="form-radio h-4 w-4 text-brand-primary border-gray-300 focus:ring-brand-primary">
                                            <span class="ml-2 text-sm sm:text-base text-text-primary dark:text-text-primary-dark">No</span>
                                        </label>
                                    </div>
                                    <textarea id="residuos_pegamento_detalle" name="residuos_pegamento_detalle" rows="3" class="hidden mt-2 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-brand-primary focus:ring focus:ring-brand-primary focus:ring-opacity-50 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark text-sm" placeholder="Ubicación y detalle de residuos..."></textarea>
                                    <div id="residuos-photo-container" class="hidden mt-2">
                                        <button type="button" id="residuos-photo-btn" class="w-full flex items-center justify-center py-2 px-3 sm:px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-xs sm:text-sm font-medium text-text-primary dark:text-text-primary-dark bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                                            <i data-lucide="camera" class="h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2"></i> 
                                            <span class="hidden sm:inline">Tomar Foto</span>
                                            <span class="sm:hidden">Foto</span>
                                        </button>
                                        <div id="residuos-photo-preview" class="mt-2 hidden">
                                            <img src="" alt="Vista previa" class="w-full h-auto rounded-md">
                                        </div>
                                    </div>
                                </fieldset>
                                <fieldset class="space-y-3">
                                    <legend class="text-base sm:text-lg font-semibold text-text-primary dark:text-text-primary-dark">Daño de Pintura</legend>
                                    <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-2 sm:space-y-0">
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="dano_si" name="dano_pintura" value="true" class="form-radio h-4 w-4 text-brand-primary border-gray-300 focus:ring-brand-primary">
                                            <span class="ml-2 text-sm sm:text-base text-text-primary dark:text-text-primary-dark">Sí</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" id="dano_no" name="dano_pintura" value="false" checked class="form-radio h-4 w-4 text-brand-primary border-gray-300 focus:ring-brand-primary">
                                            <span class="ml-2 text-sm sm:text-base text-text-primary dark:text-text-primary-dark">No</span>
                                        </label>
                                    </div>
                                    <textarea id="dano_pintura_detalle" name="dano_pintura_detalle" rows="3" class="hidden mt-2 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-brand-primary focus:ring focus:ring-brand-primary focus:ring-opacity-50 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark text-sm" placeholder="Ubicación y detalle del daño..."></textarea>
                                    <div id="dano-photo-container" class="hidden mt-2">
                                        <button type="button" id="dano-photo-btn" class="w-full flex items-center justify-center py-2 px-3 sm:px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-xs sm:text-sm font-medium text-text-primary dark:text-text-primary-dark bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                                            <i data-lucide="camera" class="h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2"></i> 
                                            <span class="hidden sm:inline">Tomar Foto</span>
                                            <span class="sm:hidden">Foto</span>
                                        </button>
                                        <div id="dano-photo-preview" class="mt-2 hidden">
                                            <img src="" alt="Vista previa" class="w-full h-auto rounded-md">
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        
                        <!-- Botones del formulario - Completamente responsivos -->
                        <div class="flex flex-col sm:flex-row justify-end gap-3 pt-4">
                            <button type="button" onclick="reinitializeForm()" class="w-full sm:w-auto bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-3 sm:px-4 rounded-lg flex items-center justify-center shadow-md transition-colors duration-200 text-sm sm:text-base" title="Reinicializar formulario si hay problemas">
                                <i data-lucide="refresh-cw" class="h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2"></i> 
                                <span class="hidden sm:inline">Reinicializar</span>
                                <span class="sm:hidden">Reiniciar</span>
                            </button>
                            <button type="button" id="form-save-draft" class="w-full sm:w-auto bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-text-primary dark:text-text-primary-dark font-medium py-2 px-3 sm:px-4 rounded-lg flex items-center justify-center shadow-md transition-colors duration-200 text-sm sm:text-base">
                                <i data-lucide="archive" class="h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2"></i> 
                                <span class="hidden sm:inline">Guardar Borrador</span>
                                <span class="sm:hidden">Borrador</span>
                            </button>
                            <button type="submit" class="w-full sm:w-auto bg-brand-secondary hover:bg-brand-dark text-white font-bold py-2 px-4 sm:px-6 rounded-lg flex items-center justify-center shadow-md hover:shadow-lg transition-all duration-300 ease-in-out text-sm sm:text-base">
                                <i data-lucide="save" class="h-3 w-3 sm:h-4 sm:w-4 mr-1 sm:mr-2"></i> 
                                <span class="hidden sm:inline">Guardar Registro</span>
                                <span class="sm:hidden">Guardar</span>
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Fleet View -->
                <div id="fleet-view" class="view">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold text-text-primary dark:text-text-primary-dark">Flota de Buses</h2>
                        <div class="flex flex-wrap gap-2">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="search" class="h-4 w-4 text-gray-400"></i>
                                </span>
                                <input type="text" id="fleet-search" placeholder="Buscar por PPU o N° Interno..." class="pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                            </div>
                            <select id="fleet-filter" class="py-2 px-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                                <option value="all">Todos los buses</option>
                                <option value="inspected">Inspeccionados</option>
                                <option value="pending">Pendientes</option>
                                <option value="damaged">Con daños</option>
                                <option value="residue">Con residuos</option>
                            </select>
                            <select id="fleet-terminal-filter" class="py-2 px-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                                <option value="all">Todos los terminales</option>
                                <option value="El Roble">El Roble</option>
                                <option value="La Reina">La Reina</option>
                                <option value="Maria Angelica">Maria Angelica</option>
                                <option value="El Descanso">El Descanso</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-6">
                        <div class="flex flex-wrap gap-4 mb-4">
                            <div class="flex-1 min-w-[180px] bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                                <div class="text-sm text-text-secondary dark:text-text-secondary-dark">Total de buses</div>
                                <div class="mt-1 text-2xl font-bold text-text-primary dark:text-text-primary-dark" id="fleet-total-count">0</div>
                            </div>
                            <div class="flex-1 min-w-[180px] bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                                <div class="text-sm text-text-secondary dark:text-text-secondary-dark">Inspeccionados</div>
                                <div class="mt-1 text-2xl font-bold text-status-green" id="fleet-inspected-count">0</div>
                            </div>
                            <div class="flex-1 min-w-[180px] bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                                <div class="text-sm text-text-secondary dark:text-text-secondary-dark">Pendientes</div>
                                <div class="mt-1 text-2xl font-bold text-status-yellow" id="fleet-pending-count">0</div>
                            </div>
                            <div class="flex-1 min-w-[180px] bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                                <div class="text-sm text-text-secondary dark:text-text-secondary-dark">Con problemas</div>
                                <div class="mt-1 text-2xl font-bold text-status-red" id="fleet-issues-count">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="fleet-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        <div class="bg-gray-100 dark:bg-gray-700 animate-pulse h-32 rounded-lg"></div>
                        <div class="bg-gray-100 dark:bg-gray-700 animate-pulse h-32 rounded-lg"></div>
                        <div class="bg-gray-100 dark:bg-gray-700 animate-pulse h-32 rounded-lg"></div>
                        <div class="bg-gray-100 dark:bg-gray-700 animate-pulse h-32 rounded-lg"></div>
                        <div class="bg-gray-100 dark:bg-gray-700 animate-pulse h-32 rounded-lg"></div>
                    </div>
                    
                    <div id="fleet-empty-state" class="hidden text-center py-12">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-gray-100 dark:bg-gray-700">
                            <i data-lucide="bus" class="h-6 w-6 text-gray-400 dark:text-gray-500"></i>
                        </div>
                        <h3 class="mt-4 text-lg font-medium text-text-primary dark:text-text-primary-dark">No se encontraron buses</h3>
                        <p class="mt-2 text-sm text-text-secondary dark:text-text-secondary-dark">
                            Intenta ajustar los filtros o buscar con otros términos.
                        </p>
                    </div>
                    
                    <div class="flex justify-center mt-6">
                        <nav class="flex items-center space-x-2" id="fleet-pagination">
                            <button id="fleet-prev-page" class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 text-text-secondary dark:text-text-secondary-dark hover:bg-brand-light hover:text-white disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="chevron-left" class="h-4 w-4"></i>
                            </button>
                            <span id="fleet-page-info" class="text-sm text-text-secondary dark:text-text-secondary-dark">Página 1 de 1</span>
                            <button id="fleet-next-page" class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 text-text-secondary dark:text-text-secondary-dark hover:bg-brand-light hover:text-white disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="chevron-right" class="h-4 w-4"></i>
                            </button>
                        </nav>
                    </div>
                </div>
                
                <!-- Assistance View -->
                <div id="assistance-view" class="view">
                    <h2 class="text-2xl font-bold mb-6 text-text-primary dark:text-text-primary-dark">Centro de Asistencia</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-status-red dark:text-status-red flex items-center">
                                    <i data-lucide="paintbrush-2" class="h-5 w-5 mr-2"></i>Buses con Daño de Pintura
                                </h3>
                                <span id="damage-count-badge" class="badge bg-status-red text-white">0</span>
                            </div>
                            <div class="flex mb-4">
                                <div class="relative flex-1">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="search" class="h-4 w-4 text-gray-400"></i>
                                    </span>
                                    <input type="text" id="damage-search" placeholder="Buscar por PPU o N° Interno..." class="pl-10 pr-4 py-2 w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                                </div>
                            </div>
                            <ul id="damage-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                                <li class="text-text-secondary dark:text-text-secondary-dark text-center py-2">Cargando datos...</li>
                            </ul>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-status-yellow dark:text-status-yellow flex items-center">
                                    <i data-lucide="sticky-note" class="h-5 w-5 mr-2"></i>Buses con Residuos de Pegamento
                                </h3>
                                <span id="residue-count-badge" class="badge bg-status-yellow text-black">0</span>
                            </div>
                            <div class="flex mb-4">
                                <div class="relative flex-1">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="search" class="h-4 w-4 text-gray-400"></i>
                                    </span>
                                    <input type="text" id="residue-search" placeholder="Buscar por PPU o N° Interno..." class="pl-10 pr-4 py-2 w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                                </div>
                            </div>
                            <ul id="residue-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                                <li class="text-text-secondary dark:text-text-secondary-dark text-center py-2">Cargando datos...</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-6 text-text-primary dark:text-text-primary-dark flex items-center">
                            <i data-lucide="clipboard-list" class="h-5 w-5 mr-2 text-brand-light"></i>Registro de Mantenimiento
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full data-table">
                                <thead>
                                    <tr class="bg-gray-50 dark:bg-gray-900 text-left text-xs font-medium text-text-secondary dark:text-text-secondary-dark uppercase tracking-wider">
                                        <th class="px-6 py-3 rounded-tl-lg">PPU</th>
                                        <th class="px-6 py-3">N° Interno</th>
                                        <th class="px-6 py-3">Tipo</th>
                                        <th class="px-6 py-3">Detalle</th>
                                        <th class="px-6 py-3">Terminal</th>
                                        <th class="px-6 py-3">Fecha</th>
                                        <th class="px-6 py-3 rounded-tr-lg">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenance-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr>
                                        <td colspan="7" class="px-6 py-4 text-center text-text-secondary dark:text-text-secondary-dark">
                                            No hay registros de mantenimiento.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Reports View -->
                <div id="reports-view" class="view">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold text-text-primary dark:text-text-primary-dark">Reportes e Informes</h2>
                        <div class="flex flex-wrap gap-2">
                            <button id="export-excel-btn" class="flex items-center bg-status-green hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-colors duration-200">
                                <i data-lucide="file-spreadsheet" class="h-4 w-4 mr-2"></i> Exportar a Excel
                            </button>
                            <button id="export-pdf-btn" class="flex items-center bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-colors duration-200">
                                <i data-lucide="file-text" class="h-4 w-4 mr-2"></i> Exportar a PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md card-hover">
                            <div class="flex items-center">
                                <div class="bg-brand-light/20 dark:bg-brand-light/10 p-3 rounded-lg mr-4">
                                    <i data-lucide="check-circle" class="h-8 w-8 text-status-green"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-text-primary dark:text-text-primary-dark">Total de Inspecciones</h3>
                                    <p id="report-total-inspections" class="text-3xl font-bold text-brand-primary dark:text-brand-light">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md card-hover">
                            <div class="flex items-center">
                                <div class="bg-brand-light/20 dark:bg-brand-light/10 p-3 rounded-lg mr-4">
                                    <i data-lucide="shield-alert" class="h-8 w-8 text-status-red"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-text-primary dark:text-text-primary-dark">Buses con Daño</h3>
                                    <p id="report-total-damages" class="text-3xl font-bold text-status-red">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md card-hover">
                            <div class="flex items-center">
                                <div class="bg-brand-light/20 dark:bg-brand-light/10 p-3 rounded-lg mr-4">
                                    <i data-lucide="alert-triangle" class="h-8 w-8 text-status-yellow"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-text-primary dark:text-text-primary-dark">Buses con Residuos</h3>
                                    <p id="report-total-residues" class="text-3xl font-bold text-status-yellow">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md mb-6">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                            <h3 class="text-xl font-bold text-text-primary dark:text-text-primary-dark flex items-center">
                                <i data-lucide="bar-chart-2" class="h-5 w-5 mr-2 text-brand-light"></i>Estadísticas por Terminal
                            </h3>
                            <div class="flex space-x-2 mt-3 md:mt-0">
                                <button class="terminal-filter px-3 py-1 text-xs font-medium rounded-full bg-brand-light text-white hover:bg-brand-primary transition-colors" data-terminal="all">Todos</button>
                                <button class="terminal-filter px-3 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-brand-light hover:text-white dark:hover:bg-brand-light transition-colors" data-terminal="El Roble">El Roble</button>
                                <button class="terminal-filter px-3 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-brand-light hover:text-white dark:hover:bg-brand-light transition-colors" data-terminal="La Reina">La Reina</button>
                                <button class="terminal-filter px-3 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-brand-light hover:text-white dark:hover:bg-brand-light transition-colors" data-terminal="Maria Angelica">Maria Angelica</button>
                                <button class="terminal-filter px-3 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-brand-light hover:text-white dark:hover:bg-brand-light transition-colors" data-terminal="El Descanso">El Descanso</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="h-[300px]">
                                <canvas id="terminal-stats-chart"></canvas>
                            </div>
                            <div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full data-table">
                                        <thead>
                                            <tr class="bg-gray-50 dark:bg-gray-900 text-left text-xs font-medium text-text-secondary dark:text-text-secondary-dark uppercase tracking-wider">
                                                <th class="px-4 py-3 rounded-tl-lg">Terminal</th>
                                                <th class="px-4 py-3">Inspecciones</th>
                                                <th class="px-4 py-3">Con Daños</th>
                                                <th class="px-4 py-3">Con Residuos</th>
                                                <th class="px-4 py-3 rounded-tr-lg">Progreso</th>
                                            </tr>
                                        </thead>
                                        <tbody id="terminal-stats-table" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            <tr class="animate-pulse">
                                                <td class="px-4 py-3">
                                                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/4"></div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/3"></div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <div class="border-b border-gray-200 dark:border-gray-700">
                            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                <a href="#" id="tab-residues" class="tab-link border-brand-secondary text-brand-secondary dark:text-brand-light dark:border-brand-light whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Buses con Residuos</a>
                                <a href="#" id="tab-damages" class="tab-link border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Buses con Daños</a>
                                <a href="#" id="tab-all" class="tab-link border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Todos los Registros</a>
                            </nav>
                        </div>
                        
                        <div id="report-content-residues" class="report-content mt-6">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                <p class="text-text-secondary dark:text-text-secondary-dark mb-3 md:mb-0">Listado de todos los buses con reportes de residuos de pegamento.</p>
                                <div class="flex space-x-2">
                                    <div class="relative">
                                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="search" class="h-4 w-4 text-gray-400"></i>
                                        </span>
                                        <input type="text" id="residues-report-search" placeholder="Buscar..." class="pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                                    </div>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full data-table">
                                    <thead>
                                        <tr class="bg-gray-50 dark:bg-gray-900 text-left text-xs font-medium text-text-secondary dark:text-text-secondary-dark uppercase tracking-wider">
                                            <th class="px-6 py-3 rounded-tl-lg">PPU</th>
                                            <th class="px-6 py-3">N° Interno</th>
                                            <th class="px-6 py-3">Marca</th>
                                            <th class="px-6 py-3">Terminal</th>
                                            <th class="px-6 py-3">Detalle</th>
                                            <th class="px-6 py-3">Fecha</th>
                                            <th class="px-6 py-3 rounded-tr-lg">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-list-residues" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                        <tr>
                                            <td colspan="7" class="px-6 py-4 text-center text-text-secondary dark:text-text-secondary-dark">
                                                Cargando datos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="report-content-damages" class="report-content mt-6 hidden">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                <p class="text-text-secondary dark:text-text-secondary-dark mb-3 md:mb-0">Listado de todos los buses con reportes de daños en la pintura.</p>
                                <div class="flex space-x-2">
                                    <div class="relative">
                                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="search" class="h-4 w-4 text-gray-400"></i>
                                        </span>
                                        <input type="text" id="damages-report-search" placeholder="Buscar..." class="pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                                    </div>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full data-table">
                                    <thead>
                                        <tr class="bg-gray-50 dark:bg-gray-900 text-left text-xs font-medium text-text-secondary dark:text-text-secondary-dark uppercase tracking-wider">
                                            <th class="px-6 py-3 rounded-tl-lg">PPU</th>
                                            <th class="px-6 py-3">N° Interno</th>
                                            <th class="px-6 py-3">Marca</th>
                                            <th class="px-6 py-3">Terminal</th>
                                            <th class="px-6 py-3">Detalle</th>
                                            <th class="px-6 py-3">Fecha</th>
                                            <th class="px-6 py-3 rounded-tr-lg">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-list-damages" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                        <tr>
                                            <td colspan="7" class="px-6 py-4 text-center text-text-secondary dark:text-text-secondary-dark">
                                                Cargando datos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="report-content-all" class="report-content mt-6 hidden">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                <p class="text-text-secondary dark:text-text-secondary-dark mb-3 md:mb-0">Listado completo de todas las inspecciones.</p>
                                <div class="flex space-x-2">
                                    <div class="relative">
                                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="search" class="h-4 w-4 text-gray-400"></i>
                                        </span>
                                        <input type="text" id="all-report-search" placeholder="Buscar..." class="pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                                    </div>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full data-table">
                                    <thead>
                                        <tr class="bg-gray-50 dark:bg-gray-900 text-left text-xs font-medium text-text-secondary dark:text-text-secondary-dark uppercase tracking-wider">
                                            <th class="px-6 py-3 rounded-tl-lg">PPU</th>
                                            <th class="px-6 py-3">N° Interno</th>
                                            <th class="px-6 py-3">Terminal</th>
                                            <th class="px-6 py-3">Pub. Izq.</th>
                                            <th class="px-6 py-3">Pub. Luneta</th>
                                            <th class="px-6 py-3">Pub. Der.</th>
                                            <th class="px-6 py-3">Residuos</th>
                                            <th class="px-6 py-3">Daños</th>
                                            <th class="px-6 py-3">Fecha</th>
                                            <th class="px-6 py-3 rounded-tr-lg">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-list-all" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                        <tr>
                                            <td colspan="10" class="px-6 py-4 text-center text-text-secondary dark:text-text-secondary-dark">
                                                Cargando datos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="flex justify-between items-center mt-4">
                                <div class="text-sm text-text-secondary dark:text-text-secondary-dark">
                                    Mostrando <span id="all-report-showing">0</span> de <span id="all-report-total">0</span> registros
                                </div>
                                <div class="flex space-x-2">
                                    <button id="all-report-prev" class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 text-text-secondary dark:text-text-secondary-dark hover:bg-brand-light hover:text-white disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i data-lucide="chevron-left" class="h-4 w-4"></i>
                                    </button>
                                    <span id="all-report-page" class="px-3 py-1 text-sm text-text-secondary dark:text-text-secondary-dark">
                                        Página 1 de 1
                                    </span>
                                    <button id="all-report-next" class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 text-text-secondary dark:text-text-secondary-dark hover:bg-brand-light hover:text-white disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i data-lucide="chevron-right" class="h-4 w-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics View -->
                <div id="analytics-view" class="view">
                    <h2 class="text-2xl font-bold mb-6 text-text-primary dark:text-text-primary-dark">Analítica Avanzada</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-text-primary dark:text-text-primary-dark flex items-center">
                                    <i data-lucide="bar-chart-3" class="h-5 w-5 mr-2 text-brand-light"></i>
                                    Tendencias de Inspección
                                </h3>
                                <div class="flex space-x-2">
                                    <button class="trends-period px-3 py-1 text-xs font-medium rounded-full bg-brand-light text-white hover:bg-brand-primary transition-colors" data-period="7">7 días</button>
                                    <button class="trends-period px-3 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-brand-light hover:text-white dark:hover:bg-brand-light transition-colors" data-period="30">30 días</button>
                                    <button class="trends-period px-3 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-brand-light hover:text-white dark:hover:bg-brand-light transition-colors" data-period="90">90 días</button>
                                </div>
                            </div>
                            <div class="h-[300px]">
                                <canvas id="trends-chart"></canvas>
                            </div>
                            <div class="grid grid-cols-3 gap-4 mt-4 text-center">
                                <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <div class="text-xs text-text-secondary dark:text-text-secondary-dark">Promedio Diario</div>
                                    <div id="avg-daily" class="mt-1 text-lg font-bold text-text-primary dark:text-text-primary-dark">-</div>
                                </div>
                                <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <div class="text-xs text-text-secondary dark:text-text-secondary-dark">Tendencia</div>
                                    <div id="trend-indicator" class="mt-1 text-lg font-bold">-</div>
                                </div>
                                <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <div class="text-xs text-text-secondary dark:text-text-secondary-dark">Proyección</div>
                                    <div id="projection" class="mt-1 text-lg font-bold text-brand-light">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-text-primary dark:text-text-primary-dark flex items-center">
                                    <i data-lucide="pie-chart" class="h-5 w-5 mr-2 text-brand-light"></i>
                                    Distribución por Categoría
                                </h3>
                                <div>
                                    <select id="distribution-type" class="py-1 px-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm text-sm">
                                        <option value="publicity">Publicidad</option>
                                        <option value="issues">Problemas</option>
                                        <option value="terminals">Terminales</option>
                                    </select>
                                </div>
                            </div>
                            <div class="h-[300px]">
                                <canvas id="distribution-chart"></canvas>
                            </div>
                            <div id="distribution-legend" class="grid grid-cols-2 gap-3 mt-4">
                                <!-- Será generado dinámicamente -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                            <h3 class="text-lg font-bold mb-4 text-text-primary dark:text-text-primary-dark flex items-center">
                                <i data-lucide="trending-up" class="h-5 w-5 mr-2 text-brand-light"></i>
                                Actividad Reciente
                            </h3>
                            <div class="space-y-4">
                                <div id="activity-timeline" class="relative pl-8 space-y-6 before:absolute before:top-0 before:bottom-0 before:left-3 before:w-0.5 before:bg-gray-200 dark:before:bg-gray-700">
                                    <!-- Será generado dinámicamente -->
                                    <div class="flex items-center animate-pulse">
                                        <div class="h-4 w-4 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
                                        <div class="ml-4 h-4 w-3/4 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                    </div>
                                    <div class="flex items-center animate-pulse">
                                        <div class="h-4 w-4 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
                                        <div class="ml-4 h-4 w-2/3 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                    </div>
                                    <div class="flex items-center animate-pulse">
                                        <div class="h-4 w-4 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
                                        <div class="ml-4 h-4 w-4/5 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md xl:col-span-2">
                            <h3 class="text-lg font-bold mb-4 text-text-primary dark:text-text-primary-dark flex items-center">
                                <i data-lucide="boxes" class="h-5 w-5 mr-2 text-brand-light"></i>
                                Comparativa por Terminal
                            </h3>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="h-[300px]">
                                    <canvas id="terminals-comparison-chart"></canvas>
                                </div>
                                <div class="space-y-4">
                                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-text-primary dark:text-text-primary-dark">El Roble</span>
                                            <span id="roble-efficiency" class="text-sm font-semibold text-status-green">0%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                            <div id="roble-efficiency-bar" class="bg-status-green h-2 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <div class="flex justify-between mt-2 text-xs text-text-secondary dark:text-text-secondary-dark">
                                            <span id="roble-progress-detail">0/0 buses</span>
                                            <span id="roble-issue-ratio">0% con problemas</span>
                                        </div>
                                    </div>
                                    
                                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-text-primary dark:text-text-primary-dark">La Reina</span>
                                            <span id="reina-efficiency" class="text-sm font-semibold text-status-green">0%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                            <div id="reina-efficiency-bar" class="bg-status-green h-2 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <div class="flex justify-between mt-2 text-xs text-text-secondary dark:text-text-secondary-dark">
                                            <span id="reina-progress-detail">0/0 buses</span>
                                            <span id="reina-issue-ratio">0% con problemas</span>
                                        </div>
                                    </div>
                                    
                                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-text-primary dark:text-text-primary-dark">Maria Angelica</span>
                                            <span id="maria-efficiency" class="text-sm font-semibold text-status-green">0%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                            <div id="maria-efficiency-bar" class="bg-status-green h-2 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <div class="flex justify-between mt-2 text-xs text-text-secondary dark:text-text-secondary-dark">
                                            <span id="maria-progress-detail">0/0 buses</span>
                                            <span id="maria-issue-ratio">0% con problemas</span>
                                        </div>
                                    </div>
                                    
                                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-text-primary dark:text-text-primary-dark">El Descanso</span>
                                            <span id="descanso-efficiency" class="text-sm font-semibold text-status-green">0%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                            <div id="descanso-efficiency-bar" class="bg-status-green h-2 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <div class="flex justify-between mt-2 text-xs text-text-secondary dark:text-text-secondary-dark">
                                            <span id="descanso-progress-detail">0/0 buses</span>
                                            <span id="descanso-issue-ratio">0% con problemas</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-bold mb-6 text-text-primary dark:text-text-primary-dark flex items-center">
                            <i data-lucide="kanban-square" class="h-5 w-5 mr-2 text-brand-light"></i>
                            Métricas Clave de Rendimiento (KPIs)
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="flex items-center">
                                    <div class="bg-brand-light/20 dark:bg-brand-light/10 p-3 rounded-full mr-3">
                                        <i data-lucide="activity" class="h-6 w-6 text-brand-light"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-text-secondary dark:text-text-secondary-dark">Tasa de Inspección</p>
                                        <p id="inspection-rate" class="text-xl font-bold text-text-primary dark:text-text-primary-dark">0/día</p>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <div class="flex justify-between text-xs text-text-secondary dark:text-text-secondary-dark">
                                        <span>Meta: 25/día</span>
                                        <span id="inspection-rate-percentage">0%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5 mt-1">
                                        <div id="inspection-rate-bar" class="bg-brand-primary h-1.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="flex items-center">
                                    <div class="bg-brand-light/20 dark:bg-brand-light/10 p-3 rounded-full mr-3">
                                        <i data-lucide="percent" class="h-6 w-6 text-brand-light"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-text-secondary dark:text-text-secondary-dark">Cobertura de Flota</p>
                                        <p id="fleet-coverage" class="text-xl font-bold text-text-primary dark:text-text-primary-dark">0%</p>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <div class="flex justify-between text-xs text-text-secondary dark:text-text-secondary-dark">
                                        <span>Meta: 90%</span>
                                        <span id="fleet-coverage-percentage">0%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5 mt-1">
                                        <div id="fleet-coverage-bar" class="bg-brand-primary h-1.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="flex items-center">
                                    <div class="bg-brand-light/20 dark:bg-brand-light/10 p-3 rounded-full mr-3">
                                        <i data-lucide="alert-triangle" class="h-6 w-6 text-brand-light"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-text-secondary dark:text-text-secondary-dark">Tasa de Incidencias</p>
                                        <p id="issue-rate" class="text-xl font-bold text-text-primary dark:text-text-primary-dark">0%</p>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <div class="flex justify-between text-xs text-text-secondary dark:text-text-secondary-dark">
                                        <span>Objetivo: <10%</span>
                                        <span id="issue-rate-status">Óptimo</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5 mt-1">
                                        <div id="issue-rate-bar" class="bg-status-green h-1.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="flex items-center">
                                    <div class="bg-brand-light/20 dark:bg-brand-light/10 p-3 rounded-full mr-3">
                                        <i data-lucide="timer" class="h-6 w-6 text-brand-light"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-text-secondary dark:text-text-secondary-dark">Tiempo Estimado</p>
                                        <p id="estimated-completion" class="text-xl font-bold text-text-primary dark:text-text-primary-dark">-</p>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <div class="flex justify-between text-xs text-text-secondary dark:text-text-secondary-dark">
                                        <span id="estimated-remaining">- buses pendientes</span>
                                        <span id="estimated-date">-</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5 mt-1">
                                        <div id="estimated-completion-bar" class="bg-brand-primary h-1.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Fixed bottom navbar for mobile -->
            <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 shadow-[0_-1px_3px_rgba(0,0,0,0.1)] dark:shadow-[0_-1px_3px_rgba(0,0,0,0.3)] flex justify-around z-30">
                <a href="#" data-view="dashboard" class="mobile-nav-link nav-link flex-1 flex flex-col items-center justify-center p-2 text-gray-600 dark:text-gray-400">
                    <i data-lucide="layout-dashboard" class="h-5 w-5"></i>
                    <span class="text-xs font-medium mt-1">Dashboard</span>
                </a>
                <a href="#" data-view="form" class="mobile-nav-link nav-link flex-1 flex flex-col items-center justify-center p-2 text-gray-600 dark:text-gray-400">
                    <i data-lucide="clipboard-plus" class="h-5 w-5"></i>
                    <span class="text-xs font-medium mt-1">Registrar</span>
                </a>
                <a href="#" data-view="fleet" class="mobile-nav-link nav-link flex-1 flex flex-col items-center justify-center p-2 text-gray-600 dark:text-gray-400">
                    <i data-lucide="bus" class="h-5 w-5"></i>
                    <span class="text-xs font-medium mt-1">Flota</span>
                </a>
                <a href="#" data-view="assistance" class="mobile-nav-link nav-link flex-1 flex flex-col items-center justify-center p-2 text-gray-600 dark:text-gray-400">
                    <i data-lucide="wrench" class="h-5 w-5"></i>
                    <span class="text-xs font-medium mt-1">Asistencia</span>
                </a>
                <a href="#" data-view="reports" class="mobile-nav-link nav-link flex-1 flex flex-col items-center justify-center p-2 text-gray-600 dark:text-gray-400">
                    <i data-lucide="file-bar-chart-2" class="h-5 w-5"></i>
                    <span class="text-xs font-medium mt-1">Reportes</span>
                </a>
            </nav>
        </div>
    </div>

    <!-- Modals -->
    <div id="fleet-modal" class="modal fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-40">
        <div id="fleet-modal-content" class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all">
        </div>
    </div>
    
    <div id="pending-buses-modal" class="modal fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-2xl flex flex-col max-h-[80vh] transform scale-95 opacity-0 transition-all">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-text-primary dark:text-text-primary-dark flex items-center">
                        <i data-lucide="list-todo" class="h-5 w-5 mr-2 text-status-yellow"></i>
                        Buses Pendientes de Inspección
                    </h3>
                    <button id="close-pending-modal-btn" class="p-1 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i data-lucide="x" class="h-5 w-5"></i>
                    </button>
                </div>
                <div class="mt-4 flex items-center justify-between">
                    <div class="relative flex-1">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="search" class="h-4 w-4 text-gray-400"></i>
                        </span>
                        <input type="text" id="pending-search" placeholder="Buscar por PPU o N° Interno..." class="pl-10 pr-4 py-2 w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                    </div>
                    <div class="ml-3">
                        <select id="pending-terminal-filter" class="py-2 px-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                            <option value="all">Todos los terminales</option>
                            <option value="El Roble">El Roble</option>
                            <option value="La Reina">La Reina</option>
                            <option value="Maria Angelica">Maria Angelica</option>
                            <option value="El Descanso">El Descanso</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="p-4 overflow-y-auto">
                <div id="pending-stats" class="flex flex-wrap gap-3 mb-4">
                    <div class="flex-1 min-w-[120px] p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="text-sm text-text-secondary dark:text-text-secondary-dark">Total Pendientes</div>
                        <div id="pending-total" class="text-xl font-bold text-text-primary dark:text-text-primary-dark">0</div>
                    </div>
                    <div class="flex-1 min-w-[120px] p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="text-sm text-text-secondary dark:text-text-secondary-dark">El Roble</div>
                        <div id="pending-el-roble" class="text-xl font-bold text-brand-primary dark:text-brand-light">0</div>
                    </div>
                    <div class="flex-1 min-w-[120px] p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="text-sm text-text-secondary dark:text-text-secondary-dark">La Reina</div>
                        <div id="pending-la-reina" class="text-xl font-bold text-brand-primary dark:text-brand-light">0</div>
                    </div>
                    <div class="flex-1 min-w-[120px] p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="text-sm text-text-secondary dark:text-text-secondary-dark">Maria Angelica</div>
                        <div id="pending-maria-angelica" class="text-xl font-bold text-brand-primary dark:text-brand-light">0</div>
                    </div>
                    <div class="flex-1 min-w-[120px] p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="text-sm text-text-secondary dark:text-text-secondary-dark">El Descanso</div>
                        <div id="pending-el-descanso" class="text-xl font-bold text-brand-primary dark:text-brand-light">0</div>
                    </div>
                </div>
                <ul id="pending-buses-list" class="space-y-2">
                    <li class="flex items-center justify-center p-12 text-text-secondary dark:text-text-secondary-dark">
                        <i data-lucide="loader-2" class="h-6 w-6 mr-3 animate-spin"></i> Cargando buses pendientes...
                    </li>
                </ul>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-between">
                <div class="text-sm text-text-secondary dark:text-text-secondary-dark">
                    <span id="pending-showing">0</span> de <span id="pending-total-count">0</span> buses pendientes
                </div>
                <!-- Botón de seleccionar aleatorio eliminado -->
            </div>
        </div>
    </div>
    
    <div id="bus-detail-modal" class="modal fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all">
            <div id="bus-detail-content">
                <!-- El contenido será cargado dinámicamente -->
                <div class="flex items-center justify-center p-16">
                    <i data-lucide="loader-2" class="h-8 w-8 mr-3 animate-spin text-brand-primary"></i> 
                    <span class="text-lg text-text-secondary dark:text-text-secondary-dark">Cargando información del bus...</span>
                </div>
            </div>
        </div>
    </div>
    
    <div id="photo-modal" class="modal fixed inset-0 bg-black bg-opacity-90 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-transparent w-full max-w-4xl transform scale-95 opacity-0 transition-all">
            <div class="flex justify-end mb-4">
                <button id="close-photo-modal-btn" class="p-2 text-white hover:text-gray-200 rounded-full hover:bg-white/10 transition-colors">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div id="photo-content" class="flex items-center justify-center">
                <img src="" alt="Fotografía ampliada" class="max-w-full max-h-[80vh] object-contain">
            </div>
        </div>
    </div>

    <div id="export-options-modal" class="modal fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md transform scale-95 opacity-0 transition-all">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-text-primary dark:text-text-primary-dark">Opciones de Exportación</h3>
                    <button id="close-export-options-btn" class="p-1 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i data-lucide="x" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-2">Filtrar por Terminal</label>
                    <select id="export-terminal-filter" class="w-full py-2 px-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                        <option value="all">Todos los terminales</option>
                        <option value="El Roble">El Roble</option>
                        <option value="La Reina">La Reina</option>
                        <option value="Maria Angelica">Maria Angelica</option>
                        <option value="El Descanso">El Descanso</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-2">Filtrar por Tipo</label>
                    <select id="export-type-filter" class="w-full py-2 px-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                        <option value="all">Todos los registros</option>
                        <option value="with_damage">Buses con daños</option>
                        <option value="with_residue">Buses con residuos</option>
                        <option value="with_publicity">Buses con publicidad</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-2">Rango de Fechas</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-text-secondary dark:text-text-secondary-dark mb-1">Desde</label>
                            <input type="date" id="export-date-from" class="w-full py-2 px-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-text-secondary dark:text-text-secondary-dark mb-1">Hasta</label>
                            <input type="date" id="export-date-to" class="w-full py-2 px-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-2">Incluir Columnas</label>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="col-ppu" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary">
                            <span class="ml-2 text-sm text-text-primary dark:text-text-primary-dark">PPU</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="col-numero-interno" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary">
                            <span class="ml-2 text-sm text-text-primary dark:text-text-primary-dark">N° Interno</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="col-terminal" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary">
                            <span class="ml-2 text-sm text-text-primary dark:text-text-primary-dark">Terminal</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="col-marca" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary">
                            <span class="ml-2 text-sm text-text-primary dark:text-text-primary-dark">Marca</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="col-publicidad" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary">
                            <span class="ml-2 text-sm text-text-primary dark:text-text-primary-dark">Publicidad</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="col-detalles" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary">
                            <span class="ml-2 text-sm text-text-primary dark:text-text-primary-dark">Detalles</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="col-fecha" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary">
                            <span class="ml-2 text-sm text-text-primary dark:text-text-primary-dark">Fecha</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="col-ubicacion" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary">
                            <span class="ml-2 text-sm text-text-primary dark:text-text-primary-dark">Ubicación</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="col-observaciones" checked class="form-checkbox h-4 w-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary">
                            <span class="ml-2 text-sm text-text-primary dark:text-text-primary-dark">Observaciones</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
                <button id="confirm-export-excel" class="flex items-center bg-status-green hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-colors duration-200">
                    <i data-lucide="file-spreadsheet" class="h-4 w-4 mr-2"></i> Exportar a Excel
                </button>
                <button id="confirm-export-pdf" class="flex items-center bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-colors duration-200">
                    <i data-lucide="file-text" class="h-4 w-4 mr-2"></i> Exportar a PDF
                </button>
            </div>
        </div>
    </div>
    
    <div id="maintenance-modal" class="modal fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md transform scale-95 opacity-0 transition-all">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-text-primary dark:text-text-primary-dark">Registrar Mantenimiento</h3>
                    <button id="close-maintenance-modal-btn" class="p-1 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i data-lucide="x" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="maintenance-form">
                    <input type="hidden" id="maintenance-ppu" name="ppu">
                    <input type="hidden" id="maintenance-numero-interno" name="numero_interno">
                    
                    <div class="mb-4">
                        <p class="font-medium text-text-primary dark:text-text-primary-dark">Bus: <span id="maintenance-bus-info" class="font-normal"></span></p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-2" for="maintenance-type">Tipo de Mantenimiento</label>
                        <select id="maintenance-type" name="maintenance_type" required class="w-full py-2 px-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                            <option value="">Seleccionar tipo...</option>
                            <option value="residuo">Limpieza de Residuos</option>
                            <option value="pintura">Reparación de Pintura</option>
                            <option value="publicidad">Retiro de Publicidad</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-2" for="maintenance-notes">Notas Adicionales</label>
                        <textarea id="maintenance-notes" name="notes" rows="4" class="w-full py-2 px-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm resize-none" placeholder="Detalles del mantenimiento..."></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-2" for="maintenance-date">Fecha Programada</label>
                        <input type="date" id="maintenance-date" name="scheduled_date" required class="w-full py-2 px-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-text-primary dark:text-text-primary-dark focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:border-transparent shadow-sm">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary dark:text-text-secondary-dark mb-2">Prioridad</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="priority" value="baja" class="form-radio h-4 w-4 text-brand-primary border-gray-300 focus:ring-brand-primary">
                                <span class="ml-2 text-sm text-text-primary dark:text-text-primary-dark">Baja</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="priority" value="media" checked class="form-radio h-4 w-4 text-brand-primary border-gray-300 focus:ring-brand-primary">
                                <span class="ml-2 text-sm text-text-primary dark:text-text-primary-dark">Media</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="priority" value="alta" class="form-radio h-4 w-4 text-brand-primary border-gray-300 focus:ring-brand-primary">
                                <span class="ml-2 text-sm text-text-primary dark:text-text-primary-dark">Alta</span>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                <button id="save-maintenance-btn" class="flex items-center bg-brand-secondary hover:bg-brand-dark text-white font-medium py-2 px-4 rounded-lg shadow-md transition-colors duration-200">
                    <i data-lucide="save" class="h-4 w-4 mr-2"></i> Guardar Mantenimiento
                </button>
            </div>
        </div>
    </div>

    <div id="loader-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div class="flex flex-col items-center">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
            <p id="loader-text" class="mt-4 text-white text-lg font-semibold">Cargando...</p>
        </div>
    </div>
    
    <div id="toast-container" class="fixed top-5 right-5 z-50 w-full max-w-xs sm:max-w-sm"></div>

    <script type="module">
        const SUPABASE_URL = 'https://tcmtxvuucjttngcazgff.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjbXR4dnV1Y2p0dG5nY2F6Z2ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA3MjUwMDEsImV4cCI6MjA1NjMwMTAwMX0.2WcIjMUEhSM6j9kYpbsYArQocZdHx86k7wXk-NyjIs0';

        const { createClient } = supabase;
        var dbClient;

        // Configuración de temas
        const htmlElement = document.documentElement;
        const darkModeToggle = document.getElementById('theme-toggle');
        const darkModeToggleCollapsed = document.getElementById('theme-toggle-collapsed');
        const darkModeToggleNavbar = document.getElementById('theme-toggle-navbar');
        const themeText = document.getElementById('theme-text');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const sunIconCollapsed = document.getElementById('sun-icon-collapsed');
        const moonIconCollapsed = document.getElementById('moon-icon-collapsed');

        // Comprobamos si hay un tema guardado en localStorage
        const savedTheme = localStorage.getItem('theme');
        const isDarkMode = savedTheme === 'dark' || (savedTheme === null && window.matchMedia('(prefers-color-scheme: dark)').matches);
        
        function updateThemeIcons(isDark) {
            if (isDark) {
                htmlElement.classList.add('dark');
                darkModeToggle.checked = true;
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                sunIconCollapsed.classList.remove('hidden');
                moonIconCollapsed.classList.add('hidden');
                themeText.textContent = 'Modo Claro';
            } else {
                htmlElement.classList.remove('dark');
                darkModeToggle.checked = false;
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                sunIconCollapsed.classList.add('hidden');
                moonIconCollapsed.classList.remove('hidden');
                themeText.textContent = 'Modo Oscuro';
            }
        }
        
        // Inicializamos el tema
        updateThemeIcons(isDarkMode);
        
        // Manejadores de eventos para cambiar el tema
        function toggleDarkMode() {
            const isDark = htmlElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcons(isDark);
        }
        
        darkModeToggle.addEventListener('change', toggleDarkMode);
        darkModeToggleCollapsed.addEventListener('click', toggleDarkMode);
        darkModeToggleNavbar.addEventListener('click', toggleDarkMode);

        // Configuración de terminales y constantes globales
        const terminals = {
            'El Roble': { lat: -33.44071194412281, lon: -70.78973603006452 },
            'La Reina': { lat: -33.4648451661274, lon: -70.53179284909858 },
            'Maria Angelica': { lat: -33.51772240158645, lon: -70.55641931656773 },
            'El Descanso': { lat: -33.4695150389365, lon: -70.76243487908678 },
        };
        
        // Funciones para seguimiento en tiempo real
        function startRealTimeTracking() {
            if (!navigator.geolocation) {
                console.warn('Geolocalización no soportada');
                return;
            }
            
            // Configurar seguimiento de ubicación optimizado (menos frecuente)
            const options = {
                enableHighAccuracy: false, // Cambiar a false para mejor rendimiento
                timeout: 5000, // Reducido a 5 segundos
                maximumAge: 60000 // Usar ubicación cacheada si tiene menos de 1 minuto
            };
            
            locationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude: lat, longitude: lon, accuracy } = position.coords;
                    lastKnownPosition = { lat, lon };
                    
                    // Actualizar ubicación del usuario en el mapa (solo si cambió significativamente)
                    if (!currentUserLocation || 
                        Math.abs(currentUserLocation.lat - lat) > 0.001 || 
                        Math.abs(currentUserLocation.lon - lon) > 0.001) {
                        updateUserLocation(lat, lon, accuracy);
                    }
                    
                    // Actualizar terminal más cercano
                    const nearestTerminal = getNearestTerminal(lat, lon);
                    updateTerminalInfo(nearestTerminal);
                    
                    // Mostrar toast solo la primera vez
                    if (!lastKnownPosition) {
                        showToast(`Terminal: ${nearestTerminal}`, 'success');
                    }
                },
                (error) => {
                    console.error('Error en seguimiento de ubicación:', error);
                },
                options
            );
            
            // Iniciar actualizaciones menos frecuentes
            startRealTimeUpdates();
            
            console.log('Seguimiento optimizado iniciado');
        }
        
        function stopRealTimeTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
                realTimeUpdateInterval = null;
            }
            
            // Detener seguimiento de usuarios activos
            stopActiveUsersTracking();
            
            console.log('Seguimiento en tiempo real detenido');
        }
        
        function startRealTimeUpdates() {
            realTimeUpdateInterval = setInterval(async () => {
                if (!isRealTimeEnabled) return;
                
                try {
                    // Verificar nuevas inspecciones (menos frecuente)
                    const newInspections = await fetchAllInspections();
                    const currentCount = newInspections.length;
                    
                    if (currentCount > lastInspectionCount) {
                        // Solo actualizar si hay cambios significativos
                        allInspections = newInspections;
                        lastInspectionCount = currentCount;
                        
                        // Actualizar solo la vista actual
                        if (currentView === 'dashboard') {
                            updateDashboardStats();
                        }
                        
                        // Mostrar notificación simple
                        showToast('Nueva inspección registrada', 'success');
                    }
                    
                } catch (error) {
                    console.error('Error en actualización:', error);
                }
            }, 5000); // Actualizar cada 5 segundos para mejor rendimiento
        }
        
        function updateUserLocation(lat, lon, accuracy = null) {
            if (!map) return;
            
            const userPos = [lat, lon];
            currentUserLocation = { lat, lon };
            
            // Remover marcador anterior si existe
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // Crear marcador pequeño y simple (sin seguimiento gigante)
            userMarker = L.marker(userPos, {
                icon: L.divIcon({
                    html: `<div class="flex items-center justify-center bg-blue-500 text-white rounded-full shadow-lg" style="width: 20px; height: 20px; font-size: 10px;">👤</div>`,
                    className: 'user-marker-simple',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);
            
            userMarker.bindPopup("<b>Tu ubicación actual</b>");
            
            // Centrar mapa en la ubicación del usuario solo la primera vez
            if (!lastKnownPosition) {
                map.setView(userPos, 13);
            }
            
            // Actualizar indicador de precisión GPS (optimizado)
            const accuracyElement = document.getElementById('gps-accuracy');
            if (accuracyElement && accuracy !== null) {
                const accuracyMeters = Math.round(accuracy);
                accuracyElement.textContent = `GPS: ${accuracyMeters}m`;
                accuracyElement.className = `text-xs ${accuracyMeters > 50 ? 'text-yellow-600' : 'text-green-600'}`;
            }
        }
        
        function addRealTimeNotification(notification) {
            realTimeNotifications.unshift(notification);
            
            // Mantener solo las últimas 50 notificaciones
            if (realTimeNotifications.length > 50) {
                realTimeNotifications = realTimeNotifications.slice(0, 50);
            }
            
            // Actualizar panel de notificaciones
            updateNotificationsPanel();
            
            // Mostrar notificación en tiempo real
            showRealTimeNotification(notification);
        }
        
        function updateNotificationsPanel() {
            const notificationsList = document.getElementById('notifications-list');
            if (!notificationsList) return;
            
            // Obtener los últimos 3 registros reales de inspecciones
            const recentInspections = allInspections
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 3);
            
            if (recentInspections.length === 0) {
                notificationsList.innerHTML = `
                    <div class="px-4 py-2 text-sm text-gray-500 dark:text-gray-400">
                        No hay registros recientes.
                    </div>
                `;
                return;
            }
            
            // Crear notificaciones basadas en registros reales
            const notificationsHTML = recentInspections.map((inspection, index) => {
                const inspectorName = inspection.inspector_name || currentInspectorName;
                const terminal = inspection.terminal || 'Terminal desconocido';
                const hasIssues = inspection.dano_pintura || inspection.residuos_pegamento;
                const issueType = inspection.dano_pintura ? 'Daño de pintura' : 
                                 inspection.residuos_pegamento ? 'Residuos de pegamento' : null;
                
                // Verificar si es una notificación reciente (menos de 5 minutos)
                const isRecent = (new Date() - new Date(inspection.created_at)) < 5 * 60 * 1000;
                
                let icon = 'bus';
                let iconColor = 'bg-brand-light';
                let statusText = '';
                let newIndicator = '';
                
                if (hasIssues) {
                    icon = 'alert-triangle';
                    iconColor = 'bg-status-red';
                    statusText = `<span class="text-xs text-status-red font-medium">⚠️ ${issueType}</span>`;
                }
                
                if (isRecent && index === 0) {
                    newIndicator = `<span class="absolute top-2 right-2 w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>`;
                }
                
                return `
                    <div class="border-b border-gray-200 dark:border-gray-700 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer relative" onclick="showInspectionDetails('${inspection.id}')">
                        ${newIndicator}
                        <div class="flex items-start">
                            <div class="flex-shrink-0 pt-0.5">
                                <div class="h-8 w-8 rounded-full ${iconColor} flex items-center justify-center text-white">
                                    <i data-lucide="${icon}" class="h-4 w-4"></i>
                                </div>
                            </div>
                            <div class="ml-3 flex-1">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-text-primary dark:text-text-primary-dark">
                                        ${inspectorName}
                                    </p>
                                    <span class="text-xs text-text-secondary dark:text-text-secondary-dark">
                                        ${formatTimeAgo(new Date(inspection.created_at))}
                                    </span>
                                </div>
                                <p class="text-xs text-brand-primary dark:text-brand-light mt-1">
                                    Bus ${inspection.ppu} - ${terminal}
                                </p>
                                ${statusText}
                                <div class="mt-2 flex items-center space-x-2 text-xs text-text-secondary dark:text-text-secondary-dark">
                                    <span class="flex items-center">
                                        <i data-lucide="map-pin" class="h-3 w-3 mr-1"></i>
                                        ${terminal}
                                    </span>
                                    <span class="flex items-center">
                                        <i data-lucide="clock" class="h-3 w-3 mr-1"></i>
                                        ${formatSimpleTime(new Date(inspection.created_at))}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Agregar header con contador y botón de limpiar
            const totalNotifications = recentInspections.length;
            const headerHTML = `
                <div class="px-4 py-2 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold text-sm">Últimos Registros</h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs bg-brand-light text-white px-2 py-1 rounded-full">${totalNotifications}</span>
                            <button onclick="clearNotifications()" class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <i data-lucide="trash-2" class="h-3 w-3"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            notificationsList.innerHTML = headerHTML + notificationsHTML;
            
            // Mostrar badge de notificaciones si hay registros
            const notificationBadge = document.getElementById('notification-badge');
            if (notificationBadge) {
                if (totalNotifications > 0) {
                    notificationBadge.classList.remove('hidden');
                    notificationBadge.textContent = totalNotifications > 3 ? '3+' : totalNotifications;
                } else {
                    notificationBadge.classList.add('hidden');
                }
            }
            
            lucide.createIcons();
        }
        
        function showInspectionDetails(inspectionId) {
            const inspection = allInspections.find(ins => ins.id === inspectionId);
            if (!inspection) return;
            
            // Crear modal con detalles de la inspección
            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-text-primary dark:text-text-primary-dark">
                                Detalles de Inspección
                            </h3>
                            <button onclick="closeInspectionModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <i data-lucide="x" class="h-5 w-5"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                                <h4 class="font-semibold text-brand-primary dark:text-brand-light mb-2">Información del Bus</h4>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div><span class="font-medium">PPU:</span> ${inspection.ppu}</div>
                                    <div><span class="font-medium">N° Interno:</span> ${inspection.numero_interno}</div>
                                    <div><span class="font-medium">Terminal:</span> ${inspection.terminal}</div>
                                    <div><span class="font-medium">Inspector:</span> ${inspection.inspector_name || currentInspectorName}</div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                                <h4 class="font-semibold text-brand-primary dark:text-brand-light mb-2">Estado de Publicidad</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center">
                                        <span class="w-3 h-3 rounded-full ${inspection.publicidad_izquierda ? 'bg-status-red' : 'bg-status-green'} mr-2"></span>
                                        <span>Publicidad Izquierda: ${inspection.publicidad_izquierda ? 'Sí' : 'No'}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="w-3 h-3 rounded-full ${inspection.publicidad_luneta ? 'bg-status-red' : 'bg-status-green'} mr-2"></span>
                                        <span>Publicidad Luneta: ${inspection.publicidad_luneta ? 'Sí' : 'No'}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="w-3 h-3 rounded-full ${inspection.publicidad_derecha ? 'bg-status-red' : 'bg-status-green'} mr-2"></span>
                                        <span>Publicidad Derecha: ${inspection.publicidad_derecha ? 'Sí' : 'No'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            ${inspection.dano_pintura || inspection.residuos_pegamento ? `
                                <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg border border-red-200 dark:border-red-800">
                                    <h4 class="font-semibold text-status-red mb-2">⚠️ Problemas Detectados</h4>
                                    <div class="space-y-2 text-sm">
                                        ${inspection.dano_pintura ? `
                                            <div class="flex items-start">
                                                <i data-lucide="paintbrush-2" class="h-4 w-4 text-status-red mr-2 mt-0.5"></i>
                                                <div>
                                                    <div class="font-medium text-status-red">Daño de Pintura</div>
                                                    <div class="text-text-secondary dark:text-text-secondary-dark">${inspection.dano_pintura_detalle || 'Sin detalles'}</div>
                                                </div>
                                            </div>
                                        ` : ''}
                                        ${inspection.residuos_pegamento ? `
                                            <div class="flex items-start">
                                                <i data-lucide="sticky-note" class="h-4 w-4 text-status-yellow mr-2 mt-0.5"></i>
                                                <div>
                                                    <div class="font-medium text-status-yellow">Residuos de Pegamento</div>
                                                    <div class="text-text-secondary dark:text-text-secondary-dark">${inspection.residuos_pegamento_detalle || 'Sin detalles'}</div>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                                <h4 class="font-semibold text-brand-primary dark:text-brand-light mb-2">Información de Ubicación</h4>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div><span class="font-medium">Latitud:</span> ${inspection.lat?.toFixed(6) || 'N/A'}</div>
                                    <div><span class="font-medium">Longitud:</span> ${inspection.lon?.toFixed(6) || 'N/A'}</div>
                                    <div><span class="font-medium">Precisión:</span> ${inspection.accuracy ? `${Math.round(inspection.accuracy)}m` : 'N/A'}</div>
                                    <div><span class="font-medium">Fecha:</span> ${formatSimpleDate(inspection.created_at)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Agregar modal al DOM
            const modalContainer = document.createElement('div');
            modalContainer.id = 'inspection-modal';
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);
            
            lucide.createIcons();
        }
        
        function closeInspectionModal() {
            const modal = document.getElementById('inspection-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function formatSimpleTime(date) {
            return date.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function clearNotifications() {
            // Limpiar notificaciones en tiempo real
            realTimeNotifications = [];
            
            // Ocultar badge
            const notificationBadge = document.getElementById('notification-badge');
            if (notificationBadge) {
                notificationBadge.classList.add('hidden');
            }
            
            // Actualizar panel
            updateNotificationsPanel();
            
            showToast('Notificaciones limpiadas', 'info');
        }
        
        function showRealTimeNotification(notification) {
            // Crear notificación emergente
            const notificationElement = document.createElement('div');
            notificationElement.className = 'fixed top-4 right-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-4 max-w-sm z-50 transform transition-all duration-300 translate-x-full';
            notificationElement.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <div class="h-8 w-8 rounded-full bg-brand-light flex items-center justify-center text-white">
                            <i data-lucide="bus" class="h-4 w-4"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium text-text-primary dark:text-text-primary-dark">${notification.message}</p>
                        <p class="text-xs text-text-secondary dark:text-text-secondary-dark mt-1">${formatTimeAgo(notification.timestamp)}</p>
                    </div>
                    <button class="ml-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i data-lucide="x" class="h-4 w-4"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notificationElement);
            
            // Animar entrada
            setTimeout(() => {
                notificationElement.classList.remove('translate-x-full');
            }, 10);
            
            // Configurar botón de cerrar
            const closeBtn = notificationElement.querySelector('button');
            closeBtn.addEventListener('click', () => {
                notificationElement.classList.add('translate-x-full');
                setTimeout(() => notificationElement.remove(), 300);
            });
            
            // Auto-remover después de 5 segundos
            setTimeout(() => {
                if (notificationElement.parentNode) {
                    notificationElement.classList.add('translate-x-full');
                    setTimeout(() => notificationElement.remove(), 300);
                }
            }, 5000);
            
            lucide.createIcons();
        }
        
        function playNotificationSound() {
            // Crear audio para notificación
            if (!notificationSound) {
                notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
            }
            
            try {
                notificationSound.play().catch(e => console.log('No se pudo reproducir sonido:', e));
            } catch (e) {
                console.log('Error reproduciendo sonido:', e);
            }
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (seconds < 60) return 'Hace un momento';
            if (minutes < 60) return `Hace ${minutes} minuto${minutes > 1 ? 's' : ''}`;
            if (hours < 24) return `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
            return date.toLocaleDateString('es-ES');
        }
        
        function updateActiveUsersCount() {
            const activeUsersElement = document.getElementById('active-users');
            if (activeUsersElement) {
                // Simular usuarios activos basado en la actividad reciente
                const activeCount = Math.max(1, Math.floor(Math.random() * 5) + 1);
                activeUsersElement.textContent = activeCount;
            }
        }
        
        // Funciones de actualización de datos en tiempo real
        function updateDashboardData() {
            if (currentView !== 'dashboard') return;
            
            // Actualizar estadísticas del dashboard
            updateDashboardStats();
            
            // Actualizar mapa si está visible
            if (map && mapView) {
                updateMapView(mapView);
            }
            
            // Actualizar gráficos
            updateDashboardCharts();
        }
        
        function updateFleetData() {
            if (currentView !== 'fleet') return;
            
            // Actualizar grid de flota
            renderFleetGrid();
            
            // Actualizar contadores
            updateFleetCounters();
        }
        
        function updateReportsData() {
            if (currentView !== 'reports') return;
            
            // Actualizar tablas de reportes
            updateReportsTables();
            
            // Actualizar gráficos de reportes
            updateReportsCharts();
        }
        
        function updateDashboardStats() {
            // Calcular estadísticas reales por terminal
            const terminalStats = {
                'El Roble': { inspections: 0, total: 0, pending: 0 },
                'La Reina': { inspections: 0, total: 0, pending: 0 },
                'Maria Angelica': { inspections: 0, total: 0, pending: 0 },
                'El Descanso': { inspections: 0, total: 0, pending: 0 }
            };
            
            // Contar inspecciones reales por terminal
            allInspections.forEach(insp => {
                if (insp.terminal && terminalStats[insp.terminal]) {
                    terminalStats[insp.terminal].inspections++;
                }
            });
            
            // Distribuir buses de la flota por terminales
            const inspectedPPUs = new Set(allInspections.map(i => i.ppu));
            const terminalNames = Object.keys(terminalStats);
            
            busFleet.forEach((bus, index) => {
                // Si el bus ya fue inspeccionado, usar su terminal real
                const inspection = allInspections.find(insp => insp.ppu === bus.ppu);
                if (inspection && inspection.terminal) {
                    if (terminalStats[inspection.terminal]) {
                        terminalStats[inspection.terminal].total++;
                    }
                } else {
                    // Distribuir buses no inspeccionados equitativamente
                    const terminalIndex = index % terminalNames.length;
                    const terminal = terminalNames[terminalIndex];
                    terminalStats[terminal].total++;
                }
            });
            
            // Calcular pendientes por terminal
            Object.keys(terminalStats).forEach(terminal => {
                terminalStats[terminal].pending = terminalStats[terminal].total - terminalStats[terminal].inspections;
            });
            
            // Actualizar elementos del DOM con datos reales
            Object.keys(terminalStats).forEach(terminal => {
                const stats = terminalStats[terminal];
                const elementId = `stats-${terminal.toLowerCase().replace(' ', '-')}`;
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = stats.inspections;
                }
                
                // Actualizar barras de progreso por terminal
                const progressElement = document.getElementById(`${terminal.toLowerCase().replace(' ', '-')}-progress-text`);
                const progressBar = document.getElementById(`${terminal.toLowerCase().replace(' ', '-')}-progress-bar`);
                
                if (progressElement && progressBar) {
                    const percentage = stats.total > 0 ? Math.round((stats.inspections / stats.total) * 100) : 0;
                    progressElement.textContent = `${percentage}%`;
                    progressBar.style.width = `${percentage}%`;
                }
            });
            
            // Actualizar contadores de pendientes en el modal
            updatePendingCounters(terminalStats);
            
            // Actualizar progreso general
            const totalInspections = allInspections.length;
            const totalBuses = busFleet.length;
            const progressPercentage = totalBuses > 0 ? Math.round((totalInspections / totalBuses) * 100) : 0;
            
            const progressElement = document.getElementById('fleet-progress-percentage');
            if (progressElement) {
                progressElement.textContent = `${progressPercentage}%`;
            }
            
            const progressBar = document.getElementById('fleet-progress-bar');
            if (progressBar) {
                progressBar.style.width = `${progressPercentage}%`;
            }
            
            const progressText = document.getElementById('fleet-progress-text');
            if (progressText) {
                progressText.textContent = `${totalInspections}/${totalBuses}`;
            }
            
            // Actualizar contadores de buses inspeccionados y pendientes
            const busesInspectedElement = document.getElementById('buses-inspected');
            const busesPendingElement = document.getElementById('buses-pending');
            
            if (busesInspectedElement) busesInspectedElement.textContent = totalInspections;
            if (busesPendingElement) busesPendingElement.textContent = totalBuses - totalInspections;
            
            console.log('Estadísticas del dashboard actualizadas:', terminalStats);
        }
        
        function updateDashboardCharts() {
            // Actualizar gráfico de inspecciones si existe
            if (window.inspectionsChart) {
                const chartData = groupInspectionsByDate(allInspections, 30);
                window.inspectionsChart.data.labels = Object.keys(chartData);
                window.inspectionsChart.data.datasets[0].data = Object.values(chartData);
                window.inspectionsChart.update();
            }
        }
        
        function updateFleetCounters() {
            const totalCount = busFleet.length;
            const inspectedCount = allInspections.length;
            const pendingCount = totalCount - inspectedCount;
            
            // Actualizar contadores
            const totalElement = document.getElementById('fleet-total-count');
            const inspectedElement = document.getElementById('fleet-inspected-count');
            const pendingElement = document.getElementById('fleet-pending-count');
            
            if (totalElement) totalElement.textContent = totalCount;
            if (inspectedElement) inspectedElement.textContent = inspectedCount;
            if (pendingElement) pendingElement.textContent = pendingCount;
        }
        
        function updatePendingCounters(terminalStats) {
            // Calcular total de pendientes
            const totalPending = Object.values(terminalStats).reduce((sum, stats) => sum + stats.pending, 0);
            
            // Actualizar contadores en el modal de pendientes
            const totalElement = document.getElementById('pending-total');
            const elRobleElement = document.getElementById('pending-el-roble');
            const laReinaElement = document.getElementById('pending-la-reina');
            const mariaAngelicaElement = document.getElementById('pending-maria-angelica');
            const elDescansoElement = document.getElementById('pending-el-descanso');
            
            if (totalElement) totalElement.textContent = totalPending;
            if (elRobleElement) elRobleElement.textContent = terminalStats['El Roble']?.pending || 0;
            if (laReinaElement) laReinaElement.textContent = terminalStats['La Reina']?.pending || 0;
            if (mariaAngelicaElement) mariaAngelicaElement.textContent = terminalStats['Maria Angelica']?.pending || 0;
            if (elDescansoElement) elDescansoElement.textContent = terminalStats['El Descanso']?.pending || 0;
            
            console.log('Contadores de pendientes actualizados:', {
                total: totalPending,
                byTerminal: terminalStats
            });
        }
        
        function updateReportsTables() {
            // Actualizar tablas de reportes según la pestaña activa
            const activeTab = document.querySelector('.tab-link.border-brand-secondary');
            if (activeTab) {
                const tabId = activeTab.id;
                switch (tabId) {
                    case 'tab-residues':
                        updateResiduesTable();
                        break;
                    case 'tab-damages':
                        updateDamagesTable();
                        break;
                    case 'tab-all':
                        updateAllInspectionsTable();
                        break;
                }
            }
        }
        
        function updateReportsCharts() {
            // Actualizar gráficos de reportes
            if (window.terminalStatsChart) {
                const terminalData = {};
                allInspections.forEach(insp => {
                    if (insp.terminal) {
                        if (!terminalData[insp.terminal]) {
                            terminalData[insp.terminal] = { inspections: 0, damages: 0, residues: 0 };
                        }
                        terminalData[insp.terminal].inspections++;
                        if (insp.dano_pintura) terminalData[insp.terminal].damages++;
                        if (insp.residuos_pegamento) terminalData[insp.terminal].residues++;
                    }
                });
                
                window.terminalStatsChart.data.labels = Object.keys(terminalData);
                window.terminalStatsChart.data.datasets[0].data = Object.values(terminalData).map(d => d.inspections);
                window.terminalStatsChart.update();
            }
        }
        


        // Variables globales para datos
        let busFleet = [];
        var allInspections = [];
        let currentUserLocation = null;
        let map;
        let userMarker;
        let heatMapLayer;
        let markersLayer;
        let markersClusterLayer;
        let terminalsLayer;
        let mapView = 'standard'; // 'standard', 'heat', 'clusters', 'terminals'
        let dateFilterPeriod = 'month'; // 'day', 'week', 'month', 'year'
        let terminalFilter = 'all'; // 'all', 'El Roble', 'La Reina', 'Maria Angelica', 'El Descanso'
        let distributionType = 'publicity'; // 'publicity', 'issues', 'terminals'
        let trendsPeriod = 7; // 7, 30, 90 days
        let currentFleetPage = 1;
        let fleetItemsPerPage = 20;
        let allReportPage = 1;
        let allReportItemsPerPage = 10;
        
        // Variables para seguimiento en tiempo real
        let locationWatchId = null;
        let realTimeUpdateInterval = null;
        let lastKnownPosition = null;
        let isRealTimeEnabled = true;
        let notificationSound = null;
        let lastInspectionCount = 0;
        let realTimeNotifications = [];
        let currentInspectorName = 'Inspector'; // Nombre base del inspector (se actualizará según terminal)
        var currentView = 'dashboard'; // Vista actual activa
        var currentTerminal = 'Detectando...'; // Terminal actual del usuario
        
        // Variables para usuarios activos en tiempo real
        let activeUsers = [];
        let currentSessionId = null;
        let userActivityInterval = null;
        let activeUsersUpdateInterval = null;
        let userMapMarkers = new Map(); // Para almacenar marcadores del mapa
        
        const fleetSearchParams = {
            searchTerm: '',
            filter: 'all', // 'all', 'inspected', 'pending', 'damaged', 'residue'
            terminal: 'all' // 'all', 'El Roble', 'La Reina', 'Maria Angelica', 'El Descanso'
        };
        
        // Elementos DOM compartidos
        const loaderOverlay = document.getElementById('loader-overlay');
        const loaderText = document.getElementById('loader-text');
        const toastContainer = document.getElementById('toast-container');
        
        // Gestores UI
        function showLoader(message = 'Cargando...') {
            loaderText.textContent = message;
            loaderOverlay.classList.remove('hidden');
        }
        
        function hideLoader() {
            loaderOverlay.classList.add('hidden');
        }
        
        // Sistema para evitar toasts duplicados
        let lastToastMessage = '';
        let lastToastTime = 0;
        
        function showToast(message, type = 'info', duration = 4000) {
            const now = Date.now();
            const timeSinceLastToast = now - lastToastTime;
            
            // Evitar toasts duplicados en un corto período
            if (message === lastToastMessage && timeSinceLastToast < 3000) {
                return;
            }
            
            lastToastMessage = message;
            lastToastTime = now;
            
            const colors = {
                info: 'bg-blue-500 text-white',
                success: 'bg-green-500 text-white',
                warning: 'bg-yellow-500 text-black',
                error: 'bg-red-500 text-white',
            };
            const icons = {
                info: 'info',
                success: 'check-circle',
                warning: 'alert-triangle',
                error: 'x-circle',
            };
            
            const toast = document.createElement('div');
            toast.className = `p-4 rounded-lg font-medium shadow-lg mb-3 transform transition-all duration-300 ease-out translate-x-full flex items-center ${colors[type]}`;
            toast.innerHTML = `
                <i data-lucide="${icons[type]}" class="h-5 w-5 mr-3"></i>
                <span>${message}</span>
            `;
            toastContainer.appendChild(toast);
            
            lucide.createIcons({
                icons: {
                    [icons[type]]: lucide.icons[icons[type]]
                },
                attrs: {
                    class: "h-5 w-5"
                }
            }, toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 10);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }
        
        // Navegación entre vistas
        const views = document.querySelectorAll('.view');
        const navLinks = document.querySelectorAll('.nav-link');
        const headerTitle = document.getElementById('header-title');
        
        async function navigateTo(viewId) {
            // Actualizar vista actual
            currentView = viewId;
            
            // Actualizar título del header
            const titles = {
                'dashboard': 'Dashboard',
                'form': 'Nuevo Registro',
                'fleet': 'Flota de Buses',
                'assistance': 'Centro de Asistencia',
                'reports': 'Reportes e Informes',
                'analytics': 'Analítica Avanzada'
            };
            headerTitle.textContent = titles[viewId] || 'Dashboard';
            
            // Activar la vista correspondiente
            views.forEach(view => {
                view.classList.toggle('active', view.id === `${viewId}-view`);
            });

            // Actualizar enlaces de navegación
            navLinks.forEach(link => {
                const isMobile = link.classList.contains('mobile-nav-link');
                const isCurrent = link.dataset.view === viewId;
                
                if (isMobile) {
                    link.classList.toggle('active', isCurrent);
                    if (isCurrent) {
                        link.classList.add('text-brand-primary', 'dark:text-brand-light');
                    } else {
                        link.classList.remove('text-brand-primary', 'dark:text-brand-light');
                    }
                } else {
                    if (isCurrent) {
                        link.classList.add('bg-brand-primary', 'text-white');
                    } else {
                        link.classList.remove('bg-brand-primary', 'text-white');
                    }
                }
            });
            
            // Cargar datos específicos según la vista
            switch(viewId) {
                case 'dashboard': await loadDashboardData(); break;
                case 'form': 
                    await setupFormView(); 
                    // Verificar que el formulario esté listo después de cargar
                    setTimeout(() => {
                        if (!ensureFormReady()) {
                            console.warn('Formulario no está completamente listo, reintentando...');
                            setTimeout(() => ensureFormReady(), 500);
                        }
                    }, 100);
                    break;
                case 'fleet': await loadFleetData(); break;
                case 'assistance': await loadAssistanceData(); break;
                case 'reports': await loadReportsData(); break;
                case 'analytics': await loadAnalyticsData(); break;
            }
            
            // Cerrar menú móvil si está abierto
            if (document.getElementById('mobile-sidebar').classList.contains('block')) {
                closeMobileMenu();
            }
            
            // Si estamos en el dashboard, asegurarnos de que el mapa se redimensione correctamente
            if (viewId === 'dashboard' && map) {
                setTimeout(() => map.invalidateSize(), 100);
            }
            
            // Refrescar iconos de Lucide
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        // Control de sidebar
        const collapseSidebarBtn = document.getElementById('collapse-sidebar');
        const expandSidebarBtn = document.getElementById('expand-sidebar');
        const sidebar = document.querySelector('aside');
        const collapsedSidebar = document.getElementById('collapsed-sidebar');
        
        collapseSidebarBtn.addEventListener('click', () => {
            sidebar.classList.add('hidden');
            collapsedSidebar.classList.remove('hidden');
            collapsedSidebar.classList.add('flex');
        });
        
        expandSidebarBtn.addEventListener('click', () => {
            sidebar.classList.remove('hidden');
            collapsedSidebar.classList.add('hidden');
            collapsedSidebar.classList.remove('flex');
        });
        
        // Menú móvil
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileSidebar = document.getElementById('mobile-sidebar');
        const mobileSidebarContent = document.getElementById('mobile-sidebar-content');
        const closeMobileSidebarBtn = document.getElementById('close-mobile-sidebar');
        const mobileSidebarBackdrop = document.getElementById('mobile-sidebar-backdrop');
        
        function openMobileMenu() {
            mobileSidebar.classList.remove('hidden');
            mobileSidebar.classList.add('block');
            setTimeout(() => {
                mobileSidebarContent.classList.remove('-translate-x-full');
            }, 10);
        }
        
        function closeMobileMenu() {
            mobileSidebarContent.classList.add('-translate-x-full');
            setTimeout(() => {
                mobileSidebar.classList.add('hidden');
                mobileSidebar.classList.remove('block');
            }, 300);
        }
        
        mobileMenuButton.addEventListener('click', openMobileMenu);
        closeMobileSidebarBtn.addEventListener('click', closeMobileMenu);
        mobileSidebarBackdrop.addEventListener('click', closeMobileMenu);
        
        // Dropdowns del header
        const userDropdown = document.getElementById('user-dropdown');
        const userPanel = document.getElementById('user-panel');
        const notificationsDropdown = document.getElementById('notifications-dropdown');
        const notificationsPanel = document.getElementById('notifications-panel');
        
        userDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
            userPanel.classList.toggle('hidden');
            notificationsPanel.classList.add('hidden');
        });
        
        notificationsDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
            notificationsPanel.classList.toggle('hidden');
            userPanel.classList.add('hidden');
        });
        
        document.addEventListener('click', () => {
            userPanel.classList.add('hidden');
            notificationsPanel.classList.add('hidden');
        });
        
        // Detectar terminal más cercano basado en geolocalización
        function getNearestTerminal(lat, lon) {
            return Object.keys(terminals).reduce((nearest, terminalName) => {
                const terminalCoords = terminals[terminalName];
                const distance = haversineDistance(lat, lon, terminalCoords.lat, terminalCoords.lon);
                return distance < nearest.minDistance ? { name: terminalName, minDistance: distance } : nearest;
            }, { name: null, minDistance: Infinity }).name;
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radio de la Tierra en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
        
        // Funciones para obtener datos de Supabase
        async function fetchBusFleet() {
            if (!dbClient) {
                console.warn('Cliente de Supabase no inicializado');
                return [];
            }
            try {
                const { data, error } = await dbClient.from('buses').select('*');
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error fetching bus fleet:', error);
                // Solo mostrar error si es la primera vez
                if (busFleet.length === 0) {
                    showToast('Error al cargar la flota de buses. Verificando conexión...', 'warning');
                }
                return [];
            }
        }
        
        // Función para cargar datos iniciales y actualizar notificaciones
        async function loadInitialData() {
            try {
                // Cargar flota de buses
                busFleet = await fetchBusFleet();
                
                // Cargar inspecciones
                allInspections = await fetchAllInspections();
                lastInspectionCount = allInspections.length;
                
                // Cargar usuarios activos
                activeUsers = await fetchActiveUsers();
                
                // Actualizar panel de notificaciones con datos reales
                updateNotificationsPanel();
                
                // Inicializar nombre del inspector si ya tenemos ubicación
                if (lastKnownPosition) {
                    const nearestTerminal = getNearestTerminal(lastKnownPosition.lat, lastKnownPosition.lon);
                    updateTerminalInfo(nearestTerminal);
                }
                
                // Actualizar estadísticas del dashboard con datos reales
                updateDashboardStats();
                
                // Actualizar contadores de flota
                updateFleetCounters();
                
                // Actualizar contador de usuarios activos
                updateActiveUsersCounter(activeUsers);
                
                // Actualizar gráficos si estamos en la vista de analítica
                if (currentView === 'analytics') {
                    renderTerminalsComparison();
                    updateKPIs();
                }
                
                console.log(`Datos cargados: ${busFleet.length} buses, ${allInspections.length} inspecciones, ${activeUsers.length} usuarios activos`);
                
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
                showToast('Error al cargar datos iniciales', 'error');
            }
        }

        // ===== SISTEMA DE USUARIOS ACTIVOS EN TIEMPO REAL =====
        
        // Generar ID de sesión único
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Obtener información del dispositivo
        function getDeviceInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screenWidth: screen.width,
                screenHeight: screen.height,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            };
        }
        
        // Registrar usuario activo
        async function registerActiveUser(lat, lon, terminal, inspectorName) {
            try {
                if (!dbClient) return;
                
                // Generar session ID si no existe
                if (!currentSessionId) {
                    currentSessionId = generateSessionId();
                }
                
                const userData = {
                    user_id: currentSessionId,
                    inspector_name: inspectorName,
                    terminal: terminal,
                    lat: lat,
                    lon: lon,
                    session_id: currentSessionId,
                    device_info: getDeviceInfo(),
                    last_activity: new Date().toISOString()
                };
                
                // Intentar upsert primero
                let { error } = await dbClient
                    .from('active_users')
                    .upsert(userData, { 
                        onConflict: 'session_id',
                        ignoreDuplicates: false 
                    });
                
                // Si falla el upsert, intentar insert/update manual
                if (error && error.code === '42P10') {
                    console.log('Upsert falló, intentando insert/update manual...');
                    
                    // Verificar si el usuario ya existe
                    const { data: existingUser } = await dbClient
                        .from('active_users')
                        .select('session_id')
                        .eq('session_id', currentSessionId)
                        .single();
                    
                    if (existingUser) {
                        // Actualizar usuario existente
                        const { error: updateError } = await dbClient
                            .from('active_users')
                            .update(userData)
                            .eq('session_id', currentSessionId);
                        
                        if (updateError) throw updateError;
                    } else {
                        // Insertar nuevo usuario
                        const { error: insertError } = await dbClient
                            .from('active_users')
                            .insert([userData]);
                        
                        if (insertError) throw insertError;
                    }
                } else if (error) {
                    throw error;
                }
                
                console.log('Usuario activo registrado:', userData);
                
            } catch (error) {
                console.error('Error registrando usuario activo:', error);
            }
        }
        
        // Obtener usuarios activos
        async function fetchActiveUsers() {
            try {
                if (!dbClient) return [];
                
                const { data, error } = await dbClient
                    .from('active_users')
                    .select('*')
                    .gte('last_activity', new Date(Date.now() - 5 * 60 * 1000).toISOString()) // Últimos 5 minutos
                    .order('last_activity', { ascending: false });
                
                if (error) throw error;
                
                return data || [];
                
            } catch (error) {
                console.error('Error obteniendo usuarios activos:', error);
                return [];
            }
        }
        
        // Actualizar usuarios activos en el mapa - SOLO EL MÁS RECIENTE
        function updateActiveUsersOnMap(users) {
            // Limpiar marcadores anteriores
            userMapMarkers.forEach(marker => {
                if (map && map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            userMapMarkers.clear();
            
            // Filtrar solo usuarios que no sean el actual
            const otherUsers = users.filter(user => user.session_id !== currentSessionId);
            
            console.log(`🗺️ Usuarios activos encontrados: ${otherUsers.length}`);
            
            if (otherUsers.length > 0) {
                // Tomar solo el usuario más reciente (último en actualizarse)
                const latestUser = otherUsers[0]; // Ya viene ordenado por fecha más reciente
                console.log(`📍 Mostrando solo el usuario más reciente: ${latestUser.inspector_name} en ${latestUser.terminal}`);
                
                const marker = L.marker([latestUser.lat, latestUser.lon], {
                    icon: L.divIcon({
                        html: `<div class="flex items-center justify-center bg-green-500 text-white rounded-full font-bold text-xs p-1" style="width: 28px; height: 28px;"><i data-lucide="user" class="h-3 w-3"></i></div>`,
                        className: 'active-user-marker',
                        iconSize: [28, 28]
                    })
                });
                
                const popupContent = `
                    <div class="text-center">
                        <div class="font-bold text-green-600">${latestUser.inspector_name}</div>
                        <div class="text-sm text-gray-600">${latestUser.terminal}</div>
                        <div class="text-xs text-gray-500">Activo ahora</div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                marker.addTo(map);
                userMapMarkers.set(latestUser.session_id, marker);
            }
        }
        
        // Actualizar contador de usuarios activos
        function updateActiveUsersCounter(users) {
            const activeUsersCount = users.filter(user => user.session_id !== currentSessionId).length;
            const counterElement = document.getElementById('active-users-count');
            
            if (counterElement) {
                counterElement.textContent = activeUsersCount;
                
                // Actualizar el texto para plural/singular
                const container = counterElement.parentElement;
                if (container) {
                    const textElement = container.querySelector('span:last-child');
                    if (textElement) {
                        textElement.textContent = activeUsersCount === 1 ? ' Usuario Activo' : ' Usuarios Activos';
                    }
                }
            }
        }
        
        // Iniciar seguimiento de actividad del usuario
        function startUserActivityTracking() {
            // Limpiar intervalo anterior si existe
            if (userActivityInterval) {
                clearInterval(userActivityInterval);
            }
            
            // Actualizar actividad cada 30 segundos
            userActivityInterval = setInterval(async () => {
                if (lastKnownPosition && currentTerminal && currentTerminal !== 'Detectando...') {
                    await registerActiveUser(
                        lastKnownPosition.lat,
                        lastKnownPosition.lon,
                        currentTerminal,
                        currentInspectorName
                    );
                }
            }, 30000); // 30 segundos
        }
        
        // Iniciar actualización de usuarios activos
        function startActiveUsersUpdates() {
            // Limpiar intervalo anterior si existe
            if (activeUsersUpdateInterval) {
                clearInterval(activeUsersUpdateInterval);
            }
            
            // Actualizar usuarios activos cada 10 segundos
            activeUsersUpdateInterval = setInterval(async () => {
                try {
                    activeUsers = await fetchActiveUsers();
                    updateActiveUsersOnMap(activeUsers);
                    updateActiveUsersCounter(activeUsers);
                } catch (error) {
                    console.error('Error actualizando usuarios activos:', error);
                }
            }, 10000); // 10 segundos
        }
        
        // Detener seguimiento de usuarios activos
        function stopActiveUsersTracking() {
            if (userActivityInterval) {
                clearInterval(userActivityInterval);
                userActivityInterval = null;
            }
            
            if (activeUsersUpdateInterval) {
                clearInterval(activeUsersUpdateInterval);
                activeUsersUpdateInterval = null;
            }
            
            // Limpiar marcadores del mapa
            userMapMarkers.forEach(marker => {
                if (map && map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            userMapMarkers.clear();
        }

        async function fetchAllInspections() {
            if (!dbClient) {
                console.warn('Cliente de Supabase no inicializado');
                return [];
            }
            
            // Verificar conectividad antes de hacer la petición
            if (!navigator.onLine) {
                console.warn('Sin conexión a internet');
                showToast('Sin conexión a internet. Los datos se cargarán cuando se restablezca la conexión.', 'warning');
                return [];
            }
            
            try {
                const { data, error } = await dbClient
                    .from('levantamiento_de_publicidad')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error fetching inspections:', error);
                
                // Manejar diferentes tipos de errores
                if (error.message && error.message.includes('Failed to fetch')) {
                    showToast('Error de conexión. Verifica tu conexión a internet.', 'error');
                } else if (error.message && error.message.includes('net::ERR_INTERNET_DISCONNECTED')) {
                    showToast('Sin conexión a internet. Los datos se cargarán cuando se restablezca la conexión.', 'warning');
                } else {
                    // Solo mostrar error si es la primera vez
                    if (allInspections.length === 0) {
                        showToast('Error al cargar los datos de inspección. Verificando conexión...', 'warning');
                    }
                }
                return [];
            }
        }
        
        // Funciones de utilidad
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatSimpleDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function calculatePercentage(value, total) {
            if (total === 0) return 0;
            return Math.round((value / total) * 100);
        }
        
        function getUniqueIncidents(inspections, type) {
            const latestIncidents = {};
            inspections.filter(insp => insp[type]).forEach(insp => {
                if (!latestIncidents[insp.ppu] || new Date(insp.created_at) > new Date(latestIncidents[insp.ppu].created_at)) {
                    latestIncidents[insp.ppu] = insp;
                }
            });
            return Object.values(latestIncidents);
        }
        
        function groupInspectionsByDate(inspections, period = 30) {
            const now = new Date();
            const result = {};
            const dateFormat = new Intl.DateTimeFormat('es', { day: '2-digit', month: 'short' });
            
            // Inicializar el objeto con fechas vacías
            for (let i = period - 1; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const formattedDate = dateFormat.format(date);
                result[formattedDate] = 0;
            }
            
            // Agrupar inspecciones por fecha
            inspections.forEach(insp => {
                const inspDate = new Date(insp.created_at);
                const daysDiff = Math.floor((now - inspDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff < period) {
                    const formattedDate = dateFormat.format(inspDate);
                    result[formattedDate] = (result[formattedDate] || 0) + 1;
                }
            });
            
            return result;
        }
        
        function calculateTrendIndicator(groupedData) {
            const values = Object.values(groupedData);
            if (values.length < 2) return 0;
            
            const firstHalf = values.slice(0, Math.floor(values.length / 2));
            const secondHalf = values.slice(Math.floor(values.length / 2));
            
            const firstHalfAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
            const secondHalfAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;
            
            if (firstHalfAvg === 0) return secondHalfAvg > 0 ? 100 : 0;
            
            return Math.round(((secondHalfAvg - firstHalfAvg) / firstHalfAvg) * 100);
        }
        
        // Inicialización del mapa
        function initMap() {
            if (map) {
                map.invalidateSize();
                return map;
            }
            
            // Crear el mapa base
            map = L.map('map', {
                center: [-33.45, -70.65],
                zoom: 11,
                zoomControl: false
            });
            
            // Añadir controles de zoom en una posición diferente
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            
            // Añadir capa base satelital
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '&copy; <a href="https://www.esri.com/">Esri</a>',
                maxZoom: 19
            }).addTo(map);
            
            // Inicializar capas
            markersLayer = L.layerGroup();
            markersClusterLayer = L.markerClusterGroup({
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    return L.divIcon({
                        html: `<div class="bg-brand-primary text-white rounded-full flex items-center justify-center font-bold" style="width: 30px; height: 30px;">${count}</div>`,
                        className: 'marker-cluster-custom',
                        iconSize: L.point(30, 30)
                    });
                }
            });
            
            terminalsLayer = L.layerGroup();
            
            // Crear marcadores de terminales
            Object.entries(terminals).forEach(([name, coords]) => {
                const marker = L.marker([coords.lat, coords.lon], {
                    icon: L.divIcon({
                        html: `<div class="flex items-center justify-center bg-brand-light text-white rounded-full font-bold text-xs p-1" style="width: 24px; height: 24px;"><i data-lucide="bus" class="h-3 w-3"></i></div>`,
                        className: 'terminal-marker',
                        iconSize: [24, 24]
                    })
                });
                marker.bindPopup(`<b>Terminal: ${name}</b>`);
                marker.addTo(terminalsLayer);
            });
            
            // Iniciar seguimiento en tiempo real de la ubicación del usuario
            startRealTimeTracking();
            
            // Actualizar usuarios activos en el mapa
            if (activeUsers.length > 0) {
                updateActiveUsersOnMap(activeUsers);
            }
            
            return map;
        }
        
        function updateTerminalInfo(terminal) {
            // Actualizar variable global
            currentTerminal = terminal || 'Detectando...';
            
            // Actualizar en la barra lateral
            document.getElementById('sidebar-terminal').textContent = `Terminal: ${currentTerminal}`;
            document.getElementById('mobile-sidebar-terminal').textContent = `Terminal: ${currentTerminal}`;
            document.getElementById('user-panel-terminal').textContent = `Terminal: ${currentTerminal}`;
            
            // Actualizar en el formulario si estamos en esa vista
            const currentTerminalElement = document.getElementById('current-terminal');
            if (currentTerminalElement) {
                currentTerminalElement.textContent = currentTerminal;
            }
            
            // Actualizar nombre del inspector basado en el terminal
            updateInspectorName(currentTerminal);
            
            // Registrar usuario activo si tenemos ubicación
            if (lastKnownPosition && currentTerminal && currentTerminal !== 'Detectando...') {
                registerActiveUser(lastKnownPosition.lat, lastKnownPosition.lon, currentTerminal, currentInspectorName);
            }
        }
        
        function updateInspectorName(terminal) {
            if (!terminal) {
                currentInspectorName = 'Inspector';
                return;
            }
            
            // Mapeo de terminales a nombres de inspectores
            const inspectorNames = {
                'El Roble': 'Inspector de El Roble',
                'La Reina': 'Inspector de La Reina',
                'Maria Angelica': 'Inspector de Maria Angelica',
                'El Descanso': 'Inspector de El Descanso'
            };
            
            currentInspectorName = inspectorNames[terminal] || `Inspector de ${terminal}`;
            
            // Actualizar elementos del DOM que muestran el nombre del inspector
            updateInspectorNameInUI();
            
            // Mostrar información del terminal en la consola
            const terminalInfo = terminals[terminal];
            if (terminalInfo) {
                console.log(`Inspector actualizado: ${currentInspectorName}`);
                console.log(`Terminal: ${terminal} (${terminalInfo.lat.toFixed(6)}, ${terminalInfo.lon.toFixed(6)})`);
            }
        }
        
        function updateInspectorNameInUI() {
            // Actualizar en la barra lateral
            const sidebarInspectorElements = document.querySelectorAll('.sidebar-inspector-name');
            sidebarInspectorElements.forEach(element => {
                element.textContent = currentInspectorName;
            });
            
            // Actualizar en el panel de usuario
            const userPanelInspectorElements = document.querySelectorAll('.user-panel-inspector-name');
            userPanelInspectorElements.forEach(element => {
                element.textContent = currentInspectorName;
            });
            
            // Actualizar en el sidebar móvil
            const mobileInspectorElements = document.querySelectorAll('.mobile-inspector-name');
            mobileInspectorElements.forEach(element => {
                element.textContent = currentInspectorName;
            });
            
            // Actualizar en el formulario
            const currentInspectorElement = document.getElementById('current-inspector');
            if (currentInspectorElement) {
                currentInspectorElement.textContent = currentInspectorName;
            }
        }
        
        function updateMapView(view) {
            if (!map) {
                console.warn('Mapa no inicializado');
                return;
            }
            
            console.log('Cambiando vista del mapa a:', view);
            mapView = view;
            
            // Limpiar todas las capas existentes
            try {
                if (markersLayer && map.hasLayer(markersLayer)) {
                    map.removeLayer(markersLayer);
                }
                if (markersClusterLayer && map.hasLayer(markersClusterLayer)) {
                    map.removeLayer(markersClusterLayer);
                }
                if (heatMapLayer && map.hasLayer(heatMapLayer)) {
                    map.removeLayer(heatMapLayer);
                }
                if (terminalsLayer && map.hasLayer(terminalsLayer)) {
                    map.removeLayer(terminalsLayer);
                }
            } catch (error) {
                console.warn('Error al limpiar capas:', error);
            }
            
            // Actualizar botones de vista
            document.querySelectorAll('.map-toggle').forEach(btn => {
                btn.classList.remove('bg-brand-light', 'text-white');
                btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });
            
            const activeBtn = document.getElementById(`map-view-${view}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                activeBtn.classList.add('bg-brand-light', 'text-white');
            }
            
            // Aplicar vista seleccionada
            switch (view) {
                case 'heat':
                    console.log('Aplicando vista de calor');
                    if (allInspections && allInspections.length > 0) {
                        const heatData = allInspections
                            .filter(i => i.lat && i.lon)
                            .map(i => [i.lat, i.lon, 0.5]);
                        
                        if (heatData.length > 0) {
                            heatMapLayer = L.heatLayer(heatData, {
                                radius: 25,
                                blur: 15,
                                maxZoom: 17,
                                gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'}
                            });
                            heatMapLayer.addTo(map);
                        }
                    }
                    if (terminalsLayer) terminalsLayer.addTo(map);
                    break;
                    
                case 'clusters':
                    console.log('Aplicando vista de clusters');
                    if (markersClusterLayer) {
                        markersClusterLayer.clearLayers();
                        if (allInspections && allInspections.length > 0) {
                            allInspections.forEach(insp => {
                                if (insp.lat && insp.lon) {
                                    const marker = L.marker([insp.lat, insp.lon], {
                                        icon: L.divIcon({
                                            html: `<div class="flex items-center justify-center bg-white border-2 border-status-red text-status-red rounded-full" style="width: 24px; height: 24px;"><i data-lucide="bus" class="h-3 w-3"></i></div>`,
                                            className: 'inspection-marker',
                                            iconSize: [24, 24]
                                        })
                                    });
                                    marker.bindPopup(`<b>PPU:</b> ${insp.ppu}<br><b>N° Interno:</b> ${insp.numero_interno}<br><b>Fecha:</b> ${formatDate(insp.created_at)}`);
                                    markersClusterLayer.addLayer(marker);
                                }
                            });
                        }
                        markersClusterLayer.addTo(map);
                    }
                    if (terminalsLayer) terminalsLayer.addTo(map);
                    break;
                    
                case 'terminals':
                    console.log('Aplicando vista de terminales');
                    if (terminalsLayer) terminalsLayer.addTo(map);
                    
                    // Crear círculos para mostrar densidad de inspecciones por terminal
                    const terminalCounts = {};
                    if (allInspections && allInspections.length > 0) {
                        allInspections.forEach(i => {
                            if (i.terminal) {
                                terminalCounts[i.terminal] = (terminalCounts[i.terminal] || 0) + 1;
                            }
                        });
                    }
                    
                    Object.entries(terminals).forEach(([name, coords]) => {
                        const count = terminalCounts[name] || 0;
                        const radius = Math.max(500, Math.sqrt(count) * 200);
                        
                        L.circle([coords.lat, coords.lon], {
                            radius: radius,
                            color: '#1e40af',
                            fillColor: '#3b82f6',
                            fillOpacity: 0.3,
                            weight: 1
                        }).bindPopup(`<b>${name}</b><br>${count} inspecciones`).addTo(map);
                    });
                    break;
                    
                default: // standard
                    console.log('Aplicando vista estándar');
                    if (markersLayer) {
                        markersLayer.clearLayers();
                        if (allInspections && allInspections.length > 0) {
                            allInspections.forEach(insp => {
                                if (insp.lat && insp.lon) {
                                    const marker = L.marker([insp.lat, insp.lon], {
                                        icon: L.divIcon({
                                            html: `<div class="flex items-center justify-center bg-white border-2 border-status-red text-status-red rounded-full" style="width: 24px; height: 24px;"><i data-lucide="map-pin" class="h-3 w-3"></i></div>`,
                                            className: 'inspection-marker',
                                            iconSize: [24, 24]
                                        })
                                    });
                                    marker.bindPopup(`<b>PPU:</b> ${insp.ppu}<br><b>N° Interno:</b> ${insp.numero_interno}<br><b>Fecha:</b> ${formatDate(insp.created_at)}`);
                                    marker.addTo(markersLayer);
                                }
                            });
                        }
                        markersLayer.addTo(map);
                    }
                    if (terminalsLayer) terminalsLayer.addTo(map);
                    break;
            }
            
            // Forzar actualización del mapa
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                }
            }, 100);
            
                        // Refrescar iconos
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }        
        // Carga de datos optimizada por vista
        async function loadDashboardData() {
            showLoader('Cargando dashboard...');
            
            try {
                // Cargar datos solo si no están disponibles
                if (busFleet.length === 0) {
                    busFleet = await fetchBusFleet();
                }
                if (allInspections.length === 0) {
                    allInspections = await fetchAllInspections();
                }
                
                // Inicializar mapa solo si no existe
                if (!map) {
                    map = initMap();
                    setTimeout(() => {
                        if (map) {
                            updateMapView(mapView || 'standard');
                        }
                    }, 100);
                }
                
                // Actualizar solo estadísticas esenciales
                updateDashboardStats();
                updateInspectionsChart(allInspections);
                updateFleetProgress();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Error al cargar datos', 'warning');
            } finally {
                hideLoader();
            }
        }
        

        
        function updateFleetProgress() {
            const totalBuses = busFleet.length;
            const inspectedBuses = new Set(allInspections.map(i => i.ppu)).size;
            const pendingBuses = totalBuses - inspectedBuses;
            const percentage = calculatePercentage(inspectedBuses, totalBuses);
            
            // Actualizar contadores
            document.getElementById('buses-inspected').textContent = inspectedBuses;
            document.getElementById('buses-pending').textContent = pendingBuses;
            document.getElementById('fleet-progress-text').textContent = `${inspectedBuses}/${totalBuses}`;
            document.getElementById('fleet-progress-percentage').textContent = `${percentage}%`;
            
            // Actualizar barra de progreso
            document.getElementById('fleet-progress-bar').style.width = `${percentage}%`;
            
            // Actualizar anillo de progreso SVG
            const circle = document.getElementById('progress-ring');
            const radius = 40;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            circle.style.strokeDasharray = `${circumference} ${circumference}`;
        }
        
        function updateInspectionsChart(inspections) {
            const ctx = document.getElementById('inspections-chart').getContext('2d');
            
            // Filtrar inspecciones según el período seleccionado
            const now = new Date();
            const filtered = inspections.filter(insp => {
                const inspDate = new Date(insp.created_at);
                const diffTime = Math.abs(now - inspDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                switch (dateFilterPeriod) {
                    case 'day': return diffDays <= 1;
                    case 'week': return diffDays <= 7;
                    case 'month': return diffDays <= 30;
                    case 'year': return diffDays <= 365;
                    default: return true;
                }
            });
            
            // Agrupar por terminal
            const terminalData = {
                'El Roble': 0,
                'La Reina': 0,
                'Maria Angelica': 0,
                'El Descanso': 0
            };
            
            filtered.forEach(insp => {
                if (terminalData.hasOwnProperty(insp.terminal)) {
                    terminalData[insp.terminal]++;
                }
            });
            
            // Si ya existe un chart, destruirlo para crear uno nuevo
            if (window.inspectionsChart) {
                window.inspectionsChart.destroy();
            }
            
            // Crear el nuevo chart
            window.inspectionsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(terminalData),
                    datasets: [{
                        label: 'Inspecciones',
                        data: Object.values(terminalData),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.7)', // brand-light
                            'rgba(30, 64, 175, 0.7)', // brand-primary
                            'rgba(29, 78, 216, 0.7)', // brand-secondary
                            'rgba(30, 58, 138, 0.7)'  // brand-dark
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(30, 64, 175)',
                            'rgb(29, 78, 216)',
                            'rgb(30, 58, 138)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        function updateDashboardIncidentLists() {
            const damageIncidents = getUniqueIncidents(allInspections, 'dano_pintura');
            const residueIncidents = getUniqueIncidents(allInspections, 'residuos_pegamento');
            
            // Actualizar contadores
            document.getElementById('damage-count').textContent = damageIncidents.length;
            document.getElementById('residue-count').textContent = residueIncidents.length;
            
            // Actualizar listas
            const damageList = document.getElementById('dashboard-damage-list');
            const residueList = document.getElementById('dashboard-residue-list');
            
            damageList.innerHTML = '';
            residueList.innerHTML = '';
            
            // Mostrar solo los 3 más recientes en el dashboard
            damageIncidents.slice(0, 3).forEach(insp => {
                damageList.innerHTML += `
                    <li class="bg-gray-50 dark:bg-gray-900 rounded-lg p-3">
                        <div class="flex justify-between">
                            <p class="font-medium text-text-primary dark:text-text-primary-dark">${insp.ppu} <span class="font-normal text-text-secondary dark:text-text-secondary-dark">(${insp.numero_interno})</span></p>
                            <span class="text-xs text-text-secondary dark:text-text-secondary-dark">${formatSimpleDate(insp.created_at)}</span>
                        </div>
                        <p class="text-sm text-text-secondary dark:text-text-secondary-dark mt-1 line-clamp-2">${insp.dano_pintura_detalle}</p>
                    </li>
                `;
            });
            
            residueIncidents.slice(0, 3).forEach(insp => {
                residueList.innerHTML += `
                    <li class="bg-gray-50 dark:bg-gray-900 rounded-lg p-3">
                        <div class="flex justify-between">
                            <p class="font-medium text-text-primary dark:text-text-primary-dark">${insp.ppu} <span class="font-normal text-text-secondary dark:text-text-secondary-dark">(${insp.numero_interno})</span></p>
                            <span class="text-xs text-text-secondary dark:text-text-secondary-dark">${formatSimpleDate(insp.created_at)}</span>
                        </div>
                        <p class="text-sm text-text-secondary dark:text-text-secondary-dark mt-1 line-clamp-2">${insp.residuos_pegamento_detalle}</p>
                    </li>
                `;
            });
            
            // Mostrar mensaje si no hay incidentes
            if (damageIncidents.length === 0) {
                damageList.innerHTML = `<li class="text-center text-text-secondary dark:text-text-secondary-dark py-2">No hay buses con daños reportados.</li>`;
            }
            
            if (residueIncidents.length === 0) {
                residueList.innerHTML = `<li class="text-center text-text-secondary dark:text-text-secondary-dark py-2">No hay buses con residuos reportados.</li>`;
            }
            
            // Añadir enlace "Ver más" si hay más de 3 incidentes
            if (damageIncidents.length > 3) {
                damageList.innerHTML += `
                    <li class="text-center mt-2">
                        <a href="#" data-view="assistance" class="text-sm text-brand-primary dark:text-brand-light hover:underline">Ver todos (${damageIncidents.length})</a>
                    </li>
                `;
            }
            
            if (residueIncidents.length > 3) {
                residueList.innerHTML += `
                    <li class="text-center mt-2">
                        <a href="#" data-view="assistance" class="text-sm text-brand-primary dark:text-brand-light hover:underline">Ver todos (${residueIncidents.length})</a>
                    </li>
                `;
            }
            
            // Añadir listeners a los enlaces "Ver más"
            document.querySelectorAll('#dashboard-damage-list a[data-view], #dashboard-residue-list a[data-view]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(link.dataset.view);
                });
            });
        }
        
        async function setupFormView() {
            // Cargar datos si aún no están disponibles
            if (busFleet.length === 0) {
                showLoader('Cargando flota de buses...');
                busFleet = await fetchBusFleet();
                hideLoader();
            }
            
            // Detectar terminal más cercano si hay geolocalización disponible
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const nearestTerminal = getNearestTerminal(pos.coords.latitude, pos.coords.longitude);
                    document.getElementById('current-terminal').textContent = nearestTerminal || 'Desconocido';
                }, () => {
                    document.getElementById('current-terminal').textContent = 'No disponible';
                });
            }
            
            // Configurar campos condicionales
            const conditionalFields = [
                { radioName: 'publicidad_izquierda', detailId: 'publicidad_izquierda_detalle', photoContainerId: 'pub-izq-photo-container' },
                { radioName: 'publicidad_luneta', detailId: 'publicidad_luneta_detalle', photoContainerId: 'pub-luneta-photo-container' },
                { radioName: 'publicidad_derecha', detailId: 'publicidad_derecha_detalle', photoContainerId: 'pub-der-photo-container' },
                { radioName: 'residuos_pegamento', detailId: 'residuos_pegamento_detalle', photoContainerId: 'residuos-photo-container' },
                { radioName: 'dano_pintura', detailId: 'dano_pintura_detalle', photoContainerId: 'dano-photo-container' }
            ];
            
            conditionalFields.forEach(({ radioName, detailId, photoContainerId }) => {
                document.querySelectorAll(`input[name="${radioName}"]`).forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const detailEl = document.getElementById(detailId);
                        const photoContainer = document.getElementById(photoContainerId);
                        
                        const isYes = e.target.value === 'true';
                        detailEl.classList.toggle('hidden', !isYes);
                        photoContainer.classList.toggle('hidden', !isYes);
                        
                        detailEl.required = isYes;
                        if (!isYes) {
                            detailEl.value = '';
                        }
                    });
                });
            });
            
            // Simular funcionalidad de tomar fotos (en una implementación real, esto usaría la API de la cámara)
            document.querySelectorAll('[id$="-photo-btn"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const containerId = e.target.closest('[id$="-photo-container"]').id;
                    const previewId = containerId.replace('container', 'preview');
                    const previewElement = document.getElementById(previewId);
                    
                    // Simular una foto con una imagen de placeholder
                    previewElement.querySelector('img').src = 'https://via.placeholder.com/400x300?text=Foto+Simulada';
                    previewElement.classList.remove('hidden');
                    
                    showToast('Foto capturada con éxito', 'success');
                });
            });
        }
        
        async function loadFleetData() {
            showLoader('Cargando datos de la flota...');
            
            try {
                // Cargar datos si aún no están disponibles
                if (busFleet.length === 0) {
                    busFleet = await fetchBusFleet();
                }
                if (allInspections.length === 0) {
                    allInspections = await fetchAllInspections();
                }
                
                // Actualizar estadísticas de la flota
                updateFleetStats();
                
                // Renderizar la grid de buses con paginación
                renderFleetGrid();
                
            } catch (error) {
                console.error('Error loading fleet data:', error);
                showToast('Error al cargar los datos de la flota.', 'error');
            } finally {
                hideLoader();
            }
        }
        
        function updateFleetStats() {
            const totalBuses = busFleet.length;
            const inspectedPPUs = new Set(allInspections.map(i => i.ppu));
            const inspectedCount = inspectedPPUs.size;
            const pendingCount = totalBuses - inspectedCount;
            
            // Contar buses con problemas (daños o residuos)
            const busesWithIssues = new Set();
            allInspections.forEach(insp => {
                if (insp.dano_pintura || insp.residuos_pegamento) {
                    busesWithIssues.add(insp.ppu);
                }
            });
            const issuesCount = busesWithIssues.size;
            
            // Actualizar contadores
            document.getElementById('fleet-total-count').textContent = totalBuses;
            document.getElementById('fleet-inspected-count').textContent = inspectedCount;
            document.getElementById('fleet-pending-count').textContent = pendingCount;
            document.getElementById('fleet-issues-count').textContent = issuesCount;
        }
        
        function renderFleetGrid() {
            const fleetGrid = document.getElementById('fleet-grid');
            const searchTerm = fleetSearchParams.searchTerm.toLowerCase();
            const filter = fleetSearchParams.filter;
            const terminal = fleetSearchParams.terminal;
            
            // Crear un conjunto de PPUs inspeccionados
            const inspectedPPUs = new Set(allInspections.map(i => i.ppu));
            
            // Crear un mapa de terminales por PPU
            const terminalByPPU = {};
            allInspections.forEach(i => {
                if (i.terminal) {
                    terminalByPPU[i.ppu] = i.terminal;
                }
            });
            
            // Crear conjuntos de buses con problemas
            const busesWithDamage = new Set();
            const busesWithResidue = new Set();
            allInspections.forEach(i => {
                if (i.dano_pintura) busesWithDamage.add(i.ppu);
                if (i.residuos_pegamento) busesWithResidue.add(i.ppu);
            });
            
            // Filtrar buses según los criterios
            let filteredBuses = busFleet.filter(bus => {
                // Filtrar por término de búsqueda
                const matchesSearch = searchTerm === '' || 
                    bus.ppu.toLowerCase().includes(searchTerm) || 
                    (bus.numero_interno && bus.numero_interno.toLowerCase().includes(searchTerm));
                
                // Filtrar por estado de inspección
                let matchesFilter = true;
                switch (filter) {
                    case 'inspected': matchesFilter = inspectedPPUs.has(bus.ppu); break;
                    case 'pending': matchesFilter = !inspectedPPUs.has(bus.ppu); break;
                    case 'damaged': matchesFilter = busesWithDamage.has(bus.ppu); break;
                    case 'residue': matchesFilter = busesWithResidue.has(bus.ppu); break;
                }
                
                // Filtrar por terminal
                let matchesTerminal = true;
                if (terminal !== 'all') {
                    matchesTerminal = terminalByPPU[bus.ppu] === terminal;
                }
                
                return matchesSearch && matchesFilter && matchesTerminal;
            });
            
            // Ordenar buses (inspeccionados primero, luego por número interno)
            filteredBuses.sort((a, b) => {
                const aInspected = inspectedPPUs.has(a.ppu);
                const bInspected = inspectedPPUs.has(b.ppu);
                
                if (aInspected !== bInspected) {
                    return aInspected ? -1 : 1;
                }
                
                return a.numero_interno.localeCompare(b.numero_interno);
            });
            
            // Mostrar todos los buses sin paginación
            const allBuses = filteredBuses;
            
            // Ocultar paginación
            document.getElementById('fleet-pagination').classList.add('hidden');
            
            // Mostrar estado vacío si no hay resultados
            const fleetEmptyState = document.getElementById('fleet-empty-state');
            if (filteredBuses.length === 0) {
                fleetGrid.innerHTML = '';
                fleetEmptyState.classList.remove('hidden');
                return;
            } else {
                fleetEmptyState.classList.add('hidden');
            }
            
            // Renderizar tarjetas de buses
            fleetGrid.innerHTML = '';
            allBuses.forEach(bus => {
                const isInspected = inspectedPPUs.has(bus.ppu);
                const hasDamage = busesWithDamage.has(bus.ppu);
                const hasResidue = busesWithResidue.has(bus.ppu);
                const busTerminal = terminalByPPU[bus.ppu] || 'No asignado';
                
                let statusClass = '';
                let statusText = '';
                let statusIcon = '';
                
                if (hasDamage) {
                    statusClass = 'bg-status-red text-white';
                    statusText = 'Daño';
                    statusIcon = 'shield-alert';
                } else if (hasResidue) {
                    statusClass = 'bg-status-yellow text-black';
                    statusText = 'Residuo';
                    statusIcon = 'alert-triangle';
                } else if (isInspected) {
                    statusClass = 'bg-status-green text-white';
                    statusText = 'Inspeccionado';
                    statusIcon = 'check-circle';
                } else {
                    statusClass = 'bg-status-gray text-white';
                    statusText = 'Pendiente';
                    statusIcon = 'clock';
                }
                
                const card = document.createElement('div');
                card.className = 'bus-card bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer card-hover';
                card.dataset.ppu = bus.ppu;
                card.dataset.numeroInterno = bus.numero_interno;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-lg text-text-primary dark:text-text-primary-dark">${bus.ppu}</div>
                            <div class="text-sm text-text-secondary dark:text-text-secondary-dark">N° ${bus.numero_interno}</div>
                            <div class="text-xs text-text-secondary dark:text-text-secondary-dark mt-1">${bus.marca || 'Sin datos'}</div>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="badge ${statusClass} flex items-center">
                                <i data-lucide="${statusIcon}" class="h-3 w-3 mr-1"></i> ${statusText}
                            </span>
                            ${isInspected ? `<span class="text-xs text-text-secondary dark:text-text-secondary-dark mt-2">${busTerminal}</span>` : ''}
                        </div>
                    </div>
                    ${isInspected ? `
                    <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between text-xs">
                            <span class="text-text-secondary dark:text-text-secondary-dark">Última inspección:</span>
                            <span class="text-text-primary dark:text-text-primary-dark font-medium">
                                ${formatSimpleDate(allInspections.find(i => i.ppu === bus.ppu)?.created_at || new Date())}
                            </span>
                        </div>
                    </div>` : ''}
                `;
                
                card.addEventListener('click', () => showBusDetailModal(bus.ppu));
                fleetGrid.appendChild(card);
            });
            
            // Refrescar iconos de Lucide
            lucide.createIcons();
        }
        
        function showBusDetailModal(ppu) {
            const modal = document.getElementById('bus-detail-modal');
            const modalContent = document.getElementById('bus-detail-content');
            
            modal.classList.remove('hidden');
            
            // Obtener datos del bus
            const bus = busFleet.find(b => b.ppu === ppu);
            if (!bus) {
                modalContent.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-4 mb-4">
                            <h3 class="text-xl font-bold text-text-primary dark:text-text-primary-dark">Bus no encontrado</h3>
                            <button class="close-bus-detail-btn p-1 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <i data-lucide="x" class="h-5 w-5"></i>
                            </button>
                        </div>
                        <p class="text-text-secondary dark:text-text-secondary-dark">No se encontró información para el bus con PPU: ${ppu}</p>
                    </div>
                `;
                
                setTimeout(() => {
                    modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                }, 10);
                
                configureModalClosers(modal);
                return;
            }
            
            // Obtener historial de inspecciones para este bus
            const busInspections = allInspections.filter(i => i.ppu === ppu).sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );
            
            const lastInspection = busInspections[0];
            const isInspected = !!lastInspection;
            
            // Determinar si tiene problemas
            const hasDamage = lastInspection?.dano_pintura || false;
            const hasResidue = lastInspection?.residuos_pegamento || false;
            const hasPublicity = lastInspection?.publicidad_izquierda || lastInspection?.publicidad_luneta || lastInspection?.publicidad_derecha || false;
            
            // Crear contenido del modal
            modalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-4 mb-6">
                        <div class="flex items-center">
                            <div class="mr-3 h-10 w-10 bg-brand-light/20 dark:bg-brand-light/10 rounded-full flex items-center justify-center">
                                <i data-lucide="bus" class="h-5 w-5 text-brand-primary dark:text-brand-light"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-text-primary dark:text-text-primary-dark">${ppu}</h3>
                                <p class="text-sm text-text-secondary dark:text-text-secondary-dark">N° Interno: ${bus.numero_interno}</p>
                            </div>
                        </div>
                        <button class="close-bus-detail-btn p-1 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i data-lucide="x" class="h-5 w-5"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            ${isInspected ? `
                                <div class="bg-gray-50 dark:bg-gray-900 rounded-xl p-5 mb-6">
                                    <h4 class="text-lg font-semibold text-text-primary dark:text-text-primary-dark mb-4">Última Inspección</h4>
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <p class="text-sm text-text-secondary dark:text-text-secondary-dark">Fecha:</p>
                                            <p class="font-medium text-text-primary dark:text-text-primary-dark">${formatDate(lastInspection.created_at)}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-text-secondary dark:text-text-secondary-dark">Terminal:</p>
                                            <p class="font-medium text-text-primary dark:text-text-primary-dark">${lastInspection.terminal || 'No especificado'}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-4 mb-4">
                                        <div class="grid grid-cols-3 gap-4">
                                            <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                                <div class="flex items-center mb-1">
                                                    <i data-lucide="${lastInspection.publicidad_izquierda ? 'check' : 'x'}" class="h-4 w-4 mr-1 ${lastInspection.publicidad_izquierda ? 'text-status-red' : 'text-status-green'}"></i>
                                                    <p class="text-sm font-medium">Pub. Izquierda</p>
                                                </div>
                                                ${lastInspection.publicidad_izquierda ? `
                                                    <p class="text-xs text-text-secondary dark:text-text-secondary-dark line-clamp-2">${lastInspection.publicidad_izquierda_detalle}</p>
                                                ` : ''}
                                            </div>
                                            <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                                <div class="flex items-center mb-1">
                                                    <i data-lucide="${lastInspection.publicidad_luneta ? 'check' : 'x'}" class="h-4 w-4 mr-1 ${lastInspection.publicidad_luneta ? 'text-status-red' : 'text-status-green'}"></i>
                                                    <p class="text-sm font-medium">Pub. Luneta</p>
                                                </div>
                                                ${lastInspection.publicidad_luneta ? `
                                                    <p class="text-xs text-text-secondary dark:text-text-secondary-dark line-clamp-2">${lastInspection.publicidad_luneta_detalle}</p>
                                                ` : ''}
                                            </div>
                                            <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                                <div class="flex items-center mb-1">
                                                    <i data-lucide="${lastInspection.publicidad_derecha ? 'check' : 'x'}" class="h-4 w-4 mr-1 ${lastInspection.publicidad_derecha ? 'text-status-red' : 'text-status-green'}"></i>
                                                    <p class="text-sm font-medium">Pub. Derecha</p>
                                                </div>
                                                ${lastInspection.publicidad_derecha ? `
                                                    <p class="text-xs text-text-secondary dark:text-text-secondary-dark line-clamp-2">${lastInspection.publicidad_derecha_detalle}</p>
                                                ` : ''}
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                                <div class="flex items-center mb-1">
                                                    <i data-lucide="${lastInspection.residuos_pegamento ? 'check' : 'x'}" class="h-4 w-4 mr-1 ${lastInspection.residuos_pegamento ? 'text-status-red' : 'text-status-green'}"></i>
                                                    <p class="text-sm font-medium">Residuos de Pegamento</p>
                                                </div>
                                                ${lastInspection.residuos_pegamento ? `
                                                    <p class="text-xs text-text-secondary dark:text-text-secondary-dark">${lastInspection.residuos_pegamento_detalle}</p>
                                                ` : ''}
                                            </div>
                                            <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                                <div class="flex items-center mb-1">
                                                    <i data-lucide="${lastInspection.dano_pintura ? 'check' : 'x'}" class="h-4 w-4 mr-1 ${lastInspection.dano_pintura ? 'text-status-red' : 'text-status-green'}"></i>
                                                    <p class="text-sm font-medium">Daño de Pintura</p>
                                                </div>
                                                ${lastInspection.dano_pintura ? `
                                                    <p class="text-xs text-text-secondary dark:text-text-secondary-dark">${lastInspection.dano_pintura_detalle}</p>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-end mt-4">
                                        <button class="text-sm text-brand-primary dark:text-brand-light hover:underline mr-3 schedule-maintenance-btn" data-ppu="${ppu}" data-numero-interno="${bus.numero_interno}">
                                            <i data-lucide="calendar-plus" class="h-4 w-4 mr-1 inline-block"></i> Programar Mantenimiento
                                        </button>
                                        <button class="text-sm text-brand-primary dark:text-brand-light hover:underline register-inspection-btn" data-ppu="${ppu}" data-numero-interno="${bus.numero_interno}">
                                            <i data-lucide="clipboard-edit" class="h-4 w-4 mr-1 inline-block"></i> Nueva Inspección
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <div class="bg-gray-50 dark:bg-gray-900 rounded-xl p-5 mb-6">
                                    <div class="flex items-center mb-4">
                                        <i data-lucide="info" class="h-5 w-5 mr-2 text-brand-light"></i>
                                        <h4 class="text-lg font-semibold text-text-primary dark:text-text-primary-dark">Sin Inspecciones</h4>
                                    </div>
                                    <p class="text-text-secondary dark:text-text-secondary-dark mb-4">Este bus aún no ha sido inspeccionado.</p>
                                    <div class="flex justify-end">
                                        <button class="bg-brand-primary hover:bg-brand-dark text-white py-2 px-4 rounded-lg shadow-md transition-colors duration-200 register-inspection-btn" data-ppu="${ppu}" data-numero-interno="${bus.numero_interno}">
                                            <i data-lucide="clipboard-plus" class="h-4 w-4 mr-1 inline-block"></i> Registrar Inspección
                                        </button>
                                    </div>
                                </div>
                            `}
                            
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-xl p-5">
                                <h4 class="text-lg font-semibold text-text-primary dark:text-text-primary-dark mb-4">Historial de Inspecciones</h4>
                                ${busInspections.length > 0 ? `
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full">
                                            <thead>
                                                <tr class="text-left text-xs font-medium text-text-secondary dark:text-text-secondary-dark uppercase tracking-wider">
                                                    <th class="px-4 py-2">Fecha</th>
                                                    <th class="px-4 py-2">Terminal</th>
                                                    <th class="px-4 py-2">Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                                ${busInspections.map(insp => {
                                                    const hasIssue = insp.dano_pintura || insp.residuos_pegamento;
                                                    const hasPublicity = insp.publicidad_izquierda || insp.publicidad_luneta || insp.publicidad_derecha;
                                                    let statusClass = hasIssue ? 'text-status-red' : (hasPublicity ? 'text-status-yellow' : 'text-status-green');
                                                    let statusText = hasIssue ? 'Con problemas' : (hasPublicity ? 'Con publicidad' : 'Sin novedad');
                                                    
                                                    return `
                                                        <tr class="hover:bg-gray-100 dark:hover:bg-gray-800">
                                                            <td class="px-4 py-2 text-sm">${formatDate(insp.created_at)}</td>
                                                            <td class="px-4 py-2 text-sm">${insp.terminal || 'No especificado'}</td>
                                                            <td class="px-4 py-2 text-sm ${statusClass} font-medium">${statusText}</td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : `
                                    <p class="text-text-secondary dark:text-text-secondary-dark text-center py-4">No hay registros de inspecciones para este bus.</p>
                                `}
                            </div>
                        </div>
                        
                        <div>
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-xl p-5 mb-6">
                                <h4 class="text-lg font-semibold text-text-primary dark:text-text-primary-dark mb-4">Información del Bus</h4>
                                <div class="space-y-3">
                                    <div>
                                        <p class="text-sm text-text-secondary dark:text-text-secondary-dark">PPU:</p>
                                        <p class="font-medium text-text-primary dark:text-text-primary-dark">${bus.ppu}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-text-secondary dark:text-text-secondary-dark">N° Interno:</p>
                                        <p class="font-medium text-text-primary dark:text-text-primary-dark">${bus.numero_interno}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-text-secondary dark:text-text-secondary-dark">Marca Chasis:</p>
                                        <p class="font-medium text-text-primary dark:text-text-primary-dark">${bus.marca || 'No especificado'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-text-secondary dark:text-text-secondary-dark">Estado actual:</p>
                                        <p class="font-medium flex items-center mt-1">
                                            <span class="inline-flex items-center justify-center w-3 h-3 mr-2 rounded-full ${
                                                hasDamage ? 'bg-status-red' : (
                                                    hasResidue ? 'bg-status-yellow' : (
                                                        isInspected ? 'bg-status-green' : 'bg-status-gray'
                                                    )
                                                )
                                            }"></span>
                                            <span class="${
                                                hasDamage ? 'text-status-red' : (
                                                    hasResidue ? 'text-status-yellow' : (
                                                        isInspected ? 'text-status-green' : 'text-status-gray'
                                                    )
                                                )
                                            }">
                                                ${
                                                    hasDamage ? 'Con daños' : (
                                                        hasResidue ? 'Con residuos' : (
                                                            hasPublicity ? 'Con publicidad' : (
                                                                isInspected ? 'Inspeccionado' : 'Pendiente'
                                                            )
                                                        )
                                                    )
                                                }
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            ${isInspected ? `
                                <div class="bg-gray-50 dark:bg-gray-900 rounded-xl p-5">
                                    <h4 class="text-lg font-semibold text-text-primary dark:text-text-primary-dark mb-4">Resumen de Estado</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <p class="text-sm text-text-secondary dark:text-text-secondary-dark mb-1">Cumplimiento de Inspección:</p>
                                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                                <div class="bg-status-green h-2 rounded-full" style="width: 100%"></div>
                                            </div>
                                        </div>
                                        <div>
                                            <p class="text-sm text-text-secondary dark:text-text-secondary-dark mb-1">Estado de Limpieza:</p>
                                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                                <div class="bg-${hasResidue ? 'status-yellow' : 'status-green'} h-2 rounded-full" style="width: ${hasResidue ? '60%' : '100%'}"></div>
                                            </div>
                                        </div>
                                        <div>
                                            <p class="text-sm text-text-secondary dark:text-text-secondary-dark mb-1">Estado de Pintura:</p>
                                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                                <div class="bg-${hasDamage ? 'status-red' : 'status-green'} h-2 rounded-full" style="width: ${hasDamage ? '40%' : '100%'}"></div>
                                            </div>
                                        </div>
                                        <div>
                                            <p class="text-sm text-text-secondary dark:text-text-secondary-dark mb-1">Nivel de Publicidad:</p>
                                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                                <div class="bg-${hasPublicity ? 'brand-primary' : 'status-gray'} h-2 rounded-full" style="width: ${
                                                    lastInspection ? (
                                                        (lastInspection.publicidad_izquierda ? 33 : 0) + 
                                                        (lastInspection.publicidad_luneta ? 33 : 0) + 
                                                        (lastInspection.publicidad_derecha ? 34 : 0)
                                                    ) : 0
                                                }%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Mostrar el modal con animación
            setTimeout(() => {
                modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
            }, 10);
            
            // Configurar botones de cierre
            configureModalClosers(modal);
            
            // Configurar botones de acción
            document.querySelectorAll('.register-inspection-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    modal.querySelector('.close-bus-detail-btn').click();
                    navigateTo('form');
                    // Seleccionar el bus en el formulario
                    document.getElementById('ppu').value = btn.dataset.ppu;
                    document.getElementById('numero_interno').value = btn.dataset.numeroInterno;
                    document.getElementById('marca_chasis').value = bus.marca || '';
                    document.getElementById('suggestions-box').classList.add('hidden');
                });
            });
            
            document.querySelectorAll('.schedule-maintenance-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    modal.querySelector('.close-bus-detail-btn').click();
                    showMaintenanceModal(btn.dataset.ppu, btn.dataset.numeroInterno);
                });
            });
            
            // Refrescar iconos de Lucide
            lucide.createIcons();
        }
        
        function showMaintenanceModal(ppu, numeroInterno) {
            const modal = document.getElementById('maintenance-modal');
            
            // Completar campos
            document.getElementById('maintenance-ppu').value = ppu;
            document.getElementById('maintenance-numero-interno').value = numeroInterno;
            document.getElementById('maintenance-bus-info').textContent = `${ppu} (${numeroInterno})`;
            
            // Establecer fecha mínima a hoy
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('maintenance-date').min = today;
            document.getElementById('maintenance-date').value = today;
            
            // Mostrar el modal
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
            }, 10);
            
            // Configurar botones de cierre
            configureModalClosers(modal);
            
            // Configurar botón de guardar
            document.getElementById('save-maintenance-btn').addEventListener('click', () => {
                const form = document.getElementById('maintenance-form');
                if (form.checkValidity()) {
                    // En una implementación real, esto enviaría los datos a la API
                    showToast('Mantenimiento programado con éxito', 'success');
                    modal.querySelector('#close-maintenance-modal-btn').click();
                    
                    // Actualizar la tabla de mantenimiento (simulado)
                    updateMaintenanceTable({
                        ppu: ppu,
                        numero_interno: numeroInterno,
                        type: document.getElementById('maintenance-type').value,
                        notes: document.getElementById('maintenance-notes').value,
                        scheduled_date: document.getElementById('maintenance-date').value,
                        priority: document.querySelector('input[name="priority"]:checked').value,
                        status: 'Programado'
                    });
                } else {
                    form.reportValidity();
                }
            });
        }
        
        function updateMaintenanceTable(maintenance) {
            const tableBody = document.getElementById('maintenance-table-body');
            if (!tableBody) return;
            
            // Eliminar el mensaje "No hay registros" si existe
            if (tableBody.querySelector('td[colspan="7"]')) {
                tableBody.innerHTML = '';
            }
            
            const now = new Date();
            const formattedDate = now.toLocaleDateString('es-ES');
            
            // Mapear tipo de mantenimiento a texto descriptivo
            const typeText = {
                'residuo': 'Limpieza de Residuos',
                'pintura': 'Reparación de Pintura',
                'publicidad': 'Retiro de Publicidad'
            }[maintenance.type] || maintenance.type;
            
            // Mapear prioridad a color
            const priorityColor = {
                'baja': 'text-status-green',
                'media': 'text-status-yellow',
                'alta': 'text-status-red'
            }[maintenance.priority] || 'text-status-gray';
            
            // Crear la fila
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 dark:hover:bg-gray-900';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">${maintenance.ppu}</td>
                <td class="px-6 py-4 whitespace-nowrap">${maintenance.numero_interno}</td>
                <td class="px-6 py-4 whitespace-nowrap">${typeText}</td>
                <td class="px-6 py-4">${maintenance.notes || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap">Simulado</td>
                <td class="px-6 py-4 whitespace-nowrap">${new Date(maintenance.scheduled_date).toLocaleDateString('es-ES')}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${priorityColor} bg-${priorityColor.replace('text-', '')}/10">
                        ${maintenance.status}
                    </span>
                </td>
            `;
            
            // Añadir la fila al principio de la tabla
            tableBody.insertBefore(row, tableBody.firstChild);
        }
        
        async function loadAssistanceData() {
            showLoader('Cargando datos de asistencia...');
            
            try {
                // Cargar datos si aún no están disponibles
                if (busFleet.length === 0) {
                    busFleet = await fetchBusFleet();
                }
                if (allInspections.length === 0) {
                    allInspections = await fetchAllInspections();
                }
                
                // Renderizar listas de daños y residuos
                renderAssistanceLists();
                
            } catch (error) {
                console.error('Error loading assistance data:', error);
                showToast('Error al cargar los datos de asistencia.', 'error');
            } finally {
                hideLoader();
            }
        }
        
        function renderAssistanceLists() {
            const damageIncidents = getUniqueIncidents(allInspections, 'dano_pintura');
            const residueIncidents = getUniqueIncidents(allInspections, 'residuos_pegamento');
            
            // Actualizar contadores
            document.getElementById('damage-count-badge').textContent = damageIncidents.length;
            document.getElementById('residue-count-badge').textContent = residueIncidents.length;
            
            // Función para renderizar un elemento de lista
            function renderListItem(insp, detailKey) {
                return `
                    <li class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer bus-detail-trigger" data-ppu="${insp.ppu}">
                        <div class="flex justify-between">
                            <div>
                                <p class="font-bold text-text-primary dark:text-text-primary-dark">${insp.ppu}</p>
                                <p class="text-sm text-text-secondary dark:text-text-secondary-dark">N° ${insp.numero_interno}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-text-secondary dark:text-text-secondary-dark">${insp.terminal || 'No especificado'}</p>
                                <p class="text-xs text-text-secondary dark:text-text-secondary-dark">${formatSimpleDate(insp.created_at)}</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                            <p class="text-sm text-text-secondary dark:text-text-secondary-dark">${insp[detailKey]}</p>
                        </div>
                        <div class="mt-3 flex justify-end">
                            <button class="text-xs text-brand-primary dark:text-brand-light hover:underline mr-3 schedule-maintenance-btn" data-ppu="${insp.ppu}" data-numero-interno="${insp.numero_interno}">
                                <i data-lucide="calendar-plus" class="h-3 w-3 mr-1 inline-block"></i> Programar Mantenimiento
                            </button>
                            <button class="text-xs text-brand-primary dark:text-brand-light hover:underline view-details-btn" data-ppu="${insp.ppu}">
                                <i data-lucide="eye" class="h-3 w-3 mr-1 inline-block"></i> Ver Detalles
                            </button>
                        </div>
                    </li>
                `;
            }
            
            // Renderizar listas
            const damageList = document.getElementById('damage-list');
            const residueList = document.getElementById('residue-list');
            
            damageList.innerHTML = '';
            residueList.innerHTML = '';
            
            damageIncidents.forEach(insp => {
                damageList.innerHTML += renderListItem(insp, 'dano_pintura_detalle');
            });
            
            residueIncidents.forEach(insp => {
                residueList.innerHTML += renderListItem(insp, 'residuos_pegamento_detalle');
            });
            
            // Mostrar mensaje si no hay incidentes
            if (damageIncidents.length === 0) {
                damageList.innerHTML = `<li class="text-center text-text-secondary dark:text-text-secondary-dark py-4">No hay buses con daños reportados.</li>`;
            }
            
            if (residueIncidents.length === 0) {
                residueList.innerHTML = `<li class="text-center text-text-secondary dark:text-text-secondary-dark py-4">No hay buses con residuos reportados.</li>`;
            }
            
            // Añadir listeners
            document.querySelectorAll('.bus-detail-trigger, .view-details-btn').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    showBusDetailModal(e.currentTarget.dataset.ppu);
                });
            });
            
            document.querySelectorAll('.schedule-maintenance-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showMaintenanceModal(btn.dataset.ppu, btn.dataset.numeroInterno);
                });
            });
            
            // Configurar búsqueda en las listas
            document.getElementById('damage-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#damage-list li:not(.text-center)').forEach(item => {
                    const ppu = item.querySelector('.font-bold').textContent.toLowerCase();
                    const numeroInterno = item.querySelector('.text-sm').textContent.toLowerCase();
                    item.style.display = (ppu.includes(searchTerm) || numeroInterno.includes(searchTerm)) ? 'block' : 'none';
                });
            });
            
            document.getElementById('residue-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#residue-list li:not(.text-center)').forEach(item => {
                    const ppu = item.querySelector('.font-bold').textContent.toLowerCase();
                    const numeroInterno = item.querySelector('.text-sm').textContent.toLowerCase();
                    item.style.display = (ppu.includes(searchTerm) || numeroInterno.includes(searchTerm)) ? 'block' : 'none';
                });
            });
            
            // Refrescar iconos de Lucide
            lucide.createIcons();
        }
        
        async function loadReportsData() {
            showLoader('Cargando datos de reportes...');
            
            try {
                // Cargar datos si aún no están disponibles
                if (busFleet.length === 0) {
                    busFleet = await fetchBusFleet();
                }
                if (allInspections.length === 0) {
                    allInspections = await fetchAllInspections();
                }
                
                // Actualizar contadores
                updateReportCounters();
                
                // Renderizar estadísticas por terminal
                renderTerminalStats();
                
                // Renderizar listas de reportes
                renderReportLists();
                
            } catch (error) {
                console.error('Error loading reports data:', error);
                showToast('Error al cargar los datos de reportes.', 'error');
            } finally {
                hideLoader();
            }
        }
        
        function updateReportCounters() {
            const totalInspections = allInspections.length;
            const uniqueInspectedBuses = new Set(allInspections.map(i => i.ppu)).size;
            
            // Contar buses con daños y residuos
            const busesWithDamage = new Set();
            const busesWithResidue = new Set();
            
            allInspections.forEach(insp => {
                if (insp.dano_pintura) busesWithDamage.add(insp.ppu);
                if (insp.residuos_pegamento) busesWithResidue.add(insp.ppu);
            });
            
            document.getElementById('report-total-inspections').textContent = totalInspections;
            document.getElementById('report-total-damages').textContent = busesWithDamage.size;
            document.getElementById('report-total-residues').textContent = busesWithResidue.size;
        }
        
        function renderTerminalStats() {
            // Agrupar inspecciones por terminal
            const terminalStats = {
                'El Roble': { inspections: 0, damages: 0, residues: 0 },
                'La Reina': { inspections: 0, damages: 0, residues: 0 },
                'Maria Angelica': { inspections: 0, damages: 0, residues: 0 },
                'El Descanso': { inspections: 0, damages: 0, residues: 0 }
            };
            
            // Buses totales por terminal (simulado)
            const busesPerTerminal = {
                'El Roble': Math.round(busFleet.length * 0.3),
                'La Reina': Math.round(busFleet.length * 0.25),
                'Maria Angelica': Math.round(busFleet.length * 0.25),
                'El Descanso': Math.round(busFleet.length * 0.2)
            };
            
            // Contar inspecciones, daños y residuos por terminal
            allInspections.forEach(insp => {
                if (terminalStats[insp.terminal]) {
                    terminalStats[insp.terminal].inspections++;
                    if (insp.dano_pintura) terminalStats[insp.terminal].damages++;
                    if (insp.residuos_pegamento) terminalStats[insp.terminal].residues++;
                }
            });
            
            // Renderizar gráfico
            const ctx = document.getElementById('terminal-stats-chart').getContext('2d');
            
            // Si ya existe un chart, destruirlo para crear uno nuevo
            if (window.terminalStatsChart) {
                window.terminalStatsChart.destroy();
            }
            
            // Crear datasets para el gráfico
            const inspectionsData = Object.values(terminalStats).map(s => s.inspections);
            const damagesData = Object.values(terminalStats).map(s => s.damages);
            const residuesData = Object.values(terminalStats).map(s => s.residues);
            
            // Crear el nuevo chart
            window.terminalStatsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(terminalStats),
                    datasets: [
                        {
                            label: 'Inspecciones',
                            data: inspectionsData,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)', // brand-light
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        },
                        {
                            label: 'Daños',
                            data: damagesData,
                            backgroundColor: 'rgba(220, 38, 38, 0.7)', // status-red
                            borderColor: 'rgb(220, 38, 38)',
                            borderWidth: 1
                        },
                        {
                            label: 'Residuos',
                            data: residuesData,
                            backgroundColor: 'rgba(245, 158, 11, 0.7)', // status-yellow
                            borderColor: 'rgb(245, 158, 11)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            // Renderizar tabla de estadísticas
            const terminalStatsTable = document.getElementById('terminal-stats-table');
            terminalStatsTable.innerHTML = '';
            
            Object.entries(terminalStats).forEach(([terminal, stats]) => {
                const totalBuses = busesPerTerminal[terminal];
                const progress = calculatePercentage(stats.inspections, totalBuses);
                
                terminalStatsTable.innerHTML += `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-900">
                        <td class="px-4 py-3">${terminal}</td>
                        <td class="px-4 py-3">${stats.inspections}</td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center">
                                <span class="h-2 w-2 rounded-full bg-status-red mr-2"></span>
                                ${stats.damages}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center">
                                <span class="h-2 w-2 rounded-full bg-status-yellow mr-2"></span>
                                ${stats.residues}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mr-2">
                                    <div class="bg-brand-primary h-2 rounded-full" style="width: ${progress}%"></div>
                                </div>
                                <span class="text-xs whitespace-nowrap">${progress}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }
        
        function renderReportLists() {
            // Funciones de renderizado para cada tipo de lista
            function renderResiduesList() {
                const residuesList = document.getElementById('report-list-residues');
                const residuesWithDetails = allInspections.filter(i => i.residuos_pegamento);
                
                if (residuesWithDetails.length === 0) {
                    residuesList.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-text-secondary dark:text-text-secondary-dark">
                                No hay buses con residuos reportados.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                residuesList.innerHTML = '';
                
                residuesWithDetails.forEach(insp => {
                    residuesList.innerHTML += `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-900">
                            <td class="px-6 py-4 whitespace-nowrap">${insp.ppu}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${insp.numero_interno}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${insp.marca_chasis || 'No especificado'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${insp.terminal || 'No especificado'}</td>
                            <td class="px-6 py-4">${insp.residuos_pegamento_detalle}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${formatDate(insp.created_at)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex space-x-2">
                                    <button class="text-brand-primary dark:text-brand-light hover:text-brand-dark dark:hover:text-brand-light/80 view-details-btn" data-ppu="${insp.ppu}">
                                        <i data-lucide="eye" class="h-4 w-4"></i>
                                    </button>
                                    <button class="text-status-green hover:text-green-700 schedule-maintenance-btn" data-ppu="${insp.ppu}" data-numero-interno="${insp.numero_interno}">
                                        <i data-lucide="calendar-plus" class="h-4 w-4"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            function renderDamagesList() {
                const damagesList = document.getElementById('report-list-damages');
                const damagesWithDetails = allInspections.filter(i => i.dano_pintura);
                
                if (damagesWithDetails.length === 0) {
                    damagesList.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-text-secondary dark:text-text-secondary-dark">
                                No hay buses con daños reportados.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                damagesList.innerHTML = '';
                
                damagesWithDetails.forEach(insp => {
                    damagesList.innerHTML += `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-900">
                            <td class="px-6 py-4 whitespace-nowrap">${insp.ppu}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${insp.numero_interno}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${insp.marca_chasis || 'No especificado'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${insp.terminal || 'No especificado'}</td>
                            <td class="px-6 py-4">${insp.dano_pintura_detalle}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${formatDate(insp.created_at)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex space-x-2">
                                    <button class="text-brand-primary dark:text-brand-light hover:text-brand-dark dark:hover:text-brand-light/80 view-details-btn" data-ppu="${insp.ppu}">
                                        <i data-lucide="eye" class="h-4 w-4"></i>
                                    </button>
                                    <button class="text-status-green hover:text-green-700 schedule-maintenance-btn" data-ppu="${insp.ppu}" data-numero-interno="${insp.numero_interno}">
                                        <i data-lucide="calendar-plus" class="h-4 w-4"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            function renderAllList() {
                const allList = document.getElementById('report-list-all');
                
                if (allInspections.length === 0) {
                    allList.innerHTML = `
                        <tr>
                            <td colspan="10" class="px-6 py-4 text-center text-text-secondary dark:text-text-secondary-dark">
                                No hay inspecciones registradas.
                            </td>
                        </tr>
                    `;
                    document.getElementById('all-report-showing').textContent = '0';
                    document.getElementById('all-report-total').textContent = '0';
                    document.getElementById('all-report-page').textContent = 'Página 1 de 1';
                    return;
                }
                
                // Ordenar por fecha, más recientes primero
                const sortedInspections = [...allInspections].sort((a, b) => 
                    new Date(b.created_at) - new Date(a.created_at)
                );
                
                // Paginación
                const totalItems = sortedInspections.length;
                const totalPages = Math.ceil(totalItems / allReportItemsPerPage);
                allReportPage = Math.min(allReportPage, totalPages || 1);
                
                const startIndex = (allReportPage - 1) * allReportItemsPerPage;
                const endIndex = Math.min(startIndex + allReportItemsPerPage, totalItems);
                
                // Actualizar indicadores de paginación
                document.getElementById('all-report-showing').textContent = `${startIndex + 1}-${endIndex}`;
                document.getElementById('all-report-total').textContent = totalItems;
                document.getElementById('all-report-page').textContent = `Página ${allReportPage} de ${totalPages}`;
                document.getElementById('all-report-prev').disabled = allReportPage <= 1;
                document.getElementById('all-report-next').disabled = allReportPage >= totalPages;
                
                // Renderizar filas
                allList.innerHTML = '';
                
                sortedInspections.slice(startIndex, endIndex).forEach(insp => {
                    const pubIzq = insp.publicidad_izquierda ? 
                        '<i data-lucide="check" class="h-4 w-4 text-status-red"></i>' : 
                        '<i data-lucide="x" class="h-4 w-4 text-status-green"></i>';
                    
                    const pubLuneta = insp.publicidad_luneta ? 
                        '<i data-lucide="check" class="h-4 w-4 text-status-red"></i>' : 
                        '<i data-lucide="x" class="h-4 w-4 text-status-green"></i>';
                    
                    const pubDer = insp.publicidad_derecha ? 
                        '<i data-lucide="check" class="h-4 w-4 text-status-red"></i>' : 
                        '<i data-lucide="x" class="h-4 w-4 text-status-green"></i>';
                    
                    const residuos = insp.residuos_pegamento ? 
                        '<i data-lucide="check" class="h-4 w-4 text-status-yellow"></i>' : 
                        '<i data-lucide="x" class="h-4 w-4 text-status-green"></i>';
                    
                    const danos = insp.dano_pintura ? 
                        '<i data-lucide="check" class="h-4 w-4 text-status-red"></i>' : 
                        '<i data-lucide="x" class="h-4 w-4 text-status-green"></i>';
                    
                    allList.innerHTML += `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-900">
                            <td class="px-6 py-4 whitespace-nowrap">${insp.ppu}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${insp.numero_interno}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${insp.terminal || 'No especificado'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">${pubIzq}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">${pubLuneta}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">${pubDer}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">${residuos}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">${danos}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${formatDate(insp.created_at)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex space-x-2">
                                    <button class="text-brand-primary dark:text-brand-light hover:text-brand-dark dark:hover:text-brand-light/80 view-details-btn" data-ppu="${insp.ppu}">
                                        <i data-lucide="eye" class="h-4 w-4"></i>
                                    </button>
                                    <button class="text-status-green hover:text-green-700 schedule-maintenance-btn" data-ppu="${insp.ppu}" data-numero-interno="${insp.numero_interno}">
                                        <i data-lucide="calendar-plus" class="h-4 w-4"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            // Renderizar todas las listas
            renderResiduesList();
            renderDamagesList();
            renderAllList();
            
            // Configurar funcionalidad de búsqueda
            document.getElementById('residues-report-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#report-list-residues tr:not([colspan])').forEach(row => {
                    const ppu = row.querySelector('td:first-child').textContent.toLowerCase();
                    const numeroInterno = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    row.style.display = (ppu.includes(searchTerm) || numeroInterno.includes(searchTerm)) ? 'table-row' : 'none';
                });
            });
            
            document.getElementById('damages-report-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#report-list-damages tr:not([colspan])').forEach(row => {
                    const ppu = row.querySelector('td:first-child').textContent.toLowerCase();
                    const numeroInterno = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    row.style.display = (ppu.includes(searchTerm) || numeroInterno.includes(searchTerm)) ? 'table-row' : 'none';
                });
            });
            
            document.getElementById('all-report-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#report-list-all tr:not([colspan])').forEach(row => {
                    const ppu = row.querySelector('td:first-child').textContent.toLowerCase();
                    const numeroInterno = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    row.style.display = (ppu.includes(searchTerm) || numeroInterno.includes(searchTerm)) ? 'table-row' : 'none';
                });
            });
            
            // Configurar controles de paginación
            document.getElementById('all-report-prev').addEventListener('click', function() {
                if (allReportPage > 1) {
                    allReportPage--;
                    renderAllList();
                }
            });
            
            document.getElementById('all-report-next').addEventListener('click', function() {
                const totalPages = Math.ceil(allInspections.length / allReportItemsPerPage);
                if (allReportPage < totalPages) {
                    allReportPage++;
                    renderAllList();
                }
            });
            
            // Añadir listeners para ver detalles y programar mantenimiento
            document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    showBusDetailModal(btn.dataset.ppu);
                });
            });
            
            document.querySelectorAll('.schedule-maintenance-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    showMaintenanceModal(btn.dataset.ppu, btn.dataset.numeroInterno);
                });
            });
            
            // Refrescar iconos de Lucide
            lucide.createIcons();
        }
        
        async function loadAnalyticsData() {
            showLoader('Cargando datos analíticos...');
            
            try {
                // Cargar datos si aún no están disponibles
                if (busFleet.length === 0) {
                    busFleet = await fetchBusFleet();
                }
                if (allInspections.length === 0) {
                    allInspections = await fetchAllInspections();
                }
                
                // Renderizar gráficos y métricas
                renderTrendsChart();
                renderDistributionChart();
                renderActivityTimeline();
                renderTerminalsComparison();
                updateKPIs();
                
            } catch (error) {
                console.error('Error loading analytics data:', error);
                showToast('Error al cargar los datos analíticos.', 'error');
            } finally {
                hideLoader();
            }
        }
        
        function renderTrendsChart() {
            const ctx = document.getElementById('trends-chart').getContext('2d');
            
            // Agrupar inspecciones por fecha
            const groupedByDate = groupInspectionsByDate(allInspections, trendsPeriod);
            const dates = Object.keys(groupedByDate);
            const counts = Object.values(groupedByDate);
            
            // Calcular tendencia
            const trendIndicator = calculateTrendIndicator(groupedByDate);
            const trendElement = document.getElementById('trend-indicator');
            if (trendIndicator > 0) {
                trendElement.innerHTML = `<span class="text-status-green flex items-center"><i data-lucide="trending-up" class="h-4 w-4 mr-1"></i> +${trendIndicator}%</span>`;
            } else if (trendIndicator < 0) {
                trendElement.innerHTML = `<span class="text-status-red flex items-center"><i data-lucide="trending-down" class="h-4 w-4 mr-1"></i> ${trendIndicator}%</span>`;
            } else {
                trendElement.innerHTML = `<span class="text-status-gray flex items-center"><i data-lucide="minus" class="h-4 w-4 mr-1"></i> 0%</span>`;
            }
            
            // Calcular promedio diario
            const totalInspections = counts.reduce((a, b) => a + b, 0);
            const avgDaily = (totalInspections / dates.length).toFixed(1);
            document.getElementById('avg-daily').textContent = avgDaily;
            
            // Calcular proyección
            const daysLeft = 30 - trendsPeriod;
            const projectedTotal = Math.round(totalInspections + (avgDaily * daysLeft));
            document.getElementById('projection').textContent = projectedTotal;
            
            // Crear gráfico
            if (window.trendsChart) {
                window.trendsChart.destroy();
            }
            
            window.trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Inspecciones',
                        data: counts,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            // Refrescar iconos
            lucide.createIcons();
        }
        
        function renderDistributionChart() {
            const ctx = document.getElementById('distribution-chart').getContext('2d');
            const legendContainer = document.getElementById('distribution-legend');
            
            // Determinar qué datos mostrar según el tipo seleccionado
            let labels = [];
            let data = [];
            let backgroundColor = [];
            let title = '';
            
            switch (distributionType) {
                case 'publicity':
                    title = 'Distribución de Publicidad';
                    labels = ['Izquierda', 'Luneta', 'Derecha', 'Sin Publicidad'];
                    
                    const pubIzq = allInspections.filter(i => i.publicidad_izquierda).length;
                    const pubLuneta = allInspections.filter(i => i.publicidad_luneta).length;
                    const pubDer = allInspections.filter(i => i.publicidad_derecha).length;
                    const sinPub = allInspections.filter(i => !i.publicidad_izquierda && !i.publicidad_luneta && !i.publicidad_derecha).length;
                    
                    data = [pubIzq, pubLuneta, pubDer, sinPub];
                    backgroundColor = [
                        'rgba(59, 130, 246, 0.8)', // brand-light
                        'rgba(30, 64, 175, 0.8)', // brand-primary
                        'rgba(29, 78, 216, 0.8)', // brand-secondary
                        'rgba(107, 114, 128, 0.8)' // status-gray
                    ];
                    break;
                    
                case 'issues':
                    title = 'Distribución de Problemas';
                    labels = ['Daños Pintura', 'Residuos Pegamento', 'Ambos', 'Sin Problemas'];
                    
                    const danosOnly = allInspections.filter(i => i.dano_pintura && !i.residuos_pegamento).length;
                    const residuosOnly = allInspections.filter(i => !i.dano_pintura && i.residuos_pegamento).length;
                    const both = allInspections.filter(i => i.dano_pintura && i.residuos_pegamento).length;
                    const none = allInspections.filter(i => !i.dano_pintura && !i.residuos_pegamento).length;
                    
                    data = [danosOnly, residuosOnly, both, none];
                    backgroundColor = [
                        'rgba(220, 38, 38, 0.8)', // status-red
                        'rgba(245, 158, 11, 0.8)', // status-yellow
                        'rgba(124, 58, 237, 0.8)', // purple-600
                        'rgba(22, 163, 74, 0.8)' // status-green
                    ];
                    break;
                    
                case 'terminals':
                default:
                    title = 'Distribución por Terminal';
                    labels = ['El Roble', 'La Reina', 'Maria Angelica', 'El Descanso', 'No Especificado'];
                    
                    const elRoble = allInspections.filter(i => i.terminal === 'El Roble').length;
                    const laReina = allInspections.filter(i => i.terminal === 'La Reina').length;
                    const mariaAngelica = allInspections.filter(i => i.terminal === 'Maria Angelica').length;
                    const elDescanso = allInspections.filter(i => i.terminal === 'El Descanso').length;
                    const noTerminal = allInspections.filter(i => !i.terminal).length;
                    
                    data = [elRoble, laReina, mariaAngelica, elDescanso, noTerminal];
                    backgroundColor = [
                        'rgba(59, 130, 246, 0.8)', // brand-light
                        'rgba(30, 64, 175, 0.8)', // brand-primary
                        'rgba(29, 78, 216, 0.8)', // brand-secondary
                        'rgba(30, 58, 138, 0.8)', // brand-dark
                        'rgba(107, 114, 128, 0.8)' // status-gray
                    ];
                    break;
            }
            
            // Crear gráfico
            if (window.distributionChart) {
                window.distributionChart.destroy();
            }
            
            window.distributionChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1
                        }
                    }
                }
            });
            
            // Generar leyenda personalizada
            legendContainer.innerHTML = '';
            labels.forEach((label, index) => {
                const percentage = Math.round((data[index] / data.reduce((a, b) => a + b, 0)) * 100) || 0;
                legendContainer.innerHTML += `
                    <div class="flex items-center">
                        <span class="inline-block h-3 w-3 rounded-full mr-2" style="background-color: ${backgroundColor[index]}"></span>
                        <span class="text-sm text-text-primary dark:text-text-primary-dark">${label}</span>
                        <span class="ml-auto text-sm font-medium">${data[index]} <span class="text-text-secondary dark:text-text-secondary-dark">(${percentage}%)</span></span>
                    </div>
                `;
            });
        }
        
        function renderActivityTimeline() {
            const timeline = document.getElementById('activity-timeline');
            
            // Tomar las 5 inspecciones más recientes
            const recentInspections = [...allInspections]
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 5);
            
            if (recentInspections.length === 0) {
                timeline.innerHTML = `
                    <div class="text-center text-text-secondary dark:text-text-secondary-dark py-4">
                        No hay actividad reciente.
                    </div>
                `;
                return;
            }
            
            timeline.innerHTML = '';
            
            recentInspections.forEach(insp => {
                let iconName = 'clipboard-check';
                let iconColor = 'text-brand-light';
                let actionText = 'Inspección realizada';
                
                if (insp.dano_pintura) {
                    iconName = 'shield-alert';
                    iconColor = 'text-status-red';
                    actionText = 'Daño de pintura reportado';
                } else if (insp.residuos_pegamento) {
                    iconName = 'sticky-note';
                    iconColor = 'text-status-yellow';
                    actionText = 'Residuos de pegamento reportados';
                } else if (insp.publicidad_izquierda || insp.publicidad_luneta || insp.publicidad_derecha) {
                    iconName = 'layout-dashboard';
                    iconColor = 'text-brand-primary';
                    actionText = 'Publicidad registrada';
                }
                
                const timeAgo = getTimeAgo(insp.created_at);
                
                timeline.innerHTML += `
                    <div class="relative">
                        <span class="absolute left-0 top-0 h-6 w-6 -ml-3 rounded-full bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 flex items-center justify-center">
                            <i data-lucide="${iconName}" class="h-3 w-3 ${iconColor}"></i>
                        </span>
                        <div class="mb-1">
                            <span class="font-medium text-text-primary dark:text-text-primary-dark">${actionText}</span>
                            <span class="text-xs text-text-secondary dark:text-text-secondary-dark ml-2">${timeAgo}</span>
                        </div>
                        <p class="text-sm text-text-secondary dark:text-text-secondary-dark">
                            Bus ${insp.ppu} (${insp.numero_interno}) en ${insp.terminal || 'ubicación no especificada'}.
                        </p>
                    </div>
                `;
            });
            
            // Refrescar iconos
            lucide.createIcons();
        }
        
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffMinutes = Math.floor(diffTime / (1000 * 60));
            const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffMinutes < 60) {
                return `hace ${diffMinutes} ${diffMinutes === 1 ? 'minuto' : 'minutos'}`;
            } else if (diffHours < 24) {
                return `hace ${diffHours} ${diffHours === 1 ? 'hora' : 'horas'}`;
            } else {
                return `hace ${diffDays} ${diffDays === 1 ? 'día' : 'días'}`;
            }
        }
        
        function renderTerminalsComparison() {
            const ctx = document.getElementById('terminals-comparison-chart').getContext('2d');
            
            // Calcular estadísticas reales por terminal
            const terminalStats = {
                'El Roble': { total: 0, inspected: 0, issues: 0 },
                'La Reina': { total: 0, inspected: 0, issues: 0 },
                'Maria Angelica': { total: 0, inspected: 0, issues: 0 },
                'El Descanso': { total: 0, inspected: 0, issues: 0 }
            };
            
            // Contar inspecciones reales por terminal
            allInspections.forEach(insp => {
                if (insp.terminal && terminalStats[insp.terminal]) {
                    terminalStats[insp.terminal].inspected++;
                    
                    // Contar problemas reales
                    if (insp.dano_pintura || insp.residuos_pegamento) {
                        terminalStats[insp.terminal].issues++;
                    }
                }
            });
            
            // Distribuir buses de la flota por terminales
            const inspectedPPUs = new Set(allInspections.map(i => i.ppu));
            const terminalNames = Object.keys(terminalStats);
            
            busFleet.forEach((bus, index) => {
                // Si el bus ya fue inspeccionado, usar su terminal real
                const inspection = allInspections.find(insp => insp.ppu === bus.ppu);
                if (inspection && inspection.terminal) {
                    if (terminalStats[inspection.terminal]) {
                        terminalStats[inspection.terminal].total++;
                    }
                } else {
                    // Distribuir buses no inspeccionados equitativamente
                    const terminalIndex = index % terminalNames.length;
                    const terminal = terminalNames[terminalIndex];
                    terminalStats[terminal].total++;
                }
            });
            
            // Preparar datos para el gráfico
            const terminals = Object.keys(terminalStats);
            const totalBuses = terminals.map(t => terminalStats[t].total);
            const inspectedCount = terminals.map(t => terminalStats[t].inspected);
            const issuesCount = terminals.map(t => terminalStats[t].issues);
            
            // Debug: mostrar datos calculados
            console.log('Datos del gráfico de comparación por terminales:', {
                terminalStats,
                terminals,
                totalBuses,
                inspectedCount,
                issuesCount
            });
            
            // Crear gráfico
            if (window.terminalsComparisonChart) {
                window.terminalsComparisonChart.destroy();
            }
            
            window.terminalsComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: terminals,
                    datasets: [
                        {
                            label: 'Total Buses',
                            data: totalBuses,
                            backgroundColor: 'rgba(107, 114, 128, 0.7)', // status-gray
                            borderColor: 'rgb(107, 114, 128)',
                            borderWidth: 1
                        },
                        {
                            label: 'Inspeccionados',
                            data: inspectedCount,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)', // brand-light
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        },
                        {
                            label: 'Con Problemas',
                            data: issuesCount,
                            backgroundColor: 'rgba(220, 38, 38, 0.7)', // status-red
                            borderColor: 'rgb(220, 38, 38)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            // Actualizar métricas de eficiencia por terminal
            updateTerminalEfficiencyMetrics(terminalStats);
        }
        
        function updateTerminalEfficiencyMetrics(terminalStats) {
            const terminals = {
                'roble': 'El Roble',
                'reina': 'La Reina',
                'maria': 'Maria Angelica',
                'descanso': 'El Descanso'
            };
            
            Object.entries(terminals).forEach(([key, name]) => {
                const stats = terminalStats[name];
                if (!stats) return;
                
                const efficiency = calculatePercentage(stats.inspected, stats.total);
                const issueRatio = stats.inspected > 0 ? calculatePercentage(stats.issues, stats.inspected) : 0;
                
                // Actualizar elementos si existen
                const efficiencyElement = document.getElementById(`${key}-efficiency`);
                const efficiencyBarElement = document.getElementById(`${key}-efficiency-bar`);
                const progressDetailElement = document.getElementById(`${key}-progress-detail`);
                const issueRatioElement = document.getElementById(`${key}-issue-ratio`);
                
                if (efficiencyElement) efficiencyElement.textContent = `${efficiency}%`;
                if (efficiencyBarElement) efficiencyBarElement.style.width = `${efficiency}%`;
                if (progressDetailElement) progressDetailElement.textContent = `${stats.inspected}/${stats.total} buses`;
                if (issueRatioElement) issueRatioElement.textContent = `${issueRatio}% con problemas`;
            });
        }
        
        function updateKPIs() {
            // Calcular tasa de inspección
            const oneMonthAgo = new Date();
            oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
            
            const recentInspections = allInspections.filter(i => new Date(i.created_at) >= oneMonthAgo);
            const inspectionRate = (recentInspections.length / 30).toFixed(1);
            const inspectionRatePercentage = calculatePercentage(inspectionRate, 25); // Meta: 25 inspecciones/día
            
            document.getElementById('inspection-rate').textContent = `${inspectionRate}/día`;
            document.getElementById('inspection-rate-percentage').textContent = `${inspectionRatePercentage}%`;
            document.getElementById('inspection-rate-bar').style.width = `${Math.min(inspectionRatePercentage, 100)}%`;
            
            // Calcular cobertura de flota
            const inspectedBuses = new Set(allInspections.map(i => i.ppu)).size;
            const fleetCoverage = calculatePercentage(inspectedBuses, busFleet.length);
            const fleetCoveragePercentage = calculatePercentage(fleetCoverage, 90); // Meta: 90% de cobertura
            
            document.getElementById('fleet-coverage').textContent = `${fleetCoverage}%`;
            document.getElementById('fleet-coverage-percentage').textContent = `${fleetCoveragePercentage}%`;
            document.getElementById('fleet-coverage-bar').style.width = `${Math.min(fleetCoveragePercentage, 100)}%`;
            
            // Calcular tasa de incidencias
            const busesWithIssues = new Set();
            allInspections.forEach(i => {
                if (i.dano_pintura || i.residuos_pegamento) {
                    busesWithIssues.add(i.ppu);
                }
            });
            
            const issueRate = calculatePercentage(busesWithIssues.size, inspectedBuses);
            let issueRateStatus = 'Óptimo';
            let issueRateColor = 'bg-status-green';
            
            if (issueRate > 30) {
                issueRateStatus = 'Crítico';
                issueRateColor = 'bg-status-red';
            } else if (issueRate > 10) {
                issueRateStatus = 'Precaución';
                issueRateColor = 'bg-status-yellow';
            }
            
            document.getElementById('issue-rate').textContent = `${issueRate}%`;
            document.getElementById('issue-rate-status').textContent = issueRateStatus;
            document.getElementById('issue-rate-bar').className = `${issueRateColor} h-1.5 rounded-full`;
            document.getElementById('issue-rate-bar').style.width = `${issueRate}%`;
            
            // Calcular tiempo estimado de finalización
            const pendingBuses = busFleet.length - inspectedBuses;
            const daysToComplete = inspectionRate > 0 ? Math.ceil(pendingBuses / inspectionRate) : 0;
            
            const completionDate = new Date();
            completionDate.setDate(completionDate.getDate() + daysToComplete);
            
            document.getElementById('estimated-completion').textContent = `${daysToComplete} días`;
            document.getElementById('estimated-remaining').textContent = `${pendingBuses} buses pendientes`;
            document.getElementById('estimated-date').textContent = formatSimpleDate(completionDate);
            document.getElementById('estimated-completion-bar').style.width = `${fleetCoverage}%`;
        }
        
        function openExportOptionsModal() {
            const modal = document.getElementById('export-options-modal');
            
            // Establecer fechas por defecto
            const today = new Date();
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(today.getMonth() - 1);
            
            document.getElementById('export-date-from').value = oneMonthAgo.toISOString().split('T')[0];
            document.getElementById('export-date-to').value = today.toISOString().split('T')[0];
            
            // Mostrar el modal
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
            }, 10);
            
            // Configurar botones de cierre
            configureModalClosers(modal);
            
            // Configurar botones de exportación
            document.getElementById('confirm-export-excel').addEventListener('click', exportToExcel);
            document.getElementById('confirm-export-pdf').addEventListener('click', exportToPDF);
        }
        
        function exportToExcel() {
            showLoader('Generando archivo Excel...');
            
            try {
                // Obtener opciones de filtrado
                const terminalFilter = document.getElementById('export-terminal-filter').value;
                const typeFilter = document.getElementById('export-type-filter').value;
                const dateFrom = new Date(document.getElementById('export-date-from').value);
                const dateTo = new Date(document.getElementById('export-date-to').value);
                dateTo.setHours(23, 59, 59); // Incluir todo el día final
                
                // Columnas seleccionadas
                const columns = {
                    ppu: document.getElementById('col-ppu').checked,
                    numeroInterno: document.getElementById('col-numero-interno').checked,
                    terminal: document.getElementById('col-terminal').checked,
                    marca: document.getElementById('col-marca').checked,
                    publicidad: document.getElementById('col-publicidad').checked,
                    detalles: document.getElementById('col-detalles').checked,
                    fecha: document.getElementById('col-fecha').checked,
                    ubicacion: document.getElementById('col-ubicacion').checked,
                    observaciones: document.getElementById('col-observaciones').checked
                };
                
                // Filtrar datos
                let filteredData = allInspections.filter(i => {
                    const inspDate = new Date(i.created_at);
                    const dateInRange = inspDate >= dateFrom && inspDate <= dateTo;
                    
                    let terminalMatch = true;
                    if (terminalFilter !== 'all') {
                        terminalMatch = i.terminal === terminalFilter;
                    }
                    
                    let typeMatch = true;
                    if (typeFilter === 'with_damage') {
                        typeMatch = i.dano_pintura;
                    } else if (typeFilter === 'with_residue') {
                        typeMatch = i.residuos_pegamento;
                    } else if (typeFilter === 'with_publicity') {
                        typeMatch = i.publicidad_izquierda || i.publicidad_luneta || i.publicidad_derecha;
                    }
                    
                    return dateInRange && terminalMatch && typeMatch;
                });
                
                // Si no hay datos, mostrar un mensaje
                if (filteredData.length === 0) {
                    showToast('No hay datos que cumplan con los criterios de filtrado.', 'warning');
                    hideLoader();
                    document.getElementById('close-export-options-btn').click();
                    return;
                }
                
                // Preparar datos para exportación
                const exportData = filteredData.map(i => {
                    const publicidad = [];
                    if (i.publicidad_izquierda) publicidad.push('Izquierda');
                    if (i.publicidad_luneta) publicidad.push('Luneta');
                    if (i.publicidad_derecha) publicidad.push('Derecha');
                    
                    const detalles = [];
                    if (i.dano_pintura) detalles.push(`Daño: ${i.dano_pintura_detalle}`);
                    if (i.residuos_pegamento) detalles.push(`Residuos: ${i.residuos_pegamento_detalle}`);
                    
                    const observaciones = [];
                    if (i.publicidad_izquierda_detalle) observaciones.push(`Izq: ${i.publicidad_izquierda_detalle}`);
                    if (i.publicidad_luneta_detalle) observaciones.push(`Luneta: ${i.publicidad_luneta_detalle}`);
                    if (i.publicidad_derecha_detalle) observaciones.push(`Der: ${i.publicidad_derecha_detalle}`);
                    if (i.dano_pintura_detalle) observaciones.push(`Daño: ${i.dano_pintura_detalle}`);
                    if (i.residuos_pegamento_detalle) observaciones.push(`Residuos: ${i.residuos_pegamento_detalle}`);
                    
                    const row = {};
                    
                    if (columns.ppu) row['PPU'] = i.ppu;
                    if (columns.numeroInterno) row['N° Interno'] = i.numero_interno;
                    if (columns.terminal) row['Terminal'] = i.terminal || 'No especificado';
                    if (columns.marca) row['Marca'] = i.marca_chasis || 'No especificado';
                    if (columns.publicidad) row['Publicidad'] = publicidad.length > 0 ? publicidad.join(', ') : 'Ninguna';
                    if (columns.detalles) row['Detalles'] = detalles.length > 0 ? detalles.join(' | ') : 'Sin novedad';
                    if (columns.fecha) row['Fecha'] = new Date(i.created_at).toLocaleString();
                    if (columns.ubicacion) row['Ubicación'] = i.lat && i.lon ? `${i.lat}, ${i.lon}` : 'No disponible';
                    if (columns.observaciones) row['Observaciones'] = observaciones.length > 0 ? observaciones.join(' | ') : 'Sin observaciones';
                    
                    return row;
                });
                
                // Crear libro de Excel
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Inspecciones");
                
                // Título del archivo con fecha
                const now = new Date();
                const fileTitle = `Reporte_PubliBus_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
                
                // Descargar archivo
                XLSX.writeFile(workbook, `${fileTitle}.xlsx`);
                
                showToast('Reporte Excel generado con éxito.', 'success');
                document.getElementById('close-export-options-btn').click();
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showToast('Error al generar el reporte Excel.', 'error');
            } finally {
                hideLoader();
            }
        }
        
        function exportToPDF() {
            showLoader('Generando archivo PDF...');
            
            try {
                // Obtener opciones de filtrado
                const terminalFilter = document.getElementById('export-terminal-filter').value;
                const typeFilter = document.getElementById('export-type-filter').value;
                const dateFrom = new Date(document.getElementById('export-date-from').value);
                const dateTo = new Date(document.getElementById('export-date-to').value);
                dateTo.setHours(23, 59, 59); // Incluir todo el día final
                
                // Filtrar datos
                let filteredData = allInspections.filter(i => {
                    const inspDate = new Date(i.created_at);
                    const dateInRange = inspDate >= dateFrom && inspDate <= dateTo;
                    
                    let terminalMatch = true;
                    if (terminalFilter !== 'all') {
                        terminalMatch = i.terminal === terminalFilter;
                    }
                    
                    let typeMatch = true;
                    if (typeFilter === 'with_damage') {
                        typeMatch = i.dano_pintura;
                    } else if (typeFilter === 'with_residue') {
                        typeMatch = i.residuos_pegamento;
                    } else if (typeFilter === 'with_publicity') {
                        typeMatch = i.publicidad_izquierda || i.publicidad_luneta || i.publicidad_derecha;
                    }
                    
                    return dateInRange && terminalMatch && typeMatch;
                });
                
                // Si no hay datos, mostrar un mensaje
                if (filteredData.length === 0) {
                    showToast('No hay datos que cumplan con los criterios de filtrado.', 'warning');
                    hideLoader();
                    document.getElementById('close-export-options-btn').click();
                    return;
                }
                
                // Crear documento PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Título del informe
                doc.setFontSize(18);
                doc.setTextColor(30, 64, 175); // brand-primary
                doc.text('Informe de Inspecciones PubliBus', 14, 20);
                
                // Subtítulo con rango de fechas
                doc.setFontSize(10);
                doc.setTextColor(75, 85, 99);
                doc.text(`Período: ${dateFrom.toLocaleDateString()} - ${dateTo.toLocaleDateString()}`, 14, 30);
                
                // Agregar filtros aplicados
                let filterText = 'Filtros aplicados: ';
                filterText += terminalFilter !== 'all' ? `Terminal: ${terminalFilter}, ` : 'Todas las terminales, ';
                
                switch (typeFilter) {
                    case 'with_damage': filterText += 'Solo buses con daños'; break;
                    case 'with_residue': filterText += 'Solo buses con residuos'; break;
                    case 'with_publicity': filterText += 'Solo buses con publicidad'; break;
                    default: filterText += 'Todos los registros';
                }
                
                doc.text(filterText, 14, 38);
                
                // Resumen estadístico
                doc.setFontSize(12);
                doc.setTextColor(30, 64, 175);
                doc.text('Resumen', 14, 50);
                
                doc.setFontSize(10);
                doc.setTextColor(31, 41, 55);
                doc.text(`Total de inspecciones: ${filteredData.length}`, 14, 58);
                
                // Contar buses únicos
                const uniqueBuses = new Set(filteredData.map(i => i.ppu)).size;
                doc.text(`Buses únicos inspeccionados: ${uniqueBuses}`, 14, 66);
                
                // Contar por terminal
                const terminalCounts = {};
                filteredData.forEach(i => {
                    const terminal = i.terminal || 'No especificado';
                    terminalCounts[terminal] = (terminalCounts[terminal] || 0) + 1;
                });
                
                doc.text('Distribución por terminal:', 14, 74);
                let yPos = 82;
                Object.entries(terminalCounts).forEach(([terminal, count]) => {
                    doc.text(`- ${terminal}: ${count} inspecciones`, 20, yPos);
                    yPos += 8;
                });
                
                // Tabla de datos
                doc.setFontSize(12);
                doc.setTextColor(30, 64, 175);
                doc.text('Detalle de Inspecciones', 14, yPos + 8);
                
                // Preparar datos para la tabla
                const tableData = filteredData.map(i => {
                    const publicidad = [];
                    if (i.publicidad_izquierda) publicidad.push('Izq');
                    if (i.publicidad_luneta) publicidad.push('Lun');
                    if (i.publicidad_derecha) publicidad.push('Der');
                    
                    return [
                        i.ppu,
                        i.numero_interno,
                        i.terminal || '-',
                        publicidad.length > 0 ? publicidad.join(', ') : '-',
                        i.dano_pintura ? 'Sí' : 'No',
                        i.residuos_pegamento ? 'Sí' : 'No',
                        new Date(i.created_at).toLocaleDateString()
                    ];
                });
                
                // Encabezados de la tabla
                const headers = [
                    'PPU', 'N° Interno', 'Terminal', 'Publicidad', 'Daños', 'Residuos', 'Fecha'
                ];
                
                // Agregar tabla
                doc.autoTable({
                    startY: yPos + 16,
                    head: [headers],
                    body: tableData,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [30, 64, 175],
                        textColor: [255, 255, 255]
                    },
                    alternateRowStyles: {
                        fillColor: [240, 247, 255]
                    },
                    margin: { top: 10 }
                });
                
                // Agregar pie de página
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    
                    // Fecha de generación
                    const now = new Date();
                    doc.text(
                        `Generado el: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`,
                        14, doc.internal.pageSize.height - 10
                    );
                    
                    // Número de página
                    doc.text(
                        `Página ${i} de ${pageCount}`,
                        doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10
                    );
                }
                
                // Título del archivo con fecha
                const now = new Date();
                const fileTitle = `Reporte_PubliBus_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
                
                // Descargar archivo
                doc.save(`${fileTitle}.pdf`);
                
                showToast('Reporte PDF generado con éxito.', 'success');
                document.getElementById('close-export-options-btn').click();
                
            } catch (error) {
                console.error('Error exporting to PDF:', error);
                showToast('Error al generar el reporte PDF.', 'error');
            } finally {
                hideLoader();
            }
        }
        
        function showPendingBusesModal() {
            const modal = document.getElementById('pending-buses-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
            
            // Calcular buses pendientes
            const inspectedPPUs = new Set(allInspections.map(i => i.ppu));
            const pendingBuses = busFleet.filter(bus => !inspectedPPUs.has(bus.ppu));
            
            // Agrupar por terminal (simulado para esta demo)
            // Calcular pendientes por terminal basado en datos reales
            const pendingByTerminal = {
                'El Roble': 0,
                'La Reina': 0,
                'Maria Angelica': 0,
                'El Descanso': 0
            };
            
            // Distribuir buses pendientes por terminales
            const terminalNames = Object.keys(pendingByTerminal);
            pendingBuses.forEach((bus, index) => {
                // Si el bus ya fue inspeccionado, usar su terminal real
                const inspection = allInspections.find(insp => insp.ppu === bus.ppu);
                if (inspection && inspection.terminal && pendingByTerminal[inspection.terminal] !== undefined) {
                    // Este bus ya fue inspeccionado, no debería estar en pendientes
                    // Esto es solo para casos edge
                } else {
                    // Distribuir buses no inspeccionados equitativamente
                    const terminalIndex = index % terminalNames.length;
                    const terminal = terminalNames[terminalIndex];
                    pendingByTerminal[terminal]++;
                }
            });
            
            // Actualizar estadísticas
            document.getElementById('pending-total').textContent = pendingBuses.length;
            document.getElementById('pending-el-roble').textContent = pendingByTerminal['El Roble'];
            document.getElementById('pending-la-reina').textContent = pendingByTerminal['La Reina'];
            document.getElementById('pending-maria-angelica').textContent = pendingByTerminal['Maria Angelica'];
            document.getElementById('pending-el-descanso').textContent = pendingByTerminal['El Descanso'];
            
            document.getElementById('pending-showing').textContent = pendingBuses.length;
            document.getElementById('pending-total-count').textContent = pendingBuses.length;
            
            // Renderizar lista
            const list = document.getElementById('pending-buses-list');
            list.innerHTML = '';
            
            if (pendingBuses.length === 0) {
                list.innerHTML = `
                    <li class="text-center text-text-secondary dark:text-text-secondary-dark py-6">
                        ¡Felicitaciones! No hay buses pendientes de inspección.
                    </li>
                `;
            } else {
                pendingBuses.forEach(bus => {
                    // Asignar terminal simulado
                    const randomTerminal = Object.keys(pendingByTerminal)[Math.floor(Math.random() * Object.keys(pendingByTerminal).length)];
                    
                    const li = document.createElement('li');
                    li.className = 'pending-bus-item bg-white dark:bg-gray-800 p-4 rounded-lg hover:shadow-md transition-all duration-200 cursor-pointer';
                    li.dataset.ppu = bus.ppu;
                    li.dataset.numeroInterno = bus.numero_interno;
                    li.dataset.terminal = randomTerminal;
                    
                    li.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-text-primary dark:text-text-primary-dark">${bus.ppu}</div>
                                <div class="text-sm text-text-secondary dark:text-text-secondary-dark">N° ${bus.numero_interno}</div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs px-2 py-1 rounded-full bg-brand-light/10 text-brand-light">${randomTerminal}</span>
                            </div>
                        </div>
                    `;
                    
                    li.addEventListener('click', () => selectPendingBus(bus));
                    list.appendChild(li);
                });
            }
            
            // Configurar búsqueda
            document.getElementById('pending-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.pending-bus-item').forEach(item => {
                    const ppu = item.dataset.ppu.toLowerCase();
                    const numero = item.dataset.numeroInterno.toLowerCase();
                    item.style.display = ppu.includes(searchTerm) || numero.includes(searchTerm) ? 'block' : 'none';
                });
            });
            
            // Configurar filtro por terminal
            document.getElementById('pending-terminal-filter').addEventListener('change', function(e) {
                const terminal = e.target.value;
                document.querySelectorAll('.pending-bus-item').forEach(item => {
                    if (terminal === 'all' || item.dataset.terminal === terminal) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
            
            // Botón de selección aleatoria eliminado
            
            // Configurar cerrado del modal
            configureModalClosers(modal);
        }
        
        function selectPendingBus(bus) {
            // Cerrar el modal
            document.getElementById('close-pending-modal-btn').click();
            
            // Navegar al formulario
            navigateTo('form');
            
            // Completar los datos del bus
            setTimeout(() => {
                document.getElementById('ppu').value = bus.ppu;
                document.getElementById('numero_interno').value = bus.numero_interno;
                document.getElementById('marca_chasis').value = bus.marca || '';
                document.getElementById('suggestions-box').classList.add('hidden');
                
                // Verificar si el bus ya fue inspeccionado - INMEDIATAMENTE
                onBusSelected(bus.ppu);
                
                showToast(`Bus ${bus.ppu} seleccionado para inspección.`, 'success');
            }, 300);
        }
        

        
        // Función genérica para configurar el cierre de modales
        function configureModalClosers(modal) {
            // Configurar botones de cierre con ID específico
            const closeButtons = modal.querySelectorAll('[id^="close-"][id$="-btn"]');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const content = modal.querySelector('.modal-content');
                    content.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                });
            });
            
            // Configurar botones de cierre con clase específica
            const closeClassButtons = modal.querySelectorAll('.close-bus-detail-btn');
            closeClassButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const content = modal.querySelector('.modal-content');
                    content.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                });
            });
            
            // Cerrar al hacer clic fuera del modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    const content = modal.querySelector('.modal-content');
                    content.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                }
            });
        }
        
        // Event listeners optimizados
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Iniciando PubliBus (optimizado)...');
            
            // Verificar que las funciones de alerta estén disponibles
            if (typeof hideBusInspectionAlert === 'undefined') {
                console.error('Funciones de alerta no están disponibles. Verificando en 1 segundo...');
                setTimeout(() => {
                    if (typeof hideBusInspectionAlert === 'undefined') {
                        console.error('ERROR: Las funciones de alerta no se cargaron correctamente');
                        alert('Error: Las funciones de alerta no se cargaron. Por favor, recarga la página.');
                    }
                }, 1000);
            }
            
            // Inicializar Supabase
            dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // Inicializar iconos de Lucide de forma diferida
            setTimeout(() => {
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }, 200);
            
            // Configurar listeners de conectividad
            window.addEventListener('online', async () => {
                console.log('✅ Conexión restablecida');
                showToast('Conexión restablecida. Recargando datos...', 'success');
                
                // Recargar datos cuando se restablezca la conexión
                try {
                    busFleet = await fetchBusFleet();
                    allInspections = await fetchAllInspections();
                    updateDashboardStats();
                    updateFleetCounters();
                    showToast('Datos actualizados correctamente.', 'success');
                } catch (error) {
                    console.error('Error recargando datos:', error);
                    showToast('Error al recargar datos.', 'error');
                }
            });
            
            window.addEventListener('offline', () => {
                console.log('❌ Conexión perdida');
                showToast('Conexión perdida. Algunas funciones pueden no estar disponibles.', 'warning');
            });
            
            // CONFIGURAR NAVEGACIÓN DEL SIDEBAR - ESTO FALTABA
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = link.getAttribute('data-view');
                    navigateTo(viewId);
                });
            });
            
            // Cargar datos iniciales
            try {
                showLoader('Cargando datos iniciales...');
                busFleet = await fetchBusFleet();
                allInspections = await fetchAllInspections();
                hideLoader();
                
                if (busFleet.length === 0 && allInspections.length === 0) {
                    showToast('No se encontraron datos. Verifica la conexión a la base de datos.', 'warning');
                } else {
                    showToast('Datos cargados correctamente.', 'success');
                }
            } catch (error) {
                console.error('Error loading initial data:', error);
                hideLoader();
                showToast('Error al cargar los datos iniciales. Revisando conexión...', 'warning');
            }
            
            // Configurar filtros del dashboard
            document.querySelectorAll('.date-filter').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.date-filter').forEach(b => {
                        b.classList.remove('bg-brand-light', 'text-white');
                        b.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    });
                    btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    btn.classList.add('bg-brand-light', 'text-white');
                    
                    dateFilterPeriod = btn.dataset.period;
                    updateInspectionsChart(allInspections);
                });
            });
            
            // Configurar filtros de terminales
            document.querySelectorAll('.terminal-filter').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.terminal-filter').forEach(b => {
                        b.classList.remove('bg-brand-light', 'text-white');
                        b.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    });
                    btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    btn.classList.add('bg-brand-light', 'text-white');
                    
                    terminalFilter = btn.dataset.terminal;
                    renderTerminalStats();
                });
            });
            
            // Configurar selector de tipo de distribución
            document.getElementById('distribution-type').addEventListener('change', function(e) {
                distributionType = e.target.value;
                renderDistributionChart();
            });
            
            // Configurar filtros de tendencias
            document.querySelectorAll('.trends-period').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.trends-period').forEach(b => {
                        b.classList.remove('bg-brand-light', 'text-white');
                        b.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    });
                    btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    btn.classList.add('bg-brand-light', 'text-white');
                    
                    trendsPeriod = parseInt(btn.dataset.period);
                    renderTrendsChart();
                });
            });
            
            // Configurar mapa
            document.querySelectorAll('.map-toggle').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewType = btn.id.replace('map-view-', '');
                    console.log('Botón de mapa clickeado:', viewType);
                    updateMapView(viewType);
                });
            });
            
            // Configurar pestañas de reportes
            document.querySelectorAll('.tab-link').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    document.querySelectorAll('.tab-link').forEach(t => {
                        t.classList.replace('border-brand-secondary', 'border-transparent');
                        t.classList.replace('text-brand-secondary', 'text-gray-500');
                        t.classList.replace('dark:text-brand-light', 'dark:text-gray-400');
                        t.classList.replace('dark:border-brand-light', 'border-transparent');
                    });
                    
                    tab.classList.replace('border-transparent', 'border-brand-secondary');
                    tab.classList.replace('text-gray-500', 'text-brand-secondary');
                    tab.classList.replace('dark:text-gray-400', 'dark:text-brand-light');
                    tab.classList.replace('border-transparent', 'dark:border-brand-light');
                    
                    const contentId = tab.id.replace('tab-', 'report-content-');
                    document.querySelectorAll('.report-content').forEach(c => {
                        c.classList.toggle('hidden', c.id !== contentId);
                    });
                });
            });
            
            // Eliminados los event listeners de paginación - ya no se necesita paginación
            
            // Iniciar seguimiento optimizado después de configurar todo
            setTimeout(() => {
                startRealTimeTracking();
                console.log('✅ PubliBus iniciado correctamente (optimizado)');
            }, 500);
            
            // Configurar búsqueda en la flota
            document.getElementById('fleet-search').addEventListener('input', (e) => {
                fleetSearchParams.searchTerm = e.target.value;
                renderFleetGrid();
            });
            
            // Configurar filtros de la flota
            document.getElementById('fleet-filter').addEventListener('change', (e) => {
                fleetSearchParams.filter = e.target.value;
                renderFleetGrid();
            });
            
            document.getElementById('fleet-terminal-filter').addEventListener('change', (e) => {
                fleetSearchParams.terminal = e.target.value;
                renderFleetGrid();
            });
            
            // Configurar búsqueda en el formulario con debounce para evitar llamadas excesivas
            let searchTimeout;
            document.getElementById('ppu').addEventListener('input', async () => {
                // Limpiar timeout anterior
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // Configurar nuevo timeout para evitar llamadas excesivas
                searchTimeout = setTimeout(async () => {
                const query = document.getElementById('ppu').value.toLowerCase();
                const suggestionsBox = document.getElementById('suggestions-box');
                
                if (query.length < 1) {
                    suggestionsBox.classList.add('hidden');
                    hideBusInspectionAlert();
                    return;
                }
                
                const filteredBuses = busFleet.filter(bus => 
                    bus.ppu.toLowerCase().includes(query) || 
                    (bus.numero_interno && bus.numero_interno.toLowerCase().includes(query))
                );
                
                suggestionsBox.innerHTML = '';
                
                if (filteredBuses.length > 0) {
                    filteredBuses.forEach(bus => {
                        const div = document.createElement('div');
                        div.className = 'p-3 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer';
                        div.innerHTML = `
                            <div class="font-medium">${bus.ppu}</div>
                            <div class="text-sm text-text-secondary dark:text-text-secondary-dark">N° ${bus.numero_interno}</div>
                        `;
                        div.onclick = () => {
                            document.getElementById('ppu').value = bus.ppu;
                            document.getElementById('numero_interno').value = bus.numero_interno;
                            document.getElementById('marca_chasis').value = bus.marca || '';
                            suggestionsBox.classList.add('hidden');
                            
                            console.log('✅ Bus seleccionado de la lista:', bus.ppu);
                            // Verificar si el bus ya fue inspeccionado - INMEDIATAMENTE
                            onBusSelected(bus.ppu);
                            // Mostrar toast de confirmación
                            showToast(`Bus ${bus.ppu} seleccionado para inspección.`, 'success');
                        };
                        suggestionsBox.appendChild(div);
                    });
                    suggestionsBox.classList.remove('hidden');
                } else {
                    suggestionsBox.classList.add('hidden');
                }
                
                // Verificar duplicados solo cuando se complete la búsqueda (no en tiempo real)
                // Removido para evitar llamadas excesivas
                }, 300); // 300ms de debounce
            });
            
            // Cerrar sugerencias al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (e.target.id !== 'ppu' && e.target.id !== 'suggestions-box') {
                    document.getElementById('suggestions-box').classList.add('hidden');
                }
            });
            
            // Verificar PPU cuando se confirma (Enter o blur)
            document.getElementById('ppu').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const ppu = e.target.value.trim();
                    if (ppu) {
                        console.log('✅ PPU confirmada con Enter:', ppu);
                        // Verificar si el bus ya fue inspeccionado
                        onBusSelected(ppu);
                        // Ocultar sugerencias
                        document.getElementById('suggestions-box').classList.add('hidden');
                        // Mostrar toast de confirmación
                        showToast(`Bus ${ppu} seleccionado para inspección.`, 'success');
                    }
                }
            });
            
            // Verificar PPU cuando se pierde el foco (blur)
            document.getElementById('ppu').addEventListener('blur', (e) => {
                const ppu = e.target.value.trim();
                if (ppu) {
                    // Pequeño delay para permitir que se complete la selección de sugerencias
                    setTimeout(() => {
                        onBusSelected(ppu);
                    }, 100);
                } else {
                    // Si el campo está vacío, ocultar alerta
                    hideBusInspectionAlert();
                    hideBusStatusIndicator();
                }
            });
            
            // Limpiar alerta cuando se empiece a escribir una nueva PPU
            document.getElementById('ppu').addEventListener('input', (e) => {
                const ppu = e.target.value.trim();
                if (!ppu) {
                    // Si se borra todo el contenido, ocultar alerta
                    hideBusInspectionAlert();
                    hideBusStatusIndicator();
                }
            });
            
            // Configurar formulario con verificaciones mejoradas
            document.getElementById('inspection-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Verificar que el formulario esté listo (con fallback)
                if (typeof ensureFormReady === 'function') {
                    if (!ensureFormReady()) {
                        return;
                    }
                } else {
                    // Fallback si ensureFormReady no está disponible
                    const requiredElements = ['ppu', 'numero_interno', 'marca_chasis'];
                    const missingElements = requiredElements.filter(id => !document.getElementById(id));
                    
                    if (missingElements.length > 0) {
                        showToast('Error: Formulario no está completamente cargado. Por favor, recarga la página.', 'error');
                        return;
                    }
                    
                    if (typeof dbClient === 'undefined' || !dbClient) {
                        showToast('Error: Conexión a la base de datos no disponible. Por favor, recarga la página.', 'error');
                        return;
                    }
                }
                
                // Verificar que se haya seleccionado un bus
                const ppu = document.getElementById('ppu').value;
                const numeroInterno = document.getElementById('numero_interno').value;
                
                if (!ppu || !numeroInterno) {
                    showToast('Debe seleccionar un bus de la lista antes de registrar.', 'warning');
                    return;
                }
                
                // La verificación de bus ya inspeccionado se hace automáticamente al seleccionar la PPU
                // No es necesario verificar aquí nuevamente
                
                showLoader('Obteniendo ubicación GPS...');
                
                if (!navigator.geolocation) {
                    showToast('La geolocalización no es soportada.', 'error');
                    hideLoader();
                    return;
                }
                
                // Optimizar el proceso de guardado
                const startTime = Date.now();
                
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const { latitude: lat, longitude: lon } = position.coords;
                    const nearestTerminal = getNearestTerminal(lat, lon);
                    
                    // Preparar datos del formulario de forma más eficiente
                    const formData = new FormData(e.target);
                    const record = { 
                        lat, 
                        lon, 
                        terminal: nearestTerminal,
                        inspector_name: currentInspectorName,
                        accuracy: position.coords.accuracy || null,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Procesar campos del formulario de forma optimizada
                    const booleanFields = ['publicidad_izquierda', 'publicidad_luneta', 'publicidad_derecha', 'residuos_pegamento', 'dano_pintura'];
                    const textFields = ['publicidad_izquierda_detalle', 'publicidad_luneta_detalle', 'publicidad_derecha_detalle', 'residuos_pegamento_detalle', 'dano_pintura_detalle'];
                    
                    for (let [key, value] of formData.entries()) {
                        if (booleanFields.includes(key)) {
                            record[key] = value === 'true';
                        } else if (textFields.includes(key)) {
                            record[key] = value || null;
                        } else {
                            record[key] = value;
                        }
                    }
                    
                    try {
                        if (!dbClient) throw new Error("Cliente de Supabase no inicializado.");
                        
                        // Actualizar loader con progreso
                        showLoader('Guardando inspección en la base de datos...');
                        
                        console.log('Guardando inspección...', record);
                        
                        // Guardar en la base de datos
                        const { error } = await dbClient.from('levantamiento_de_publicidad').insert([record]);
                        
                        if (error) throw error;
                        
                        console.log('Inspección guardada en', Date.now() - startTime, 'ms');
                        
                        // Actualizar datos de forma asíncrona (no bloquear la UI)
                        setTimeout(async () => {
                            try {
                                allInspections = await fetchAllInspections();
                                updateDashboardStats();
                                updateFleetCounters();
                                
                                if (currentView === 'analytics') {
                                    renderTerminalsComparison();
                                    updateKPIs();
                                }
                                
                                updateNotificationsPanel();
                            } catch (updateError) {
                                console.error('Error actualizando datos:', updateError);
                            }
                        }, 100);
                        
                        showToast('Inspección guardada con éxito.', 'success');
                        
                        // Limpiar formulario
                        e.target.reset();
                        document.querySelectorAll('textarea[id$="_detalle"]').forEach(el => {
                            el.classList.add('hidden');
                        });
                        document.querySelectorAll('[id$="-photo-container"]').forEach(el => {
                            el.classList.add('hidden');
                        });
                        document.querySelectorAll('[id$="-photo-preview"]').forEach(el => {
                            el.classList.add('hidden');
                        });
                        
                        // Redirigir al dashboard
                        navigateTo('dashboard');
                        
                    } catch (error) {
                        console.error('Error saving inspection:', error);
                        showToast(`Error al guardar: ${error.message}`, 'error');
                    } finally {
                        hideLoader();
                    }
                }, (error) => {
                    showToast(`Error de geolocalización: ${error.message}`, 'error');
                    hideLoader();
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000, // 10 segundos máximo
                    maximumAge: 30000 // Usar ubicación cacheada si tiene menos de 30 segundos
                });
            });
            
            // Guardar como borrador (simulado)
            document.getElementById('form-save-draft').addEventListener('click', () => {
                showToast('Borrador guardado localmente.', 'success');
            });
            
            // SOLUCIÓN DIRECTA: Event listener específico para el botón de registro
            const submitButton = document.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('🎯 BOTÓN DE REGISTRO CLICKEADO - SOLUCIÓN DIRECTA');
                    
                    // Verificar que se haya seleccionado un bus
                    const ppu = document.getElementById('ppu').value;
                    const numeroInterno = document.getElementById('numero_interno').value;
                    
                    if (!ppu || !numeroInterno) {
                        showToast('Debe seleccionar un bus de la lista antes de registrar.', 'warning');
                        return;
                    }
                    
                    // Verificar si el bus ya fue inspeccionado
                    if (typeof allInspections !== 'undefined' && allInspections) {
                        const existingInspection = allInspections.find(insp => 
                            insp.ppu.toLowerCase() === ppu.toLowerCase()
                        );
                        
                        if (existingInspection) {
                            showToast('Este bus ya fue inspeccionado. Verifica la alerta arriba.', 'warning');
                            return;
                        }
                    }
                    
                    // Verificar conexión a base de datos
                    if (typeof dbClient === 'undefined' || !dbClient) {
                        showToast('Error: Conexión a la base de datos no disponible. Por favor, recarga la página.', 'error');
                        return;
                    }
                    
                    showLoader('Obteniendo ubicación GPS...');
                    
                    if (!navigator.geolocation) {
                        showToast('La geolocalización no es soportada.', 'error');
                        hideLoader();
                        return;
                    }
                    
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const { latitude: lat, longitude: lon } = position.coords;
                        const nearestTerminal = getNearestTerminal(lat, lon);
                        
                        // Obtener datos del formulario
                        const form = document.getElementById('inspection-form');
                        const formData = new FormData(form);
                        
                        const record = { 
                            lat, 
                            lon, 
                            terminal: nearestTerminal,
                            inspector_name: currentInspectorName,
                            accuracy: position.coords.accuracy || null,
                            timestamp: new Date().toISOString()
                        };
                        
                        // Procesar campos del formulario
                        const booleanFields = ['publicidad_izquierda', 'publicidad_luneta', 'publicidad_derecha', 'residuos_pegamento', 'dano_pintura'];
                        const textFields = ['publicidad_izquierda_detalle', 'publicidad_luneta_detalle', 'publicidad_derecha_detalle', 'residuos_pegamento_detalle', 'dano_pintura_detalle'];
                        
                        for (let [key, value] of formData.entries()) {
                            if (booleanFields.includes(key)) {
                                record[key] = value === 'true';
                            } else if (textFields.includes(key)) {
                                record[key] = value || null;
                            } else {
                                record[key] = value;
                            }
                        }
                        
                        try {
                            showLoader('Guardando inspección en la base de datos...');
                            
                            console.log('💾 Guardando inspección...', record);
                            
                            const { error } = await dbClient.from('levantamiento_de_publicidad').insert([record]);
                            
                            if (error) throw error;
                            
                            console.log('✅ Inspección guardada exitosamente');
                            
                            // Actualizar datos
                            setTimeout(async () => {
                                try {
                                    allInspections = await fetchAllInspections();
                                    updateDashboardStats();
                                    updateFleetCounters();
                                    
                                    if (currentView === 'analytics') {
                                        renderTerminalsComparison();
                                        updateKPIs();
                                    }
                                    
                                    updateNotificationsPanel();
                                } catch (updateError) {
                                    console.error('Error actualizando datos:', updateError);
                                }
                            }, 100);
                            
                            showToast('🎉 Inspección guardada con éxito.', 'success');
                            
                            // Limpiar formulario
                            form.reset();
                            document.querySelectorAll('textarea[id$="_detalle"]').forEach(el => {
                                el.classList.add('hidden');
                            });
                            document.querySelectorAll('[id$="-photo-container"]').forEach(el => {
                                el.classList.add('hidden');
                            });
                            document.querySelectorAll('[id$="-photo-preview"]').forEach(el => {
                                el.classList.add('hidden');
                            });
                            
                            // Redirigir al dashboard
                            navigateTo('dashboard');
                            
                        } catch (error) {
                            console.error('❌ Error saving inspection:', error);
                            showToast(`Error al guardar: ${error.message}`, 'error');
                        } finally {
                            hideLoader();
                        }
                    }, (error) => {
                        showToast(`Error de geolocalización: ${error.message}`, 'error');
                        hideLoader();
                    }, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 30000
                    });
                });
                
                console.log('✅ Event listener directo agregado al botón de registro');
            } else {
                console.error('❌ Botón de submit no encontrado');
            }
            
            // Función para verificar el estado del formulario (para debugging)
            window.checkFormStatus = function() {
                console.log('=== ESTADO DEL FORMULARIO ===');
                console.log('Cliente Supabase:', typeof dbClient, !!dbClient);
                console.log('allInspections:', typeof allInspections, allInspections ? allInspections.length : 'undefined');
                console.log('Formulario:', !!document.getElementById('inspection-form'));
                console.log('Campo PPU:', !!document.getElementById('ppu'));
                console.log('Campo N° Interno:', !!document.getElementById('numero_interno'));
                console.log('Campo Marca:', !!document.getElementById('marca_chasis'));
                console.log('Vista actual:', currentView);
                console.log('ensureFormReady disponible:', typeof ensureFormReady);
                console.log('showToast disponible:', typeof showToast);
                console.log('hideBusInspectionAlert disponible:', typeof hideBusInspectionAlert);
                console.log('==============================');
            };
            
            // Función para probar el botón de registro
            window.testFormSubmission = function() {
                console.log('=== PROBANDO ENVÍO DE FORMULARIO ===');
                
                // 1. Verificar que el formulario existe
                const form = document.getElementById('inspection-form');
                if (!form) {
                    console.error('❌ Formulario no encontrado');
                    return;
                }
                console.log('✅ Formulario encontrado');
                
                // 2. Verificar que el botón de submit existe
                const submitButton = form.querySelector('button[type="submit"]');
                if (!submitButton) {
                    console.error('❌ Botón de submit no encontrado');
                    return;
                }
                console.log('✅ Botón de submit encontrado:', submitButton.textContent.trim());
                
                // 3. Verificar campos requeridos
                const ppu = document.getElementById('ppu');
                const numeroInterno = document.getElementById('numero_interno');
                const marcaChasis = document.getElementById('marca_chasis');
                
                console.log('📝 Campo PPU:', ppu ? ppu.value : 'No encontrado');
                console.log('📝 Campo N° Interno:', numeroInterno ? numeroInterno.value : 'No encontrado');
                console.log('📝 Campo Marca:', marcaChasis ? marcaChasis.value : 'No encontrado');
                
                // 4. Simular clic en el botón
                console.log('🖱️ Simulando clic en el botón...');
                submitButton.click();
                
                // 5. También simular envío del formulario
                console.log('📤 Simulando envío del formulario...');
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                form.dispatchEvent(submitEvent);
                
                console.log('✅ Prueba completada');
            };
            
            // Función para verificar si el event listener está funcionando
            window.checkEventListener = function() {
                console.log('=== VERIFICANDO EVENT LISTENER ===');
                
                const form = document.getElementById('inspection-form');
                if (!form) {
                    console.error('❌ Formulario no encontrado');
                    return;
                }
                
                // Verificar si el formulario tiene event listeners
                console.log('📋 Formulario:', form);
                console.log('🔗 Event listeners disponibles:', form.onSubmit ? 'Sí' : 'No');
                
                // Probar si el formulario responde a eventos
                const testEvent = new Event('submit', { bubbles: true, cancelable: true });
                let eventHandled = false;
                
                const originalPreventDefault = testEvent.preventDefault;
                testEvent.preventDefault = function() {
                    eventHandled = true;
                    console.log('✅ Event listener está funcionando - preventDefault llamado');
                    return originalPreventDefault.call(this);
                };
                
                form.dispatchEvent(testEvent);
                
                if (!eventHandled) {
                    console.error('❌ Event listener NO está funcionando');
                }
            };
            
            // Función para forzar el registro del event listener
            window.forceAddEventListener = function() {
                console.log('=== FORZANDO REGISTRO DE EVENT LISTENER ===');
                
                const form = document.getElementById('inspection-form');
                if (!form) {
                    console.error('❌ Formulario no encontrado');
                    return;
                }
                
                // Remover event listeners existentes
                const newForm = form.cloneNode(true);
                form.parentNode.replaceChild(newForm, form);
                
                console.log('🔄 Formulario clonado y reemplazado');
                
                // Agregar el event listener nuevamente
                newForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log('✅ Event listener funcionando correctamente');
                    
                    // Verificar que el formulario esté listo (con fallback)
                    if (typeof ensureFormReady === 'function') {
                        if (!ensureFormReady()) {
                            return;
                        }
                    } else {
                        // Fallback si ensureFormReady no está disponible
                        const requiredElements = ['ppu', 'numero_interno', 'marca_chasis'];
                        const missingElements = requiredElements.filter(id => !document.getElementById(id));
                        
                        if (missingElements.length > 0) {
                            showToast('Error: Formulario no está completamente cargado. Por favor, recarga la página.', 'error');
                            return;
                        }
                        
                        if (typeof dbClient === 'undefined' || !dbClient) {
                            showToast('Error: Conexión a la base de datos no disponible. Por favor, recarga la página.', 'error');
                            return;
                        }
                    }
                    
                    showToast('✅ Event listener funcionando - Formulario listo para procesar', 'success');
                });
                
                console.log('✅ Event listener registrado nuevamente');
            };
            
            // FUNCIÓN DE EMERGENCIA: Forzar funcionamiento del botón
            window.emergencyFixButton = function() {
                console.log('🚨 APLICANDO FIX DE EMERGENCIA AL BOTÓN');
                
                // Buscar el botón
                const submitButton = document.querySelector('button[type="submit"]');
                if (!submitButton) {
                    console.error('❌ Botón no encontrado');
                    return;
                }
                
                // Remover todos los event listeners existentes
                const newButton = submitButton.cloneNode(true);
                submitButton.parentNode.replaceChild(newButton, submitButton);
                
                // Agregar event listener directo
                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('🎯 BOTÓN FUNCIONANDO - FIX DE EMERGENCIA');
                    
                    // Verificar campos básicos
                    const ppu = document.getElementById('ppu').value;
                    const numeroInterno = document.getElementById('numero_interno').value;
                    
                    if (!ppu || !numeroInterno) {
                        alert('Debe seleccionar un bus antes de registrar');
                        return;
                    }
                    
                    // Mostrar mensaje de éxito
                    alert('¡Botón funcionando! Formulario listo para procesar');
                    
                    // Aquí puedes agregar la lógica completa del formulario
                    console.log('✅ Botón de registro funcionando correctamente');
                });
                
                console.log('✅ Fix de emergencia aplicado');
            };
            
                    // FUNCIONES DE OPTIMIZACIÓN DE RENDIMIENTO
        window.optimizePerformance = function() {
            console.log('🚀 Optimizando rendimiento...');
            
            // Limpiar intervalos innecesarios
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
                realTimeUpdateInterval = null;
            }
            
            // Reducir frecuencia de actualizaciones
            startRealTimeUpdates();
            
            // Limpiar caché de datos innecesarios
            if (window.performance && window.performance.memory) {
                console.log('Memoria antes:', Math.round(window.performance.memory.usedJSHeapSize / 1024 / 1024), 'MB');
            }
            
            // Forzar garbage collection si está disponible
            if (window.gc) {
                window.gc();
            }
            
            console.log('✅ Optimización completada');
        };
        
        // Función para limpiar recursos del mapa
        window.cleanupMap = function() {
            if (map) {
                // Limpiar capas innecesarias
                map.eachLayer((layer) => {
                    if (layer !== map) {
                        map.removeLayer(layer);
                    }
                });
                
                // Reducir zoom para mejor rendimiento
                map.setZoom(10);
                
                console.log('🗺️ Mapa optimizado');
            }
        };
        
        // Función para reinicializar el formulario si hay problemas
        window.reinitializeForm = function() {
                try {
                    // Verificar que todos los elementos estén disponibles
                    const form = document.getElementById('inspection-form');
                    if (!form) {
                        console.error('Formulario no encontrado');
                        return false;
                    }
                    
                    // Limpiar formulario
                    form.reset();
                    
                    // Ocultar alertas
                    hideBusInspectionAlert();
                    
                    // Limpiar campos ocultos
                    document.querySelectorAll('textarea[id$="_detalle"]').forEach(el => {
                        el.classList.add('hidden');
                    });
                    document.querySelectorAll('[id$="-photo-container"]').forEach(el => {
                        el.classList.add('hidden');
                    });
                    document.querySelectorAll('[id$="-photo-preview"]').forEach(el => {
                        el.classList.add('hidden');
                    });
                    
                    // Ocultar sugerencias
                    const suggestionsBox = document.getElementById('suggestions-box');
                    if (suggestionsBox) {
                        suggestionsBox.classList.add('hidden');
                    }
                    
                    showToast('Formulario reinicializado correctamente.', 'success');
                    return true;
                } catch (error) {
                    console.error('Error reinicializando formulario:', error);
                    showToast('Error al reinicializar el formulario. Por favor, recarga la página.', 'error');
                    return false;
                }
            };
            
            // Configurar botón de exportación
            document.getElementById('export-excel-btn').addEventListener('click', openExportOptionsModal);
            document.getElementById('export-pdf-btn').addEventListener('click', openExportOptionsModal);
            
            // Configurar botón de buses pendientes
            document.getElementById('open-pending-modal-btn').addEventListener('click', showPendingBusesModal);
            
            // Cargar datos iniciales y actualizar notificaciones
            await loadInitialData();
            
            // Navegar a la vista inicial
            await navigateTo('dashboard');
        });
        
        // Limpiar seguimiento en tiempo real al cerrar la página
        window.addEventListener('beforeunload', async () => {
            stopRealTimeTracking();
            
            // Eliminar usuario activo de la base de datos
            if (currentSessionId && dbClient) {
                try {
                    await dbClient
                        .from('active_users')
                        .delete()
                        .eq('session_id', currentSessionId);
                } catch (error) {
                    console.error('Error eliminando usuario activo:', error);
                }
            }
        });
        
        // Ajustar alerta en cambios de orientación móvil
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                const alertElement = document.getElementById('bus-inspection-alert');
                if (alertElement && alertElement.style.display !== 'none') {
                    // Reajustar posición después del cambio de orientación
                    if (window.innerWidth <= 768) {
                        alertElement.style.left = '1rem';
                        alertElement.style.right = '1rem';
                        alertElement.style.transform = 'none';
                    } else {
                        alertElement.style.left = '50%';
                        alertElement.style.right = 'auto';
                        alertElement.style.transform = 'translateX(-50%)';
                    }
                }
            }, 100);
        });
        
        // Ajustar alerta en redimensionamiento de ventana
        window.addEventListener('resize', () => {
            const alertElement = document.getElementById('bus-inspection-alert');
            if (alertElement && alertElement.style.display !== 'none') {
                // Reajustar posición después del redimensionamiento
                if (window.innerWidth <= 768) {
                    alertElement.style.left = '1rem';
                    alertElement.style.right = '1rem';
                    alertElement.style.transform = 'none';
                } else {
                    alertElement.style.left = '50%';
                    alertElement.style.right = 'auto';
                    alertElement.style.transform = 'translateX(-50%)';
                }
            }
        });



    </script>
</body>
</html>
